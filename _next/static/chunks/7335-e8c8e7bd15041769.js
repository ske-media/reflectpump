!function(){try{var t="undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{},e=(new t.Error).stack;e&&(t._sentryDebugIds=t._sentryDebugIds||{},t._sentryDebugIds[e]="256f1672-7bab-4ab0-94dd-6a565825bdbf",t._sentryDebugIdIdentifier="sentry-dbid-256f1672-7bab-4ab0-94dd-6a565825bdbf")}catch(t){}}(),(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[7335],{52785:function(t,e,n){"use strict";n.d(e,{V:function(){return l}});var r=n(18734),i=n(75422),a=n(8680);async function o(t){let{noteStore:e,contactStore:n,backlink:r,matchByLabel:i=!1}=t,a=r.id,o=a?await e.findById(a):null;if(o)return o;if(r.dailyAt?o=await e.findOrCreateDailyNoteByDate(r.dailyAt):i&&r.label&&(o=await e.findBySubjectAlias(r.label)),!o){let t=await s({backlink:r,graphId:e.assertGraph.id,contactStore:n});o=await e.createNote({subject:r.label,document:null!=t?t:void 0},{emptyList:!1})}return o}async function s(t){let{backlink:e,graphId:n,contactStore:r}=t,o=e.contactId;if(!o)return null;let s=await r.find(o);return s?(0,i.FT)((0,a.ct)(s,n)):null}async function l(t){var e;let{noteStore:n,contactStore:i,backlink:a,matchByLabel:s=!0}=t,l=await o({noteStore:n,contactStore:i,backlink:a,matchByLabel:s});l.incrementBacklinkedCount();let c=l.assertGraph,d=null!==(e=a.insertLabel)&&void 0!==e?e:a.label;return(0,r.yV)({backlinkCreated:!0}),(0,r.j)("backlink_created"),{...a,graphId:c.id,label:d,id:l.id}}},45113:function(t,e,n){"use strict";n.d(e,{Dh:function(){return i},Px:function(){return a}});var r=n(75422);async function i(t,e,n){if((await t.getOutgoingBacklinks()).find(t=>t.toNoteId===e))return t.changeManager.modifyDocument(t=>(0,r.Ne)(t,t=>{(0,r.YK)(t,e,n)}))}async function a(t,e){for(let i of t.incomingBacklinks){var n;let a=await (null===(n=t.noteStore)||void 0===n?void 0:n.findById(i.fromNoteId));a&&function(t,e){let{backlinkId:n,label:i}=e;t.changeManager.modifyDocument(t=>(0,r.Ne)(t,t=>{(0,r.YK)(t,n,n,{label:i})}))}(a,{backlinkId:t.id,label:e})}return!0}},57387:function(t,e,n){"use strict";n.d(e,{m:function(){return r}});class r extends Error{constructor(){super("Promise timed out"),this.name="PromiseTimeoutError"}}},69549:function(t,e,n){"use strict";n.d(e,{AA:function(){return i},Kg:function(){return r},bZ:function(){return a},fD:function(){return o}});class r extends Error{constructor(t){super("Graph ".concat(t," does not exist")),this.name="GraphDoesNotExistError"}}class i extends Error{constructor(t){super("Graph ".concat(t.graph.id," is currently migrating to version ").concat(t.migratingVersion)),this.name="GraphMigratingError"}}class a extends Error{constructor(){super("Attempted to save during migration or in newer format than latest migration"),this.name="GraphOldSaveRejectedError"}}class o extends Error{constructor(){super("Failed to fetch graph version"),this.name="FailedFetchingGraphVersionError"}}},8711:function(t,e,n){"use strict";n.d(e,{KL:function(){return i},UG:function(){return a},h3:function(){return r}});class r extends Error{constructor(t){super("Note ".concat(t.graphId,"/").concat(t.id," is missing the document")),this.name="MissingDocError"}}class i extends Error{constructor(t){super("Note ".concat(t.graphId,"/").concat(t.id," is missing YDoc")),this.name="MissingYjsDocError"}}class a extends Error{constructor({id:t,cause:e}){super("Failed reading note ".concat(t,": ").concat(e),{cause:e}),this.name="FailedReadingNoteError"}}},94232:function(t,e,n){"use strict";n.d(e,{Cn:function(){return r},WA:function(){return a},Xn:function(){return i}});class r extends Error{constructor(){super("Cannot create a commit, it already exists"),this.name="CommitExistsError"}}class i extends Error{constructor(){super("Commit is too large"),this.name="CommitTooLargeError"}}class a extends Error{constructor(t){super("Failed fetching commits: ".concat(t),{cause:t}),this.name="FailedFetchingCommitsError"}}},46582:function(t,e,n){"use strict";n.d(e,{hH:function(){return u},w1:function(){return c},zu:function(){return s}});var r=n(65728),i=n(53967),a=n(18786);let o=r.ZP.array(r.ZP.string());function s(t){return(e,n)=>l(e,n,t)}async function l(t,e,n){let r=e.text?await (0,i.$N)({type:"AssetText",value:e.text,key:n.assertEncryptionKey,itemId:e.id}):null;return{graphId:n.id,id:t,createdAt:(0,a.av)(e.created_at),updatedAt:(0,a.av)(e.updated_at),noteIds:JSON.stringify(e.note_ids),isExtracted:e.extracted?1:0,text:r||""}}function c(t){return e=>d(e,t)}async function d(t,e){let n=t.text?await (0,i.lb)({plain:t.text,encrypt:!0,key:e.assertEncryptionKey,itemId:t.id}):null;return{id:t.id,created_at:(0,a.Mp)(t.createdAt),updated_at:(0,a.Mp)(t.updatedAt),note_ids:u(t.noteIds),extracted:1===t.isExtracted,text:n}}function u(t){return o.parse(JSON.parse(t))}},88957:function(t,e,n){"use strict";n.d(e,{AP:function(){return a},Ec:function(){return o},lw:function(){return s},m$:function(){return i}});var r=n(53342);function i(t){return l(function(t){let e=[];return t.descendants(t=>{var n,r;if("image"===t.type.name){let r=null===(n=t.attrs)||void 0===n?void 0:n.src;r&&"string"==typeof r&&e.push(r)}else if("file"===t.type.name){let n=null===(r=t.attrs)||void 0===r?void 0:r.url;n&&"string"==typeof n&&e.push(n)}}),e}(t))}function a(t){return l(o(t))}function o(t){let e=[],n=t=>{var r,i,a;if(t){if("image"===t.type){let n=null===(r=t.attrs)||void 0===r?void 0:r.src;n&&"string"==typeof n&&e.push(n)}else if("file"===t.type){let n=null===(i=t.attrs)||void 0===i?void 0:i.url;n&&"string"==typeof n&&e.push(n)}else null===(a=t.content)||void 0===a||a.forEach(n)}};return n(t),e}function s(t){if(t.includes("reflect-assets.app")){var e;return null!==(e=t.replace(/\?.*/,"").split("/").findLast(Boolean))&&void 0!==e?e:null}return null}function l(t){return t.map(s).filter(r.Dw)}},16169:function(t,e,n){"use strict";function r(t,e){let n=[];for(let r of t)for(let t of i(e(r)))n.push({item:r,alias:t});return n}function i(t){return t.split("//").map(t=>t.trim())}function a(t){return i(t)[0]}function o(t){let[e]=t.split("//",2);return e.trim()}n.d(e,{bd:function(){return o},dU:function(){return a},gO:function(){return i},wl:function(){return r}})},15969:function(t,e,n){"use strict";n.d(e,{K:function(){return a},s:function(){return i}});var r=n(41200);function i(t){var e,n;let{graphId:i,backlink:a}=t;return{id:(0,r.O)(),updatedAt:new Date().getTime(),graphId:i,label:a.label,fromNoteId:a.fromNoteId,toNoteId:a.toNoteId,contextHtml:null!==(e=a.contextHtml)&&void 0!==e?e:null,fromNoteCreatedAt:null!==(n=a.fromNoteCreatedAt)&&void 0!==n?n:null}}function a(t){var e,n;return{graphId:t.graphId,label:t.label,fromNoteId:t.fromNoteId,toNoteId:t.toNoteId,contextHtml:null!==(e=t.contextHtml)&&void 0!==e?e:void 0,fromNoteCreatedAt:null!==(n=t.fromNoteCreatedAt)&&void 0!==n?n:void 0}}},81055:function(t,e,n){"use strict";n.d(e,{f:function(){return a}});var r=n(15767),i=n(86534);class a extends(0,i.Hnr)({id:i.UB4,name:(0,i.vgT)(),primary:(0,i.vgT)(),enabled:(0,i.vgT)().withSetter(),priority:(0,i.vgT)(0)}){get sortOrder(){return this.primary?0:this.priority}}a=(0,r.gn)([(0,i.o4J)("Calendar")],a)},12774:function(t,e,n){"use strict";n.d(e,{Z:function(){return l}});var r=n(4363),i=n.n(r),a=n(44838),o=n(82020),s=n(53342);class l{async dispose(){await (0,o.$)(this.listeners)}observeChanges(){let t=(0,a.reaction)(()=>this.changeStore.pendingCommits.map(t=>{let e=t.commit;return{pointer:t,size:e.yjsUpdates.length}}),(t,e)=>this.handleChange(t,e),{delay:this.debounce});this.listeners.push(t)}handleChange(t,e){let{changed:n}=function(t){let{previous:e,current:n,objectKey:r,versionKey:i}=t,a=[],o=[],s=new Map,l=new Map,c=new Set;for(let t of e){let e=r(t);c.add(e),s.set(e,t)}for(let t of n){let e=r(t);c.add(e),l.set(e,t)}for(let t of c){let e=s.get(t),n=l.get(t);e&&!n?o.push(e):!e&&n?a.push(n):e&&n&&i&&i(e)!==i(n)&&a.push(n)}return{removed:o,changed:a}}({current:t,previous:e,objectKey:t=>{let{pointer:e}=t;return e.commit.id},versionKey:t=>{let{size:e}=t;return e.toString()}}),r=i()(n.filter(t=>{let{pointer:e}=t;return e.graphId===this.graphId}).map(t=>{let{pointer:e}=t;return e.noteId}).filter(s.Dw));r.length>0&&this.onChange(r)}async setDebounce(t){await this.dispose(),this.debounce=t,this.observeChanges()}constructor({graphId:t,changeStore:e,onChange:n,debounce:r}){this.listeners=[],this.graphId=t,this.changeStore=e,this.onChange=n,this.debounce=r,this.observeChanges()}}},16285:function(t,e,n){"use strict";n.d(e,{Q:function(){return a},a:function(){return o}});var r=n(59592),i=n(48757);function a(t){let{updates:e,forceSave:n=!1}=t;return new i.i({yjsUpdates:e.map(t=>(0,r.kZ)(t)),forceSave:n})}function o(t){let e=[];for(let n of t)if(n.yjsUpdates)for(let t of n.yjsUpdates)e.push(t);return e}},86708:function(t,e,n){"use strict";n.d(e,{Me:function(){return u},iv:function(){return h.i}});var r=n(15767),i=n(75422),a=n(86534),o=n(63317),s=n(39833),l=n(9544),c=n(16285);class d extends(0,a.Hnr)({graphId:(0,a.vgT)().withSetter(),noteId:(0,a.vgT)().withSetter(),commit:(0,a.vgT)().withSetter()}){}d=(0,r.gn)([(0,a.o4J)("PendingCommitPointer")],d);class u extends(0,a.Hnr)({pendingCommits:(0,a.vgT)(()=>[])}){onAttachedToRootStore(){console.log("[ChangeStore] Attached with commits ".concat(this.shortCommitsDebug)),this.logPendingCommits("attach")}onPersist(){console.log("[ChangeStore] Persisted with commits ".concat(this.shortCommitsDebug))}logPendingCommits(t){for(let e of this.pendingCommits){let n=e.commit.yjsUpdates.length,r="<Commit graphId=".concat(e.graphId," noteId=").concat(e.noteId," length=").concat(n,">");console.log("[ChangeStore] (".concat(t.toUpperCase(),") Change Store pending commit: ").concat(r," (app loaded ").concat(this.loadedAgo,"s ago)"),{graphId:e.graphId,noteId:e.noteId})}}addPendingUpdates(t){let{note:e,forceSave:n,...r}=t,a=r.updates.length>0?[i.pU.mergeUpdates(r.updates)]:[],s=i.pU.mergeUpdates(a);if(!(0,o.Q)(s,e.assertYDoc)&&!n)return;let l=this.getPendingCommit(e);if(l)l.addUpdates(a);else{var d;let t=e.removePlaceholderCommit(),n=null!==(d=null==t?void 0:t.yjsUpdatesArrays)&&void 0!==d?d:[];l=(0,c.Q)({updates:[...n,...a]}),this.setPendingCommit(e,l)}return n&&l.setForceSave(n),l}setPendingUpdates(t){var e;let{note:n,updates:r}=t,i=this.getPendingCommit(n),a=null!==(e=null==i?void 0:i.forceSave)&&void 0!==e&&e;if(r.length>0){let t=(0,c.Q)({updates:r,forceSave:a});return this.setPendingCommit(n,t),t}if(a){let t=(0,c.Q)({updates:[],forceSave:a});this.setPendingCommit(n,t)}else this.clearPendingCommit(n);this.logger.info("[ChangeStore] Consolidated to commits ".concat(this.shortCommitsDebug))}getPointer(t){return this.pendingCommits.find(e=>e.graphId===t.graphId&&e.noteId===t.id)}getPendingCommit(t){var e;return null===(e=this.getPointer(t))||void 0===e?void 0:e.commit}setPendingCommit(t,e){(0,s.hu)(t.graphId,"Note must have graphId");let n=this.getPointer(t);if(n)return n.setCommit(e),n;{let n=new d({graphId:t.graphId,noteId:t.id,commit:e});return this.pendingCommits.push(n),n}}clearPendingCommit(t){let e=this.getPointer(t);e&&(0,a.ogt)(e)}ensureCommit(t){let{note:e,forceSave:n}=t;this.addPendingUpdates({note:e,updates:[],forceSave:n})}async savePendingChanges(t){for(let e of this.pendingCommits){let{graphId:n,noteId:r}=e;if(n!==t.id)continue;let i=await t.noteStore.findById(e.noteId);if(!i){this.logger.warn("no note was found for pending commit ".concat(n,"/").concat(r),{graphId:n,noteId:r});continue}i.changeManager.handleReconnect()}}get shortCommitsDebug(){return"["+this.pendingCommits.map(t=>t.commit.yjsUpdates.length).join(", ")+"]"}get rootStore(){return(0,l.w0)(this)}get logger(){return this.rootStore.logger}get loadedAgo(){return Math.floor((new Date().getTime()-this.loadedAt.getTime())/1e3)}constructor(...t){super(...t),this.loadedAt=new Date}}(0,r.gn)([a.ZBq],u.prototype,"setPendingCommit",null),(0,r.gn)([a.ZBq],u.prototype,"clearPendingCommit",null),u=(0,r.gn)([(0,a.o4J)("ChangeStore")],u);var h=n(48757);n(64762)},64762:function(t,e,n){"use strict";n.d(e,{u:function(){return a}});var r=n(31223),i=n.n(r);class a{matchesDoc(t){return i()(this.docVector,t)}matchesUpdates(t){return this.updatesCount===t.length}constructor(t){this.docVector=t.docVector,this.updatesCount=t.updatesCount,this.ydoc=t.ydoc,this.doc=t.doc}}},48757:function(t,e,n){"use strict";n.d(e,{i:function(){return m}});var r=n(15767),i=n(75422),a=n(59592),o=n(25674),s=n.n(o),l=n(44838),c=n(86534),d=n(8711),u=n(63317),h=n(41200),p=n(15858),g=n(64762);class m extends(0,c.Hnr)({id:c.UB4,yjsUpdates:(0,c.vgT)(),forceSave:(0,c.vgT)(!1).withSetter()}){addUpdates(t){for(let e of t)this.yjsUpdates.push((0,a.kZ)(e))}get yjsUpdatesArrays(){return this.yjsUpdates.map(t=>(0,a._f)(t))}get shouldSave(){return this.yjsUpdates.length>0||this.forceSave}get isEmpty(){return 0===this.yjsUpdates.length}setIsPlaceholder(t){this.isPlaceholder=t}get debugString(){let t=this.yjsUpdatesArrays,e=t.map(t=>"".concat(t.length)).join(", "),n=this.isPlaceholder?"*":"";return"(".concat(t.length,") [").concat(e).concat(n,"]")}getPendingDoc(t){return this.getCache(t).doc}getPendingYDoc(t){return this.getCache(t).ydoc}getCache(t){if(!t.yDoc)throw new d.KL(t);let e=i.pU.encodeStateVector(t.yDoc),n=this.cachedResult,r=this.yjsUpdates.length;return n&&n.matchesDoc(e)?(n.matchesUpdates(this.yjsUpdatesArrays)||((0,u.Bu)(n.ydoc,this.yjsUpdatesArrays),n.updatesCount=this.yjsUpdatesArrays.length,n.doc=(0,i.x4)(n.ydoc)),n):this.createCache({note:t,docVector:e,updatesCount:r})}createCache(t){let{note:e,docVector:n,updatesCount:r}=t,a=this.createYDocCopy(e);(0,u.Bu)(a,this.yjsUpdatesArrays);let o=(0,i.x4)(a),s=new g.u({docVector:n,updatesCount:r,ydoc:a,doc:o});return this.cachedResult=s,s}createYDocCopy(t){let e=t.yDocAsUpdateArray;if(!e)throw new d.KL(t);let n=new i.pU.Doc;return i.pU.applyUpdate(n,e),n}consolidate(t){var e;let n=t.assertYDoc,r=i.pU.mergeUpdates(this.yjsUpdatesArrays),a=(0,u.Q)(r,n)?[r]:[];return null===(e=t.changeStore)||void 0===e||e.setPendingUpdates({note:t,updates:a}),a.length}encodeStateVector(){let t=s()(this.yjsUpdatesArrays);return t?i.pU.encodeStateVectorFromUpdate(t):null}async backup(t){let{note:e}=t,n=e.assertGraph,r=n.commitBackupStore;if(console.log("[YjsPendingCommit] Backing up pending commit!"),0===this.yjsUpdates.length){console.warn("[YjsPendingCommit] Backup: no steps");return}let i=this.getPendingDoc(e),a=(0,h.O)();await r.table.insert({id:a,graphId:n.id,noteId:e.id,documentJson:i?JSON.stringify(i):null,platform:(0,p.ob)(),createdAt:Date.now(),updatedAt:Date.now()}),await r.save(a)}constructor(...t){super(...t),this.isPlaceholder=!1}}(0,r.gn)([c.ZBq],m.prototype,"addUpdates",null),(0,r.gn)([l.computed],m.prototype,"yjsUpdatesArrays",null),(0,r.gn)([l.computed],m.prototype,"debugString",null),m=(0,r.gn)([(0,c.o4J)("PendingCommit")],m)},94666:function(t,e,n){"use strict";n.d(e,{k:function(){return er}});var r=n(15767),i=n(4363),a=n.n(i),o=n(44838),s=n(86534),l=n(8680),c=n(24669),d=n.n(c),u=n(86655);async function h(t){let{graphId:e}=t;return(await p())[e]}async function p(){let t=(await u.j.keys()).filter(t=>t.startsWith("graph-store")),e={};for(let r of t){let t=await u.j.getItem(r),i=t?JSON.parse(t):null;if(d()(null==i?void 0:i.graphs))for(let t of i.graphs){var n;let r=null!==(n=t.$modelId)&&void 0!==n?n:t.id;r&&t.encryptionKey&&(e[r]=t.encryptionKey)}}return e}var g=n(82020),m=n(7947),y=n(44225),f=n(9544),v=n(62298),w=n(99490),b=n(6046),S=n(53414),k=n(41255),I=n.n(k),N=n(60065),x=n(77956);async function T(t){let{graphId:e,tags:n,batchSize:r=500}=t;for(let t of I()(n,r)){let n=x.RZ.writeBatch(N.db);for(let r of t){let t=(0,b.kb)({db:N.db,graphId:e,tag:r});n.set(t,{created_at:S.Timestamp.now()},{merge:!0})}await n.commit()}}var D=n(44719);n(25674);var A=n(6885),C=n(70551);async function _(t){let{graph:e}=t;for(let t of(await (0,A.c)(e))){if("string"!=typeof t.createdAt&&"string"!=typeof t.updatedAt&&"string"!=typeof t.editedAt)continue;console.log("[migrate-001] Migrating note",t);let n=function(t){let e={...t};return"string"==typeof t.createdAt&&(e.createdAt=new Date(t.createdAt).getTime()),"string"==typeof t.editedAt&&(e.editedAt=new Date(t.editedAt).getTime()),e.updatedAt=new Date().getTime(),e}(t),r=new l.jC({...n,id:n.$modelId||n.id});await (0,C.h)(e,r)}}async function M(t){let{graph:e}=t;console.log("[migrate-002] noop")}var E=n(75422);async function F(t){let{graph:e}=t;for(let t of(await (0,A.c)(e))){var n,r;t.document&&((null!==(r=null===(n=t.document.attrs)||void 0===n?void 0:n.version)&&void 0!==r?r:0)>2||await U(e,t))}}async function U(t,e){console.log("[migrate-003] Migrating note",e);let n=function(t){let e={...t};if(e.document=t.document?(0,E.$b)(t.document):(0,l.Tw)().toJSON(),e.updatedAt=new Date().getTime(),!e.document)throw Error("003-migration issue - blank document");return e}(e),r=new l.jC({...n,id:n.$modelId||n.id});await (0,C.h)(t,r)}var B=n(59592),R=n(39833),j=n(53967),P=n(30059),O=n(18786);async function L(t){let{graph:e,notes:n,batchSize:r=500,progress:i}=t;null==i||i.setTotal(n.length);let a=await K(e,n);for(let t of I()(a,r)){let n=x.RZ.writeBatch(N.db);for(let r of t){let t=(0,b.lB)({db:N.db,graphId:e.id,noteId:r.id});n.set(t,r.data,{merge:!0})}await n.commit(),null==i||i.increment(t.length)}}async function K(t,e){return await Promise.all(e.map(e=>G(t,e)))}async function G(t,e){let n=await q(function(t){let{lastCommitId:e,...n}=t.createSnapshot();return n}(e),{encrypt:!!t.encryptionKey&&!e.public,itemId:e.id,key:t.encryptionKey});return{id:e.id,data:n}}async function q(t,e){var n,r,i,a,o,s;let l={id:t.id,version:4,acl:t.acl,created_at:(0,O.Mp)(t.createdAt),updated_at:(0,O.Mp)(t.updatedAt),edited_at:(0,O.Mp)(null!==(n=t.editedAt)&&void 0!==n?n:null),deleted_at:(0,O.Mp)(t.deletedAt),backlinked_count:t.backlinkedCount,daily:t.daily,ignored_backlink_from_note_ids:t.ignoredBacklinkFromNoteIds,ignored_backlink_labels:await (0,P.FS)(null!==(r=t.ignoredBacklinkLabels)&&void 0!==r?r:[],e),ignored_contact_names:await (0,P.FS)(null!==(i=t.ignoredContactNames)&&void 0!==i?i:[],e),pinned_index:null!==(a=t.pinnedIndex)&&void 0!==a?a:null,system_metadata:null!==(o=t.systemMetadata)&&void 0!==o?o:null,subject:await (0,P.Wu)(null!==(s=t.subject)&&void 0!==s?s:"",e),document_json:t.yDocAsUpdate?null:await (0,P.ec)(t.document,e)};return t.yDocAsUpdate&&(l.yjs_doc=await function(t,e){(0,R.hu)(t,"yDocAsUpdate is required");let n=(0,B._f)(t);return(0,j.RY)({plain:n,...e})}(t.yDocAsUpdate,e)),l}async function Z(t){let{graph:e,progress:n}=t;if(await H({graph:e})){let{noteStore:t}=e;console.log("[migrate-004] Re-saving notes");let r=await t.adapter.fetch(t.undeletedNotesQuery);await L({graph:e,notes:r,progress:n})}}async function H(t){let{graph:e}=t;try{await (0,A.c)(e)}catch(t){return!0}return!1}async function J(){}async function Q(){}async function Y(){}async function z(t){let{progress:e,graph:n}=t,{noteStore:r}=n;await (0,o.when)(()=>r.syncDown.hasSynced);let i=await r.adapter.fetch(r.undeletedNotesQuery);for(let t of i){var a,s,l;if("number"==typeof t.lastCommitId){console.warn("[migrate-008] Skipping document migration for note with lastCommitId",t.id);continue}let e=null!==(l=null===(s=t.document)||void 0===s?void 0:null===(a=s.attrs)||void 0===a?void 0:a.version)&&void 0!==l?l:0;t.document&&e!==E.KZ&&t.setDocument((0,E.$b)(t.document))}await L({graph:n,notes:i,progress:e,batchSize:100})}var V=n(63317),W=n(18612),$=n(75087),X=n(71157);async function tt(t){let{graph:e,progress:n}=t;e.logger.info("[009-yjs] Migrating server..."),await te({graph:e,progress:n})}async function te(t){let{graph:e,progress:n}=t,{noteStore:r,logger:i}=e;await tn(r);let a=await r.adapter.fetch(r.undeletedNotesQuery),o=a.filter(t=>t.document),s=a.filter(t=>!t.document);s.length>0&&(0,X.uT)("[009-yjs] Found notes with missing document",{extra:{notes:s.map(t=>{var e;return{id:t.id,deletedAt:t.deletedAt,subjectLength:null===(e=t.subject)||void 0===e?void 0:e.length}})}}),function(t,e){for(let n of(t=t.filter(t=>!t.yDocAsUpdate),e.info("Found ".concat(t.length," notes without YJS"),{migration:9}),t))(function(t,e){if(t.yDocAsUpdate)throw Error("Note already converted to YJS");try{let{ydoc:e}=(0,V.kg)(t.assertDocument,{template:!0}),n=E.pU.encodeStateAsUpdate(e);t.setYDocAsUpdateArray(n)}catch(n){e.error("Couldn't initialize YJS document: ".concat(n),{noteId:t.id}),(0,X.Tb)(n,{extra:{noteId:t.id,doc:(0,$.wk)(t.assertDocument)}})}})(n,e)}(o,i);let l=o.filter(t=>!1!==t.persisted);await (0,C.g)({graph:e,notes:l,batchSize:100,progress:n,createInitialCommit:!1}),await (0,W.Z)(300)}async function tn(t){await (0,o.when)(()=>t.syncDown.hasSynced)}async function tr(t){t.graph.logger.info("[010-yjs-prepare] Migrating server...",{migration:10}),await ti(t)}async function ti(t){let{graph:e}=t;e.logger.info("[010-yjs-prepare] Preparing...",{migration:10});let{changeStore:n}=e.assertRootStore;await n.savePendingChanges(e)}async function ta(t){t.graph.logger.info("[011-migrate-pinned] Migrating server...",{migration:11});let e=x.RZ.doc(N.db,"graphs",t.graph.id),n=x.RZ.collection(e,"notes").withConverter((0,b.sh)()),r=x.RZ.query(n,x.RZ.where("pinned","==",!0)),{docs:i}=await x.RZ.getDocsFromServer(r);for(let[t,e]of i.entries())await x.RZ.updateDoc(e.ref,{pinned_index:t,updated_at:S.Timestamp.now()})}var to=n(36556),ts=n(84769);async function tl(t){let{graph:e}=t;e.logger.info("[012-migrate-templates] Migrating server...",{migration:11});let n=await (0,to.i1)(),r=x.RZ.collection(N.db,"users",n.uid,"templates").withConverter((0,b.sh)()),{docs:i}=await x.RZ.getDocsFromServer(r);for(let t of i.map(t=>new l.YS({name:t.data().name,document:JSON.parse(t.data().document),createdAt:t.data().created_at.toMillis()})))await (0,ts.zX)(e,t);for(let t of i)await x.RZ.deleteDoc(t.ref)}var tc=n(98454);async function td(t){let{graph:e,progress:n}=t,r=e.logger.child({migration:13});r.info("[013-ensure-yjs] Migrating server...");let i=(0,b.J4)({db:N.db,graphId:e.id});for(let t of(await x.RZ.getDocsFromServer(i)).docs){let n=t.id,i=t.data();"document_json"in i&&!i.yjs_doc&&i.document_json&&(r.info("Fixing note ".concat(n)),await tu(n,i,e,r))}await e.noteStore.lastSyncManager.setLastSync(null),null==n||n.setProgress({total:1,finished:1})}async function tu(t,e,n,r){let i;let{noteStore:a}=n,o=(0,b.J4)({db:N.db,graphId:n.id}),l=await th(t,e,n);if(!l){(0,tc.uT)("[013-ensure-ydoc] Failed decrypting document",{extra:{noteId:t}});return}try{i=await tp(t,l,n)}catch(e){(0,tc.Tb)(e,{extra:{migration:13,noteId:t}}),r.error("Failed converting note ".concat(t," to YJS: ").concat(e));return}let c=x.RZ.doc(o,t);await x.RZ.setDoc(c,{yjs_doc:i},{merge:!0});let d=await a.findById(t);d&&(0,s.ogt)(d)}async function th(t,e,n){let r={key:n.encryptionKey,itemId:t},i=await (0,j.MJ)({type:"Note",value:e.document_json,...r});return i?JSON.parse(i):void 0}async function tp(t,e,n){let{ydoc:r}=(0,V.kg)(e,{template:!0}),i=E.pU.encodeStateAsUpdate(r),a=(0,B.kZ)(i);return await function(t,e){(0,R.hu)(t,"yDocAsUpdate is required");let n=(0,B._f)(t);return(0,j.RY)({plain:n,...e})}(a,{encrypt:!0,itemId:t,key:n.encryptionKey})}async function tg(){}var tm=n(48901);function ty(){return[{version:1,run:_},{version:2,run:M},{version:3,run:F},{version:4,run:Z},{version:5,run:J},{version:6,run:Q},{version:7,run:Y},{version:8,run:z},{version:9,run:tt},{version:10,run:tr},{version:11,run:ta},{version:12,run:tl},{version:13,run:td},{version:14,run:tg},{version:15,run:tm.Z}]}function tf(){return Math.max(...ty().map(t=>t.version))}function tv(t){var e;let n=t.version;if(!t.ready)throw Error("migrations can only be applied to a graph that is ready");if(null===n)throw Error("Graph ".concat(t.id," has no version"));return(function(t){let e=ty(),n=[];for(let r of e){if(r.requiredFlag&&!t.includes(r.requiredFlag))break;n.push(r)}return n})(null!==(e=t.flags)&&void 0!==e?e:[]).filter(t=>t.version>n)}function tw(t){return null!==t.version&&tv(t).length>0}var tb=n(7480),tS=n(18453),tk=n(18734),tI=n(38542);async function tN(t,e){let{extractText:r}=await Promise.all([n.e(5724),n.e(2705)]).then(n.bind(n,15136));return await r(t,e)}var tx=n(91523),tT=n(17234),tD=n(15858),tA=n(46582),tC=n(88957);class t_ extends(0,s.Hnr)({},{toSnapshotProcessor:t=>{let{}=t;return{}}}){onAttachedToRootStore(){return(0,o.makeObservable)(this),this.attachTable(),this.observeNoteChanges(),()=>{this.detach()}}attachTable(){let t=this.assertGraph;this._context=new tT.p({name:"assets",lastSyncContext:t.id,scope:[{key:"graphId",operator:"==",value:t.id}],syncDown:{collectionRef:()=>(0,b.rp)({db:N.db,graphId:t.id}),convertDown:(0,tA.zu)(t)},syncUp:{docRef:e=>(0,b.Z6)({db:N.db,graphId:t.id,assetId:e.id}),convertUp:(0,tA.w1)(t),allowCreate:!0,debounce:this.syncUpDebounce}}),this.listeners.push(()=>{this.table.detach()}),this.setIsSetup(!0),this.attachSync()}async attachSync(){if(await (0,o.when)(()=>this.assertGraph.readyToInitStores),this.isDetached)return}detach(){this.isDetached=!0,this.enqueueExtractionTask.clearQueue(),(0,g.$)(this.listeners)}setIsSetup(t){this.isSetup=t}async findById(t){return await this.table.get(t)}async findByNoteIds(t){let e=this.table.query().selectAll().where(e=>{let n=t.map(t=>(0,tx.$M)(e,"noteIds",t));return e.or(n)});return await this.table.fetch(e)}async createAsset(t){let e=new Date().getTime(),n={id:t.id,graphId:this.assertGraph.id,text:"",isExtracted:0,noteIds:JSON.stringify(t.noteIds),createdAt:e,updatedAt:e};return await this.table.insertMany([n]),await this.syncUp.save(n.id),(0,tk.j)("asset_created"),n}async ensureAsset(t){let e=await this.findById(t.id);if(e){let n=(0,tA.hH)(e.noteIds),r=a()([...n,t.noteId]);return e.noteIds=JSON.stringify(r),await this.updateAsset(e),e}return await this.createAsset({id:t.id,noteIds:[t.noteId]})}observeNoteChanges(){if(this.isDetached)return;let t=this.noteTable;this.listeners.push(t.hooks.on("after","create",async t=>{await this.processNoteRows(t)}),t.hooks.on("after","update",async t=>{let e=t.map(t=>t.id);await this.processNoteRowsByIds(e)}))}async processNoteRowsByIds(t){let e=await this.noteTable.getMany(t);await this.processNoteRows(e)}async processNoteRows(t){for(let e of t)await this.processNoteRow(e)}async processNoteRow(t){var e;let n=null===(e=(0,tS.wL)(t.document))||void 0===e?void 0:e.data;if(n)for(let e of(0,tC.Ec)(n))await this.processAssetLink(e,t.id)}async processAssetLink(t,e){let n=(0,tC.lw)(t);if(!n||this.pendingExtractionLinks.has(t))return;let r=await this.findById(n);!((null==r?void 0:r.isExtracted)===1||this.pendingExtractionLinks.has(t))&&(this.pendingExtractionLinks.add(t),this.assertGraph.textExtractionEnabled&&(0,tD.ob)()!==tD.t4.Mobile&&this.enqueueExtractionTask(async()=>{await this.extractText({assetId:n,assetLink:t,noteId:e}),this.pendingExtractionLinks.delete(t)}))}async extractText(t){let e=await this.ensureAsset({id:t.assetId,noteId:t.noteId}),n=await tI.I.get(t.assetLink);n&&(e.text=await tN(t.assetId,n.blob),e.isExtracted=1,await this.updateAsset(e))}async updateAsset(t){return t.updatedAt=new Date().getTime(),await this.table.update(t.id,t),await this.syncUp.save(t.id),t}get rootStore(){return(0,s.k0l)(this)}get assertRootStore(){return(0,f.wi)(this,"rootStore")}get graph(){return(0,s.G_R)(this)}get assertGraph(){return(0,f.wi)(this,"graph")}get assertNoteStore(){return this.assertGraph.noteStore}get noteTable(){return this.assertNoteStore.table}get context(){return(0,f.wi)(this,"_context")}get syncUp(){let t=this.context.syncUp;return(0,R.hu)(t,"TableContext is missing syncUp"),t}get syncDown(){let t=this.context.syncDown;return(0,R.hu)(t,"TableContext is missing syncDown"),t}get table(){return this.context.table}constructor(...t){super(...t),this.isDetached=!1,this.isSetup=!1,this.listeners=[],this.syncUpDebounce=5e3,this.pendingExtractionLinks=new Set,this.enqueueExtractionTask=(0,tb.Z)(1)}}(0,r.gn)([o.observable],t_.prototype,"isSetup",void 0),(0,r.gn)([o.action],t_.prototype,"setIsSetup",null),(0,r.gn)([s.ZBq],t_.prototype,"createAsset",null),t_=(0,r.gn)([(0,s.o4J)("AssetStore")],t_);var tM=n(2600),tE=n.n(tM),tF=n(20282),tU=n(36076),tB=n(12774),tR=n(15969),tj=n(94523);function tP(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:5e3;return new Promise(e=>{(0,tj.Kk)(e,{timeout:t})})}async function tO(t){if(await tq()||0===await t.table.getCount())return;let e=await t.noteTable.getCount(),n=Date.now();tH("Starting backlink verification for ".concat(e," notes"));let r=await tL(t,e);tH("Verifying ".concat(r.length," backlinks..."));let i=I()(r,500),a=0,o=[];for(let e of i){await tP();let n=new Set(e.map(t=>t.toNoteId)),r=new Set(await t.noteTable.hasIds([...n]));a+=(e=e.filter(t=>r.has(t.toNoteId))).length;let i=e.map(tK),s=new Set((await t.table.fetch(t.table.query().where("fromNoteId","in",(0,tx.pP)(e.map(t=>t.fromNoteId))).where("toNoteId","in",(0,tx.pP)(e.map(t=>t.toNoteId))))).map(tK)),l=i.filter(t=>!s.has(t));o.push(...l)}let s=Date.now()-n;if(tH("Backlink verification completed in ".concat((s/1e3).toFixed(1),"s. Checked ").concat(a," valid backlinks out of ").concat(r.length," total backlinks and found ").concat(o.length," missing.")),o.length>5){let e=o.map(tG);(0,X.uT)("Missing backlinks detected during verification",{level:"warning",extra:{missingBacklinkCount:o.length,missingBacklinks:e.map(t=>({fromNoteId:t.fromNoteId,toNoteId:t.toNoteId}))}}),tZ(t)}}async function tL(t,e){tH("Collecting expected backlinks...");let n=[],r=Math.ceil(e/500),i=t.noteTable.query().orderBy("id");for(let e=0;e<r;e++){await tP();let r=500*e,a=await t.noteTable.fetch(i.limit(500).offset(r)),o=t.backlinksFromNotes(a);n.push(...o)}return n}function tK(t){return JSON.stringify({fromNoteId:t.fromNoteId,toNoteId:t.toNoteId,contextHtml:t.contextHtml})}function tG(t){return JSON.parse(t)}async function tq(){let t="last-backlink-verification",e=await u.j.getItem(t),n=e?Number.parseInt(e,10):0;return Date.now()-n<432e5||(await u.j.setItem(t,Date.now().toString()),!1)}async function tZ(t){let e=t.table,n=t.noteTable;await e.deleteAll();let r=Math.ceil(await n.getCount()/500),i=n.query().orderBy("id");for(let a=0;a<r;a++){let r=500*a,o=await n.fetch(i.limit(500).offset(r)),s=t.backlinksFromNotes(o);await e.insertMany(s)}}function tH(t){console.log("%c[backlinks-verify] ".concat(t),"color: #4CAF50; font-weight: bold")}class tJ extends(0,s.Hnr)({}){onAttachedToRootStore(){return this.attach(),this.beforeDetach.bind(this)}attach(){this._table=new tU._({name:"noteBacklinks",scope:[{key:"graphId",operator:"==",value:this.graphId}]}),this.observeCommitChanges(),this.observeNoteChanges(),this.setIsSetup(!0),(0,tD.ob)()!==tD.t4.Mobile&&tO(this)}async beforeDetach(){this.isDetached=!0,await (0,g.$)(this.listeners)}observeCommitChanges(){this.changesObserver=new tB.Z({graphId:this.graphId,changeStore:this.changeStore,onChange:this.handleCommitsChanged.bind(this),debounce:1e3}),this.listeners.push(()=>{var t;return null===(t=this.changesObserver)||void 0===t?void 0:t.dispose()})}observeNoteChanges(){let t=this.noteTable;this.listeners.push(t.hooks.on("after","create",async t=>{await this.handleNotesCreated(t)}),t.hooks.on("after","update",async t=>{await this.handleNotesUpdated(t)}),t.hooks.on("after","delete",async t=>{await this.handleNotesDeleted(t)}))}handleCommitsChanged(t){0!==t.length&&this.refreshForNoteIds(t)}async handleNotesCreated(t){0!==t.length&&(this.log("updating backlinks for created notes",t.length),await this.updateBacklinksForNotes(t))}async handleNotesUpdated(t){if(0===t.length)return;this.log("updating backlinks for updated notes",t.length);let e=t.filter(t=>!!t.changes.document).map(t=>t.id);await this.refreshForNoteIds(e)}async handleNotesDeleted(t){0!==t.length&&(this.log("deleting backlinks for deleted notes",t),await this.clearBacklinksForNoteIds(t))}async refreshForNoteIds(t){if(0===t.length)return;this.log("refreshing backlinks for updated notes",t);let e=await this.noteTable.getMany(t);await this.updateBacklinksForNotes(e)}async updateBacklinksForNotes(t){await this.updateTask(async()=>{await this.clearBacklinksForNotes(t);let e=this.backlinksFromNotes(t);await this.table.insertMany(e)})}async clearBacklinksForNotes(t){let e=t.map(t=>t.id);await this.clearBacklinksForNoteIds(e)}async clearBacklinksForNoteIds(t){let e=await this.backlinkIdsForNotes(t);await this.table.deleteMany(e)}async backlinkIdsForNotes(t){let e=this.table.query().where("fromNoteId","in",(0,tx.pP)(t)).clearSelect().select("id");return(await this.table.adapter.executeSelect(e)).map(t=>t.id)}backlinksFromNotes(t){let e=[];for(let n of t)for(let t of this.getBacklinksForNoteRow(n).map(t=>(0,tR.s)({graphId:this.graphId,backlink:t})))e.push(t);return e}getBacklinksForNoteRow(t){var e,n;let{node:r}=(0,tS.tE)(t,this.noteAdapter);if(!r)return[];let i=null!==(e=t.isDaily?t.dailyDate:null)&&void 0!==e?e:t.createdAt;return n={graphId:this.assertGraph.id,fromNoteId:t.id,fromNoteCreatedAt:i},(r?(0,E.rc)(r):[]).map(t=>({graphId:n.graphId,label:t.label,contextHtml:t.contextHtml,fromNoteId:n.fromNoteId,fromNoteCreatedAt:n.fromNoteCreatedAt,toNoteId:t.id}))}async getOutgoingBacklinkNoteIds(t){return(await this.getOutgoingBacklinks(t)).map(t=>t.toNoteId)}async getOutgoingBacklinks(t){let e=this.table.query().where("fromNoteId","==",t);return(await this.table.fetch(e)).map(t=>(0,tR.K)(t))}async getIncomingBacklinks(t){let e=this.createIncomingBacklinksQueryBuilder(t);return this.table.fetch(e)}async getIncomingBacklinkNoteIds(t){let e=this.createIncomingBacklinksQueryBuilder(t).clearSelect().select("fromNoteId");return(await this.table.adapter.executeSelect(e)).map(t=>t.fromNoteId)}createIncomingBacklinksQuery(t){let e=this.createIncomingBacklinksQueryBuilder(t);return new tF.y({table:this.table,query:e,afterFetch:t=>tE()(t,t=>[t.fromNoteId,t.toNoteId,t.contextHtml].join("-"))})}createIncomingBacklinksQueryBuilder(t){return this.table.query().selectAll().where("toNoteId","==",t).where("fromNoteId","!=",t).orderBy("fromNoteCreatedAt","desc")}setIsSetup(t){this.isSetup=t}get assertRootStore(){return(0,f.pE)(this)}get assertGraph(){return(0,f.w0)(this)}get graph(){return(0,s.G_R)(this)}get changeStore(){return this.assertRootStore.changeStore}get graphId(){return this.assertGraph.id}get assertNoteStore(){return this.assertGraph.noteStore}get noteTable(){return this.assertNoteStore.table}get noteAdapter(){return this.assertNoteStore.adapter}get table(){return(0,f.wi)(this,"_table")}get jobQueue(){return this.assertGraph.jobQueueStore.manager}log(t){for(var e=arguments.length,n=Array(e>1?e-1:0),r=1;r<e;r++)n[r-1]=arguments[r];console.log("%c[backlinks] %s","font-weight: bold; color: white; background: orange;",t,...n)}constructor(...t){super(...t),this.listeners=[],this.isSetup=!1,this.isDetached=!1,this.updateTask=(0,tb.Z)(1)}}async function tQ(t,e){let n={encrypt:!0,key:e.assertEncryptionKey,itemId:t.noteId},r=t.documentJson?JSON.parse(t.documentJson):null,i=await (0,P.ec)(r,n);return{id:t.id,created_at:(0,O.Mp)(t.createdAt),updated_at:(0,O.Mp)(t.updatedAt),document_json:i,platform:t.platform}}(0,r.gn)([o.observable],tJ.prototype,"isSetup",void 0),(0,r.gn)([o.action],tJ.prototype,"setIsSetup",null),tJ=(0,r.gn)([(0,s.o4J)("NoteBacklinkStore")],tJ);class tY extends(0,s.Hnr)({}){onAttachedToRootStore(){return this.attach(),()=>{this.detach()}}attach(){let t=this.assertGraph,e=t.id;this._context=new tT.p({name:"commitBackups",lastSyncContext:e,scope:[{key:"graphId",operator:"==",value:e}],syncUp:{docRef:t=>(0,b.yK)({db:N.db,graphId:e,noteId:t.noteId,backupId:t.id}),convertUp:e=>tQ(e,t)}}),this.context.attach()}detach(){var t;null===(t=this.context)||void 0===t||t.detach()}async save(t){await this.context.syncUp.save(t)}get context(){return(0,f.wi)(this,"_context")}get table(){return this.context.table}get graph(){return(0,s.G_R)(this)}get assertGraph(){return(0,f.wi)(this,"graph")}}async function tz(t,e){t.assertGraph.logger.info("Repairing outdated docs for ".concat(e.length," notes"));let n=t.adapter;if(!n){console.warn("No adapter found, skipping repair");return}let r=(await n.findByIds(e)).map(t=>t.changeManager.loadAndApplyCommits());await Promise.all(r)}tY=(0,r.gn)([(0,s.o4J)("CommitBackupStore")],tY);var tV=n(45113),tW=n(41200);class t${log(t,e){console.log("%c[JobQueueManager] ".concat(t),"color: #8a2be2",...e?[e]:[])}dispose(){this.isDisposed=!0}async prepare(){await this.restartUnfinishedJobs(),this.setIsReady(!0),this.requestFlush(5e3)}setIsReady(t){this.isReady=t}setIsFlushing(t){this.isFlushing=t}async restartUnfinishedJobs(){let t=[];await this.table.executeTransaction("restartUnfinishedJobs",async e=>(t=(await e.selectFrom("jobs").select(["id"]).where("contextId","=",this.contextId).where("status","=","running").execute()).map(t=>t.id),await e.updateTable("jobs").set({status:"pending",updatedAt:Date.now()}).where("id","in",(0,tx.pP)(t)).execute(),{changedIds:t}))}async insert(t){let{task:e,args:n,delay:r}=t;await (0,o.when)(()=>this.isReady),this.log("Inserting job:",{task:e,delay:r});let i=(0,tW.O)();await this.table.executeTransaction("insert",async t=>(await t.insertInto("jobs").values({id:i,task:e,args:JSON.stringify(n),contextId:this.contextId,scheduledAt:Date.now()+r,status:"pending",updatedAt:Date.now()}).execute(),{changedIds:[i]})),this.requestFlush(r)}async replace(t){let{task:e,getArgs:n,delay:r}=t;await (0,o.when)(()=>this.isReady),this.log("Setting job:",{task:e,delay:r});let i=null;await this.table.executeTransaction("replace",async t=>{let a=await t.selectFrom("jobs").selectAll().where("task","=",e).where("contextId","=",this.contextId).where("status","!=","running").executeTakeFirst(),o=n(a?JSON.parse(a.args):null);if(a)await t.updateTable("jobs").set({args:JSON.stringify(o),updatedAt:Date.now(),scheduledAt:Date.now()+r}).where("id","=",a.id).execute(),i=a.id;else{let n=(0,tW.O)();await t.insertInto("jobs").values({id:n,task:e,args:JSON.stringify(o),contextId:this.contextId,updatedAt:Date.now(),scheduledAt:Date.now()+r,status:"pending"}).execute(),i=n}return{changedIds:i?[i]:[]}}),this.requestFlush(r)}async requestFlush(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0;this.isDisposed||(await (0,W.Z)(t+100),await (0,o.when)(()=>!this.isFlushing),this.setIsFlushing(!0),await this.flush(),this.setIsFlushing(!1))}async flush(){var t;let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};if(this.isDisposed)return;let n=null!==(t=e.ignoreSchedule)&&void 0!==t&&t;for(this.log("Flushing jobs...");;){let t=await this.table.executeTransaction("flush",async t=>{let e=await t.selectFrom("jobs").selectAll().where("contextId","=",this.contextId).where("scheduledAt","<=",n?Number.MAX_SAFE_INTEGER:Date.now()).where("status","=","pending").limit(1).executeTakeFirst();return e?(await t.updateTable("jobs").set({status:"running",updatedAt:Date.now()}).where("id","=",e.id).execute(),{result:e,changedIds:[e.id]}):{result:null,changedIds:[]}});if(!t)break;try{this.log("Processing job:",t),await this.execute(t.task,JSON.parse(t.args))}catch(t){console.error("[JobQueueManager] Error processing job:",t),(0,X.Tb)(t)}finally{await this.adapter.executeDelete(this.adapter.db.deleteFrom("jobs").where("id","=",t.id)),this.table.events.change([t.id])}}}constructor(t){this.isDisposed=!1,this.isReady=!1,this.isFlushing=!1,(0,o.makeObservable)(this),this.adapter=t.adapter,this.contextId=t.contextId,this.execute=t.execute,this.table=new tU._({name:"jobs"}),this.prepare()}}(0,r.gn)([o.observable],t$.prototype,"isReady",void 0),(0,r.gn)([o.observable],t$.prototype,"isFlushing",void 0),(0,r.gn)([o.action],t$.prototype,"setIsReady",null),(0,r.gn)([o.action],t$.prototype,"setIsFlushing",null);var tX=n(60288);class t0 extends(0,s.Hnr)({}){onAttachedToRootStore(){return this._manager=new t$({contextId:this.graph.id,adapter:tX.v,execute:(t,e)=>this.execute(t,e)}),()=>this.onBeforeDetach()}onBeforeDetach(){this.manager.dispose()}async execute(t,e){switch(console.log("[JobQueueStore] Executing job:",{task:t,args:e}),t){case"reindexSearch":await this.noteStore.searchStore.handleJobExecution(e);break;case"rewriteBacklinks":let{rewrites:n}=e;for(let t of n){let e=await this.noteStore.findById(t.noteId);if(!e){console.warn("note not found",{noteId:t.noteId});continue}await (0,tV.Px)(e,t.updatedSubject)}break;case"repairOutdatedDoc":let{noteIds:r}=e;await tz(this.noteStore,r)}}get manager(){return(0,f.wi)(this,"_manager")}get rootStore(){return(0,f.pE)(this)}get graph(){return(0,f.w0)(this)}get noteStore(){return this.graph.noteStore}}t0=(0,r.gn)([(0,s.o4J)("JobQueueStore")],t0);var t1=n(69776),t3=n(66657);class t4{setup(){this.listeners.push((0,o.autorun)(()=>{!this.hasTodaysBackup&&this.readyToBackup&&this.backupWhenIdle()}))}async dispose(){await (0,g.$)(this.listeners)}get readyToBackup(){let{ready:t,needsEncryptionSetup:e,noteStore:n}=this.graph;return t&&!e&&n.undeletedNotes.count>0}get hasTodaysBackup(){let{lastBackupAt:t}=this.graph;return t&&(0,t1.Z)(t)}async backup(){this.graph.setLastBackupAt(new Date),await (0,t3.hp)(this.graph)}backupWhenIdle(){(0,tj.ZP)(()=>{this.backup()})}constructor(t){this.listeners=[],this.graph=t,(0,o.makeObservable)(this),this.setup()}}(0,r.gn)([o.computed],t4.prototype,"readyToBackup",null),(0,r.gn)([o.computed],t4.prototype,"hasTodaysBackup",null);var t5=n(69549);class t6{setTotal(t){this.total=t,this.finished=0}setProgress(t){let{total:e,finished:n}=t;this.total=e,this.finished=n}increment(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1;this.finished+=t}reset(){this.total=0,this.finished=0}get progress(){return this.total>0?Math.min(this.finished/this.total,1):0}get isComplete(){return this.progress>=1}get percentFormatted(){return t2(this.progress)}constructor({total:t=0,finished:e=0}={}){this.total=t,this.finished=e,(0,o.makeObservable)(this)}}(0,r.gn)([o.observable],t6.prototype,"total",void 0),(0,r.gn)([o.observable],t6.prototype,"finished",void 0),(0,r.gn)([o.action],t6.prototype,"setTotal",null),(0,r.gn)([o.action],t6.prototype,"setProgress",null),(0,r.gn)([o.action],t6.prototype,"increment",null),(0,r.gn)([o.action],t6.prototype,"reset",null),(0,r.gn)([o.computed],t6.prototype,"progress",null),(0,r.gn)([o.computed],t6.prototype,"isComplete",null),(0,r.gn)([o.computed],t6.prototype,"percentFormatted",null);let t2=t=>""+Math.round(100*t);async function t8(t){let{graph:e,progress:n}=t,r=e.logger;r.info("Running migrations...");let i=await (0,v.E)(e.id);if(e.version!==i&&e.setVersion(i),i>=tf()){r.info("On latest version ".concat(i));return}for(let t of(await e.assertBackupManager.backup(),e.isEncrypted&&(0,R.Ee)(e.encryptionKey),tv(e)))r.info("Migrating to ".concat(t.version,"...")),await (0,v.h4)(e,t.version),await t.run({graph:e,progress:n}),r.info("Successfully migrated to ".concat(t.version,"...")),await (0,v.w$)({graph:e,version:t.version});r.info("Finished migrations")}class t7{async setup(){await (0,o.when)(()=>this.readyToMigrate),this.migrate()}dispose(){}get readyToMigrate(){return this.graph.ready&&!this.graph.versionUnsupported&&!this.graph.needsEncryptionSetup}async migrate(){let t=this.graph.logger,e=new t6,{graph:n}=this;if(tw(this.graph)){t.info("Starting migrations"),(0,tk.j)("migration_started",{graphId:this.graph.id,version:this.graph.version}),this.setMigrationProgress(e);try{await t8({graph:n,progress:e})}catch(t){if(t instanceof t5.fD){this.setMigrationStatus({type:"offline"}),this.graph.logger.warn("Migration can't run because the device is offline");return}throw this.handleMigrationFailure(t,n),t}this.setMigrationStatus(null)}}setMigrationProgress(t){this.migrationStatus={type:"running",progress:t}}setMigrationStatus(t){this.migrationStatus=t}handleMigrationFailure(t,e){this.setMigrationStatus({type:"failed"}),e.logger.error("Migration failed: ".concat(t)),(0,X.Tb)(t),(0,tk.j)("migration_failed",{graphId:e.id})}get migrating(){var t;return(null===(t=this.migrationStatus)||void 0===t?void 0:t.type)==="running"}get migrationProgress(){let t=this.migrationStatus;return(null==t?void 0:t.type)==="running"?t.progress:null}get migrationFailed(){var t;return(null===(t=this.migrationStatus)||void 0===t?void 0:t.type)==="failed"}get migrationOffline(){var t;return(null===(t=this.migrationStatus)||void 0===t?void 0:t.type)==="offline"}constructor(t){this.migrationStatus=null,this.graph=t,(0,o.makeObservable)(this),this.setup()}}(0,r.gn)([o.observable],t7.prototype,"migrationStatus",void 0),(0,r.gn)([o.computed],t7.prototype,"readyToMigrate",null),(0,r.gn)([o.action],t7.prototype,"setMigrationProgress",null),(0,r.gn)([o.action],t7.prototype,"setMigrationStatus",null);var t9=n(22052),et=n.n(t9),ee=n(28109);function en(){return et()(ee.b)}class er extends(0,s.Hnr)({id:s.UB4,name:(0,s.vgT)("").withSetter(),acl:(0,s.vgT)(()=>[]),tags:(0,s.vgT)(()=>[]).withSetter(),hasSetup:(0,s.vgT)(!0),encryptionKey:(0,s.vgT)(null),version:(0,s.vgT)(null).withSetter(),migratingVersion:(0,s.vgT)(null),ready:(0,s.vgT)(!1).withSetter(),flags:(0,s.vgT)(null).withSetter(),lastBackupAt:(0,s.vgT)(null).withTransform((0,s.h8)()).withSetter(),colorHex:(0,s.vgT)(en()).withSetter(),noteStore:(0,s.vgT)(()=>new l.Dj({})),commitBackupStore:(0,s.vgT)(()=>new tY({})),noteBacklinkStore:(0,s.vgT)(()=>new tJ({})),noteOperationStore:(0,s.vgT)(()=>new l.Jo({})),bookStore:(0,s.vgT)(()=>new l.ux({})),templateStore:(0,s.vgT)(()=>new l.j$({})),audioRecordingStore:(0,s.vgT)(()=>new l.xB({})),assetStore:(0,s.vgT)(()=>new t_({})),jobQueueStore:(0,s.vgT)(()=>new t0({}))}){onAttachedToRootStore(){return console.info("Attached graph to root store"),this.prepareMigrationManager(),this.prepareBackupManager(),this.prepareSetup(),this.observeSnapshot(),this.observeTags(),()=>this.beforeDetach()}prepareMigrationManager(){this.migrationManager=new t7(this),this.listeners.push(()=>{var t;return null===(t=this.migrationManager)||void 0===t?void 0:t.dispose()})}prepareBackupManager(){this.backupManager=new t4(this),this.listeners.push(()=>{var t;return null===(t=this.backupManager)||void 0===t?void 0:t.dispose()})}async prepareSetup(){await (0,o.when)(()=>this.readyToSetup),(0,w.Vz)(this)}observeSnapshot(){this.listeners.push((0,v.B6)(this.id,async t=>{await this.setGraph(t)}))}observeTags(){this.listeners.push(function(t,e){let n=(0,b.ql)({db:N.db,graphId:t});return x.RZ.onSnapshot(n,t=>{e(t.docs.map(t=>t.id))})}(this.id,t=>this.setTags(t)))}beforeDetach(){return(0,g.$)(this.listeners)}get needsEncryptionSetup(){return this.isEncrypted&&!this.encryptionKey}get logger(){var t;return D.k.child({graphId:this.id,userId:null===(t=this.user)||void 0===t?void 0:t.id})}get assertMigrationManager(){return(0,f.wi)(this,"migrationManager")}get assertBackupManager(){return(0,f.wi)(this,"backupManager")}get nameWithId(){return this.name===this.id?this.name:"".concat(this.name," (").concat(this.id,")")}aclCanRead(t){return!!t&&(this.aclCanWrite(t)||this.acl.includes("public")||this.acl.includes("read.".concat(t)))}aclCanWrite(t){return!!t&&(this.aclIsOwner(t)||this.acl.includes("write.".concat(t)))}aclIsOwner(t){return!!t&&this.acl.includes("owner.".concat(t))}hasFlag(t){var e;return(null!==(e=this.flags)&&void 0!==e?e:[]).includes(t)}get yjsDebug(){return this.hasFlag("yjs_debug")}get isInternalTeamMember(){return this.hasFlag("internal_team_member")||(0,m.yG)()}get user(){var t;return null===(t=this.rootStore)||void 0===t?void 0:t.currentUser}get rootStore(){return(0,s.k0l)(this)}get preferenceStore(){var t;return null===(t=this.rootStore)||void 0===t?void 0:t.preferenceStore}get jobQueue(){return this.jobQueueStore.manager}get assertRootStore(){return(0,f.wi)(this,"rootStore")}get assertAssetStore(){return(0,f.wi)(this,"assetStore")}get assertNoteStore(){return(0,f.wi)(this,"noteStore")}get assertUser(){return(0,f.wi)(this,"user")}get assertEncryptionKey(){if(!this.encryptionKey)throw Error("blank encryptionKey");return this.encryptionKey}get uid(){var t;return null===(t=this.user)||void 0===t?void 0:t.id}get assertUid(){let t=this.uid;if(!t)throw Error("blank uid");return t}get canRead(){return this.aclCanRead(this.uid)}get canWrite(){return this.aclCanWrite(this.uid)}get isOwner(){return this.aclIsOwner(this.uid)}get readyToSetup(){return!this.hasSetup&&this.readyToInitStores&&this.isOwner}matchTags(t){let e=t.replace(/^#/,"");return(e?(0,y.C)({items:this.tags,query:e,sort:!0}).map(t=>{let[e]=t;return this.tags[e]}):this.tags).map(t=>({label:t,id:t}))}deleteTag(t){this.tags=this.tags.filter(e=>e!==t),function(t,e){let n=(0,b.kb)({db:N.db,graphId:t,tag:e});x.RZ.deleteDoc(n)}(this.id,t)}updateColorHex(t){this.setColorHex(t),this.update()}update(){return(0,v.A9)(this)}findOrCreateTag(t){return this.tags.find(e=>e===t)||this.createTag(t)}async createTag(t){return this.tags=this.tags.includes(t)?this.tags:this.tags.concat([t]),await function(t,e){let n=(0,b.kb)({db:N.db,graphId:t,tag:e});return x.RZ.setDoc(n,{created_at:S.Timestamp.now()})}(this.id,t),t}async batchCreateTags(t){let e=new Set(this.tags),n=a()(t).filter(t=>!e.has(t));return this.tags=this.tags.concat(n),await T({graphId:this.id,tags:n}),n}onTagAdd(t){let e=(t.id||t.label).trim().toLowerCase().replace(/\s+/g,"-").substring(0,50);return this.createTag(e),{id:e,graphId:this.id,label:e}}setEncryptionKey(t){this.encryptionKey=t}async setGraph(t){var e,n;this.name=t.name,this.acl=t.acl,this.hasSetup=t.hasSetup,this.version=t.version,this.migratingVersion=t.migratingVersion,this.ready=t.ready,this.flags=null!==(e=t.flags)&&void 0!==e?e:[],this.colorHex=null!==(n=t.colorHex)&&void 0!==n?n:en(),this.encryptionKey||await this.attemptToRecoverEncryptionKey()}async attemptToRecoverEncryptionKey(){if(!this.isEncrypted||this.encryptionKey)return;let t=await h({graphId:this.id});t&&this.setEncryptionKey(t)}get readyToInitStores(){var t;return!(!this.ready||this.needsEncryptionSetup||(null===(t=this.migrationManager)||void 0===t?void 0:t.migrating)||tw(this))}get storesReadyAndNotesOnline(){return this.readyToInitStores&&this.noteStore.online}get versionUnsupported(){return null!==this.version&&this.version>tf()}get migratingElsewhere(){return null!==this.migratingVersion}constructor(...t){super(...t),this.listeners=[],this.isEncrypted=!0,this.realTimeTranscriptionEnabled=!0,this.textExtractionEnabled=!0}}(0,r.gn)([o.computed],er.prototype,"needsEncryptionSetup",null),(0,r.gn)([o.computed],er.prototype,"logger",null),(0,r.gn)([o.computed],er.prototype,"yjsDebug",null),(0,r.gn)([o.computed],er.prototype,"isInternalTeamMember",null),(0,r.gn)([o.computed],er.prototype,"user",null),(0,r.gn)([o.computed],er.prototype,"uid",null),(0,r.gn)([o.computed],er.prototype,"canRead",null),(0,r.gn)([o.computed],er.prototype,"canWrite",null),(0,r.gn)([o.computed],er.prototype,"isOwner",null),(0,r.gn)([o.computed],er.prototype,"readyToSetup",null),(0,r.gn)([s.ZBq],er.prototype,"deleteTag",null),(0,r.gn)([s.ZBq],er.prototype,"findOrCreateTag",null),(0,r.gn)([s.ZBq],er.prototype,"createTag",null),(0,r.gn)([s.ZBq],er.prototype,"batchCreateTags",null),(0,r.gn)([s.ZBq],er.prototype,"setEncryptionKey",null),(0,r.gn)([s.ZBq],er.prototype,"setGraph",null),(0,r.gn)([o.computed],er.prototype,"readyToInitStores",null),(0,r.gn)([o.computed],er.prototype,"storesReadyAndNotesOnline",null),(0,r.gn)([o.computed],er.prototype,"versionUnsupported",null),er=(0,r.gn)([(0,s.o4J)("Graph")],er)},46696:function(t,e,n){"use strict";n.d(e,{H:function(){return a}});var r=n(86534),i=n(94666);function a(t){return(0,r.oU$)(t,t=>t instanceof i.k)}},20991:function(t,e,n){"use strict";n.d(e,{B:function(){return o}});var r=n(15767),i=n(44838),a=n(86534);class o extends(0,a.Hnr)({location:(0,a.vgT)(()=>-1),stack:(0,a.vgT)(()=>[]),nextId:(0,a.vgT)(()=>0)}){get canGoForward(){return this.location<this.stack.length-1}get canGoBack(){return this.location>0}handleForwardBack(t){let{stackId:e}=t,{stack:n,location:r}=this,i=n[r];e<i&&this.location--,e>i&&this.location++}addToStack(t,e){let{stack:n,location:r,nextId:i}=this;if(i===n[r])return!1;history.pushState({...e,stackId:i},"",t),this.stack=this.stack.slice(0,r+1),this.stack.push(i),this.nextId++,this.location++}}(0,r.gn)([i.computed],o.prototype,"canGoForward",null),(0,r.gn)([i.computed],o.prototype,"canGoBack",null),(0,r.gn)([a.ZBq],o.prototype,"handleForwardBack",null),(0,r.gn)([a.ZBq],o.prototype,"addToStack",null),o=(0,r.gn)([(0,a.o4J)("History")],o)},8680:function(t,e,n){"use strict";n.d(e,{c4:function(){return n$.c4},A3:function(){return n$.A3},xB:function(){return g},ps:function(){return n$.ps},fy:function(){return w},ux:function(){return S},r8:function(){return Z},fc:function(){return j},hJ:function(){return V},lT:function(){return J},PM:function(){return tl},t6:function(){return nw.t6},kJ:function(){return tf.k},gH:function(){return ty},Pj:function(){return nk},mt:function(){return n$.mt},O9:function(){return n$.O9},Ag:function(){return tU},Z4:function(){return tv},BE:function(){return t_},jC:function(){return eW.j},Dj:function(){return eV},Jo:function(){return ny},_H:function(){return n$._H},UC:function(){return n$.UC},iv:function(){return k.iv},Vi:function(){return nb},Ob:function(){return nx},LD:function(){return n_},iD:function(){return eE},R0:function(){return n$.R0},YS:function(){return n1},j$:function(){return n3},zt:function(){return nw.zt},U6:function(){return rn},L8:function(){return nw.L8},GQ:function(){return eC.GQ},E9:function(){return nD},ct:function(){return e$.ct},Tw:function(){return e$.tk},Mr:function(){return e$.Mr},_F:function(){return e$._F},vm:function(){return eC.vm},II:function(){return eX.II},v_:function(){return nK},sx:function(){return nR},DV:function(){return nO},Fq:function(){return nB},xJ:function(){return nU},nB:function(){return nH},BG:function(){return nL},z:function(){return nZ},Pw:function(){return nY},bG:function(){return nP},EC:function(){return nG},dw:function(){return nE},GP:function(){return nW},Jf:function(){return nj},Ru:function(){return nJ},Xt:function(){return nq},Yh:function(){return nM},BO:function(){return nQ},dC:function(){return nV},B0:function(){return nz},LM:function(){return nF}});var r,i=n(15767),a=n(44838),o=n(86534);class s extends(0,o.Hnr)({id:o.UB4,status:(0,o.vgT)(),completedAt:(0,o.vgT)(),createdAt:(0,o.vgT)()}){get isProcessing(){return"pending"===this.status||"processing"===this.status}}(0,i.gn)([a.computed],s.prototype,"isProcessing",null),s=(0,i.gn)([(0,o.o4J)("AudioRecording")],s);var l=n(82020),c=n(9544),d=n(6046),u=n(60065),h=n(77956);function p(t){var e,n;let r=t.data();return new s({id:t.id,status:r.status,createdAt:r.created_at.toDate().getTime(),completedAt:null===(n=r.completed_at)||void 0===n?void 0:null===(e=n.toDate)||void 0===e?void 0:e.call(n).getTime()})}class g extends(0,o.Hnr)({audioRecordings:(0,o.vgT)(()=>[])},{toSnapshotProcessor:()=>({})}){get graph(){return(0,c.w0)(this)}get isProcessing(){return this.audioRecordings.some(t=>t.isProcessing)}get processingCount(){return this.audioRecordings.filter(t=>t.isProcessing).length}replaceAudioRecordings(t){this.audioRecordings=t}addSnapshotListener(){this.listeners.push(function(t,e){let n=(0,d.t1)({db:u.db,graphId:t.id});return h.RZ.onSnapshot(n,t=>{e(t.docs.map(p))})}(this.graph,t=>{this.replaceAudioRecordings(t)}))}onAttachedToRootStore(){return this.listeners.push((0,a.autorun)(t=>{this.graph.readyToInitStores&&(this.addSnapshotListener(),t.dispose())},{delay:2e3})),()=>this.beforeDetach()}beforeDetach(){return(0,l.$)(this.listeners)}constructor(...t){super(...t),this.listeners=[]}}(0,i.gn)([a.computed],g.prototype,"isProcessing",null),(0,i.gn)([a.computed],g.prototype,"processingCount",null),(0,i.gn)([o.ZBq],g.prototype,"replaceAudioRecordings",null),g=(0,i.gn)([(0,o.o4J)("AudioRecordingStore")],g);var m=n(65728),y=n(54879),f=n(18786);let v=m.ZP.object({value:m.ZP.string(),page:m.ZP.number().nullable(),location:m.ZP.number().nullable(),type:m.ZP.enum(["note","highlight"])});m.ZP.array(v);class w{get listingUrl(){var t;return t=this.asin,"https://www.amazon.com/gp/product/".concat(t)}matchIndex(t){let e=t.toLowerCase(),n=[this.title,this.authors.join(" ")].map(t=>null==t?void 0:t.toLowerCase()).filter(t=>t);for(let[t,r]of n.entries())if(null==r?void 0:r.includes(e))return n.length-t;return -1}static build(t){var e;return new w({id:t.id,asin:t.asin,authors:(e=t.authors,(0,y.c0)(e)),title:t.title,coverSrc:t.coverSrc})}constructor(t){var e;this.id=t.id,this.asin=t.asin,this.authors=t.authors,this.title=t.title,this.coverSrc=null!==(e=t.coverSrc)&&void 0!==e?e:null}}var b=n(17234);class S extends(0,o.Hnr)({enabled:(0,o.vgT)(!0)}){onAttachedToRootStore(){return this.attach(),()=>this.detach()}attach(){let t=this.graphId;this._context=new b.p({name:"books",lastSyncContext:t,scope:[{key:"graphId",operator:"==",value:t}],syncDown:{collectionRef:()=>(0,d.DB)({db:u.db,graphId:t}),convertDown:(e,n)=>(function(t){let{id:e,graphId:n,doc:r}=t;return{id:e,graphId:n,asin:r.asin,title:r.title,authors:JSON.stringify(r.authors),coverSrc:r.cover_src,notes:JSON.stringify(r.notes),createdAt:(0,f.av)(r.created_at),updatedAt:(0,f.av)(r.updated_at)}})({id:e,graphId:t,doc:n})}}),this.context.attach()}detach(){this.context.detach()}async findByAsin(t){if(!t)return null;let{table:e}=this.context,n=await e.find(e.query().where("asin","=",t));return n?w.build(n):null}get context(){return(0,c.wi)(this,"_context")}get assertGraph(){return(0,c.w0)(this)}get graphId(){return this.assertGraph.id}}S=(0,i.gn)([(0,o.o4J)("BookStore")],S),n(81055);var k=n(86708),I=n(14489),N=n(79633),x=n(84715),T=n.n(x),D=n(7665),A=n(91523);let C=m.ZP.object({value:m.ZP.string(),primary:m.ZP.boolean().nullable()}),_=m.ZP.object({value:m.ZP.string(),primary:m.ZP.boolean().nullable()}),M=m.ZP.array(C),E=m.ZP.array(_);function F(t,e){return{id:t,credentialId:e.credential_id,givenName:e.given_name,familyName:e.family_name,customName:e.custom_name,emailValues:(0,y.Mn)(e.email_values),emails:(0,y.Mn)(e.emails),primaryEmail:e.primary_email,phoneNumbers:(0,y.Mn)(e.phone_numbers),photoUrl:e.photo_url,sourceUpdatedAt:(0,f.av)(e.source_updated_at),updatedAt:(0,f.av)(e.updated_at)}}function U(){let t=(0,I._)(["lower(givenName || ' ' || familyName)"]);return U=function(){return t},t}function B(){let t=(0,I._)(["givenName || ' ' || familyName"]);return B=function(){return t},t}function R(){return(0,D.YO)()}class j extends(0,o.Hnr)({syncEnabled:(0,o.vgT)(!0),persistEnabled:(0,o.vgT)(!0)}){onAttachedToRootStore(){return this.context.attach(),()=>{this.context.detach()}}selectAll(){return this.table.query().selectAll()}get validContactsQuery(){return this.selectAll().where((0,A.En)("emails")).where(t=>t.or([t("customName","is not",null),t("givenName","is not",null),t("familyName","is not",null)]))}async find(t){let e=await this.table.get(t);return e?Z.build(e):null}async searchContacts(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:10,n=this.validContactsQuery.where((0,N.i)(U()),"like","%".concat(t.toLowerCase(),"%")).limit(e);return(await this.table.adapter.executeSelect(n)).map(t=>Z.build(t))}async findByName(t){if(!t)return null;let e=this.validContactsQuery.where(e=>e.or([e("customName","=",t),e((0,N.i)(B()),"=",t)])),n=await this.table.adapter.executeTakeFirst(e);return n?Z.build(n):null}async sampleContacts(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:10,e=this.validContactsQuery.limit(t);return(await this.table.adapter.executeSelect(e)).map(t=>Z.build(t))}async findByEmail(t){let e=this.selectAll().where((0,A.$F)("emailValues",t)),n=await this.table.adapter.executeSelect(e),r=(n=T()(n,t=>t.customName?[1,t.id]:t.givenName||t.familyName?[2,t.id]:[3,t.id]))[0];return r?Z.build(r):null}get table(){return this.context.table}constructor(...t){super(...t),this.context=new b.p({name:"contacts",syncDown:{collectionRef:R,convertDown:F}})}}j=(0,i.gn)([(0,o.o4J)("ContactStore")],j);var P=n(4363),O=n.n(P),L=n(41200),K=n(34736),G=n.n(K);function q(){return function(t,e,n){n.get?n.get=G()(n.get,function(){return this}):n.value=G()(n.value)}}class Z{get primaryEmail(){return this.emailValues[0]}get name(){return this.customName?this.customName:[this.givenName,this.familyName].filter(Boolean).join(" ")}get emailValues(){let t=this.emails.slice().sort((t,e)=>(t.primary?-1:1)-(e.primary?-1:1)).map(t=>{var e;return null===(e=t.value)||void 0===e?void 0:e.toLowerCase()});return O()(t)}get phoneNumberValues(){let t=this.phoneNumbers.slice().sort((t,e)=>(t.primary?-1:1)-(e.primary?-1:1)).map(t=>t.value);return O()(t)}get validName(){return/^[a-z]/i.test(this.name)}get isValid(){return this.validName&&this.emails.length>0}static build(t){var e,n,r,i,a,o,s,l;return new Z({id:t.id,givenName:null!==(e=t.givenName)&&void 0!==e?e:"",familyName:null!==(n=t.familyName)&&void 0!==n?n:"",customName:null!==(r=t.customName)&&void 0!==r?r:"",emails:null!==(i=(s=t.emails)?M.parse(JSON.parse(s)):null)&&void 0!==i?i:[],phoneNumbers:null!==(a=(l=t.phoneNumbers)?E.parse(JSON.parse(l)):null)&&void 0!==a?a:[],photoUrl:null!==(o=t.photoUrl)&&void 0!==o?o:void 0})}static buildFromParts(t){let{name:e,email:n}=t,[r,...i]=(e||"").split(" ");return new Z({givenName:r,familyName:i.join(" "),emails:n?[{value:n,primary:!0}]:[]})}constructor(t){var e,n,r,i,a;this.id=null!==(e=t.id)&&void 0!==e?e:(0,L.O)(),this.givenName=null!==(n=t.givenName)&&void 0!==n?n:"",this.familyName=null!==(r=t.familyName)&&void 0!==r?r:"",this.customName=t.customName,this.emails=null!==(i=t.emails)&&void 0!==i?i:[],this.phoneNumbers=null!==(a=t.phoneNumbers)&&void 0!==a?a:[],this.photoUrl=t.photoUrl}}(0,i.gn)([q()],Z.prototype,"name",null),(0,i.gn)([q()],Z.prototype,"emailValues",null),(0,i.gn)([q()],Z.prototype,"phoneNumberValues",null),(0,i.gn)([q()],Z.prototype,"validName",null),(0,i.gn)([q()],Z.prototype,"isValid",null);var H=n(87823);class J extends(0,o.Hnr)({credentials:(0,o.vgT)(()=>[])}){get hasCredentials(){return this.credentials.length>0}get googleCredentials(){return this.credentials.filter(t=>"google"===t.provider)}get microsoftCredentials(){return this.credentials.filter(t=>"microsoft"===t.provider)}setCredentials(t){this.credentials=t}onAttachedToRootStore(){let t=(0,H.p2)(t=>{this.setCredentials(t)});return async()=>(await t)()}}(0,i.gn)([a.computed],J.prototype,"hasCredentials",null),(0,i.gn)([a.computed],J.prototype,"googleCredentials",null),(0,i.gn)([a.computed],J.prototype,"microsoftCredentials",null),(0,i.gn)([o.ZBq],J.prototype,"setCredentials",null),J=(0,i.gn)([(0,o.o4J)("CredentialStore")],J);var Q=n(99613),Y=n.n(Q),z=n(52619);class V extends(0,o.Hnr)({id:o.UB4,provider:(0,o.vgT)(),email:(0,o.vgT)(),contactsCount:(0,o.vgT)(),calendars:(0,o.vgT)(()=>[]).withSetter(),status:(0,o.vgT)("connected"),errors:(0,o.vgT)(null).withSetter()}){get sortedCalendars(){return Y()(this.calendars,[t=>t.sortOrder,t=>t.name],["asc","asc"])}get enabledCalendars(){return this.sortedCalendars.filter(t=>t.enabled)}get errorMessage(){var t;let e=null===(t=this.errors)||void 0===t?void 0:t.filter(t=>t);return(null==e?void 0:e.length)?"It seems that we cannot connect to this third-party account. Please try to revoke it and re-connect it.\n\n"+e.join("\n"):null}async revoke(){await (0,H.bL)(this.id)}onAttachedToRootStore(){return this.listeners.push((0,z.mq)(this.id,t=>{this.setCalendars(t)})),()=>this.beforeDetach()}beforeDetach(){return(0,l.$)(this.listeners)}constructor(...t){super(...t),this.listeners=[]}}(0,i.gn)([a.computed],V.prototype,"sortedCalendars",null),(0,i.gn)([a.computed],V.prototype,"enabledCalendars",null),(0,i.gn)([a.computed],V.prototype,"errorMessage",null),V=(0,i.gn)([(0,o.o4J)("Credential")],V);var W=n(56025),$=n(88359),X=n(43012),tt=n(17322),te=n(43193),tn=n(82317),tr=n(88351),ti=n(24601),ta=n(53342),to=n(14630);class ts extends(0,o.Hnr)({}){setCursor(t,e){this.editorKey=null!=t?t:null,this.selection=e}updateCursor(t){if(t.editor){let e=t.editor.getSelectionPositions();this.setCursor(t.editorKey,e)}}getCursor(t){return this.editorKey===t?this.selection:null}constructor(...t){super(...t),this.editorKey=null,this.selection=null}}(0,i.gn)([a.observable],ts.prototype,"editorKey",void 0),(0,i.gn)([a.observable],ts.prototype,"selection",void 0),(0,i.gn)([a.action],ts.prototype,"setCursor",null),ts=(0,i.gn)([(0,o.o4J)("SelectionView")],ts);class tl extends(0,o.Hnr)({selectionView:(0,o.vgT)(()=>new ts({}))}){get rootStore(){return(0,o.k0l)(this)}get noteStore(){return(0,o.G_R)(this)}get assertDailyStore(){return this.assertNoteStore.dailyStore}get assertNoteStore(){return(0,c.w0)(this)}get mainView(){var t;return null===(t=this.rootStore)||void 0===t?void 0:t.mainView}get isEndAtMoreThanToday(){let t=(0,tt.Z)(new Date);return(0,X.Z)(t,this.endAt)}get selectedNote(){return this.selectedDate?this.findByDate(this.selectedDate):null}get searchEnabled(){return!!(this.searchQuery||this.searchNodeGuid)}getSelectionOption(t){var e,n;return null===(n=null!==(e=this.selectingEdge)&&void 0!==e?e:this.selectionView.getCursor(t))||void 0===n||n}get isActive(){var t;return(null===(t=this.mainView)||void 0===t?void 0:t.activeEditor)===this.role&&this.mainView.screen===tr.oK.NoteDaily}get selectedNoteIndex(){let t=this.selectedNote;return t?this.notes.indexOf(t):-1}get selectedNoteId(){return this.selectedDate?(0,ti.l5)(this.selectedDate):null}findById(t){var e;return null!==(e=this.notes.find(e=>e.id===t))&&void 0!==e?e:null}findByDate(t){var e;let n=(0,tt.Z)(t).getTime();return null!==(e=this.notes.find(t=>t.dailyAt===n))&&void 0!==e?e:null}isDateInRange(t){return(0,to.ZQ)(t,{startAt:this.startAt,endAt:this.endAt})}get range(){return{startAt:this.startAt,endAt:this.endAt}}setRange(t,e){this.startAt=t,this.endAt=e,this.assertDailyStore.updateGeneratedNotes(this.range)}setCursorDate(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:new Date,e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:10;this.setRange((0,tt.Z)((0,te.Z)(t,e)),(0,tt.Z)((0,W.Z)(t,e)))}setSelectingEdge(t){this.selectingEdge=t}setSelectingScroll(t){this.selectingScroll=t}clearSearch(){this.searchQuery="",this.searchNodeGuid=""}setSelectedDate(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},{scroll:n=!0,focus:r=!1,edge:i=null,searchQuery:a,searchNodeGuid:o}=e;this.selectedDate=t,this.selectingScroll=n,this.selectingEdge=i,null!=a&&(this.searchQuery=a),null!=o&&(this.searchNodeGuid=o),r&&this.requestForceFocus(),this.isDateInRange(t)||this.setCursorDate(t)}setSelectedNote(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},{scroll:n=!0,edge:r=null}=e;this.setSelectedDate(t.dailyOrCreatedDate,{scroll:n,edge:r})}requestForceFocus(){this.forceFocus=!0}resetForceFocus(){this.forceFocus=!1}get dailyNotesInRangeQuery(){let t=this.startAt.getTime(),e=this.endAt.getTime(),n=this.assertNoteStore.dailyNotesQuery.where(n=>n.and([n("dailyDate","is not",null),n("dailyDate",">=",t),n("dailyDate","<=",e)]));return this.assertNoteStore.adapter.query(n)}get dailyNotesInRange(){return this.dailyNotesInRangeQuery.placeholders.map(t=>t.value).filter(ta.Dw)}get hasFetchedDailyNotes(){return this.dailyNotesInRangeQuery.hasResolved}get notes(){return this.assertDailyStore.combine(this.dailyNotesInRange)}get todaysDailyId(){return(0,ti.l5)((0,tn.zO)())}selectToday(){this.setSelectedDate(new Date,{scroll:!0,focus:!0,edge:"end"})}prependNotes(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:15;this.setRange((0,te.Z)(this.startAt,t),this.endAt)}appendNotes(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:15;this.setRange(this.startAt,(0,W.Z)(this.endAt,t))}checkSelectedDateIsWithinBounds(){this.selectedDate&&!this.isDateInRange(this.selectedDate)&&this.setCursorDate(this.selectedDate)}get daysInRange(){return(0,$.Z)({start:this.startAt,end:this.endAt})}onAttachedToRootStore(){return this.setCursorDate(new Date),this.listeners.push((0,a.autorun)(()=>{this.checkSelectedDateIsWithinBounds()})),()=>this.beforeDetach()}beforeDetach(){return(0,l.$)(this.listeners)}constructor(...t){super(...t),this.role="primary",this.selectedDate=null,this.selectingEdge=null,this.searchQuery="",this.searchNodeGuid="",this.selectingScroll=!1,this.forceFocus=!1,this.startAt=new Date(Number.NaN),this.endAt=new Date(Number.NaN),this.listeners=[]}}(0,i.gn)([a.observable],tl.prototype,"selectedDate",void 0),(0,i.gn)([a.observable],tl.prototype,"selectingEdge",void 0),(0,i.gn)([a.observable],tl.prototype,"searchQuery",void 0),(0,i.gn)([a.observable],tl.prototype,"searchNodeGuid",void 0),(0,i.gn)([a.observable],tl.prototype,"selectingScroll",void 0),(0,i.gn)([a.observable],tl.prototype,"forceFocus",void 0),(0,i.gn)([a.observable],tl.prototype,"startAt",void 0),(0,i.gn)([a.observable],tl.prototype,"endAt",void 0),(0,i.gn)([a.computed],tl.prototype,"isEndAtMoreThanToday",null),(0,i.gn)([a.computed],tl.prototype,"selectedNote",null),(0,i.gn)([a.computed],tl.prototype,"isActive",null),(0,i.gn)([a.computed],tl.prototype,"selectedNoteIndex",null),(0,i.gn)([a.computed],tl.prototype,"selectedNoteId",null),(0,i.gn)([a.computed],tl.prototype,"range",null),(0,i.gn)([a.action],tl.prototype,"setRange",null),(0,i.gn)([a.action],tl.prototype,"setSelectingEdge",null),(0,i.gn)([a.action],tl.prototype,"setSelectingScroll",null),(0,i.gn)([a.action],tl.prototype,"clearSearch",null),(0,i.gn)([a.action],tl.prototype,"setSelectedDate",null),(0,i.gn)([a.action],tl.prototype,"requestForceFocus",null),(0,i.gn)([a.action],tl.prototype,"resetForceFocus",null),(0,i.gn)([a.computed],tl.prototype,"dailyNotesInRangeQuery",null),(0,i.gn)([a.computed],tl.prototype,"dailyNotesInRange",null),(0,i.gn)([a.computed],tl.prototype,"hasFetchedDailyNotes",null),(0,i.gn)([a.computed],tl.prototype,"notes",null),(0,i.gn)([a.action],tl.prototype,"checkSelectedDateIsWithinBounds",null),tl=(0,i.gn)([(0,o.o4J)("DailyEditorView")],tl);class tc extends(0,o.Hnr)({role:(0,o.vgT)(),selectionView:(0,o.vgT)(()=>new ts({}))}){get selectedNote(){let t=this.assertNoteStore.adapter;return this.selectedNoteId?t.placeholder(this.selectedNoteId):null}get hasSelectedNote(){return!!this.selectedNote}clearSearch(){this.searchQuery="",this.searchNodeGuid=""}get searchEnabled(){return!!(this.searchQuery||this.searchNodeGuid)}setSelectedNote(t){var e;let n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};this.setSelectedNoteId(null!==(e=null==t?void 0:t.id)&&void 0!==e?e:null,n)}setSelectedNoteId(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},{searchQuery:n="",searchNodeGuid:r=""}=e;this.selectedNoteId=t,this.searchQuery=n,this.searchNodeGuid=r}get noteStore(){return(0,o.G_R)(this)}get assertNoteStore(){if(!this.noteStore)throw Error("EditNoteStore must be used within a NoteStore");return this.noteStore}constructor(...t){super(...t),this.selectedNoteId=null,this.searchQuery="",this.searchNodeGuid=""}}(0,i.gn)([a.observable],tc.prototype,"selectedNoteId",void 0),(0,i.gn)([a.observable],tc.prototype,"searchQuery",void 0),(0,i.gn)([a.observable],tc.prototype,"searchNodeGuid",void 0),(0,i.gn)([a.computed],tc.prototype,"selectedNote",null),(0,i.gn)([a.action],tc.prototype,"clearSearch",null),(0,i.gn)([a.action],tc.prototype,"setSelectedNoteId",null),tc=(0,i.gn)([(0,o.o4J)("EditorView")],tc);var td=n(98454),tu=n(23949),th=n.n(tu),tp=n(90708);class tg extends tp.Uw{setUser(){}clearUser(){}setGraphId(){}}let tm=(0,tp.fo)("AuthSync",{web:new tg});class ty extends(0,o.Hnr)({currentGraphId:(0,o.vgT)(null),graphs:(0,o.vgT)(()=>[]),volatileGraphs:(0,o.vgT)(()=>[])},{toSnapshotProcessor:t=>{let{currentGraphId:e,graphs:n}=t;return{currentGraphId:e,graphs:n}}}){onAttachedToRootStore(){return this.listeners.push((0,a.reaction)(()=>{var t;return[this.readyUser,null===(t=this.readyUser)||void 0===t?void 0:t.graphIds]},this.handleUserChanged,{fireImmediately:!0}),(0,a.reaction)(()=>this.currentGraphId,this.handleCurrentGraphChanged,{fireImmediately:!0})),()=>this.beforeDetach()}beforeDetach(){return(0,l.$)(this.listeners)}get readyUser(){return this.userStore.readyUser}get allGraphs(){return this.graphs.concat(this.volatileGraphs)}get currentGraph(){return this.allGraphs.find(t=>t.id===this.currentGraphId)}get assertCurrentGraph(){let t=this.currentGraph;if(!t)throw Error("graph blank");return t}get ownedGraphs(){return this.allGraphs.filter(t=>t.isOwner)}findById(t){return this.allGraphs.find(e=>e.id===t)}setCurrentGraph(t){this.setCurrentGraphId(t.id)}setCurrentGraphId(t){this.currentGraphId=t}ensureGraphIds(t){t.forEach(t=>this.ensureGraphId(t))}ensureGraphId(t){this.graphs.find(e=>e.id===t)||(console.info("Loading graph:",t),this.graphs.push(new tf.k({id:t}))),this.volatileGraphs=this.volatileGraphs.filter(e=>e.id!==t)}ensureVolatileGraphId(t){this.findById(t)||(console.info("Loading volatile graph:",t),this.volatileGraphs.push(new tf.k({id:t})))}clearMissingGraphs(t){for(let e of this.graphs)t.includes(e.id)||(0,o.ogt)(e)}addGraph(t){let e=this.findById(t.id);e&&(0,o.ogt)(e),this.graphs.push(t)}get rootStore(){return(0,c.w0)(this)}get userStore(){return this.rootStore.userStore}constructor(...t){super(...t),this.listeners=[],this.handleCurrentGraphChanged=t=>{td.YA("graph_id",t),tm.setGraphId({graphId:this.currentGraphId})},this.handleUserChanged=()=>{let t=this.readyUser;if(!t||!t.graphIds)return;let e=t.graphIds;if(this.ensureGraphIds(e),this.clearMissingGraphs(e),this.currentGraphId&&!this.findById(this.currentGraphId)&&(this.currentGraphId=null),!this.currentGraphId&&this.graphs.length>0){var n;this.setCurrentGraphId(null!==(n=th()(e))&&void 0!==n?n:null)}}}}(0,i.gn)([o.ZBq],ty.prototype,"handleUserChanged",void 0),(0,i.gn)([a.computed],ty.prototype,"readyUser",null),(0,i.gn)([a.computed],ty.prototype,"allGraphs",null),(0,i.gn)([a.computed],ty.prototype,"currentGraph",null),(0,i.gn)([a.computed],ty.prototype,"ownedGraphs",null),(0,i.gn)([o.ZBq],ty.prototype,"setCurrentGraphId",null),(0,i.gn)([o.ZBq],ty.prototype,"ensureGraphId",null),(0,i.gn)([o.ZBq],ty.prototype,"ensureVolatileGraphId",null),(0,i.gn)([o.ZBq],ty.prototype,"clearMissingGraphs",null),(0,i.gn)([o.ZBq],ty.prototype,"addGraph",null),ty=(0,i.gn)([(0,o.o4J)("GraphStore")],ty);var tf=n(94666);n(88448);class tv{get isBlank(){return!this.email&&!this.name}get nameWithFallback(){return this.name||this.enrichedName||null}buildContact(){return Z.buildFromParts({email:this.email,name:this.nameWithFallback})}setName(t){this.name=t}setEmail(t){this.email=t}setEnrichment(t){var e,n;this.enrichedName=(null==t?void 0:null===(n=t.person)||void 0===n?void 0:null===(e=n.name)||void 0===e?void 0:e.fullName)||this.enrichedName||null}constructor({id:t,name:e=null,email:n=null,enrichedName:r=null}){this.id=null!=t?t:(0,L.O)(),this.name=e,this.email=n,this.enrichedName=r,(0,a.makeObservable)(this)}}(0,i.gn)([a.observable],tv.prototype,"id",void 0),(0,i.gn)([a.observable],tv.prototype,"name",void 0),(0,i.gn)([a.observable],tv.prototype,"email",void 0),(0,i.gn)([a.observable],tv.prototype,"enrichedName",void 0),(0,i.gn)([a.computed],tv.prototype,"isBlank",null),(0,i.gn)([a.computed],tv.prototype,"nameWithFallback",null),(0,i.gn)([a.action],tv.prototype,"setName",null),(0,i.gn)([a.action],tv.prototype,"setEmail",null),(0,i.gn)([a.action],tv.prototype,"setEnrichment",null);var tw=n(14321),tb=n(8207),tS=n.n(tb),tk=n(55343),tI=n(36556);async function tN(t){let{startAt:e,endAt:n,credentialId:r}=t,i=new URL("/api/meetings",location.href);return i.searchParams.append("start_at",e.toISOString()),i.searchParams.append("end_at",n.toISOString()),i.searchParams.append("credential_id",r),(await (0,tI.$Q)(i.href)).map(tx)}function tx(t){var e,n,r,i,a;let o=t.attendees.map(t=>new tv(t)),s=t.startAt?null===(e=(0,tk.Z)(t.startAt))||void 0===e?void 0:e.getTime():void 0,l=t.endAt?null===(n=(0,tk.Z)(t.endAt))||void 0===n?void 0:n.getTime():void 0;return new tU({name:null!==(r=t.name)&&void 0!==r?r:void 0,description:null!==(i=t.description)&&void 0!==i?i:void 0,startAt:s,endAt:l,recurring:null!==(a=t.recurring)&&void 0!==a&&a,attendees:o})}var tT=n(34281),tD=n(76722),tA=n(2125);let tC=t=>(0,tT.Z)(t,"yyyy-MM-dd");class t_ extends(0,o.Hnr)({}){meetingsForDay(t){let e=tC(t);return this.meetings.filter(t=>t.dayId===e).map(t=>t.meeting)}meetingsForDaySorted(t){return T()(this.meetingsForDay(t),t=>{var e;return t.startAtDate?(e=t.startAtDate,60*(0,tD.Z)(e)+(0,tA.Z)(e)):0})}async fetchAllMeetingsForDay(t){this.setStatus("loading");let e=this.credentialStore.credentials;try{await Promise.all(e.map(e=>this.fetchMeetingsForDay(e,t))),this.setStatus("success")}catch(t){console.error("Error fetching meetings",t),this.setStatus("error")}}async fetchMeetingsForDay(t,e){let n=t.id,r=(0,tt.Z)(e),i=(0,tw.Z)(e),a=await tN({startAt:r,endAt:i,credentialId:n});this.replaceMeetings({day:e,credentialId:n,meetings:a})}replaceMeetings(t){let{day:e,credentialId:n,meetings:r}=t,i=tC(e),a=tS()(this.meetings,t=>t.dayId===i&&t.credentialId===n),o=r.map(t=>({dayId:i,credentialId:n,meeting:t}));this.meetings=[...a,...o]}setStatus(t){this.status=t}get rootStore(){return(0,c.pE)(this)}get credentialStore(){return this.rootStore.credentialStore}constructor(...t){super(...t),this.status="success",this.meetings=[]}}(0,i.gn)([a.observable],t_.prototype,"status",void 0),(0,i.gn)([a.observable],t_.prototype,"meetings",void 0),(0,i.gn)([a.action],t_.prototype,"replaceMeetings",null),(0,i.gn)([a.action],t_.prototype,"setStatus",null),t_=(0,i.gn)([(0,o.o4J)("MeetingStore")],t_);var tM=n(25674),tE=n.n(tM),tF=n(18688);class tU{buildContacts(t){return this.getValidAttendees(t).map(t=>t.buildContact())}get startAtDate(){return this.startAt?new Date(this.startAt):void 0}formatStartAtTime(t){return this.startAtDate?(0,tF.mr)(this.startAtDate,null!=t?t:"12"):void 0}get endAtDate(){return this.endAt?new Date(this.endAt):void 0}get hasEmptyLastAttendee(){let t=tE()(this.attendees);return!!(t&&t.isBlank)}getValidAttendees(t){return this.attendees.filter(e=>!t.includes(e.email))}setName(t){this.name=t}addAttendee(t){this.attendees.push(t)}addBlankAttendee(){this.addAttendee(new tv({}))}clearAttendees(){this.attendees=[]}removeAttendee(t){this.attendees=this.attendees.filter(e=>e!==t)}clearBlankAttendees(){this.attendees=this.attendees.filter(t=>!t.isBlank)}constructor({id:t,name:e,description:n,startAt:r,endAt:i,recurring:o,attendees:s}){this.id=null!=t?t:(0,L.O)(),this.name=null!=e?e:null,this.description=null!=n?n:null,this.startAt=null!=r?r:null,this.endAt=null!=i?i:null,this.recurring=null!=o&&o,this.attendees=null!=s?s:[],(0,a.makeObservable)(this)}}(0,i.gn)([a.observable],tU.prototype,"id",void 0),(0,i.gn)([a.observable],tU.prototype,"name",void 0),(0,i.gn)([a.observable],tU.prototype,"description",void 0),(0,i.gn)([a.observable],tU.prototype,"startAt",void 0),(0,i.gn)([a.observable],tU.prototype,"endAt",void 0),(0,i.gn)([a.observable],tU.prototype,"recurring",void 0),(0,i.gn)([a.observable],tU.prototype,"attendees",void 0),(0,i.gn)([a.computed],tU.prototype,"startAtDate",null),(0,i.gn)([a.computed],tU.prototype,"endAtDate",null),(0,i.gn)([a.computed],tU.prototype,"hasEmptyLastAttendee",null),(0,i.gn)([a.action],tU.prototype,"setName",null),(0,i.gn)([a.action],tU.prototype,"addAttendee",null),(0,i.gn)([a.action],tU.prototype,"clearAttendees",null),(0,i.gn)([a.action],tU.prototype,"removeAttendee",null),(0,i.gn)([a.action],tU.prototype,"clearBlankAttendees",null);var tB=n(75422),tR=n(41255),tj=n.n(tR),tP=n(39165),tO=n.n(tP),tL=n(11161),tK=n(7947),tG=n(66292),tq=n.n(tG);class tZ{dispose(){this.listeners.forEach(t=>t()),this.flushDebounced.flush()}prepare(){let t=this.table.on("change",t=>{let{ids:e}=t;for(let t of e)this.pendingRowIds.add(t);this.flushDebounced()});this.listeners.push(t)}async flush(){if(0===this.pendingRowIds.size)return;let t=await tH(this.pendingRowIds,this.table);this.pendingRowIds.clear(),await this.onChange(t)}constructor(t){this.pendingRowIds=new Set,this.listeners=[],this.table=t.table,this.onChange=t.onChange,this.flushDebounced=tq()(this.flush.bind(this),t.debounce),this.prepare()}}async function tH(t,e){let n=Array.from(t),r=await e.hasIds(n),i=n.filter(t=>!r.includes(t));return{updatedRowIds:r,deletedRowIds:i}}var tJ=n(12448),tQ=n.n(tJ),tY=n(2600),tz=n.n(tY),tV=n(16169),tW=n(33429);function t$(t,e,n){return t.map(t=>t.trim()).filter(Boolean).map(t=>{var r;return r=(r=t).trim(),(e?[r]:r.split(/\s+/)).map(t=>{var r;return r=t,n&&r.length<3?"":(r=r.replace(/"/g,'""'),r='"'.concat(r,'"'),e||(r="".concat(r,"*")),r)}).filter(Boolean).join(" AND ")}).filter(Boolean).map(t=>"(".concat(t,")")).join(" OR ")}function tX(){let t=(0,I._)(["MATCH"]);return tX=function(){return t},t}function t0(){let t=(0,I._)(["MATCH"]);return t0=function(){return t},t}class t1{async search(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{type:"text"};return(t=t.trim())?this.searchCombined([t],e.exactSearch):[]}async searchCombined(t){let e=arguments.length>1&&void 0!==arguments[1]&&arguments[1];if(0===(t=t.map(t=>t.trim()).filter(t=>t.length>0)).length)return[];let n=[...await this.searchNotes(t,e),...await this.searchAssets(t,e)];return this.boostRecent(n),this.boostBySubject(n,t),await this.boostPinned(n),n=T()(n,"rank"),(n=tz()(n,"id")).map(this.mapRankedNoteToSearchResult)}async searchNotes(t,e){let n=t$(t,e,!0);if(!n)return[];try{let t=N.i.raw(this.noteFtsTable.name),e=this.noteFtsTable.query().select(["subject","documentText","id","updatedAt","rank"]).where(t,(0,N.i)(tX()),n).where("rank","=",N.i.raw("'bm25(3.0)'")).limit(100).orderBy("rank");return(await this.noteFtsTable.adapter.executeSelect(e)).map(t=>({id:t.id,subject:t.subject,documentText:t.documentText||"",updatedAt:t.updatedAt,rank:t.rank||0}))}catch(e){throw console.error("Error searching notes with query ".concat(JSON.stringify(t),":"),e),e}}async searchAssets(t,e){let n=t$(t,e,!0);if(!n)return[];try{let t=N.i.raw(this.assetFtsTable.name),e=await this.assetFtsTable.adapter.executeSelect(this.assetFtsTable.query().select(["text","noteIds","rank"]).where(t,(0,N.i)(t0()),n).limit(100).orderBy("rank")),r={};for(let t of e)for(let e of t3.parse(JSON.parse(t.noteIds)))r[e]||(r[e]=t.text);let i=Object.keys(r),a=await this.noteTable.adapter.executeSelect(this.noteTable.query().select(["id","subject","updatedAt"]).where("id","in",(0,A.pP)(i))),o=Object.fromEntries(a.map(t=>[t.id,t]));return i.map(t=>{let e=r[t]||"",n=o[t];if(n)return{id:t,subject:n.subject,documentText:e,updatedAt:n.updatedAt,rank:0}}).filter(ta.Dw)}catch(e){throw console.error("Error searching assets with query ".concat(JSON.stringify(t),":"),e),e}}async getDocumentCount(){return await this.noteFtsTable.getCount()}boostRecent(t){let e=Date.now();for(let n of t){let t=(e-(n.updatedAt?tQ()(n.updatedAt):0))/864e5;n.rank*=function(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:7,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:3,r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:1;return Math.max(-(n-r)/e*(t=Math.max(t,0))+(n-r),0)+r}(t)}}async boostPinned(t){let e=t.map(t=>t.id),n=new Set(await this.getPinnedNoteIds(e));for(let e of t)n.has(e.id)&&(e.rank*=2)}boostBySubject(t,e){let n=e.map(t=>t.toLowerCase().trim());for(let e of t){let t=(e.subject||"").toLowerCase().trim(),r=(0,tV.gO)(t),i=!1,a=!1;for(let t of n)for(let e of r)i||e!==t?!a&&e.startsWith(t)&&(a=!0):i=!0;i?e.rank-=Number.POSITIVE_INFINITY:a&&(e.rank*=2)}}async getPinnedNoteIds(t){if(0===t.length)return[];let e=this.noteTable.query().select(["id"]).where("id","in",(0,A.pP)(t)).where("pinnedIndex","is not",null);return(await this.noteTable.adapter.executeSelect(e)).map(t=>t.id)}constructor({graphId:t}){this.mapRankedNoteToSearchResult=t=>{var e;return e={id:t.id,subject:t.subject,line:t.documentText,editedAt:t.updatedAt},{id:"note-".concat(e.id),title:e.subject.substring(0,500),contentLine:e.line.substring(0,5e3),timestamp:e.editedAt,noteId:e.id}},this.noteFtsTable=new tW.U({name:"notesFts",scope:[{key:"graphId",operator:"==",value:t},{key:"deletedAt",operator:"is",value:null}],multiTab:!1}),this.assetFtsTable=new tW.U({name:"assetsFts",scope:[{key:"graphId",operator:"==",value:t}],multiTab:!1}),this.noteTable=new tW.U({name:"notes",scope:[{key:"graphId",operator:"==",value:t},{key:"deletedAt",operator:"is",value:null}],multiTab:!1})}}let t3=m.ZP.array(m.ZP.string());var t4=n(80345);let t5="undefined"!=typeof Worker?new Worker(n.tu(new URL(n.p+n.u(947),n.b))):null,t6=t5?t4.Ud(t5):{loadFromStorage:()=>Promise.resolve(!1),search:()=>[],searchCombined:()=>[],updateIndex:async()=>{},getDocumentCount:()=>Promise.resolve(0),flush:async()=>{}},t2=G()(t=>new t1({graphId:t})),t8=async t=>{let e=t.types.map(async e=>{switch(e){case"text":return!0;case"embedding":return await t6.loadFromStorage(t)}});return(await Promise.all(e)).every(t=>t)},t7=async t=>{if("text"!==t.options.type)return await t6.search(t);{let e=t2(t.graphId);return await e.search(t.query,t.options)}},t9=async t=>{let e=t2(t.graphId);return await e.searchCombined(t.queries)},et=async t=>{let e=t.types.map(async e=>{switch(e){case"text":return;case"embedding":return await t6.updateIndex(t)}});await Promise.all(e)},ee=async t=>{if("text"!==t.type)return await t6.getDocumentCount(t);{let e=t2(t.graphId);return await e.getDocumentCount()}},en=async()=>{await t6.flush()};window.addEventListener("beforeunload",()=>{en()});var er=n(46582),ei=n(12774);class ea extends(0,o.Hnr)({}){onAttachedToRootStore(){return this.setup(),()=>this.beforeDetach()}beforeDetach(){return this.isDetached=!0,(0,l.$)(this.listeners)}async setup(){let t=await t8({graphId:this.assertGraph.id,types:this.searchManagerTypes}),e=await this.verifyIndex();t&&e||this.requestReindexAll(),this.observeNoteChanges(),this.observeCommitChanges(),await this.observeAssetChanges(),this.setIsSetup(!0)}setIsSetup(t){this.isSetup=t}observeNoteChanges(){if(this.isDetached)return;let t=new tZ({table:this.noteTable,onChange:t=>this.handleNoteChange(t),debounce:1e3});this.listeners.push(()=>null==t?void 0:t.dispose()),this.notesObserver=t}async handleNoteChange(t){let{updatedRowIds:e,deletedRowIds:n}=t;await this.requestReindexSome({updatedNoteIds:e,deletedNoteIds:n})}observeCommitChanges(){if(this.isDetached)return;let t=new ei.Z({graphId:this.graphId,changeStore:this.changeStore,onChange:this.handleCommitsChange.bind(this),debounce:1e3});this.listeners.push(()=>null==t?void 0:t.dispose()),this.changesObserver=t}handleCommitsChange(t){this.requestReindexSome({updatedNoteIds:t,deletedNoteIds:[]})}async observeAssetChanges(){if(this.isDetached)return;await (0,a.when)(()=>this.assertAssetStore.isSetup);let t=new tZ({table:this.assetTable,onChange:t=>void this.handleAssetChange(t),debounce:3e3});this.listeners.push(()=>t.dispose()),this.assetsObserver=t}async handleAssetChange(t){let{updatedRowIds:e}=t,n=this.assertAssetStore.table,r=n.query().select("noteIds").where("id","in",(0,A.pP)(e)),i=await n.adapter.executeSelect(r),a=O()(i.flatMap(t=>(0,er.hH)(t.noteIds)));this.requestReindexSome({updatedNoteIds:a,deletedNoteIds:[]})}async requestReindexSome(t){let{updatedNoteIds:e,deletedNoteIds:n}=t;await this.jobQueue.replace({task:"reindexSearch",getArgs:t=>t?"reindexAll"===t.type?{type:"reindexAll"}:{type:"reindexSome",updatedNoteIds:O()([...t.updatedNoteIds,...e]),deletedNoteIds:O()([...t.deletedNoteIds,...n])}:{type:"reindexSome",updatedNoteIds:e,deletedNoteIds:n},delay:this.jobDelay})}async requestReindexAll(){await this.jobQueue.replace({task:"reindexSearch",getArgs:()=>({type:"reindexAll"}),delay:this.jobDelay})}async handleJobExecution(t){if(this.searchEmbeddingEnabled)switch(t.type){case"reindexAll":return await this.reindexAll();case"reindexSome":return await this.reindexSome(t)}}async reindexAll(){if(this.isDetached)return;let t=this.validIndexingRowsQuery,e=await this.noteTable.getCount(t),n=Math.ceil(e/this.pageSize);if(0===e){await this.updateIndex({reset:!0});return}for(let e=0;e<n;e++){let n=e*this.pageSize,r=await this.noteTable.fetch(t.limit(this.pageSize).offset(n)),i=await this.docsFromRows(r),a=0===e;if(await this.updateIndex({add:i,reset:a}),this.isDetached)return}}async reindexSome(t){let{updatedNoteIds:e,deletedNoteIds:n}=t,r=this.validIndexingRowsQuery.where("id","in",(0,A.pP)(e)).clearSelect().select("id"),i=(await this.noteTable.adapter.executeSelect(r)).map(t=>t.id),a=tO()(e,i),o=O()([...n,...a]);if(0===e.length&&n.length>0){await this.updateIndex({remove:o});return}for(let[t,n]of tj()(e,this.pageSize).entries()){let e=this.validIndexingRowsQuery.where("id","in",(0,A.pP)(n)),r=await this.noteTable.fetch(e),i=await this.docsFromRows(r);await this.updateIndex({add:i,remove:0===t?o:[]})}}async docsFromRows(t){let e=await this.getAssetTextsFromNoteIds(t.map(t=>t.id));return t.map(t=>this.docFromNoteRow(t,e))}async getAssetTextsFromNoteIds(t){let e=await this.assertAssetStore.findByNoteIds(t),n=new Map;for(let t of e)n.set(t.id,t.text);return n}docFromNoteRow(t,e){return nD({row:t,adapter:this.noteAdapter,assetTextMap:e})}async verifyIndex(){let t=await ee({graphId:this.graphId,type:"text"}),e=await this.noteTable.getCount(this.validIndexingRowsQuery);return t===e||(this.logger.warn("Search index is out of sync. Expected ".concat(e," documents, got ").concat(t,". Rebuilding index.")),!1)}async updateIndex(t){var e,n,r;await et({graphId:this.graphId,types:this.searchManagerTypes,add:null!==(e=t.add)&&void 0!==e?e:[],remove:null!==(n=t.remove)&&void 0!==n?n:[],reset:null!==(r=t.reset)&&void 0!==r&&r,allowWebGPU:this.allowWebGPU})}get validIndexingRowsQuery(){return this.noteTable.query().where("deletedAt","is",null).where(t=>t.or([t("subject","is not",null),t("isBlank","=",0)])).orderBy("id")}async search(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{type:"text"},n="text"===e.type?e:{...e,allowWebGPU:this.allowWebGPU};return await t7({graphId:this.graphId,query:t,options:n})}async searchCombined(t){return await t9({graphId:this.graphId,queries:t})}get assertNoteStore(){return(0,c.w0)(this)}get assertAssetStore(){return this.assertGraph.assetStore}get noteTable(){return this.assertNoteStore.table}get assetTable(){return this.assertAssetStore.table}get noteAdapter(){return this.assertNoteStore.adapter}get assertGraph(){return this.assertNoteStore.assertGraph}get rootStore(){return this.assertNoteStore.rootStore}get preferenceStore(){var t;return null===(t=this.rootStore)||void 0===t?void 0:t.preferenceStore}get changeStore(){return this.assertNoteStore.assertRootStore.changeStore}get logger(){return this.assertGraph.logger}get graphId(){return this.assertGraph.id}get searchEmbeddingEnabled(){return!(0,tK.Y8)()&&!(0,tL.W)()&&!this.assertGraph.hasFlag("search_embedding_disabled")}get allowWebGPU(){var t,e;return null!==(e=null===(t=this.preferenceStore)||void 0===t?void 0:t.labs)&&void 0!==e&&e}get searchManagerTypes(){return this.searchEmbeddingEnabled?["text","embedding"]:["text"]}get jobQueue(){return this.assertGraph.jobQueueStore.manager}constructor(...t){super(...t),this.listeners=[],this.isSetup=!1,this.isDetached=!1,this.jobDelay=3e3,this.pageSize=500}}(0,i.gn)([a.observable],ea.prototype,"isSetup",void 0),(0,i.gn)([a.action],ea.prototype,"setIsSetup",null),ea=(0,i.gn)([(0,o.o4J)("SearchStore")],ea);var eo=n(39833),es=n(44387),el=n(18734),ec=n(17401),ed=n(22892);class eu{get value(){return this.adapter.getModelFromPool(this.id)}async resolve(){return await this.adapter.findById(this.id)}retain(){this.adapter.loadIntoPool(this.id)}release(){}constructor(t){this.adapter=t.adapter,this.id=t.id,(0,a.makeObservable)(this),(0,a.onBecomeObserved)(this,"value",()=>{this.retain()}),(0,a.onBecomeUnobserved)(this,"value",()=>{this.release()})}}(0,i.gn)([a.computed],eu.prototype,"value",null);class eh{setResults(t){this.resultIds=t,this.hasResolved=!0}subscribe(){this.table.on("change",this.refresh)}unsubscribe(){this.table.off("change",this.refresh)}get count(){return this.resultIds.length}get placeholders(){return this.resultIds.map(t=>this.createPlaceholder(t))}get(t){return this.placeholders.find(e=>e.id===t)}createPlaceholder(t){return new eu({adapter:this.adapter,id:t})}get table(){return this.adapter.table}constructor(t){this.resultIds=[],this.hasResolved=!1,this.refresh=async()=>{let t=(await this.table.adapter.executeSelect(this.query)).map(t=>t.id);return this.setResults(t),t},this.adapter=t.adapter,this.query=t.query.clearSelect().select("id"),(0,a.makeObservable)(this),(0,a.onBecomeObserved)(this,"resultIds",()=>{this.subscribe()}),(0,a.onBecomeUnobserved)(this,"resultIds",()=>{this.unsubscribe()}),this.refresh()}}(0,i.gn)([a.observable],eh.prototype,"resultIds",void 0),(0,i.gn)([a.observable],eh.prototype,"hasResolved",void 0),(0,i.gn)([a.action],eh.prototype,"setResults",null),(0,i.gn)([a.computed],eh.prototype,"count",null),(0,i.gn)([a.computed],eh.prototype,"placeholders",null);var ep=n(81394);class eg{attach(){this.table.on("change",this.boundLoadFromDb,{priority:ep.gJ.Low})}async loadFromDb(t){let{ids:e,options:n}=t;if((null==n?void 0:n.skipPoolSync)||!this.pool)return;let r=e.map(t=>this.pool.get(t)).filter(ta.Dw),i=r.map(t=>t.id),a=await this.table.getManyAsMap(i);for(let t of r){let e=t.id,n=a.get(e);if(!n){setTimeout(()=>{this.pool.delete(e)},250);continue}let r=this.snapshotFromRow(n);this.pool.applySnapshot(t,r,{shouldSkipHandler:!0}),console.log("%c<-- updating model from db","font-weight: bold")}}constructor(t){this.boundLoadFromDb=t=>this.loadFromDb(t),this.table=t.table,this.pool=t.pool,this.snapshotFromRow=t.snapshotFromRow}}class em{attach(){}async ensureSaved(t){await (null==t?void 0:t()),await (0,a.when)(()=>this.isSaving),await (0,a.when)(()=>!this.isSaving)}async flush(){await (0,a.when)(()=>!this.isSaving),this.setIsSaving(!0);let t=Array.from(this.changedIds).map(t=>this.pool.get(t)).filter(ta.Dw);this.changedIds.clear(),await this.save(t),this.setIsSaving(!1)}async save(t){for(let e of t)(0,eo.hu)((0,o.G_R)(e),"Model must be attached to a parent");let e=new Map;for(let n of t){let t=this.rowFromModel(n);e.set(n.id,t)}await this.table.updateMany(e,{skipPoolSync:!0})}async create(t){(0,eo.hu)(!(0,o.G_R)(t),"Model must not be attached to a parent"),this.pool.set(t);let e=this.rowFromModel(t);await this.table.replace(t.id,e,{skipPoolSync:!0})}setIsSaving(t){this.isSaving=t}constructor(t){this.changedIds=new Set,this.isSaving=!1,this.handleSnapshot=t=>{this.changedIds.add(t.id),this.flushDebounced()},this.flushDebounced=tq()(this.flush.bind(this),0),this.table=t.table,this.pool=t.pool,this.rowFromModel=t.rowFromModel,this.pool.onSnapshot=this.handleSnapshot,(0,a.makeObservable)(this)}}(0,i.gn)([a.observable],em.prototype,"isSaving",void 0),(0,i.gn)([a.action],em.prototype,"setIsSaving",null);class ey{attach(){this.syncUp.attach(),this.syncDown.attach()}async detach(){this.pool.detach(),await (0,l.$)(this.listeners)}placeholder(t){return new eu({adapter:this,id:t})}getModelFromPool(t){var e;return null!==(e=this.pool.get(t))&&void 0!==e?e:null}getModelsFromPool(t){return t.map(t=>this.getModelFromPool(t)).filter(ta.Dw)}ensureRowInPool(t){let e=this.getModelFromPool(t.id);if(e)return e;let n=this.onCreate(t);return this.pool.set(n),n}ensureRowsInPool(t){let e=[];for(let n of t)if(!this.getModelFromPool(n.id)){let t=this.onCreate(n);e.push(t)}this.pool.setMany(e)}async loadIntoPool(t){this.loadIntoPoolQueue.push(t),await this.flushLoadIntoPoolQueue()}async flushLoadIntoPoolQueueNow(){await this.findByIds(this.loadIntoPoolQueue),this.loadIntoPoolQueue=[]}async findById(t){let e=this.getModelFromPool(t);if(e)return e;let n=await this.table.get(t);return n?this.ensureRowInPool(n):null}async findByIds(t){let e=t.filter(t=>!this.getModelFromPool(t)),n=await this.table.getMany(e);return this.ensureRowsInPool(n),this.getModelsFromPool(t)}async find(t){let e=await this.table.find(t);return e?this.ensureRowInPool(e):null}async fetch(t){let e=await this.table.fetch(t);if(0===e.length)return[];this.warnIfFetchingManyModels("fetchModelsByQuery",e.length),this.ensureRowsInPool(e);let n=e.map(t=>t.id);return this.getModelsFromPool(n)}warnIfFetchingManyModels(t,e){e>10&&console.warn("Warning: ".concat(this.table.name,".").concat(t,"() is adding ").concat(e," models to the pool. ")+"Consider using placeholders instead for better performance.")}async addModel(t){await this.syncUp.create(t)}async deleteModel(t){await this.table.delete(t.id)}async ensureSaved(t){await this.syncUp.ensureSaved(t)}query(t){return new eh({adapter:this,query:t})}constructor(t){this.listeners=[],this.loadIntoPoolQueue=[],this.flushLoadIntoPoolQueue=tq()(this.flushLoadIntoPoolQueueNow.bind(this),0),this.table=t.table,this.onCreate=t.onCreate,this.pool=t.pool,this.syncUp=new em(t),this.syncDown=new eg(t)}}class ef extends(0,o.Hnr)(()=>({models:(0,o.vgT)(()=>new o.RTE({}))})){detach(){for(let t of this.models.keys())this.stopObserving(t)}has(t){return this.models.has(t)}get(t){return this.models.get(t)}get size(){return this.models.size}set(t){this.models.has(t.id)&&this.delete(t.id),this.models.set(t.id,t),this.observeSnapshot(t)}setMany(t){for(let e of t)this.set(e)}delete(t){this.stopObserving(t),this.models.delete(t)}clear(){for(let t of this.models.keys())this.delete(t)}observeSnapshot(t){let e=(0,o.cfB)(t,e=>{var n;this.shouldSkipHandler.has(t.id)||null===(n=this.onSnapshot)||void 0===n||n.call(this,t,e)});this.listeners.set(t.id,e)}stopObserving(t){let e=this.listeners.get(t);e&&(e(),this.listeners.delete(t))}applySnapshot(t,e){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{shouldSkipHandler:!1};n.shouldSkipHandler&&this.shouldSkipHandler.add(t.id),(0,o.Xx3)(t,e),this.shouldSkipHandler.delete(t.id)}constructor(...t){super(...t),this.listeners=new Map,this.shouldSkipHandler=new Set}}(0,i.gn)([o.ZBq],ef.prototype,"set",null),(0,i.gn)([o.ZBq],ef.prototype,"setMany",null),(0,i.gn)([o.ZBq],ef.prototype,"delete",null),(0,i.gn)([o.ZBq],ef.prototype,"clear",null),ef=(0,i.gn)([(0,o.o4J)("ModelPool")],ef);var ev=n(52110),ew=n(36076),eb=n(25956),eS=n.n(eb),ek=n(1130),eI=n(46696),eN=n(18453);function ex(){let t=(0,I._)(["CASE \n          WHEN COALESCE(updatedAt, createdAt) > ","\n          THEN 1 \n          ELSE 0 \n        END DESC"]);return ex=function(){return t},t}class eT extends(0,o.Hnr)({}){async searchBacklinks(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:10,n=await this.searchNoteBacklinks(t,e),r=(await this.searchContacts(t,e)).map(eA);return this.processBacklinks({noteBacklinks:n,contactBacklinks:r,limit:e})}async getSampleBacklinks(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:10,e=(await this.sampleNotes(t)).map(t=>{let e=(0,tV.dU)(t.subject);return eD(t,e)}),n=(await this.sampleContacts(t)).map(eA);return this.processBacklinks({noteBacklinks:e,contactBacklinks:n,limit:t})}get rootStore(){return(0,c.pE)(this)}get noteStore(){var t;return null===(t=(0,eI.H)(this))||void 0===t?void 0:t.noteStore}get assertNoteStore(){return(0,c.wi)(this,"noteStore")}get noteTable(){return this.assertNoteStore.table}get contactStore(){return this.rootStore.contactStore}processBacklinks(t){let{noteBacklinks:e,contactBacklinks:n,limit:r=10}=t;return this.combineBacklinks({noteBacklinks:e,contactBacklinks:n}).slice(0,r)}combineBacklinks(t){let{noteBacklinks:e,contactBacklinks:n}=t,r=e.flatMap(t=>t.emails),i=n.filter(t=>0===eS()(t.emails,r).length);return e.concat(i)}get sortedNotesQuery(){let t=(0,es.zO)()-864e5;return this.assertNoteStore.regularNotesQuery.orderBy((0,N.i)(ex(),t)).orderBy("backlinkedCount","desc").orderBy("updatedAt","desc")}async searchNoteBacklinks(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:10,n=this.sortedNotesQuery.clearSelect().select(["id","subject","systemMetadata"]),r=await this.noteTable.adapter.executeSelect(n);return(0,to.Gd)(r,t,e).map(t=>{let{note:e,alias:n,ranges:r}=t;return{...eD(e,n),ranges:r}})}async sampleNotes(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:10,e=this.sortedNotesQuery.limit(t);return await this.noteTable.fetch(e)}async searchContacts(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:10;return await this.contactStore.searchContacts(t,e)}async sampleContacts(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:10;return await this.contactStore.sampleContacts(t)}}function eD(t,e){var n,r,i;let a=(0,eN.Jg)(t.systemMetadata),o=null==a?void 0:null===(n=a.data)||void 0===n?void 0:n.enrichment,s=(null==o?void 0:null===(r=o.person)||void 0===r?void 0:r.avatar)||(null==o?void 0:null===(i=o.company)||void 0===i?void 0:i.logo)||void 0;return{id:t.id,previewSrc:s,label:e,normalizedLabel:(0,ek.Ue)(e)}}function eA(t){return{id:t.id,previewSrc:t.photoUrl,label:t.name,normalizedLabel:t.name.toLowerCase(),contactId:t.id}}(0,i.gn)([a.computed],eT.prototype,"sortedNotesQuery",null),eT=(0,i.gn)([(0,o.o4J)("BacklinkStore")],eT);var eC=n(20608);class e_ extends(0,o.Hnr)({}){setGeneratedNotes(t){this.generatedNotes=t}addGeneratedNote(t){this.generatedNotes.find(e=>e.id===t.id)||this.generatedNotes.push(t)}findGeneratedById(t){var e;return null!==(e=this.generatedNotes.find(e=>e.id===t))&&void 0!==e?e:null}combine(t){let e=this.generatedNotes.filter(e=>!t.some(t=>t.id===e.id));return t.concat(null!=e?e:[]).sort((t,e)=>t.dailyAt-e.dailyAt)}updateGeneratedNotes(t){if(!this.assertRootStore.preferenceStore.hasSynced)return;let e=(0,$.Z)({start:t.startAt,end:t.endAt}),n=this.generatedNotes.map(t=>t.id),r=e.filter(t=>{let e=(0,ti.l5)(t);return!n.includes(e)}),i=this.generateForDates(r),a=this.generatedNotes.concat(i).filter(e=>(0,to.ZQ)(e.dailyOrCreatedDate,t)).sort((t,e)=>t.dailyAt-e.dailyAt);this.setGeneratedNotes(a)}generateForDates(t){return t.map(t=>{let e=this.assertNoteStore.buildForDate(t);return e.setIsDailyGenerated(!0),e})}get assertNoteStore(){return(0,c.w0)(this)}get assertRootStore(){return this.assertNoteStore.assertRootStore}constructor(...t){super(...t),this.generatedNotes=[]}}(0,i.gn)([a.observable],e_.prototype,"generatedNotes",void 0),(0,i.gn)([a.action],e_.prototype,"setGeneratedNotes",null),(0,i.gn)([a.action],e_.prototype,"addGeneratedNote",null),e_=(0,i.gn)([(0,o.o4J)("DailyNoteStore")],e_);var eM=n(9793);let eE="#trash";class eF extends(0,o.Hnr)({lastSelectedNoteRef:(0,o.vgT)(),lastSelectedNotSpanNoteRef:(0,o.vgT)(),selectedNoteRefs:(0,o.vgT)(()=>[])}){get noteStore(){let t=(0,o.G_R)(this);if(!t)throw Error("blank store");return t}get rootStore(){let t=(0,o.k0l)(this);if(!t)throw Error("blank store");return t}get mainView(){return this.rootStore.mainView}get graph(){let t=this.noteStore.graph;if(!t)throw Error("no graph");return t}get hasQuery(){return!!this.query}get isTrashQuery(){return this.query===eE}get isTagQuery(){return this.query.startsWith("#")}get tagMatchNotesQuery(){let t=this.query.replaceAll("#","");return this.noteStore.undeletedNotesQuery.where((0,A.$F)("tags",t)).orderBy(t=>t.fn.coalesce("editedAt","updatedAt"),"desc")}get notesQuery(){return this.isTrashQuery?this.noteStore.deletedNotesDescQuery:this.isTagQuery?this.tagMatchNotesQuery:this.noteStore.regularNotesEditedDescQuery}get notes(){return this.noteStore.adapter.query(this.notesQuery)}get noteIds(){return this.notes.resultIds}get selectedNotes(){return this.selectedNoteRefs.map(t=>t.current).filter(t=>this.noteIds.includes(t.id))}get selectedNotesAreTrashed(){return this.selectedNotes.every(t=>t.isDeleted)}get lastSelectedNotSpanNoteIndex(){var t;let e=null===(t=this.lastSelectedNotSpanNoteRef)||void 0===t?void 0:t.maybeCurrent;return e?this.noteIds.indexOf(e.id):-1}get lastSelectedNote(){var t;let e=null===(t=this.lastSelectedNoteRef)||void 0===t?void 0:t.maybeCurrent;if(e&&this.noteIds.includes(e.id))return e}get lastSelectedNoteIndex(){let t=this.lastSelectedNote;return t?this.noteIds.indexOf(t.id):-1}setQuery(t){this.query===t?this.scrollToTop():this.query=t}clearQuery(){this.setQuery("")}setScrollIndex(t){this.scrollIndex=t,this.scrollIndexCounter++}scrollToTop(){this.setScrollIndex(0)}scrollIntoView(t){let e=this.noteIds.indexOf(t.id);-1!==e&&this.setScrollIndex(e)}isSelected(t){return this.selectedNotes.includes(t)}isLastSelected(t){var e;return(null===(e=this.lastSelectedNoteRef)||void 0===e?void 0:e.maybeCurrent)===t}unselectAll(){this.selectedNoteRefs=[]}setSelectedNotes(t){this.selectedNoteRefs=t.map(t=>(0,eM.qg)(t))}setLastSelectedNote(t){let{span:e=!1}=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};this.lastSelectedNoteRef=(0,eM.qg)(t),e||(this.lastSelectedNotSpanNoteRef=(0,eM.qg)(t))}async deleteSelectedNotes(){0!==this.selectedNotes.length&&(this.query===eE?confirm("Destroy selected notes forever?")&&await this.noteStore.destroyNotes(this.selectedNotes):await this.noteStore.deleteNotes(this.selectedNotes))}edit(t){this.mainView.editNote(t)}editSelected(){let[t]=this.selectedNotes;t&&this.edit(t)}async selectOperation(t){let{note:e,toggle:n=!1,span:r=!1}=t;n?this.toggle(e):r?await this.selectWithSpan(e):this.selectExclusively(e)}async checkOperation(t){let{note:e,span:n=!1}=t;n?await this.selectWithSpan(e):this.toggle(e)}toggle(t){this.selectedNotes.includes(t)?this.unselect(t):this.select(t)}async selectWithSpan(t){let e=this.lastSelectedNotSpanNoteIndex,n=this.noteIds.indexOf(t.id);await this.selectSpan(e,n)}selectExclusively(t){this.unselectAll(),this.select(t)}select(t){this.selectedNotes.includes(t)||(this.selectedNoteRefs.push((0,eM.qg)(t)),this.setLastSelectedNote(t),this.scrollIntoView(t))}selectAll(t){for(let e of t)this.selectedNotes.includes(e)||this.selectedNoteRefs.push((0,eM.qg)(e));let e=tE()(t);e&&(this.setLastSelectedNote(e),this.scrollIntoView(e))}unselect(t){let e=this.selectedNotes.indexOf(t);e>=0&&this.selectedNoteRefs.splice(e,1)}async selectSpan(t,e){let n=Math.min(t,e),r=Math.max(t,e);if(n<0||r>=this.noteIds.length)return;let i=this.notes.placeholders,a=i.slice(n,r+1),o=(await (0,ta.sz)(a,t=>t.resolve())).filter(ta.Dw),s=i[e],l=await s.resolve();this.setSelectedNotes(o),this.setLastSelectedNote(l,{span:!0}),this.scrollIntoView(l)}async selectDirection(t,e){let{span:n=!1}=e,r=this.lastSelectedNoteIndex+("down"===t?1:-1),i=this.notes.placeholders[r];if(i){if(n){let t=this.lastSelectedNotSpanNoteIndex;await this.selectSpan(t,r)}else{let t=await i.resolve();t&&this.selectExclusively(t)}}}constructor(...t){super(...t),this.query="",this.scrollIndex=0,this.scrollIndexCounter=0}}(0,i.gn)([a.observable],eF.prototype,"query",void 0),(0,i.gn)([a.observable],eF.prototype,"scrollIndex",void 0),(0,i.gn)([a.observable],eF.prototype,"scrollIndexCounter",void 0),(0,i.gn)([a.computed],eF.prototype,"hasQuery",null),(0,i.gn)([a.computed],eF.prototype,"tagMatchNotesQuery",null),(0,i.gn)([a.computed],eF.prototype,"notesQuery",null),(0,i.gn)([a.computed],eF.prototype,"notes",null),(0,i.gn)([(0,a.computed)({keepAlive:!0})],eF.prototype,"noteIds",null),(0,i.gn)([a.computed],eF.prototype,"selectedNotes",null),(0,i.gn)([a.computed],eF.prototype,"selectedNotesAreTrashed",null),(0,i.gn)([a.computed],eF.prototype,"lastSelectedNotSpanNoteIndex",null),(0,i.gn)([a.computed],eF.prototype,"lastSelectedNote",null),(0,i.gn)([a.action],eF.prototype,"setQuery",null),(0,i.gn)([a.action],eF.prototype,"setScrollIndex",null),(0,i.gn)([a.action],eF.prototype,"scrollToTop",null),(0,i.gn)([o.ZBq],eF.prototype,"unselectAll",null),(0,i.gn)([o.ZBq],eF.prototype,"setSelectedNotes",null),(0,i.gn)([o.ZBq],eF.prototype,"setLastSelectedNote",null),(0,i.gn)([o.ZBq],eF.prototype,"select",null),(0,i.gn)([o.ZBq],eF.prototype,"selectAll",null),(0,i.gn)([o.ZBq],eF.prototype,"unselect",null),eF=(0,i.gn)([(0,o.o4J)("NoteListView")],eF);var eU=n(59245),eB=n.n(eU),eR=n(18612),ej=n(59592),eP=n(63317),eO=n(53967);async function eL(t,e){var n,r,i,a,o,s;if(!("yjs_doc"in t))throw Error("note is missing yjs_doc");let{yDocAsUpdate:l,document:c}=await eK(t,e),d={id:t.id,subject:await eG(t,e),yDocAsUpdate:l?(0,ej.kZ)(l):void 0,document:c?{$frozen:!0,data:c}:void 0,lastCommitId:"number"==typeof t.doc_commit_id?t.doc_commit_id:null!==(s=t.last_commit_id)&&void 0!==s?s:null,acl:t.acl,createdAt:(0,f.av)(t.created_at),updatedAt:(0,f.av)(t.updated_at),editedAt:null!==(n=(0,f.av)(t.edited_at))&&void 0!==n?n:void 0,deletedAt:(0,f.av)(t.deleted_at),backlinkedCount:null!==(r=t.backlinked_count)&&void 0!==r?r:0,daily:null!==(i=t.daily)&&void 0!==i&&i,ignoredBacklinkFromNoteIds:null!==(a=t.ignored_backlink_from_note_ids)&&void 0!==a?a:[],ignoredBacklinkLabels:await eZ(t,e),ignoredContactNames:await eq(t,e),pinnedIndex:t.pinned_index,systemMetadata:{$frozen:!0,data:null!==(o=t.system_metadata)&&void 0!==o?o:{}},persisted:!0};return(0,eN.O8)({graphId:e.id,snapshot:d})}async function eK(t,e){let n;let r={key:e.encryptionKey,itemId:t.id},i=await (0,f.V$)(t.yjs_doc,r);if(i){let t=(0,eP.NR)(i);n=(0,tB.x4)(t)}else{let e=await (0,eO.MJ)({type:"Note",value:t.document_json,...r});n=e?JSON.parse(e):void 0}return{yDocAsUpdate:i,document:n}}async function eG(t,e){let n=await (0,eO.MJ)({type:"Note",value:t.subject,key:e.encryptionKey,itemId:t.id});return null!=n?n:""}async function eq(t,e){let n=await (0,eO.MJ)({type:"Note",value:t.ignored_contact_names,key:e.encryptionKey,itemId:t.id});return n?JSON.parse(n):[]}async function eZ(t,e){let n=await (0,eO.MJ)({type:"Note",value:t.ignored_backlink_labels,key:e.encryptionKey,itemId:t.id});return n?JSON.parse(n):[]}var eH=n(43214),eJ=n(71157);function eQ(){let t=(0,I._)(["coalesce(editedAt, updatedAt)"]);return eQ=function(){return t},t}function eY(){let t=(0,I._)(["RANDOM()"]);return eY=function(){return t},t}function ez(){let t=(0,I._)(["LOWER(subject)"]);return ez=function(){return t},t}class eV extends(0,o.Hnr)({pool:(0,o.vgT)(()=>new ef({})),dailyStore:(0,o.vgT)(()=>new e_({})),searchStore:(0,o.vgT)(()=>new ea({})),backlinkStore:(0,o.vgT)(()=>new eT({})),dailyEditorView:(0,o.vgT)(()=>new tl({})),primaryEditorView:(0,o.vgT)(()=>new tc({role:"primary"})),secondaryEditorView:(0,o.vgT)(()=>new tc({role:"secondary"})),listView:(0,o.vgT)(()=>new eF({}))},{toSnapshotProcessor:t=>{let{}=t;return{}}}){onAttachedToRootStore(){return this.attachTable(),this.setupReconnectListener(),()=>{this.detach()}}attachTable(){let t=this.assertGraph,e=(0,ec.w)(t),n=new ew._({name:"notes",scope:[{key:"graphId",operator:"==",value:t.id}],multiTab:!1});this._tableSqlite=n,this._lastSyncManager=new ed.f({adapter:this.table.adapter,tableName:"notes",contextId:t.id}),this._syncDown=function(t){let e=t.assertGraph;return new eH.w({table:t.table,collectionRef:()=>(0,d.J4)({db:u.db,graphId:e.id}),convertDown:(t,n)=>eL(n,e),getLastSync:()=>t.lastSyncManager.getLastSync(),onSync:e=>{let{lastChangeAt:n}=e;return t.lastSyncManager.setLastSync(n)},onBeforeUpdate:t=>eB()(t,["document","lastCommitId","yDocAsUpdate"]),fieldsForDecidingSync:["lastCommitId"],wantsCustomSync:(t,e)=>{let n=t.data;return!!e&&null!=n.last_commit_id&&n.last_commit_id!==e.lastCommitId},onCustomSync:async e=>{let n=(await t.adapter.findByIds(e)).map(t=>t.changeManager.loadAndApplyCommits());await Promise.all(n)},getFlags:t=>null!=t.doc_commit_id&&t.last_commit_id!==t.doc_commit_id?["needsFetchCommits"]:null,onAfterCreate:async e=>{await (0,eR.Z)(100);let n=e.map(t=>t.id);t.requestRemount(n);let r=e.filter(t=>{var e;return null===(e=t.flags)||void 0===e?void 0:e.includes("needsFetchCommits")}).map(t=>t.id);if(0===r.length)return;r.length>10&&(0,eJ.uT)("During initial sync, we had to fetch commits for more than 10 notes",{extra:{count:r.length}});let i=t.assertGraph;await i.jobQueue.replace({task:"repairOutdatedDoc",getArgs:t=>({noteIds:t?O()([...t.noteIds,...r]):r}),delay:0})}})}(this),this._syncUp=new ev.h({table:this.table,docRef:e=>(0,d.lB)({db:u.db,graphId:t.id,noteId:e.id}),convertUp:e,debounce:this.syncUpDebounce,allowCreate:!1}),this._adapter=new ey({table:this.table,pool:this.pool,onCreate:eN.AZ,rowFromModel:t=>(0,eN.s4)(this.assertGraph.id,t),snapshotFromRow:eN.uZ}),this.adapter.attach(),this.listeners.push(()=>{this.adapter.detach(),this.table.detach()}),this.attachSync()}async attachSync(){await (0,a.when)(()=>this.assertGraph.readyToInitStores),this.isDetached||(this.syncDown.attach(),this.syncUp.attach(),this.listeners.push(()=>{this.syncUp.detach(),this.syncDown.detach()}))}detach(){this.isDetached=!0,(0,l.$)(this.listeners)}setupReconnectListener(){this.listeners.push((0,a.reaction)(()=>this.hasSynced&&this.online,t=>{t&&this.handleReconnect()}))}get hasSynced(){return this.syncDown.hasSynced}get tableId(){return[this.assertGraph.id,"notes"].join("-")}get rootStore(){return(0,o.k0l)(this)}get assertRootStore(){return(0,c.wi)(this,"rootStore")}get graph(){return(0,o.G_R)(this)}get assertGraph(){return(0,c.wi)(this,"graph")}get changeStore(){var t;return null===(t=this.rootStore)||void 0===t?void 0:t.changeStore}get assertChangeStore(){let t=this.assertRootStore.changeStore;return(0,eo.hu)(t,"ChangeStore not found"),t}get online(){var t;return!!(null===(t=this.rootStore)||void 0===t?void 0:t.online)}get offline(){return!this.online}get table(){return(0,c.wi)(this,"_tableSqlite")}get lastSyncManager(){return(0,c.wi)(this,"_lastSyncManager")}get syncUp(){return(0,c.wi)(this,"_syncUp")}get syncDown(){return(0,c.wi)(this,"_syncDown")}get adapter(){return(0,c.wi)(this,"_adapter")}get undeletedNotesQuery(){return this.table.query().selectAll().where("deletedAt","is",null)}get regularNotesQuery(){return this.undeletedNotesQuery.where("isDaily","=",0)}get regularNotesEditedDescQuery(){return this.regularNotesQuery.orderBy((0,N.i)(eQ()),"desc")}get dailyNotesQuery(){return this.undeletedNotesQuery.where("isDaily","=",1)}get notesEditedDescQuery(){return this.undeletedNotesQuery.orderBy("editedAt","desc")}get pinnedNotesQuery(){return this.undeletedNotesQuery.where("pinnedIndex","is not",null)}get deletedNotesDescQuery(){return this.table.query().where("deletedAt","is not",null).orderBy("deletedAt","desc")}get undeletedNotes(){return this.adapter.query(this.undeletedNotesQuery)}get deletedNotesDesc(){return this.adapter.query(this.deletedNotesDescQuery)}get undeletedUnblankNotes(){let t=this.undeletedNotesQuery.where("isBlank","=",0);return this.adapter.query(t)}get undeletedHasTaskNotesQuery(){let t=(0,ti.l5)((0,es.zO)());return this.undeletedNotesQuery.where(e=>e.or([e.or([e("hasTask","is",null),e("hasTask","=",1)]),e("id","=",t)]))}get undeletedHasTaskNotes(){return this.adapter.query(this.undeletedHasTaskNotesQuery)}get regularNotes(){return this.adapter.query(this.regularNotesQuery)}get regularNotesEditedDesc(){return this.adapter.query(this.regularNotesEditedDescQuery)}get notesEditedDesc(){return this.adapter.query(this.notesEditedDescQuery)}get notesCreatedDesc(){let t=this.undeletedNotesQuery.orderBy("createdAt","desc");return this.adapter.query(t)}get pinnedNotes(){return this.adapter.query(this.pinnedNotesQuery)}get pinnnedNotesIndexAsc(){let t=this.pinnedNotesQuery.orderBy("pinnedIndex","asc");return this.adapter.query(t)}get regularNotesPinnedAscEditedDesc(){let t=this.regularNotesQuery.orderBy("pinnedIndex","asc").orderBy("editedAt","desc");return this.adapter.query(t)}async findById(t){return await this.adapter.findById(t)}async findBySubject(t){let e=this.adapter;return await e.find(this.undeletedNotesQuery.where("subject","==",t))}async findBySubjectAlias(t){let e=this.adapter,n=this.undeletedNotesQuery.where(e=>e.or([e("subject","=",t),(0,A.$M)(e,"subjectAliases",t)]));return await e.find(n)}async findByAsin(t){let e=this.undeletedNotesQuery.where("contentMetadataAsin","=",t);return await this.adapter.find(e)}async findByUrl(t){let e=this.undeletedNotesQuery.where((0,A.$F)("tags",n$.mt)).where((0,A.$F)("linkHrefs",t));return await this.adapter.find(e)}async findPersonTagByEmail(t){let e=this.undeletedNotesQuery.where((0,A.$F)("tags",n$._H)).where((0,A.$F)("emails",t));return await this.adapter.find(e)}async findByTagAndSubject(t,e){let n=this.undeletedNotesQuery.where((0,A.$F)("tags",t)).where("subject","=",e);return await this.adapter.find(n)}async findByContact(t){for(let e of t.emailValues){let t=await this.findPersonTagByEmail(e);if(t)return t}if(t.name){let e=await this.findByTagAndSubject(n$._H,t.name);if(e)return e}}hasNonEmptyNoteForDate(t){var e;let n=(0,ti.l5)(t),r=null===(e=this.undeletedNotes.get(n))||void 0===e?void 0:e.value;return!!r&&!r.isBlank}async findRandomNote(){let t=this.undeletedNotesQuery.where("isBlank","=",0).orderBy((0,N.i)(eY())).limit(1);return await this.adapter.find(t)}async getMergeNotesForNote(t,e){if(!e)return[];let n=this.notesEditedDescQuery.where("subject","is not",null).where("id","!=",t.id).where((0,N.i)(ez()),"=",null==e?void 0:e.toLowerCase());return(await this.table.adapter.executeSelect(n)).map(t=>({id:t.id,label:t.subject}))}async findOrCreateByContact(t){var e;let n=this.assertGraph.id;return await this.findByContact(t)||(await (null===(e=this.graph)||void 0===e?void 0:e.findOrCreateTag(n$._H)),await this.createNote({subject:t.name,document:(0,tB.FT)((0,e$.ct)(t,n))}))}async deleteAll(){await this.table.deleteAll()}async deleteNote(t){await this.deleteNotes([t])}async deleteNotes(t){await this.adapter.ensureSaved(()=>{for(let e of t)e.setDeletedAtDate(),e.disablePublic()}),await this.syncUp.saveMany(t.map(t=>t.id))}async destroyNote(t){await this.destroyNotes([t])}async destroyNotes(t){await this.syncUp.deleteMany(t.map(t=>t.id))}async createNote(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},{emptyList:e}=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},n=eW.j.build(t,{emptyList:e});return await this.adapter.addModel(n),n.changeManager.requestForceSave(),(0,el.j)("note_created",{daily:n.daily}),n}async findOrCreateBySubject(t){let e;let{subject:n,markdown:r}=t,i=await this.findBySubject(n);if(i)return i;if(r){let t=(0,tB.Y8)(r);e=(0,tB.FT)(tB.K3.doc([tB.K3.header(n),t]))}return await this.createNote({subject:n,document:e})}async findOrCreateDailyNoteByDate(t){let e=await this.ensureForDate(t);return e.changeManager.requestForceSave(),e}async updatePinnedIndexes(t){await (0,ta.sz)(t,async(t,e)=>{let n=await this.findById(t);return await (null==n?void 0:n.updatePinnedIndex(e))})}async togglePinned(t){await this.attachNote(t),await t.updatePinned(!t.pinned)}async togglePublish(t){await this.attachNote(t),await this.adapter.ensureSaved(()=>{t.togglePublic()}),t.changeManager.requestForceSave()}async attachNote(t){return(0,o.G_R)(t)||await this.adapter.addModel(t),t}requestRemount(t){for(let e of t){let t=this.adapter.getModelFromPool(e);null==t||t.requestRemount()}}ensureTodaysDailyNote(){return this.ensureForDate(new Date)}async ensureForDate(t){let e=(0,ti.l5)(t),n=await this.findById(e);if(n);else{var r;n=null!==(r=this.dailyStore.findGeneratedById(e))&&void 0!==r?r:this.buildForDate(t),await this.adapter.addModel(n)}return n}get noteDateFormat(){var t,e;return null!==(e=null===(t=this.rootStore)||void 0===t?void 0:t.preferenceStore.noteDateFormat)&&void 0!==e?e:"weekDayMonthYear"}buildForDate(t){let e=(0,ti.l5)(t),n=(0,tF.p6)(t,this.noteDateFormat),r=(0,e$.Xq)(n,{emptyList:!1});return eW.j.build({id:e,document:(0,tB.FT)(r),subject:n,daily:!0},{placeholder:!0,emptyList:!0})}handleReconnect(){this.assertChangeStore.savePendingChanges(this.assertGraph)}async createRecoveredNote(t){let{document:e,note:n}=t;if(!e)return!1;let r="Restored: ".concat(n.subject),i=(0,tB.hH)(e),a=(0,eC.M_)(i,r),o=eW.j.build({subject:r,document:(0,tB.FT)(a)});return await this.adapter.addModel(o),o}constructor(...t){super(...t),this.isDetached=!1,this.listeners=[],this.syncUpDebounce=2e3}}(0,i.gn)([a.computed],eV.prototype,"regularNotesEditedDescQuery",null),(0,i.gn)([a.computed],eV.prototype,"undeletedNotes",null),(0,i.gn)([a.computed],eV.prototype,"deletedNotesDesc",null),(0,i.gn)([a.computed],eV.prototype,"undeletedUnblankNotes",null),(0,i.gn)([a.computed],eV.prototype,"undeletedHasTaskNotesQuery",null),(0,i.gn)([a.computed],eV.prototype,"undeletedHasTaskNotes",null),(0,i.gn)([a.computed],eV.prototype,"regularNotes",null),(0,i.gn)([a.computed],eV.prototype,"regularNotesEditedDesc",null),(0,i.gn)([a.computed],eV.prototype,"notesEditedDesc",null),(0,i.gn)([a.computed],eV.prototype,"notesCreatedDesc",null),(0,i.gn)([a.computed],eV.prototype,"pinnedNotes",null),(0,i.gn)([a.computed],eV.prototype,"pinnnedNotesIndexAsc",null),(0,i.gn)([a.computed],eV.prototype,"regularNotesPinnedAscEditedDesc",null),(0,i.gn)([o.ZBq],eV.prototype,"deleteNote",null),(0,i.gn)([o.ZBq],eV.prototype,"createNote",null),eV=(0,i.gn)([(0,o.o4J)("NoteStore")],eV);var eW=n(87808),e$=n(65431),eX=n(39368),e0=n(85204);function e1(t,e){let n=e.map(t=>[t.value,t.page?"(p".concat(t.page,")"):null].join(" "));return(0,e$.Mr)(t,n)}let e3=async(t,e)=>{var n;let{graph:r}=e,i=r.noteStore,{book:a}=t.properties;if(!i)return;console.log("[".concat(r.id,"] syncing book"),a);let o=await (0,ta.sz)(null!==(n=a.authors)&&void 0!==n?n:[],async t=>{var e;let n=await i.findByTagAndSubject(n$.A3,t);return n||await i.createNote({subject:t,document:(0,tB.FT)((e=r.id,tB.K3.doc([tB.K3.header(t),tB.K3.list([tB.K3.listItem(tB.K3.paragraph([tB.K3.text("Type: "),tB.K3.tag({id:n$.A3,label:n$.A3,graphId:e})]))])])))})}),s=await i.findByAsin(a.asin)||eW.j.build({id:(0,L.O)(),subject:a.title,document:(0,tB.FT)(function(t){let{book:e,authorNotes:n,graphId:r}=t,i=e.notes.filter(t=>{let{type:e}=t;return"highlight"===e}),a=e.notes.filter(t=>{let{type:e}=t;return"note"===e}),o=e.authors.reduce((t,r,i)=>{let a=i===e.authors.length-1,o=n.find(t=>t.subject===r);return a?[...t,tB.K3.backlink({id:o.id,label:r})]:[...t,tB.K3.backlink({id:o.id,label:r}),tB.K3.text(", ")]},[]);return tB.K3.doc([tB.K3.header(e.title),tB.K3.list([tB.K3.listItem(tB.K3.paragraph([tB.K3.text("Type: "),tB.K3.tag({id:n$.ps,label:n$.ps,graphId:r})])),tB.K3.listItem(tB.K3.paragraphText("ASIN: ".concat(e.asin))),tB.K3.listItem(tB.K3.paragraph([tB.K3.text("Authors: "),...o])),e1("Highlights",i),e1("Notes",a)])])}({book:a,authorNotes:o,graphId:r.id}))});s.noteStore||(await i.adapter.addModel(s),s.changeManager.requestForceSave()),s.changeManager.modifyDocument(t=>{var e;return function(t,e){let n=e.filter(t=>"highlight"===t.type).map(t=>[t.value,t.page?"(p".concat(t.page,")"):null].join(" ")),r=e.filter(t=>"note"===t.type).map(t=>[t.value,t.page?"(p".concat(t.page,")"):null].join(" "));return(0,tB.Ne)(t,t=>{(0,tB.n8)(t,"Highlights",n),(0,tB.n8)(t,"Notes",r)})}(t,null!==(e=a.notes)&&void 0!==e?e:[])}),function(t){t.findOrCreateTag(n$.ps)}(r)};var e4=n(52785);async function e5(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},{matchByLabel:n}=e,r=t.assertNoteStore,i=r.assertRootStore.contactStore;await t.changeManager.modifyDocumentAsync(t=>(0,tB.rM)(t,t=>(0,e4.V)({noteStore:r,contactStore:i,backlink:t,matchByLabel:n})))}let e6=RegExp("^https?:\\/\\/(?:[^.]+\\.)?(?:twitter|x)\\.com\\/(?:#!\\/)?(?<user_id>[\\w/]+)\\/status(?:es)?\\/(?<tweet_id>\\d+).*"),e2="Description:";function e8(t,e){return tB.K3.listItem(function(t,e){if(!t)return[tB.K3.paragraphText(e2)];let n=(0,tB.Y8)(t,e),r=(0,tB._u)(n);if(1!==r.length||r[0].type.name!==tB.e3)return[tB.K3.paragraphText(e2),...r];{let t=r[0],e=tB.K3.text(e2+" ");return[t.copy(t.content.addToStart(e)),...r.slice(1)]}}(null!=t?t:"",e))}async function e7(t){let{document:e,linkNote:n,onBacklinkAdd:r}=t,i={id:n.id,label:n.subject,graphId:n.graphId},a=await r({id:"",label:"Links"});return(0,tB.Ne)(e,t=>{let e=tB.K3.paragraph(tB.K3.backlink(a)).content,n=tB.K3.listItem(tB.K3.paragraph([tB.K3.backlink(i)]));(0,tB.DA)(t,e,[n],{position:"top"})})}async function e9(t){let{document:e,tweetUrl:n,onBacklinkAdd:r}=t,i=await r({id:"",label:"Tweets"});return(0,tB.Ne)(e,t=>{let e=tB.K3.paragraph(tB.K3.backlink(i)).content,r=tB.K3.tweet({url:n}),a=tB.K3.listItem([r]);(0,tB.DA)(t,e,[a],{position:"top"})})}async function nt(t,e,n,r){var i,a,o,s,l,c;let d=t.noteStore,u=e.contactStore,h=t=>(0,e4.V)({noteStore:d,contactStore:u,backlink:t,matchByLabel:!0}),p={onBacklinkAdd:tB.uu,onTagAdd:e=>t.onTagAdd(e)},g=(0,tB.FT)((l=t.id,tB.K3.doc([tB.K3.header(null!==(c=n.title)&&void 0!==c?c:""),function(t,e,n){var r,i,a;let o=[...(null!==(r=t.offset_highlights)&&void 0!==r?r:[]).map(t=>t.text),...null!==(i=t.highlights)&&void 0!==i?i:[]];return tB.K3.list([tB.K3.listItem(tB.K3.paragraph([tB.K3.text("URL: "),tB.K3.link(t.url,t.url)])),e8(null!==(a=t.description)&&void 0!==a?a:"",n),tB.K3.listItem([tB.K3.paragraph([tB.K3.text("Type: "),tB.K3.tag({id:n$.mt,label:n$.mt,graphId:e})])]),(0,e$.Mr)("Highlights",o)])}(n,l,p)]))),m="link-".concat(null!==(i=n.id)&&void 0!==i?i:(0,L.O)()),y=await d.findById(m),f=await d.findByUrl(n.url),v=y||f||eW.j.build({id:m,subject:null!==(a=n.title)&&void 0!==a?a:function(t){try{return new URL(t).hostname}catch(t){return null}}(n.url),document:g});v.noteStore||(await d.adapter.addModel(v),v.changeManager.requestForceSave());let w=[...(null!==(o=n.offset_highlights)&&void 0!==o?o:[]).map(t=>t.text),...null!==(s=n.highlights)&&void 0!==s?s:[]];v.changeManager.modifyDocument(t=>(function(t,e){let n=tB.K3.paragraphText("Highlights").content,r=(0,e$.Jr)(e);return(0,tB.Ne)(t,t=>{(0,tB.DA)(t,n,r)})})(t,w)),v.changeManager.modifyDocument(t=>{var e,r;return(r=null!==(e=n.description)&&void 0!==e?e:"")?(0,tB.Ne)(t,t=>{(0,tB.lW)(t,e2,e8(null!=r?r:"",p))}):t}),await e5(v);let b=await d.ensureForDate(r);await b.changeManager.modifyDocumentAsync(t=>e7({document:t,linkNote:v,onBacklinkAdd:h})),await t.findOrCreateTag(n$.mt)}async function ne(t){let{graph:e,link:n,operationCreatedAt:r}=t,i=e.noteStore,a=i.assertRootStore.contactStore,o=await i.ensureForDate(r),s=t=>(0,e4.V)({noteStore:i,contactStore:a,backlink:t,matchByLabel:!0});await o.changeManager.modifyDocumentAsync(async t=>await e9({document:t,tweetUrl:n.url,onBacklinkAdd:s}))}let nn="readwise";async function nr(t,e){if(!t)return[];let n=t.split(",").map(t=>t.trim()),r=e.noteStore;return(0,ta.sz)(n,async t=>{var n;let i=await r.findByTagAndSubject(n$.A3,t);return i||r.createNote({subject:t,document:(n=e.id,tB.K3.doc([tB.K3.header(t),tB.K3.list([tB.K3.listItem(tB.K3.paragraph([tB.K3.text("Type: "),tB.K3.tag({id:n$.A3,label:n$.A3,graphId:n})]))])])).toJSON()})})}async function ni(t,e){let n=e.noteStore;return await Promise.all(t.map(t=>n.findOrCreateBySubject({subject:t})))}function na(t){return t.map(t=>t.name.replace(/^#/,""))}async function no(t){let{noteStore:e,noteId:n,syncItem:r,graph:i}=t,a=await e.findById(n);if(!a&&r.asin){var o;a=null!==(o=await e.findByAsin(r.asin))&&void 0!==o?o:null}if(!a){let t=await nr(r.author,i),e=await ni(na(r.tags),i),o=function(t){let{graphId:e,title:n,asin:r,readwiseUrl:i,category:a,documentNote:o,authorNotes:s,tagNotes:l}=t,c=function(t){let{graphId:e,category:n,tagNotes:r}=t,i=[tB.K3.tag({id:nn,label:nn,graphId:e})];switch(n){case"books":i.push(tB.K3.tag({id:n$.ps,label:n$.ps,graphId:e}));break;case"articles":i.push(tB.K3.tag({id:n$.c4,label:n$.c4,graphId:e}));break;case"tweets":i.push(tB.K3.tag({id:n$.R0,label:n$.R0,graphId:e}));break;case"podcasts":i.push(tB.K3.tag({id:n$.UC,label:n$.UC,graphId:e}))}for(let t of r)i.push(tB.K3.backlink({id:t.id,label:t.subject,graphId:e}));for(let t=i.length-1;t>0;t--)i.splice(t,0,tB.K3.text(" "));return i}({graphId:e,category:a,tagNotes:l}),d=function(t){let{graphId:e,authorNotes:n}=t;return n.reduce((t,r,i)=>i===n.length-1?[...t,tB.K3.backlink({id:r.id,label:r.subject,graphId:e})]:[...t,tB.K3.backlink({id:r.id,label:r.subject,graphId:e}),tB.K3.text(", ")],[])}({graphId:e,authorNotes:s});return tB.K3.doc([tB.K3.header(null!=n?n:""),tB.K3.list([tB.K3.listItem(tB.K3.paragraph([tB.K3.text("Type: "),...c])),i?tB.K3.listItem(tB.K3.paragraph([tB.K3.text("URL: "),tB.K3.link(i,i)])):null,r?tB.K3.listItem(tB.K3.paragraph([tB.K3.text("ASIN: "),tB.K3.text(r)])):null,d.length>0?tB.K3.listItem(tB.K3.paragraph([tB.K3.text("Author: "),...d])):null,o?tB.K3.listItem(tB.K3.paragraph([tB.K3.text(o)])):null].filter(ta.Dw))])}({graphId:i.id,title:r.title,asin:r.asin,source:r.source,readwiseUrl:r.readwise_url,category:r.category,documentNote:r.document_note,authorNotes:t,tagNotes:e});a=eW.j.build({id:n,subject:r.title,document:o.toJSON()})}return a.noteStore||(e.adapter.addModel(a),a.changeManager.requestForceSave()),a}async function ns(t){let{note:e,syncItem:n,graph:r}=t,i=await Promise.all(n.highlights.map(async t=>{let e=na(t.tags),n=await ni(e,r);return{...t,notes:n}}));e.changeManager.modifyDocument(t=>(function(t){let{node:e,highlights:n,graphId:r}=t;return(0,tB.Ne)(e,t=>{(function(t){var e;let{ctx:n,listName:r,highlights:i,graphId:a}=t,o=(e=n.tr.doc,(0,tB.nv)(e).filter(t=>t.startsWith("https://readwise.io/open/")).map(t=>t.split("/").pop()).filter(ta.Dw)),s=i.filter(t=>!o.includes(t.id));(0,tB.WJ)(n,r),(0,tB.tW)(n,r,s.map(t=>(function(t,e){var n;let r=function(t){let e=[];return(0,tB.Y8)(t).descendants(t=>{if(t.isTextblock)return e.push(t),!1}),0===e.length&&e.push(tB.K3.paragraph([])),[tB.e3,tB.tw].includes(e[0].type.name)||(e[0]=tB.K3.paragraph(e[0].content)),e}(t.text),i=r[r.length-1],a=tB.K3.link(["Loc",t.location].filter(ta.Dw).join(" "),t.readwise_url),o=(null!==(n=t.notes)&&void 0!==n?n:[]).map(t=>tB.K3.backlink({id:t.id,label:t.subject,graphId:e}));for(let t=o.length-1;t>0;t--)o.splice(t,0,tB.K3.text(" "));if(o.length>0&&o.unshift(tB.K3.text(" ")),i.type.name===tB.e3){let t=tB.K3.paragraph([tB.K3.text(" ["),a,tB.K3.text("]"),...o]),e=i.copy(i.content.append(t.content));r[r.length-1]=e}else{let t=tB.K3.paragraph([tB.K3.text("["),a,tB.K3.text("]"),...o]);r.push(t)}return t.note&&r.push(tB.K3.listItem(tB.K3.paragraphText(t.note))),tB.K3.listItem(r)})(t,a)))})({ctx:t,highlights:n,listName:"Highlights",graphId:r})})})({node:t,highlights:i,graphId:r.id}))}async function nl(t){let{syncItem:e,noteStore:n,note:r,operationCreatedAt:i}=t,a=function(t){switch(t){case"books":return"Books";case"articles":return"Articles";case"tweets":return"Tweets";case"podcasts":return"Podcasts";default:return"Readwise"}}(e.category);(await n.ensureForDate(i)).changeManager.modifyDocument(t=>(function(t,e,n){let r={id:e.id,label:e.subject,graphId:e.graphId};return(0,tB.Ne)(t,t=>{let e=tB.K3.listItem(tB.K3.paragraph([tB.K3.backlink(r)]));(0,tB.kv)(t,n,[e],{position:"top"})})})(t,r,a))}let nc={"list-append":async(t,e)=>{let n,{graph:r,logger:i}=e,a=r.noteStore,{text:o,list_name:s}=t.properties,l=t.properties.note_id;if(!o){i.warn("No text to append to list");return}let c=(0,ti.cB)(l);if(c)n=await a.ensureForDate(c);else{var d;n=null!==(d=await a.findById(l))&&void 0!==d?d:void 0}if(!n)throw Error("Note ".concat(l," not found"));n.changeManager.requestForceSave();let u=t=>r.onTagAdd(t);n.changeManager.modifyDocument(t=>(0,eC.GQ)({node:t,listName:null!=s?s:void 0,text:o,onBacklinkAdd:tB.uu,onTagAdd:u})),await e5(n,{matchByLabel:!0})},"readwise-sync":async(t,e)=>{var n,r;let{graph:i}=e;(0,eo.hu)("readwise-sync"===t.type);let a=i.noteStore,o=t.properties,s="readwise-".concat(o.id),l=null!==(r=null===(n=t.created_at)||void 0===n?void 0:n.toDate())&&void 0!==r?r:new Date,c=await no({noteStore:a,noteId:s,syncItem:o,graph:i});await ns({note:c,syncItem:o,graph:i}),await nl({syncItem:o,noteStore:a,note:c,operationCreatedAt:l}),function(t){for(let e of[nn,n$.ps,n$.c4,n$.UC,n$.R0])t.findOrCreateTag(e)}(i)},"link-create":async(t,e)=>{var n,r,i,a;let{graph:o,logger:s,rootStore:l}=e,{link:c}=t.properties,d=null!==(r=null===(n=t.created_at)||void 0===n?void 0:n.toDate())&&void 0!==r?r:new Date;if(s.info("Syncing link",{link:c}),!c.url){s.warn("Link without URL",{link:c});return}!function(t){var e,n,r,i;e6.lastIndex=0;let a=e6.exec(t);if(!a)return null;let o=null!==(r=null===(e=a.groups)||void 0===e?void 0:e.tweet_id)&&void 0!==r?r:"",s=null!==(i=null===(n=a.groups)||void 0===n?void 0:n.user_id)&&void 0!==i?i:"";return o?{tweetId:o,userId:s}:null}(c.url)||(null===(i=c.highlights)||void 0===i?void 0:i.length)||(null===(a=c.offset_highlights)||void 0===a?void 0:a.length)||c.description?await nt(o,l,c,d):await ne({graph:o,link:c,operationCreatedAt:d})},"book-sync":e3};var nd=n(53414);async function nu(t){let e=(0,d.CF)({db:u.db,graphId:t.graphId}),n=(0,d.IO)(e,(0,d.ZB)("synced_at","==",null),(0,d.b9)(t.limit));return(await (0,d.PL)(n)).docs.map(t=>({...t.data(),id:t.id}))}async function nh(t){let{graphId:e,operationId:n}=t,r=(0,d._J)({db:u.db,graphId:e,noteOperationId:n});await (0,d.oe)(r)}async function np(t){let{operationIds:e,graphId:n,logger:r}=t,i=e.map(t=>(0,d._J)({db:u.db,graphId:n,noteOperationId:t}));return await h.RZ.runTransaction(u.db,async t=>{let e=[];for(let n of i){let i=await t.get(n);if(!i.exists())continue;let a=i.data();if(!a.synced_at){if(!nc[a.type]){let t="object"==typeof a?{...a,properties:"hidden_"+typeof a.properties}:typeof a;a.type||r.warn("No callback for operation ".concat(n.id," ").concat(JSON.stringify(t)));continue}e.push(n)}}for(let n of e)t.update(n,{synced_at:nd.Timestamp.now()});return e.map(t=>t.id)})}async function ng(t){for(let e=0;e<50;e++){let e=await nu({graphId:t.id,limit:10});if(0===e.length||(await nm(t,e),e.length<10))break}}async function nm(t,e){let n;let r=t.id,i=t.assertRootStore,a=e.map(t=>t.id);if(0===a.length)return;let o=t.logger.child({operationIds:a.join(",")});o.info("Syncing operation");try{n=await np({graphId:r,operationIds:a,logger:o})}catch(t){o.info("Failed to obtain sync lock for operation",{reason:null==t?void 0:t.message});return}for(let a of(o.info("Obtained sync lock for operation"),e))if(n.includes(a.id))try{let e=nc[a.type];await e(a,{graph:t,logger:o,rootStore:i}),o.info("Successfully synced operation"),await nh({graphId:r,operationId:a.id})}catch(t){o.error("Failed to sync operation",{reason:null==t?void 0:t.message}),(0,eJ.Tb)(t)}}class ny extends(0,o.Hnr)({}){get graph(){return(0,c.w0)(this)}onAttachedToRootStore(){return this.setupSnapshotListenerWhenReady(),()=>this.beforeDetach()}async setupSnapshotListenerWhenReady(){await (0,a.when)(()=>this.graph.storesReadyAndNotesOnline),this.snapshotListener=new e0.F({onCreate:t=>(function(t){let e,n,{graph:r,onError:i}=t,a=async()=>await ng(r),o=tq()((e=!1,n=!1,async()=>{if(n=!0,!e)for(e=!0;n;){n=!1;try{await a()}catch(t){throw t}finally{e=!1}}}),5e3);return function(t){let{graphId:e,onUpdate:n,onError:r}=t,i=(0,d.CF)({db:u.db,graphId:e}),a=(0,d.IO)(i,(0,d.ZB)("synced_at","==",null));return h.RZ.onSnapshot(a,n,t=>{(0,eJ.Tb)(t),console.error("Error in operation snapshot listener: ".concat(t.message)),r(t)})}({graphId:r.id,onUpdate:()=>void o(),onError:i,logger:r.logger})})({graph:this.graph,onError:t})})}beforeDetach(){var t;return null===(t=this.snapshotListener)||void 0===t||t.dispose(),(0,l.$)(this.listeners)}constructor(...t){super(...t),this.listeners=[]}}ny=(0,i.gn)([(0,o.o4J)("OperationStore")],ny);var nf=n(28179),nv=n(33964),nw=n(32137);class nb extends(0,o.Hnr)({dateFormat:(0,o.vgT)(()=>nw.t6.MonthDayYear).withSetter(),downloadPrompt:(0,o.vgT)(!0).withSetter(),labs:(0,o.vgT)(!1).withSetter(),shortcutPrompt:(0,o.vgT)(!0).withSetter(),spellCheck:(0,o.vgT)(!0).withSetter(),theme:(0,o.vgT)("system").withSetter(),timeFormat:(0,o.vgT)(()=>nw.zt.Hours12).withSetter(),transcriptionPrompt:(0,o.vgT)("").withSetter(),weekStart:(0,o.vgT)(()=>nw.L8.Monday).withSetter(),aiProvider:(0,o.vgT)(null).withSetter(),openaiApiKeyExcerpt:(0,o.vgT)("").withSetter(),anthropicApiKeyExcerpt:(0,o.vgT)("").withSetter(),transcriptionLanguage:(0,o.vgT)("auto").withSetter(),transcriptionFormat:(0,o.vgT)(!0).withSetter(),keyboardLayout:(0,o.vgT)("auto").withSetter(),editorSize:(0,o.vgT)("sm").withSetter(),hasSynced:(0,o.vgT)(!1).withSetter()}){get rootStore(){return(0,o.G_R)(this)}get selectedGraph(){var t;if(this.selectedGraphId)return null===(t=this.rootStore)||void 0===t?void 0:t.graphStore.findById(this.selectedGraphId)}get noteDateFormat(){return(0,tF.$X)(this.dateFormat)}get openaiApiKeyWithFallback(){return this.openaiApiKey||this.openaiApiKeyExcerptFormatted}get openaiApiKeyExcerptFormatted(){return this.openaiApiKeyExcerpt?"sk-".concat("****-".repeat(3)).concat(this.openaiApiKeyExcerpt):""}get anthropicApiKeyWithFallback(){return this.anthropicApiKey||this.anthropicApiKeyExcerptFormatted}get anthropicApiKeyExcerptFormatted(){return this.anthropicApiKeyExcerpt?"sk-".concat("****-".repeat(3)).concat(this.anthropicApiKeyExcerpt):""}setOpenaiApiKey(t){this.openaiApiKey=t}setAnthropicApiKey(t){this.anthropicApiKey=t}setScreen(t){this.screen=t}setSelectedGraph(t){this.selectedGraphId=t.id}setSelectedGraphId(t){this.selectedGraphId=t}hideDownloadPrompt(){this.downloadPrompt=!1}hideShortcutPrompt(){this.shortcutPrompt=!1}updateDateFormat(t){this.setDateFormat(t),(0,nv.Oh)({dateFormat:t})}updateWeekStart(t){this.setWeekStart(t),(0,nv.Oh)({weekStart:t})}updateTimeFormat(t){this.setTimeFormat(t),(0,nv.Oh)({timeFormat:t})}updateSpellCheck(t){this.setSpellCheck(t),(0,nv.Oh)({spellCheck:t})}updateLabs(t){this.setLabs(t),(0,nv.Oh)({labs:t})}updateTranscriptionPrompt(t){this.setTranscriptionPrompt(t),(0,nv.Oh)({transcriptionPrompt:t})}updateTranscriptionLanguage(t){this.setTranscriptionLanguage(t),(0,nv.Oh)({transcriptionLanguage:t})}updateTranscriptionFormat(t){this.setTranscriptionFormat(t),(0,nv.Oh)({transcriptionFormat:t})}updateAiProvider(t){this.setAiProvider(t),(0,nv.Oh)({aiProvider:t})}updateOpenaiApiKey(t){this.setOpenaiApiKey(t),this.setOpenaiApiKeyExcerpt(t.slice(-4)),(0,nv.mD)({openaiApiKey:t})}updateAnthropicApiKey(t){this.setAnthropicApiKey(t),this.setAnthropicApiKeyExcerpt(t.slice(-4)),(0,nv.mD)({anthropicApiKey:t})}setPreferences(t){t.timeFormat&&this.setTimeFormat(t.timeFormat),t.dateFormat&&this.setDateFormat(t.dateFormat),t.weekStart&&this.setWeekStart(t.weekStart),"boolean"==typeof t.spellCheck&&this.setSpellCheck(t.spellCheck),"boolean"==typeof t.labs&&this.setLabs(t.labs),"string"==typeof t.transcriptionPrompt&&this.setTranscriptionPrompt(t.transcriptionPrompt),"string"==typeof t.transcriptionLanguage&&this.setTranscriptionLanguage(t.transcriptionLanguage),"boolean"==typeof t.transcriptionFormat&&this.setTranscriptionFormat(t.transcriptionFormat),"string"==typeof t.aiProvider&&this.setAiProvider(t.aiProvider),"string"==typeof t.openaiApiKeyExcerpt&&this.setOpenaiApiKeyExcerpt(t.openaiApiKeyExcerpt),"string"==typeof t.anthropicApiKeyExcerpt&&this.setAnthropicApiKeyExcerpt(t.anthropicApiKeyExcerpt),this.setHasSynced(!0)}onAttachedToRootStore(){return this.listeners.push((0,nv.Mo)((t,e)=>{var n;let r=(0,nv.sL)(null!==(n=e.preferences)&&void 0!==n?n:null);this.setPreferences(r)})),()=>this.beforeDetach()}beforeDetach(){return(0,l.$)(this.listeners)}constructor(...t){super(...t),this.screen=tr.JY.Profile,this.selectedGraphId=null,this.openaiApiKey="",this.anthropicApiKey="",this.getKeyboardLayoutMap=()=>"auto"===this.keyboardLayout?null:nf[this.keyboardLayout],this.listeners=[]}}(0,i.gn)([a.observable],nb.prototype,"screen",void 0),(0,i.gn)([a.observable],nb.prototype,"selectedGraphId",void 0),(0,i.gn)([a.observable],nb.prototype,"openaiApiKey",void 0),(0,i.gn)([a.observable],nb.prototype,"anthropicApiKey",void 0),(0,i.gn)([a.computed],nb.prototype,"noteDateFormat",null),(0,i.gn)([a.action],nb.prototype,"setOpenaiApiKey",null),(0,i.gn)([a.action],nb.prototype,"setAnthropicApiKey",null),(0,i.gn)([a.action],nb.prototype,"setScreen",null),(0,i.gn)([a.action],nb.prototype,"setSelectedGraph",null),(0,i.gn)([a.action],nb.prototype,"setSelectedGraphId",null),(0,i.gn)([o.ZBq],nb.prototype,"hideDownloadPrompt",null),(0,i.gn)([o.ZBq],nb.prototype,"hideShortcutPrompt",null),nb=(0,i.gn)([(0,o.o4J)("PreferenceStore")],nb);let nS=window.navigator,nk=[["auto",(null==nS?void 0:null===(r=nS.keyboard)||void 0===r?void 0:r.getLayoutMap)?"Auto detect":"Default (US)"],...["Danish","Dvorak","Finnish","French","German","Italian","LatinAmerican","Norwegian","Portuguese","Slovak","Spanish","SwissFrench","SwissGerman","US"].map(t=>[t,t.replace(/([a-z])([A-Z])/g,"$1 $2")])];var nI=n(74436);class nN extends(0,o.Hnr)({id:o.UB4,label:(0,o.vgT)("").withSetter(),template:(0,o.vgT)("").withSetter()}){}nN=(0,i.gn)([(0,o.o4J)("PromptTemplate")],nN);class nx extends(0,o.Hnr)({templates:(0,o.vgT)(()=>[])}){setTemplates(t){this.templates=t}setTemplatesFromDb(t){let e=t.map(t=>new nN(t));this.setTemplates(e)}onAttachedToRootStore(){return this.listeners.push((0,nI.ln)(t=>this.setTemplatesFromDb(t))),()=>this.beforeDetach()}beforeDetach(){return(0,l.$)(this.listeners)}constructor(...t){super(...t),this.listeners=[]}}(0,i.gn)([o.ZBq],nx.prototype,"setTemplates",null),nx=(0,i.gn)([(0,o.o4J)("PromptTemplateStore")],nx);var nT=n(88957);function nD(t){let{row:e,adapter:n,assetTextMap:r}=t,i=n.pool.get(e.id);if(i){let t=i.editedDocumentNode,e=t?(0,tB.kB)(t):"",n=[t?(0,tB.Oj)(t):"",...i.assetIds.map(t=>r.get(t)).filter(ta.Dw)].join(" ");return{id:i.id,subject:e,line:n,enrichmentText:(0,to.a1)(i.enrichment),editedAt:i.editedOrUpdatedAt}}{var a,o;let t=(0,eN.Jg)(e.systemMetadata),n=(0,eN.wL)(e.document),i=null==t?void 0:null===(a=t.data)||void 0===a?void 0:a.enrichment,s=(0,to.a1)(i),l=null==n?void 0:n.data,c=[l?(0,tB.nM)(l):"",...(l?(0,nT.AP)(l):[]).map(t=>r.get(t)).filter(ta.Dw)].join(" ");return{id:e.id,subject:e.subject,line:c,enrichmentText:s,editedAt:null!==(o=e.editedAt)&&void 0!==o?o:e.updatedAt}}}var nA=n(50959);let nC=(0,nA.createContext)(void 0),n_=nC.Provider;function nM(){let t=(0,nA.useContext)(nC);if(!t)throw Error("useRootStore must be used within a RootStoreProvider");return t}function nE(){let{noteStore:t}=nM();if(!t)throw Error("blank noteStore");return t}function nF(){let{userStore:t}=nM();return t}function nU(){let{userStore:t}=nM();return t.currentUser}function nB(){let{graphStore:t}=nM(),e=t.currentGraph;if(!e)throw Error("blank graph");return e}function nR(){let{contactStore:t}=nM();return t}function nj(){let{preferenceStore:t}=nM();return t}function nP(){var t;let{preferenceStore:e}=null!==(t=function(){let t=(0,nA.useContext)(nC);return null!=t?t:null}())&&void 0!==t?t:{};return null!=e?e:null}function nO(){let{credentialStore:t}=nM();return t}function nL(){let{graphStore:t}=nM();return t}function nK(){let{bookStore:t}=nM();if(!t)throw Error("blank bookStore");return t}function nG(){let{meetingStore:t}=nM();return t}function nq(){let{promptTemplateStore:t}=nM();return t}function nZ(){let{historyStore:t}=nM();return t}function nH(){let{dailyEditorView:t}=nE();return t}function nJ(){let{primaryEditorView:t}=nE();return t}function nQ(){let{secondaryEditorView:t}=nE();return t}function nY(){let{mainView:t}=nM();return t}function nz(){let{uiStateStore:t}=nM();return t}function nV(){let{taskFilterStore:t}=nM();return t}function nW(){let{notesMapFilterStore:t}=nM();return t}n(22341);var n$=n(28407),nX=n(84769),n0=n(66376);class n1 extends(0,o.Hnr)({id:o.UB4,name:(0,o.vgT)("").withSetter(),document:(0,o.vgT)().withTransform((0,n0.N)()).withSetter(),createdAt:(0,o.vgT)(()=>new Date().getTime())}){get contentTemplate(){var t;return{id:this.id,name:this.name,document:null!==(t=this.document)&&void 0!==t?t:{type:"doc"}}}get assertStore(){let t=(0,c.w0)(this);return(0,c.w0)(t)}async setRemote(){return await (0,nX.zX)(this.assertGraph,this)}async destroy(){await this.assertStore.destroyTemplate(this)}get assertGraph(){return this.assertStore.assertGraph}}(0,i.gn)([a.computed],n1.prototype,"contentTemplate",null),n1=(0,i.gn)([(0,o.o4J)("Template")],n1);class n3 extends(0,o.Hnr)({templates:(0,o.vgT)(()=>[])}){get contentTemplates(){return this.templatesSortedByNameAsc.filter(t=>t.name).map(t=>t.contentTemplate)}get templatesSortedByNameAsc(){return Y()(this.templates,t=>t.name,"asc")}get templatesSortedByCreatedAtDesc(){return Y()(this.templates,t=>t.createdAt,"desc")}addBlankTemplate(){this.templates.push(new n1({}))}addTemplate(t){this.templates.push(t)}setTemplates(t){this.templates=t}async reEncryptTemplates(){await (0,nX.OG)(this.assertGraph,this.templates)}async destroyTemplate(t){(0,o.ogt)(t),await (0,nX.Xc)(this.assertGraph,t.id)}get graph(){return(0,o.G_R)(this)}get assertGraph(){return(0,c.wi)(this,"graph")}onAttachedToRootStore(){let t=(0,a.autorun)(()=>{var e;(null===(e=this.graph)||void 0===e?void 0:e.readyToInitStores)&&(this.listeners.push((0,nX.ij)(this.assertGraph,t=>this.setTemplates(t))),t())});return this.listeners.push(t),()=>this.beforeDetach()}beforeDetach(){return(0,l.$)(this.listeners)}constructor(...t){super(...t),this.listeners=[]}}(0,i.gn)([a.computed],n3.prototype,"contentTemplates",null),(0,i.gn)([a.computed],n3.prototype,"templatesSortedByNameAsc",null),(0,i.gn)([a.computed],n3.prototype,"templatesSortedByCreatedAtDesc",null),(0,i.gn)([o.ZBq],n3.prototype,"addBlankTemplate",null),(0,i.gn)([o.ZBq],n3.prototype,"addTemplate",null),(0,i.gn)([o.ZBq],n3.prototype,"setTemplates",null),n3=(0,i.gn)([(0,o.o4J)("TemplateStore")],n3);var n4=n(25333),n5=n(27691),n6=n(89300),n2=n.n(n6),n8=n(24465),n7=n.n(n8),n9=n(94242),rt=n(44719);class re extends(0,o.Hnr)({id:o.UB4,name:(0,o.vgT)(),email:(0,o.vgT)(),photoUrl:(0,o.vgT)(),graphIds:(0,o.vgT)().withSetter(),traits:(0,o.vgT)(()=>({})),flags:(0,o.vgT)(()=>[]),stripeSubscriptionId:(0,o.vgT)(),stripeSubscriptionProductId:(0,o.vgT)(),stripeSubscriptionStatus:(0,o.vgT)(),trialLengthDays:(0,o.vgT)(),trialStartedAt:(0,o.vgT)()}){onAttachedToRootStore(){this.attachFirebaseDebugListener(),this.attachLoggerTransmitListener()}async beforeDetach(){await (0,l.$)(this.listeners)}update(t,e){var n,r,i,a,o,s,l,c,d;if(this.graphIds=null!==(n=e.graph_ids)&&void 0!==n?n:this.graphIds,"name"in e&&(this.name=null!==(r=e.name)&&void 0!==r?r:void 0),"email"in e&&(this.email=null!==(i=e.email)&&void 0!==i?i:void 0),this.photoUrl=null!==(a=t.photoURL)&&void 0!==a?a:this.photoUrl,e.traits&&this.mergeTraits((0,nv.xH)(e.traits)),"flags"in e&&(this.flags=null!==(o=e.flags)&&void 0!==o?o:[]),"stripe_subscription_id"in e&&(this.stripeSubscriptionId=null!==(s=e.stripe_subscription_id)&&void 0!==s?s:void 0),"stripe_subscription_product_id"in e&&(this.stripeSubscriptionProductId=null!==(l=e.stripe_subscription_product_id)&&void 0!==l?l:void 0),"stripe_subscription_status"in e){let t=(0,n9.g)(nw.ux,e.stripe_subscription_status);this.stripeSubscriptionStatus=t}"trial_started_at"in e&&(this.trialStartedAt=null===(c=e.trial_started_at)||void 0===c?void 0:c.toMillis()),"trial_length_days"in e&&(this.trialLengthDays=null!==(d=e.trial_length_days)&&void 0!==d?d:void 0),this.graphIds&&0===this.graphIds.length&&(this.needsSetup=!0)}get ready(){return!!this.graphIds}get givenName(){if(!this.name)return;let[t]=this.name.split(/\s/,2);return t}get familyName(){if(!this.name)return;let[,t]=this.name.split(/\s/,2);return t}get initials(){if(this.givenName&&this.familyName)return"".concat(this.givenName[0]).concat(this.familyName[0]).toUpperCase()}get isPayingCustomer(){return!!this.stripeSubscriptionId}get inGoodStanding(){return"trialing"===this.subscriptionStatus||"active"===this.subscriptionStatus||"paymentRequired"===this.subscriptionStatus}get subscriptionStatus(){if(this.trialInGoodStanding)return"trialing";switch(this.stripeSubscriptionStatus){case nw.ux.Trialing:return"trialing";case nw.ux.Active:return"active";case nw.ux.PastDue:case nw.ux.Incomplete:return"paymentRequired";default:return"missing"}}get isTrialing(){return!this.stripeSubscriptionId&&!!this.trialStartedAt}get trialDaysSpent(){return this.trialStartedAt?Math.abs((0,n5.Z)((0,es.zO)(),this.trialStartedAt)):0}get trialDaysLeft(){var t;let e=(null!==(t=this.trialLengthDays)&&void 0!==t?t:0)-this.trialDaysSpent;return e<0?0:e}get trialInGoodStanding(){return!!this.trialStartedAt&&this.trialDaysLeft>0}async updatePhoto(t){let e=URL.createObjectURL(t);this.setPhotoUrl(e),await (0,nv.tU)(this.id,t)}async updateTraits(t){this.mergeTraits(t),await (0,nv.CG)(this.id,this.traits)}mergeTraits(t){this.traits={...this.traits,...n7()(t,n2())}}setPhotoUrl(t){this.photoUrl=t}async setName(t){this.name=t,await (0,nv.gh)(t)}setNeedsSetup(t){this.needsSetup=t}attachFirebaseDebugListener(){let t=(0,a.reaction)(()=>this.flags.includes("firestore_debug_loglevel"),t=>(function(t){let e=t?"debug":"error";h.RZ.setLogLevel(e),console.log("Updated Firebase log level: ".concat(e))})(t),{fireImmediately:!0});this.listeners.push(t)}attachLoggerTransmitListener(){let t=(0,a.reaction)(()=>this.flags.includes("transmit_logs"),t=>{rt.k.setTransmit(t),console.log("Updated logger transmit: ".concat(t))},{fireImmediately:!0});this.listeners.push(t)}constructor(...t){super(...t),this.listeners=[],this.needsSetup=!1}}(0,i.gn)([a.observable],re.prototype,"needsSetup",void 0),(0,i.gn)([o.ZBq],re.prototype,"update",null),(0,i.gn)([a.computed],re.prototype,"ready",null),(0,i.gn)([a.computed],re.prototype,"givenName",null),(0,i.gn)([a.computed],re.prototype,"familyName",null),(0,i.gn)([a.computed],re.prototype,"initials",null),(0,i.gn)([a.computed],re.prototype,"trialDaysSpent",null),(0,i.gn)([a.computed],re.prototype,"trialDaysLeft",null),(0,i.gn)([a.computed],re.prototype,"trialInGoodStanding",null),(0,i.gn)([o.ZBq],re.prototype,"updateTraits",null),(0,i.gn)([o.ZBq],re.prototype,"setPhotoUrl",null),(0,i.gn)([o.ZBq],re.prototype,"setName",null),(0,i.gn)([a.action],re.prototype,"setNeedsSetup",null),re=(0,i.gn)([(0,o.o4J)("User")],re);class rn extends(0,o.Hnr)({currentUser:(0,o.vgT)(null),authUserReceived:(0,o.vgT)(!1),authUserUID:(0,o.vgT)(null)},{toSnapshotProcessor:t=>{let{currentUser:e}=t;return{currentUser:e}}}){onAttachedToRootStore(){return this.listeners.push((0,tI.Aj)(this.handleAuthChanged),(0,nv.Mo)(this.handleUserSnapshot)),()=>this.beforeDetach()}beforeDetach(){return(0,l.$)(this.listeners)}get needsAuth(){return!this.authUserUID&&this.authUserReceived}get signedIn(){return!this.needsAuth}get readyUser(){return this.currentUser&&this.currentUser.ready?this.currentUser:null}setCurrentUser(t){this.currentUser=t}setAuthUser(t){var e;this.authUserUID=null!==(e=null==t?void 0:t.uid)&&void 0!==e?e:null,this.authUserReceived=!0}async syncToCapacitor(t){if(t){let e=await t.getIdToken();tm.setUser({userId:t.uid,email:t.email,idToken:e})}else tm.clearUser()}syncToSentry(t){t&&t.email?td.av({id:t.uid,email:t.email}):td.av(null)}constructor(...t){super(...t),this.listeners=[],this.handleAuthChanged=t=>{var e;this.setAuthUser(t),this.syncToCapacitor(t),this.syncToSentry(t),(0,n4.N)(null==t?void 0:null===(e=t.providerData[0])||void 0===e?void 0:e.providerId)},this.handleUserSnapshot=(t,e)=>{this.currentUser||(this.currentUser=new re({id:t.uid})),this.currentUser.update(t,e)}}}(0,i.gn)([o.ZBq],rn.prototype,"handleUserSnapshot",void 0),(0,i.gn)([a.computed],rn.prototype,"needsAuth",null),(0,i.gn)([a.computed],rn.prototype,"signedIn",null),(0,i.gn)([a.computed],rn.prototype,"readyUser",null),(0,i.gn)([o.ZBq],rn.prototype,"setCurrentUser",null),(0,i.gn)([o.ZBq],rn.prototype,"setAuthUser",null),rn=(0,i.gn)([(0,o.o4J)("UserStore")],rn)},88448:function(t,e,n){"use strict";n.d(e,{v:function(){return w}});var r=n(15767),i=n(66292),a=n.n(i),o=n(30944),s=n.n(o),l=n(44838),c=n(86534),d=n(8680),u=n(91523),h=n(45113);async function p(t){var e;let{noteStore:n,fromNote:r,toNote:i}=t;n.assertGraph.logger.info("Merging note ".concat(r.id," into ").concat(i.id));let a=n.adapter,o=n.table.query().where((0,u.$F)("backlinkIds",r.id));for(let t of(await a.fetch(o)))await (0,h.Dh)(t,r.id,i.id);i.mergeDocument(null!==(e=r.editedDocumentNode)&&void 0!==e?e:(0,d.Tw)()),await n.destroyNote(r)}var g=n(88351),m=n(39833),y=n(11161),f=n(9544),v=n(32167);class w extends(0,c.Hnr)({}){get semiScreen(){return this.semiScreenUser||this.semiScreenMedia}setSemiScreenUser(t){this.semiScreenUser=t}setSemiScreenMedia(t){this.semiScreenMedia=t}addTypingMeasurement(t){this.typingMeasurements=s()([...this.typingMeasurements,t],300)}focusLastEditor(){var t;let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};this.focusEditor(null!==(t=this.lastActiveEditor)&&void 0!==t?t:"primary",e)}focusPrimary(){this.setActiveEditor("primary")}focusSecondary(){this.assertSecondaryEditorView.hasSelectedNote&&this.setActiveEditor("secondary")}focusEditor(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},{skipIfCapacitor:n=!1}=e;n&&(0,y.W)()||this.setActiveEditor(t)}setActiveEditor(t){this.activeEditor=t,null!==t&&(this.lastActiveEditor=t)}handleFocus(t){this.updateFocusDebounce(t,!0)}handleBlur(t){t.note===t.editorView.selectedNote&&(t.editorView.selectionView.updateCursor(t),this.updateFocusDebounce(t,!1))}updateFocus(t,e){e?this.setFocused(t):this.setBlurred(t)}setFocused(t){let{editorView:e,note:n}=t;this.setActiveEditor(e.role),e instanceof d.PM&&e.setSelectedNote(n,{scroll:!1})}setBlurred(t){this.setActiveEditor(null)}get rootStore(){return(0,c.k0l)(this)}get assertRootStore(){return(0,f.wi)(this,"rootStore")}get graphStore(){return this.assertRootStore.graphStore}get graph(){return this.graphStore.currentGraph}get noteStore(){var t;return null===(t=this.rootStore)||void 0===t?void 0:t.noteStore}get assertNoteStore(){return(0,f.wi)(this,"noteStore")}get assertDailyEditorView(){return this.assertNoteStore.dailyEditorView}get assertPrimaryEditorView(){return this.assertNoteStore.primaryEditorView}get assertSecondaryEditorView(){return this.assertNoteStore.secondaryEditorView}get dailyEditorView(){var t;return null===(t=this.noteStore)||void 0===t?void 0:t.dailyEditorView}get primaryEditorView(){var t;return null===(t=this.noteStore)||void 0===t?void 0:t.primaryEditorView}get searchModalIsOpen(){return this.modal===g.xr.Search}get shortcutsModalIsOpen(){return this.modal===g.xr.Shortcuts}screenIsActive(t){return this.screen===t}screenHasFocus(t){return!this.modal&&this.screenIsActive(t)}get screenIsEditOrDaily(){return[g.oK.NoteDaily,g.oK.NoteEdit].includes(this.screen)}get tasksHasFocus(){return this.screenHasFocus(g.oK.TaskList)}get noteHasFocus(){return this.screenHasFocus(g.oK.NoteDaily)||this.screenHasFocus(g.oK.NoteEdit)}closeModal(){this.modal=null,this.activeEditor||this.focusLastEditor({skipIfCapacitor:!0})}closeSearchModal(){this.searchModalIsOpen&&this.closeModal()}openShortcutsModal(){this.openModal(g.xr.Shortcuts)}toggleShortcutsModal(){this.shortcutsModalIsOpen?this.closeModal():this.openShortcutsModal()}openSearchModal(){this.openModal(g.xr.Search)}toggleSearchModal(){this.searchModalIsOpen?this.closeModal():this.openSearchModal()}openModal(t){this.activeEditor=null,this.modal=t}toggleSemiScreen(){this.semiScreenUser=!this.semiScreenUser}setScreen(t){this.screen=t}openListScreen(){this.setScreen(g.oK.NoteList),this.screen===g.oK.NoteList?this.assertNoteStore.listView.clearQuery():this.openListScreen(),this.assertNoteStore.secondaryEditorView.setSelectedNote(null)}openMapScreen(){this.setScreen(g.oK.Map)}openNoteDailyScreen(){this.screen===g.oK.NoteDaily?this.assertNoteStore.dailyEditorView.selectToday():this.setScreen(g.oK.NoteDaily),this.assertNoteStore.secondaryEditorView.setSelectedNote(null),this.focusEditor("primary",{skipIfCapacitor:!0})}openTodaysNoteDailyScreen(){this.assertNoteStore.dailyEditorView.selectToday(),this.setScreen(g.oK.NoteDaily),this.focusEditor("primary",{skipIfCapacitor:!0})}ensureSelectedNote(){this.selectedNote||this.assertDailyEditorView.selectToday()}setSelectedNote(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};(null==t?void 0:t.daily)?this.assertDailyEditorView.setSelectedDate(t.dailyOrCreatedDate,e):this.assertPrimaryEditorView.setSelectedNote(t,e)}get selectedNoteId(){var t,e;let{noteStore:n}=this;return this.screen===g.oK.NoteDaily?null!==(t=null==n?void 0:n.dailyEditorView.selectedNoteId)&&void 0!==t?t:null:null!==(e=null==n?void 0:n.primaryEditorView.selectedNoteId)&&void 0!==e?e:null}get selectedNote(){var t;let{noteStore:e}=this;return this.screen===g.oK.NoteDaily?null==e?void 0:e.dailyEditorView.selectedNote:null==e?void 0:null===(t=e.primaryEditorView.selectedNote)||void 0===t?void 0:t.value}isSelected(t){return this.selectedNote===t}clearEditorSearch(){this.assertNoteStore.dailyEditorView.clearSearch(),this.assertNoteStore.primaryEditorView.clearSearch(),this.assertNoteStore.secondaryEditorView.clearSearch()}async editNoteId(t){var e;let n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},r=await (null===(e=this.noteStore)||void 0===e?void 0:e.findById(t));this.editNote(null!=r?r:null,n)}editNote(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},n=e.secondary?"secondary":"primary",r=this.noteStore;if(!r){console.error("editNote: Note store not initialized");return}this.updateFocusDebounce.cancel(),"secondary"==n&&this.canEditSecondary(t)?(r.secondaryEditorView.setSelectedNote(t,{searchQuery:e.searchQuery,searchNodeGuid:e.searchNodeGuid}),this.setActiveEditor("secondary")):((null==t?void 0:t.daily)?(r.dailyEditorView.setSelectedDate(t.dailyOrCreatedDate,{searchQuery:e.searchQuery,searchNodeGuid:e.searchNodeGuid}),this.setScreen(g.oK.NoteDaily)):(this.setSelectedNote(t,{searchQuery:e.searchQuery,searchNodeGuid:e.searchNodeGuid}),this.setScreen(g.oK.NoteEdit)),r.secondaryEditorView.setSelectedNote(null),this.focusEditor("primary",{skipIfCapacitor:!0}))}canEditSecondary(t){return this.screenIsEditOrDaily&&!(null==t?void 0:t.daily)&&this.selectedNote!==t}closeSecondary(){var t;null===(t=this.noteStore)||void 0===t||t.secondaryEditorView.setSelectedNote(null),this.setActiveEditor("primary")}async editRandomNote(){let t=await this.assertNoteStore.findRandomNote();t&&this.editNote(t)}async createAndEditNote(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{secondary:!1},n=await this.assertNoteStore.createNote(t);n&&this.editNote(n,e)}async editNotes(t){var e,n;let{graphId:r,id:i,subject:a,content:o,splitId:s,splitSubject:l,splitContent:c}=t;if(r||(r=null===(n=this.graph)||void 0===n?void 0:n.id),!r||!this.graphStore.findById(r))return;r!==(null===(e=this.graph)||void 0===e?void 0:e.id)&&this.graphStore.setCurrentGraphId(r);let d=await this.findOrCreateByDeeplink({id:i,subject:a,markdown:o,createDaily:!0}),u=await this.findOrCreateByDeeplink({id:s,subject:l,markdown:c});this.editNote(d),u&&this.editNote(u,{secondary:!0})}async findOrCreateByDeeplink(t){let{id:e,subject:n,markdown:r,createDaily:i}=t,a=this.assertNoteStore;return(e?await a.findById(e):null)||(n?await a.findOrCreateBySubject({subject:n,markdown:r}):i?await a.ensureTodaysDailyNote():null)}async mergeNotes(t){let{fromNote:e,toNoteId:n}=t,r=await this.assertNoteStore.findById(n);if(r){if(e.id===r.id){console.warn("Unexpected: merging note into itself");return}e.setDeletedAtDate(),this.setSelectedNote(r),await p({noteStore:this.assertNoteStore,fromNote:e,toNote:r})}}openTaskView(){this.setScreen(g.oK.TaskList)}setAndOpenSearchQuery(t){this.assertNoteStore.listView.setQuery(t),this.setScreen(g.oK.NoteList)}openNotesListForTag(t){this.setAndOpenSearchQuery("#".concat(t))}async handleDeepLink(t){let e=new URL(t),n=n=>{let r=e.searchParams.get(n);return(0,m.Ee)(r,"Missing param ".concat(n," in ").concat(t)),r},r=t=>{var n;return null!==(n=e.searchParams.get(t))&&void 0!==n?n:void 0},i=n("command");switch(i){case"append-to-daily-note":await this.appendTextToDailyNote(n("text"));break;case"create-task":await this.createTask(n("text"));break;case"create-note":await this.createAndEditNote();break;case"edit-notes":await this.editNotes({graphId:r("graph"),id:r("id"),subject:r("subject"),content:r("content"),splitId:r("splitPaneId"),splitSubject:r("splitPaneSubject"),splitContent:r("splitPaneContent")});break;default:console.error("Unknown command ".concat(i," in ").concat(t))}}async appendTextToDailyNote(t){let e=await this.getTodaysDailyNote();this.editNote(e),e.changeManager.modifyDocument(e=>(0,d.GQ)({node:e,text:t}))}async createTask(t){this.openTaskView();let e=await this.getTodaysDailyNote();v.i.build({text:t,note:e}).syncToNote()}async getTodaysDailyNote(){return await this.assertNoteStore.ensureTodaysDailyNote()}constructor(...t){super(...t),this.screen=g.oK.NoteDaily,this.activeEditor=null,this.lastActiveEditor=null,this.modal=null,this.semiScreenUser=!1,this.semiScreenMedia=!1,this.typingMeasurements=[],this.updateFocusDebounce=a()(this.updateFocus.bind(this),50),this.handleBacklinkOpen=async(t,e,n)=>(await this.editNoteId(e.id,{secondary:n.modKey}),!1)}}(0,r.gn)([l.observable],w.prototype,"screen",void 0),(0,r.gn)([l.observable],w.prototype,"activeEditor",void 0),(0,r.gn)([l.observable],w.prototype,"modal",void 0),(0,r.gn)([l.observable],w.prototype,"semiScreenUser",void 0),(0,r.gn)([l.observable],w.prototype,"semiScreenMedia",void 0),(0,r.gn)([l.observable],w.prototype,"typingMeasurements",void 0),(0,r.gn)([l.action],w.prototype,"setSemiScreenUser",null),(0,r.gn)([l.action],w.prototype,"setSemiScreenMedia",null),(0,r.gn)([l.action],w.prototype,"addTypingMeasurement",null),(0,r.gn)([l.action],w.prototype,"setActiveEditor",null),(0,r.gn)([l.action],w.prototype,"setFocused",null),(0,r.gn)([l.action],w.prototype,"setBlurred",null),(0,r.gn)([l.computed],w.prototype,"searchModalIsOpen",null),(0,r.gn)([l.computed],w.prototype,"shortcutsModalIsOpen",null),(0,r.gn)([l.computed],w.prototype,"tasksHasFocus",null),(0,r.gn)([l.computed],w.prototype,"noteHasFocus",null),(0,r.gn)([l.action],w.prototype,"closeModal",null),(0,r.gn)([l.action],w.prototype,"openModal",null),(0,r.gn)([l.action],w.prototype,"toggleSemiScreen",null),(0,r.gn)([l.action],w.prototype,"setScreen",null),(0,r.gn)([l.action],w.prototype,"openNoteDailyScreen",null),(0,r.gn)([l.action],w.prototype,"ensureSelectedNote",null),(0,r.gn)([l.computed],w.prototype,"selectedNoteId",null),(0,r.gn)([l.computed],w.prototype,"selectedNote",null),(0,r.gn)([l.action],w.prototype,"editNote",null),(0,r.gn)([l.action],w.prototype,"closeSecondary",null),w=(0,r.gn)([(0,c.o4J)("MainView")],w)},65431:function(t,e,n){"use strict";n.d(e,{Jr:function(){return u},Mr:function(){return d},V$:function(){return p},Xq:function(){return l},_F:function(){return f},ct:function(){return y},d3:function(){return m},tk:function(){return c}});var r=n(75422),i=n(22612),a=n.n(i),o=n(53342),s=n(28407);function l(t){let{emptyList:e=!0}=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return t?e?r.K3.doc([r.K3.header(t),r.K3.list(r.K3.listItem(r.K3.paragraphText("")))]):c(t):c()}function c(t){return r.K3.doc([r.K3.header(null!=t?t:""),r.K3.paragraph([])])}function d(t,e){let n=[r.K3.paragraphText(t||" "),...u(e)];return r.K3.listItem(n)}function u(t){return t.map(h).filter(o.Dw)}function h(t){let e=(0,r.Y8)(t,{onTagAdd:void 0,onBacklinkAdd:void 0});if(0===e.size)return null;if(1===e.childCount){let t=e.child(0);if("list"===t.type.name)return t}try{return r.K3.listItem((0,r.Y_)(e))}catch(e){return r.K3.listItem(r.K3.paragraphText(t+" "))}}function p(t,e){var n,i;return r.K3.list([r.K3.listItem(r.K3.paragraphText("Title: ")),r.K3.listItem(r.K3.paragraphText("Company: ")),r.K3.listItem(r.K3.paragraph([r.K3.text("Type: "),r.K3.tag({id:s._H,label:s._H,graphId:e})])),g("Email:",(null!==(n=null==t?void 0:t.emailValues)&&void 0!==n?n:[]).map(t=>r.K3.link(t,"mailto:"+t))),g("Phone:",(null!==(i=null==t?void 0:t.phoneNumberValues)&&void 0!==i?i:[]).map(t=>r.K3.link(t,"tel:"+t))),r.K3.listItem(r.K3.paragraphText("Location: "))])}function g(t,e){let n=[r.K3.paragraphText(t)];return e.length>0&&n.push(...e.map(t=>r.K3.listItem(r.K3.paragraph(t)))),r.K3.listItem(n)}function m(t){let{meeting:e,meetingNote:n,attendeeNotes:i,timeFormat:o}=t,s=[];if(e.startAt&&s.push(r.K3.text("".concat(e.formatStartAtTime(o)," "))),i.length>0){e.startAt?s.push(r.K3.text("met with ")):s.push(r.K3.text("Met with "));let t=a()(i.map(t=>r.K3.backlink({id:t.id,label:t.title,graphId:t.graphId})));for(let[e,n]of t.entries())s.push(n),e!=t.length-1&&s.push(r.K3.text(", "));(n||e.name)&&s.push(r.K3.text(" for "))}return n?s.push(r.K3.backlink({id:n.id,label:n.subject,graphId:n.graphId})):e.name&&s.push(r.K3.text(e.name)),r.K3.listItem([r.K3.paragraph(s),r.K3.list([r.K3.listItem(r.K3.paragraphText(""))])])}function y(t,e){let n=r.K3.header(null==t?void 0:t.name),i=p(t,e);return r.K3.doc([n,i])}function f(t,e){var n;return r.K3.doc([r.K3.header(null!==(n=t.name)&&void 0!==n?n:void 0),r.K3.list([r.K3.listItem([r.K3.paragraph([r.K3.text("Type: "),r.K3.tag({id:s.O9,label:s.O9,graphId:e})])])])])}},39368:function(t,e,n){"use strict";n.d(e,{II:function(){return i},WK:function(){return a}});var r=n(75422);function i(t){let{graphId:e,fromNoteId:n,fromNoteNode:i,toNoteId:a,queries:o}=t;if(0===o.length)return[];let s=[];for(let t of o)for(let o of(0,r.wn)(i,[t])){let r=function(t,e){let n;return t.nodesBetween(e,e,t=>{n||"paragraph"!==t.type.name||(n=t)}),n}(i,o);if(!r)continue;let l=r.textContent;s.push({graphId:e,fromNoteId:n,toNoteId:a,label:t,contextHtml:"<p>".concat(l,"</p>")})}return s}function a(t){let e=(0,r.Jk)(t);return(0,r._F)(e)}},20608:function(t,e,n){"use strict";n.d(e,{GQ:function(){return s},M_:function(){return l},Pm:function(){return c},QY:function(){return h},RN:function(){return o},U3:function(){return u},jd:function(){return a},p0:function(){return g},vm:function(){return d},yz:function(){return p}});var r=n(75422),i=n(65431);function a(t){let{document:e,contact:n,graphId:a}=t,o=(0,i.V$)(n,a);return(0,r.Ne)(e,t=>{(0,r.rx)(t,o)})}function o(t){let{meeting:e,document:n,meetingNote:a,attendeeNotes:o,timeFormat:s}=t,l=(0,i.d3)({meeting:e,meetingNote:a,attendeeNotes:o,timeFormat:s});return(0,r.Ne)(n,t=>{(0,r.rx)(t,[l])})}function s(t){let{node:e,text:n,listName:i,onTagAdd:a,onBacklinkAdd:o}=t,s={onTagAdd:a,onBacklinkAdd:o},l=(0,r.Y8)(n,s),c=(0,r._u)(l),d=c.every(t=>t.type.name===r.WQ)?c:r.K3.listItem(l);if(!i)return(0,r.Ne)(e,t=>{(0,r.rx)(t,d)});{let t=(0,r.LX)(i,s);return(0,r.Ne)(e,e=>{(0,r.HT)(e,t,d)})}}function l(t,e){return(0,r.Ne)(t,t=>{(0,r.M_)(t,e)})}function c(t){return(0,r.Ne)(t,t=>{(0,r.fL)(t)})}function d(t){let{node:e,graphId:n}=t;return(0,r.Ne)(e,t=>{(0,r.Dx)(t,n)})}function u(t){let{doc:e,taskGuid:n,taskChecked:i,taskArchived:a,taskFragment:o,listName:s}=t;return(0,r.Ne)(e,t=>{(0,r.Qo)(t,r.K3.taskListItem(null!=o?o:r.K3.paragraphText(),{checked:i,archived:a,guid:n}),{listName:s})})}function h(t){let{doc:e,taskGuid:n}=t;return(0,r.Ne)(e,t=>{(0,r.xV)(t,new Set([n]))})}function p(t){let{doc:e,guid:n}=t;return(0,r.Ne)(e,t=>{(0,r.US)(t,{guid:n})})}function g(t){let{doc:e,taskGuid:n}=t;return(0,r.Ne)(e,t=>{(0,r.bo)(t,{guid:n,kind:"checklist"})})}},14630:function(t,e,n){"use strict";n.d(e,{DG:function(){return u},Gd:function(){return g},ZQ:function(){return h},a1:function(){return p}});var r=n(75422),i=n(17322),a=n(53342),o=n(44225),s=n(52951),l=n(16169),c=n(65431),d=n(20608);function u(t){let{documentNode:e,document:n,subject:i,...a}=t,o=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};e||(e=n?(0,r.hH)(n):(0,c.Xq)(i,o)),i?(0,r.kB)(e)!==i&&(e=(0,d.M_)(e,i)):i=(0,r.kB)(e);let s=e.toJSON();return{...a,document:s,subject:i}}function h(t,e){let n=e.startAt.getTime(),r=e.endAt.getTime(),a=(0,i.Z)(t).getTime();return a>=n&&a<=r}function p(t){var e,n,r,i,o,s,l,c,d,u,h;return t&&((null==t?void 0:t.person)||(null==t?void 0:t.company))?[null===(n=t.person)||void 0===n?void 0:null===(e=n.name)||void 0===e?void 0:e.fullName,null===(i=t.person)||void 0===i?void 0:null===(r=i.employment)||void 0===r?void 0:r.title,null===(s=t.person)||void 0===s?void 0:null===(o=s.employment)||void 0===o?void 0:o.role,null===(l=t.person)||void 0===l?void 0:l.bio,null===(d=t.person)||void 0===d?void 0:null===(c=d.twitter)||void 0===c?void 0:c.handle,null===(u=t.company)||void 0===u?void 0:u.name,null===(h=t.company)||void 0===h?void 0:h.description].filter(a.Dw).join(" ").substring(0,300):""}function g(t,e,n){let r=(0,l.wl)(t,t=>t.subject),i=r.map(t=>{let{alias:e}=t;return e}),a=(0,o.C)({items:i,query:e,sort:!1}).map(t=>{let[e,n]=t;return{note:r[e].item,alias:r[e].alias,ranges:n}});a=(a=function(t,e){let n=[];for(let r of(0,s.Kf)(t,t=>t.note.id).values()){let t=r.filter(t=>t.alias.includes(e)),i=t.length>0?t:r;n.push(...i)}return n}(a,e)).slice(0,n);let c=e.toLowerCase(),d=a.findIndex(t=>{let{alias:e}=t;return e.toLowerCase().startsWith(c)});return d>=1&&a.unshift(a.splice(d,1)[0]),a}},75240:function(t,e,n){"use strict";n.d(e,{o:function(){return o}});var r=n(75422),i=n(25674),a=n.n(i);class o{get documentNode(){return this.document?(0,r.hH)(this.document):null}yjsEncodeStateVector(){var t;let e=a()(null!==(t=this.yjsUpdates)&&void 0!==t?t:[]);return e?r.pU.encodeStateVectorFromUpdate(e):null}constructor(t){this.id=t.id,this.yjsUpdates=t.yjsUpdates,this.yjsDocAsUpdate=t.yjsDocAsUpdate,this.document=t.document,this.createdAt=t.createdAt,this.platform=t.platform}}},18453:function(t,e,n){"use strict";n.d(e,{AZ:function(){return u},Jg:function(){return p},O8:function(){return y},Q7:function(){return w},s4:function(){return m},tE:function(){return v},uZ:function(){return g},wL:function(){return h}});var r=n(75422),i=n(86534),a=n(54879),o=n(24601),s=n(1130),l=n(16169),c=n(39368),d=n(87808);function u(t){let e=g(t);return(0,i.atr)(d.j,e)}function h(t){return t?JSON.parse(t):void 0}function p(t){return t?JSON.parse(t):void 0}function g(t){var e,n,r,i,o,s,l,c,d;let u=h(t.document),g=p(t.systemMetadata);return{id:t.id,subject:t.subject,yDocAsUpdate:null!==(e=t.yDocAsUpdate)&&void 0!==e?e:void 0,document:u,systemMetadata:g,ignoredBacklinkLabels:null!==(n=(0,a.c0)(t.ignoredBacklinkLabels))&&void 0!==n?n:[],ignoredBacklinkFromNoteIds:null!==(r=(0,a.c0)(t.ignoredBacklinkFromNoteIds))&&void 0!==r?r:[],ignoredContactNames:null!==(i=(0,a.c0)(t.ignoredContactNames))&&void 0!==i?i:[],backlinkedCount:t.backlinkedCount,acl:null!==(o=(0,a.c0)(t.acl))&&void 0!==o?o:[],pinnedIndex:null!==(s=t.pinnedIndex)&&void 0!==s?s:null,daily:!!t.dailyDate,createdAt:t.createdAt,updatedAt:t.updatedAt,deletedAt:null!==(l=t.deletedAt)&&void 0!==l?l:null,editedAt:null!==(c=t.editedAt)&&void 0!==c?c:void 0,lastCommitId:null!==(d=t.lastCommitId)&&void 0!==d?d:null,persisted:!!t.persisted}}function m(t,e){return y({graphId:t,snapshot:(0,i.vMv)(e)})}function y(t){var e,n,i,d;let{graphId:u,snapshot:h}=t,p=function(t){var e;let{node:n,document:i}=f(t),a=t.daily?(0,o.cB)(t.id):void 0,d=n?(0,r.sd)(n):{},u=(n?(0,r.H9)(n):[]).map(t=>t[0].attrs.id);return{tags:n?(0,r.NJ)(n):[],hasTask:!!n&&(0,r.d5)(n),emails:n?(0,r.G5)(n):[],linkHrefs:n?(0,r.nv)(n):[],isBlank:!n||(0,c.WK)(i),contentMetadata:d,contentMetadataAsin:null!==(e=d.asin)&&void 0!==e?e:null,dailyDate:null==a?void 0:a.getTime(),normalizedSubject:(0,s.Up)(t.subject),subjectAliases:(0,l.gO)(t.subject),backlinkIds:u,documentText:i?(0,r.nM)(i):null}}(h);return{graphId:u,id:h.id,subject:h.subject,yDocAsUpdate:null!==(e=h.yDocAsUpdate)&&void 0!==e?e:null,document:(0,a.Mn)(h.document),systemMetadata:(0,a.Mn)(h.systemMetadata),ignoredBacklinkLabels:(0,a.v3)(h.ignoredBacklinkLabels),ignoredBacklinkFromNoteIds:(0,a.v3)(h.ignoredBacklinkFromNoteIds),ignoredContactNames:(0,a.v3)(h.ignoredContactNames),backlinkedCount:h.backlinkedCount,acl:(0,a.v3)(h.acl),pinnedIndex:h.pinnedIndex,createdAt:h.createdAt,updatedAt:h.updatedAt,deletedAt:h.deletedAt,editedAt:null!==(n=h.editedAt)&&void 0!==n?n:null,isDaily:Number(h.daily),lastCommitId:h.lastCommitId,persisted:Number(null!==(i=h.persisted)&&void 0!==i&&i),tags:(0,a.v3)(p.tags),hasTask:Number(p.hasTask),emails:(0,a.v3)(p.emails),linkHrefs:(0,a.v3)(p.linkHrefs),isBlank:Number(p.isBlank),dailyDate:null!==(d=p.dailyDate)&&void 0!==d?d:null,contentMetadata:(0,a.v3)(p.contentMetadata),contentMetadataAsin:p.contentMetadataAsin,normalizedSubject:p.normalizedSubject,subjectAliases:(0,a.Mn)(p.subjectAliases),backlinkIds:(0,a.v3)(p.backlinkIds),documentText:p.documentText}}function f(t){var e;let n=null===(e=t.document)||void 0===e?void 0:e.data;return n?{node:(0,r.hH)(n),document:n}:{node:null,document:null}}function v(t,e){let n=e.pool.get(t.id),r=null==n?void 0:n.editedDocument,i=null==n?void 0:n.editedDocumentNode;return r&&i?{document:r,node:i}:f({document:h(t.document)})}function w(t){return f({document:h(t.document)})}},87808:function(t,e,n){"use strict";n.d(e,{j:function(){return tl}});var r=n(15767),i=n(75422),a=n(34281),o=n(59592),s=n(66292),l=n.n(s),c=n(759),d=n.n(c),u=n(31223),h=n.n(u),p=n(25674),g=n.n(p),m=n(84715),y=n.n(m),f=n(4936),v=n.n(f),w=n(51842),b=n.n(w),S=n(44838),k=n(86534),I=n(8711),N=n(16169),x=n(18688),T=n(24601),D=n(82020),A=n(63317),C=n(39833),_=n(82317),M=n(44387),E=n(73748),F=n(9544),U=n(66376),B=n(1130),R=n(73165),j=n(6270),P=n(7480),O=n(94232),L=n(16285),K=n(71157),G=n(27999),q=n(75087),Z=n(57387),H=n(3146),J=n(6885);class Q{getState(){return this.state}setState(t){var e;let n=this.state,r=this.findTransition(n,t);if(!r)throw Error("No transition found from ".concat(n.type," to ").concat(t.type));r.block||(this.state=t,null===(e=r.after)||void 0===e||e.call(r,{state:t,prevState:n}))}findTransition(t,e){return this.transitions.find(n=>this.matchStateType(n.from,t.type)&&this.matchStateType(n.to,e.type))||null}matchStateType(t,e){return Array.isArray(t)?t.includes(e):t===e}constructor(t,e){this.state=t,this.transitions=e,(0,S.makeObservable)(this)}}function Y(t,e,n){return{from:t,to:e,block:n.block,after:n.after}}(0,r.gn)([S.observable],Q.prototype,"state",void 0),(0,r.gn)([S.action],Q.prototype,"setState",null);class z{get state(){return this.machine.getState()}requestSave(){if("saving"===this.machine.getState().type){this.shouldSaveAgain=!0;return}this.machine.setState({type:"requestedSave"})}onRequestSave(){this.debounceTimer&&clearTimeout(this.debounceTimer),this.debounceTimer=setTimeout(()=>{this.machine.setState({type:"saving",retryAttempts:4})},this.debounceInterval)}onWillRetry(t){let{state:e}=t;setTimeout(()=>{this.machine.setState({type:"saving",retryAttempts:e.retryAttempts})},this.retryTimeout)}onIdle(){this.shouldSaveAgain&&(this.shouldSaveAgain=!1,this.machine.setState({type:"requestedSave"}))}async onSave(t){let e,{state:n}=t;if(!this.note.isAttached){this.warn("Note is not attached, not saving"),this.machine.setState({type:"idle"});return}let r=this.changeStore.getPendingCommit(this.note);if(!r){this.warn("No pending commit, not saving"),this.machine.setState({type:"idle"});return}if(r.isEmpty&&!r.forceSave){this.warn("Pending commit is empty, not saving"),this.machine.setState({type:"idle"});return}if(this.noteStore.offline){this.warn("Offline, not saving"),this.machine.setState({type:"idle"}),this.updateFailure({failedAt:new Date,reason:"offline"});return}r.setForceSave(!1);let i=(0,J.U3)({graph:this.graph,note:this.note,commit:r,reason:""});try{e=await (0,H.G)(i,this.saveTimeout)}catch(t){if(t instanceof Z.m){this.retrySaving(n.retryAttempts,"expired");return}throw t}let{success:a,error:o}=e;a?(this.machine.setState({type:"idle"}),this.note.setPersisted(!0),this.note.changeManager.applySavedUpdates({updates:e.yjsUpdates}),this.verifySavedCommit(e.commitId),this.clearFailure()):"tooLarge"===o?(this.machine.setState({type:"idle"}),this.updateFailure({failedAt:new Date,reason:"tooLarge"})):this.retrySaving(n.retryAttempts,"other")}verifySavedCommit(t){if(null===t)return;let e=this.graph.logger.child({noteId:this.note.id});setTimeout(()=>{var n;let r=null!==(n=this.note.lastCommitId)&&void 0!==n?n:-1,i=t-r;if(i>10){let n="Severely out of sync: Saved commit ".concat(t," is ahead by ").concat(i," (local commit: ").concat(r,")");e.error(n),(0,K.uT)(n,{level:"error"})}},1e4)}retrySaving(t,e){t>0?this.machine.setState({type:"willRetry",reason:e,retryAttempts:t-1}):(this.updateFailure({failedAt:new Date,reason:e}),this.machine.setState({type:"idle"}))}updateFailure(t){this.failure||(this.failure=t)}clearFailure(){this.failure=null}warn(t){console.warn("[saving-manager ".concat(this.note.graphId,"/").concat(this.note.id,"] ").concat(t))}get noteStore(){return this.note.assertNoteStore}get changeStore(){return this.noteStore.assertChangeStore}get graph(){return this.noteStore.assertGraph}constructor(t){this.debounceTimer=null,this.shouldSaveAgain=!1,this.debounceInterval=2e3,this.saveTimeout=15e3,this.retryTimeout=1e4,this.failure=null,this.note=t;let e=()=>this.onRequestSave(),n=t=>this.onSave(t);this.machine=new Q({type:"idle"},[Y("idle","requestedSave",{after:e}),Y("requestedSave","requestedSave",{after:e}),Y("willRetry","requestedSave",{block:!0}),Y("willRetry","saving",{after:n}),Y("requestedSave","saving",{after:n}),Y("saving","idle",{after:()=>this.onIdle()}),Y("saving","willRetry",{after:t=>this.onWillRetry(t)})]),(0,S.makeObservable)(this)}}(0,r.gn)([S.observable],z.prototype,"failure",void 0),(0,r.gn)([S.action],z.prototype,"updateFailure",null),(0,r.gn)([S.action],z.prototype,"clearFailure",null);class V{handleReconnect(){this.requestSave()}yjsHandleUpdate(t){let{update:e}=t;if(!this.note.yDoc)throw new I.KL(this.note);this.changeStore.addPendingUpdates({note:this.note,updates:[e]}),this.requestSave(),this.note.handleDocChangedDebounce()}modifyDocument(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},n=this.getEditedDoc(),r=t((0,i.hH)(n.doc));this.confirmEdit(n.yDoc,r,e)}async modifyDocumentAsync(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},n=this.getEditedDoc(),r=await t((0,i.hH)(n.doc));this.confirmEdit(n.yDoc,r,e)}getEditedDoc(){let t=this.note.assertEditedYdoc,e=(0,i.x4)(t);return{yDoc:t,doc:e}}confirmEdit(t,e,n){let{triggerChangedCallback:r=!0,requestSave:i=!0}=n,a=(0,A.Gn)({originalYDoc:t,updatedNode:e});this.changeStore.addPendingUpdates({note:this.note,updates:a}),this.note.requestRerender(),i&&this.requestSave(),r&&this.note.handleDocChangedDebounce()}requestSave(){this.savingManager.requestSave()}requestForceSave(){this.changeStore.ensureCommit({note:this.note,forceSave:!0}),this.requestSave()}async loadAndApplyCommits(){return this.loadCommitsLock(async()=>{try{let t=await (0,G.c2)({graph:this.note.assertGraph,noteId:this.note.id,afterCommitId:this.note.lastCommitId});if(0===t.length)return;this.applyCommits(t)}catch(t){throw new O.WA(t)}})}applyCommits(t){if(!this.note.noteStore){this.logger.warn("[applyCommits] Note has been destroyed");return}this.applyYjsCommits(t)}applyYjsCommits(t){let e=g()(t);if(!e)return;this.logger.info("[".concat(this.note.id,"] applying commits: ").concat((0,q.jQ)(t))),this.notifyAboutLargeCommits(t),this.backupPending(e);let n=(0,L.a)(t);this.applyIncomingUpdates({updates:n,lastCommitId:e.id})}notifyAboutLargeCommits(t){var e,n;let r=t.filter(q.L7);0!==r.length&&(0,K.uT)("Large commits: ".concat((0,q.jQ)(r)),{extra:{graphId:this.note.graphId,note:{id:this.note.id,createdAt:null===(e=this.note.createdAtDate)||void 0===e?void 0:e.toISOString(),updatedAt:null===(n=this.note.updatedAtDate)||void 0===n?void 0:n.toISOString()}}})}applyIncomingUpdates(t){let{updates:e,lastCommitId:n}=t,r=this.note.assertYDoc;for(let t of e)i.pU.applyUpdate(r,t);let a=(0,i.x4)(r);(0,S.runInAction)(()=>{this.note.setYDoc(r),this.note.setDocument(a),this.note.setLastCommitId(n),this.note.addIncomingUpdates(e),this.note.requestRerender(),this.consolidatePendingCommit({source:"incoming"})})}applySavedUpdates(t){let{updates:e}=t,n=this.note.assertYDoc;for(let t of e)i.pU.applyUpdate(n,t);let r=(0,i.x4)(n);(0,S.runInAction)(()=>{this.note.setYDoc(n),this.note.setDocument(r)}),this.consolidatePendingCommit({source:"saved"})}consolidatePendingCommit(t){let{source:e}=t,n=this.changeStore.getPendingCommit(this.note);if(!n)return;let r=n.yjsUpdates.length,i=n.consolidate(this.note);this.logger.info("(".concat(e,") consolidated pending commit from ").concat(r," to ").concat(i," updates"))}backupPending(t){let e=this.changeStore.getPendingCommit(this.note);if(!e)return;let n=null==e?void 0:e.encodeStateVector(),r=t.yjsEncodeStateVector();h()(n,r)||e.backup({note:this.note})}get graph(){return this.noteStore.assertGraph}get logger(){return this.graph.logger.child({noteId:this.note.id})}get noteStore(){return this.note.assertNoteStore}get changeStore(){return this.noteStore.assertChangeStore}get rootStore(){return this.note.rootStore}constructor(t){this.loadCommitsLock=(0,P.Z)(1),this.note=t,this.savingManager=new z(t)}}var W=n(68405),$=n(88957),X=n(15969),tt=n(48757),te=n(46696),tn=n(28407),tr=n(32167),ti=n(65431),ta=n(39368),to=n(20608),ts=n(14630);class tl extends(0,k.Hnr)({id:k.UB4,subject:(0,k.vgT)(()=>""),document:(0,k.vgT)().withTransform((0,U.N)()).withSetter(),yDocAsUpdate:(0,k.vgT)().withSetter(),systemMetadata:(0,k.vgT)().withTransform((0,U.N)()).withSetter(),ignoredBacklinkLabels:(0,k.vgT)(()=>[]),ignoredBacklinkFromNoteIds:(0,k.vgT)(()=>[]),ignoredContactNames:(0,k.vgT)(()=>[]),backlinkedCount:(0,k.vgT)(()=>0).withSetter(),acl:(0,k.vgT)(()=>[]),pinnedIndex:(0,k.vgT)(null).withSetter(),daily:(0,k.vgT)(!1),createdAt:(0,k.vgT)(()=>new Date().getTime()),updatedAt:(0,k.vgT)(()=>new Date().getTime()),deletedAt:(0,k.vgT)(()=>null).withSetter(),editedAt:(0,k.vgT)(),lastCommitId:(0,k.vgT)(()=>null).withSetter(),persisted:(0,k.vgT)().withSetter()}){static fromSnapshot(t){return(0,k.atr)(tl,t)}static build(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return e.placeholder?this.buildPlaceholderYJS(t,e):this.buildYJS(t,e)}static buildYJS(t,e){let{document:n,...r}=(0,ts.DG)(t,e),i=(0,A.kg)(n).ydoc;return this.buildModel({...r,document:n,yDocAsUpdate:(0,A.KT)(i),persisted:!1})}static buildPlaceholderYJS(t,e){let{document:n,...r}=(0,ts.DG)(t,{...e,emptyList:!1}),{ydoc:a,node:o}=(0,A.kg)(n,{template:!0}),s=[i.pU.encodeStateAsUpdate(a)];if(e.emptyList){let t=(0,to.Pm)(o),e=(0,A.Gn)({originalYDoc:a,updatedNode:t});s.push(...e)}let l=i.pU.mergeUpdates(s);return this.buildModel({...r,document:n,yDocAsUpdate:(0,A.KT)(new i.pU.Doc),placeholderUpdate:l,persisted:!1})}static buildModel(t){let{placeholderUpdate:e,...n}=t,r=new this(n);if(e){let t=new tt.i({yjsUpdates:[(0,o.kZ)(e)]});t.setIsPlaceholder(!0),r.setPlaceholderCommit(t)}return r}get key(){return[this.graphId,this.id,this.rerenderCounter].join("-")}get rerenderKey(){return[this.id,this.rerenderCounter].join("-")}get remountKey(){return[this.id,this.remountCounter].join("-")}get createdAtDate(){return new Date(this.createdAt)}get updatedAtDate(){return new Date(this.updatedAt)}get untrackedUpdatedAtDate(){return(0,S.untracked)(()=>this.updatedAtDate)}get updatedAtTime(){return this.updatedAtDate.getTime()}get untrackedUpdatedAtTime(){return(0,S.untracked)(()=>this.updatedAtTime)}get editedAtDate(){return this.editedAt?new Date(this.editedAt):null}get deletedAtDate(){return this.deletedAt?new Date(this.deletedAt):null}get pinned(){return null!==this.pinnedIndex}get untrackedBacklinkedCount(){return(0,S.untracked)(()=>this.backlinkedCount)}get public(){return this.acl.includes("public")}aclCanRead(t){return this.aclCanWrite(t)||this.acl.includes("public")||this.acl.includes("read.".concat(t))}aclCanWrite(t){return this.aclIsOwner(t)||this.acl.includes("write.".concat(t))}aclIsOwner(t){return this.acl.includes("owner.".concat(t))}get noteStore(){var t;return null===(t=this.graph)||void 0===t?void 0:t.noteStore}get adapter(){return this.assertNoteStore.adapter}get assertNoteStore(){let t=this.noteStore;if(!t)throw console.log("[Note] parent:",(0,k.G_R)(this)),Error("missing note store (".concat(this.id,")"));return t}get isAttached(){return!!this.noteStore}get changeManager(){return new V(this)}get changeStore(){var t;return null===(t=this.noteStore)||void 0===t?void 0:t.changeStore}get noteBacklinkStore(){var t;return null===(t=this.graph)||void 0===t?void 0:t.noteBacklinkStore}get graph(){return(0,te.H)(this)}get assertGraph(){return(0,F.wi)(this,"graph")}get graphId(){var t;return null===(t=this.graph)||void 0===t?void 0:t.id}get linkHrefs(){let t=this.documentNode;return t?(0,i.nv)(t):[]}get title(){return(0,N.bd)(this.debouncedSubject||"Untitled")}get shortTitle(){return this.daily&&this.dailyDate?(0,a.Z)(this.dailyDate,"MMM do"):this.debouncedSubject}get subjectAliases(){return(0,N.gO)(this.subject)}get slug(){return this.subjectSlug?"".concat(this.subjectSlug,"-").concat(this.id):this.id}get subjectSlug(){return this.subject?(0,j.U)(this.subject):null}get normalizedSubject(){return(0,B.Up)(this.subject)}get line(){try{return this.debouncedDocumentNode?(0,i.Oj)(this.debouncedDocumentNode):""}catch(t){return(0,K.Tb)(t),""}}get emails(){return this.debouncedDocumentNode?(0,i.G5)(this.debouncedDocumentNode):[]}get phoneNumbers(){return this.debouncedDocumentNode?(0,i.mD)(this.debouncedDocumentNode):[]}get domains(){return this.debouncedDocumentNode?(0,i.Nk)(this.debouncedDocumentNode):[]}get tags(){return this.debouncedDocumentNode?(0,i.NJ)(this.debouncedDocumentNode):[]}get hasPersonTag(){return this.tags.includes(tn._H)}get hasCompanyTag(){return this.tags.includes(tn.lw)}get contentMetadata(){return this.debouncedDocumentNode?(0,i.sd)(this.debouncedDocumentNode):{}}get asin(){var t;return null!==(t=this.contentMetadata.asin)&&void 0!==t?t:null}get mentions(){return{emails:this.emails,domains:this.domains,tags:this.tags}}get snippet(){return b()(this.line,{length:70})}get isBlank(){return!this.document||(0,ta.WK)(this.document)}get isDeleted(){return!!this.deletedAt}get editedOrUpdatedAt(){var t;return null!==(t=this.editedAt)&&void 0!==t?t:this.updatedAt}get editedOrUpdatedAtDate(){var t;return null!==(t=this.editedAtDate)&&void 0!==t?t:this.updatedAtDate}get editedOrUpdatedAtTime(){return this.editedOrUpdatedAtDate.getTime()}get editedAtFormatted(){var t,e,n,r;let i=null===(e=this.rootStore)||void 0===e?void 0:null===(t=e.preferenceStore)||void 0===t?void 0:t.dateFormat,a=null===(r=this.rootStore)||void 0===r?void 0:null===(n=r.preferenceStore)||void 0===n?void 0:n.timeFormat;return(0,x.zg)(this.editedOrUpdatedAtDate,i,a)}get dailyTense(){if(this.daily)return this.isTodaysDailyNote?"present":(0,M.CR)(this.dailyOrCreatedDate)?"past":"future"}get dailyDate(){if(this.daily){let t=(0,T.cB)(this.id);if(t)return t}}get dailyOrCreatedDate(){var t;return null!==(t=this.dailyDate)&&void 0!==t?t:this.createdAtDate}get dailyDateFormatted(){var t,e,n,r;let i=null===(e=this.rootStore)||void 0===e?void 0:null===(t=e.preferenceStore)||void 0===t?void 0:t.dateFormat,a=null===(r=this.rootStore)||void 0===r?void 0:null===(n=r.preferenceStore)||void 0===n?void 0:n.timeFormat;return(0,x.zg)(this.dailyOrCreatedDate,i,a)}get dailyAt(){return this.dailyOrCreatedDate.getTime()}get isTodaysDailyNote(){return this.daily&&(0,M.zk)(this.dailyOrCreatedDate)}get enrichment(){var t,e;return null!==(e=null===(t=this.systemMetadata)||void 0===t?void 0:t.enrichment)&&void 0!==e?e:null}get previewSrc(){var t,e,n,r;return(null===(e=this.enrichment)||void 0===e?void 0:null===(t=e.person)||void 0===t?void 0:t.avatar)||(null===(r=this.enrichment)||void 0===r?void 0:null===(n=r.company)||void 0===n?void 0:n.logo)||void 0}get untrackedPreviewSrc(){return(0,S.untracked)(()=>this.previewSrc)}get firstEmail(){return this.emails[0]}get enrichmentMatchText(){return(0,ts.a1)(this.enrichment)}tagMatch(t){let e=t.replaceAll("#","");return this.tags.includes(e)}partialTagMatch(t){let e=t.replaceAll("#","");for(let t of this.tags)if(t.includes(e))return!0;return!1}get rootStore(){return(0,k.k0l)(this)}get uid(){var t;return null===(t=this.rootStore)||void 0===t?void 0:t.uid}get canRead(){var t;return!!(this.uid&&this.aclCanRead(this.uid))||null!==(t=this.graph)&&void 0!==t&&!!t.canRead}get canWrite(){var t;return!!(this.uid&&this.aclCanWrite(this.uid))||null!==(t=this.graph)&&void 0!==t&&!!t.canWrite||!this.graph}isEveryCommitNewer(t){let e=this.lastCommitId;return null===e||t.every(t=>t.id>e)}get hasHistory(){return null!==this.lastCommitId}get assertYDoc(){let t=this.yDoc;if(!t)throw new I.KL(this);return t}get pendingYDoc(){let t=this.pendingCommit;if(t instanceof tt.i)return t.getPendingYDoc(this)}get pendingDocument(){var t;return null===(t=this.pendingCommit)||void 0===t?void 0:t.getPendingDoc(this)}get pendingCommit(){var t;let e=null===(t=this.changeStore)||void 0===t?void 0:t.getPendingCommit(this);return null!=e?e:this.placeholderCommit}get pendingChangesCount(){var t,e;let n=this.pendingCommit;return null!==(e=null==n?void 0:null===(t=n.yjsUpdates)||void 0===t?void 0:t.length)&&void 0!==e?e:0}get editedDocument(){var t;return null!==(t=this.pendingDocument)&&void 0!==t?t:this.document}get editedYDoc(){var t;return null!==(t=this.pendingYDoc)&&void 0!==t?t:this.yDoc}get assertEditedYdoc(){let t=this.editedYDoc;if(!t)throw new I.h3(this);return t}get hasEditedYDoc(){return!!this.editedYDoc}get editedDocumentNode(){return this.editedDocument?(0,i.hH)(this.editedDocument):void 0}get editedDocumentMarkdown(){return this.editedDocumentNode?(0,i.b8)(this.editedDocumentNode):""}get editedDocumentHtml(){return this.editedDocumentNode?(0,i.eJ)(this.editedDocumentNode):""}get debouncedDocument(){return this.key,this.getDebouncedDocument(),(0,S.untracked)(()=>this.editedDocument)}get debouncedDocumentNode(){return this.debouncedDocument?(0,i.hH)(this.debouncedDocument):void 0}get debouncedSubject(){return this.debouncedDocumentNode?(0,i.kB)(this.debouncedDocumentNode):""}get yDocAsUpdateArray(){return this.yDocAsUpdate?(0,o._f)(this.yDocAsUpdate):void 0}setYDocAsUpdateArray(t){this.setYDocAsUpdate((0,o.kZ)(t))}setPlaceholderCommit(t){this.placeholderCommit=t}removePlaceholderCommit(){let t=this.placeholderCommit;return this.placeholderCommit=null,t}setIsDailyGenerated(t){this.isDailyGenerated=t}get yDoc(){if(this.yDocAsUpdateArray)return(0,A.NR)(this.yDocAsUpdateArray)}setYDoc(t){let e=i.pU.encodeStateAsUpdate(t);this.setYDocAsUpdateArray(e)}addIncomingUpdates(t){let e=this.incomingUpdatesCounter++;this.incomingUpdates=[...this.incomingUpdates,{counter:e,updates:t}]}getIncomingUpdates(t){var e,n;let r=this.incomingUpdates;null!==t&&(r=r.filter(e=>e.counter>t));let i=null!==(n=null===(e=g()(r))||void 0===e?void 0:e.counter)&&void 0!==n?n:null;return{incomingUpdates:r.flatMap(t=>t.updates),counter:i}}clearIncomingUpdates(){this.incomingUpdates.length>0&&(this.incomingUpdates=[])}get assertDocument(){let t=this.document;if(!t)throw new I.h3(this);return t}get documentNode(){if(this.document)return(0,i.hH)(this.document)}get documentJson(){return(0,E.l)(this.document)}get documentHash(){return this.documentJson?(0,R.Cv)(this.documentJson):void 0}get documentHtml(){return this.documentNode?(0,i.eJ)(this.documentNode):""}get documentMarkdown(){return this.documentNode?(0,i.b8)(this.documentNode):""}ensureYDoc(){this.yDoc||this.setEmptyYDoc()}setEmptyYDoc(){console.log("%csetting empty document","background: red; color: #fff"),(0,C.hu)(!this.editedYDoc,"[setEmptyDocument] expected no editedYDoc");let t=(0,ti.Xq)(this.subject),e=(0,A.kg)(t.toJSON(),{template:!0}).ydoc,n=i.pU.encodeStateAsUpdate(e),r=new tt.i({yjsUpdates:[(0,o.kZ)(n)]});r.setIsPlaceholder(!0),this.setPlaceholderCommit(r),this.setYDoc(new i.pU.Doc)}get publishUrl(){return"https://reflect.site/g/".concat(this.graphId,"/").concat(this.subjectSlug,"/").concat(this.id)}get incomingBacklinksQuery(){var t;let e=null===(t=this.graph)||void 0===t?void 0:t.noteBacklinkStore;return null==e?void 0:e.createIncomingBacklinksQuery(this.id)}get incomingBacklinks(){var t,e;let n=null===(t=this.incomingBacklinksQuery)||void 0===t?void 0:t.results;return null!==(e=null==n?void 0:n.map(X.K))&&void 0!==e?e:[]}get groupedIncomingBacklinks(){let t=d()(this.incomingBacklinks,t=>t.fromNoteId),e=v()(t);return y()(e,t=>{var e;let[n,r]=t;return-(null!==(e=r[0].fromNoteCreatedAt)&&void 0!==e?e:0)})}async getOutgoingBacklinks(){let t=this.graph,e=null==t?void 0:t.noteBacklinkStore;return await (null==e?void 0:e.getOutgoingBacklinks(this.id))||[]}requestRerender(){this.rerenderCounter+=1}requestRemount(){this.remountCounter+=1,this.rerenderCounter+=1}setTasks(t){this.tasks=t}setCreatedAtDate(t){this.createdAt=t.getTime()}setUpdatedAtDate(t){this.updatedAt=t.getTime()}setDeletedAtDate(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:new Date;this.deletedAt=t.getTime()}touchViewedAt(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:new Date;this.viewedAt=t}handleDocChanged(){this.checkEnrichment(),this.syncSubject()}async syncSubject(){let t=this.editedDocumentNode?(0,i.kB)(this.editedDocumentNode):void 0;t&&this.prevSubject!==t&&(await this.requestRewriteIncomingBacklinks((0,N.bd)(t)),this.prevSubject=t)}async requestRewriteIncomingBacklinks(t){await this.assertGraph.jobQueue.replace({task:"rewriteBacklinks",getArgs:e=>({rewrites:[...((null==e?void 0:e.rewrites)||[]).filter(t=>t.noteId!==this.id),{noteId:this.id,updatedSubject:t}]}),delay:0})}get tasksWithContext(){return this.editedDocumentNode?(0,i.kE)(this.editedDocumentNode):[]}get assetIds(){return this.editedDocumentNode?(0,$.m$)(this.editedDocumentNode):[]}addTasksListener(){this.listeners.push((0,S.reaction)(()=>this.tasksWithContext,t=>this.handleTasksChanged(t),{fireImmediately:!0}))}handleTasksChanged(t){let e=this.tasks,n=[],r=new Map(e.map(t=>[t.id,t])),i=new Set;for(let{task:e,parentBreadcrumbs:a}of t){let t=e.attrs.guid;if(i.has(t))continue;i.add(t);let o=r.get(t);if(o)o.syncFromTaskNode({node:e,parentBreadcrumbs:a}),n.push(o);else{let t=new tr.i({node:e,note:this,parentBreadcrumbs:a});n.push(t)}}this.setTasks(n)}syncFromTask(t){this.changeManager.modifyDocument(e=>(0,to.U3)({doc:e,taskGuid:t.id,taskFragment:t.contentDocumentNode.content,taskChecked:t.checked,taskArchived:t.archived,listName:this.daily?"Tasks":void 0}),{triggerChangedCallback:!1})}toggleListChecked(t){let{guid:e}=t;this.changeManager.modifyDocument(t=>(0,to.yz)({doc:t,guid:e}),{triggerChangedCallback:!1})}deleteTask(t){let{taskGuid:e}=t;this.changeManager.modifyDocument(t=>(0,to.QY)({doc:t,taskGuid:e}),{triggerChangedCallback:!1})}convertTaskIntoChecklist(t){let{taskGuid:e}=t;this.changeManager.modifyDocument(t=>(0,to.p0)({doc:t,taskGuid:e}),{triggerChangedCallback:!1})}enablePublic(){this.acl=[...this.acl,"public"]}disablePublic(){this.acl=this.acl.filter(t=>"public"!==t)}togglePublic(){this.public?this.disablePublic():this.enablePublic()}updatePinned(){let t=!(arguments.length>0)||void 0===arguments[0]||arguments[0];return this.updatePinnedIndex(t?-1:null)}async updatePinnedIndex(t){await this.adapter.ensureSaved(()=>{this.setPinnedIndex(t)}),await this.saveMeta()}async ignoreSuggestedContact(t){await this.adapter.ensureSaved(()=>{this.addIgnoredContactName(t.name)}),await this.saveMeta()}addIgnoredContactName(t){this.ignoredContactNames.push(t)}isContactIgnored(t){return this.ignoredContactNames.includes(t.name)}async ignoreSuggestedBacklink(t){await this.adapter.ensureSaved(()=>{this.addIgnoredBacklinkLabel(t.label),this.addIgnoredBacklinkFromNoteId(t.fromNoteId)}),await this.saveMeta()}addIgnoredBacklinkLabel(t){this.ignoredBacklinkLabels.push(t)}addIgnoredBacklinkFromNoteId(t){this.ignoredBacklinkFromNoteIds.push(t)}async incrementBacklinkedCount(){await this.adapter.ensureSaved(()=>{this.setBacklinkedCount(this.backlinkedCount+1)}),await this.saveMeta()}mergeDocument(t){this.changeManager.modifyDocument(e=>e?(0,i.Ne)(e,e=>{(0,i.jU)(e,t)}):t)}async addSuggestedContact(t){let e=this.assertGraph.id;await this.ignoreSuggestedContact(t),this.changeManager.modifyDocument(n=>(0,to.jd)({document:n,contact:t,graphId:e}))}addMeeting(t){let{meeting:e,meetingNote:n,attendeeNotes:r,timeFormat:i}=t;this.changeManager.modifyDocument(t=>(0,to.RN)({meeting:e,document:t,meetingNote:n,attendeeNotes:r,timeFormat:i}))}setEnrichment(t){this.systemMetadata={...this.systemMetadata,enrichment:t}}async updateEnrichment(t){h()(t,this.enrichment)||(await this.adapter.ensureSaved(()=>{this.setEnrichment(t)}),await this.saveMeta())}async checkEnrichment(){var t,e,n,r,i,a,o,s;let[l]=this.emails,[c]=this.domains;if(!l&&!c){this.enrichment&&await this.updateEnrichment(null);return}let d=null===(e=this.enrichment)||void 0===e?void 0:null===(t=e.person)||void 0===t?void 0:t.email,u=[null===(r=this.enrichment)||void 0===r?void 0:null===(n=r.company)||void 0===n?void 0:n.domain,null===(i=this.enrichment)||void 0===i?void 0:i.lookedUpDomain,...null!==(s=null===(o=this.enrichment)||void 0===o?void 0:null===(a=o.company)||void 0===a?void 0:a.domainAliases)&&void 0!==s?s:[]],h=!d&&!u.includes(c);(l!==d||h)&&await this.updateEnrichment(null),this.enrichment||await this.fetchEnrichment()}async fetchEnrichment(){if(this.enrichmentRequest||!this.hasPersonTag&&!this.hasCompanyTag)return;let[t]=this.emails,[e]=this.domains;if(!t&&!e)return;this.enrichmentRequest=(0,W.I)({email:t,domain:e});let n=await this.enrichmentRequest,r={...null!=n?n:{},...e&&{lookedUpDomain:e}};this.enrichmentRequest=null,await this.updateEnrichment(r)}async restore(){await this.adapter.ensureSaved(()=>{this.setDeletedAt(null)}),await this.saveMeta()}async deleteOrDestroy(){this.deletedAt?await this.destroy():await this.delete()}async delete(){var t;await (null===(t=this.noteStore)||void 0===t?void 0:t.deleteNote(this))}async destroy(){var t;await (null===(t=this.noteStore)||void 0===t?void 0:t.destroyNote(this))}async saveMeta(){this.persisted&&await this.assertNoteStore.syncUp.save(this.id)}touchEditedAt(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:new Date;this.editedAt=t.getTime()}createSnapshot(){return{...(0,k.vMv)(this),document:this.document,systemMetadata:this.systemMetadata}}onAttachedToRootStore(){return this.addTasksListener(),()=>this.beforeDetach()}beforeDetach(){return(0,D.$)(this.listeners)}constructor(...t){super(...t),this.listeners=[],this.prevSubject=this.subject,this.incomingUpdates=[],this.incomingUpdatesCounter=0,this.placeholderCommit=null,this.isDailyGenerated=!1,this.tasks=[],this.rerenderCounter=1,this.remountCounter=1,this.getDebouncedDocument=function(t,e){let n=(0,S.observable)({counter:0}),r=l()(()=>(0,S.runInAction)(()=>n.counter+=1),1e3);return(0,S.autorun)(()=>{t(),r()}),(0,_.Om)(()=>(n.counter,(0,S.untracked)(()=>t())))}(()=>this.editedDocument,0),this.handleDocChangedDebounce=l()(this.handleDocChanged.bind(this),3e3)}}(0,r.gn)([S.observable],tl.prototype,"viewedAt",void 0),(0,r.gn)([S.observable],tl.prototype,"incomingUpdates",void 0),(0,r.gn)([S.observable],tl.prototype,"incomingUpdatesCounter",void 0),(0,r.gn)([S.observable],tl.prototype,"placeholderCommit",void 0),(0,r.gn)([S.observable],tl.prototype,"isDailyGenerated",void 0),(0,r.gn)([S.observable],tl.prototype,"tasks",void 0),(0,r.gn)([S.observable],tl.prototype,"rerenderCounter",void 0),(0,r.gn)([S.observable],tl.prototype,"remountCounter",void 0),(0,r.gn)([S.computed],tl.prototype,"key",null),(0,r.gn)([S.computed],tl.prototype,"rerenderKey",null),(0,r.gn)([S.computed],tl.prototype,"remountKey",null),(0,r.gn)([S.computed],tl.prototype,"createdAtDate",null),(0,r.gn)([S.computed],tl.prototype,"updatedAtDate",null),(0,r.gn)([S.computed],tl.prototype,"updatedAtTime",null),(0,r.gn)([S.computed],tl.prototype,"editedAtDate",null),(0,r.gn)([S.computed],tl.prototype,"deletedAtDate",null),(0,r.gn)([S.computed],tl.prototype,"pinned",null),(0,r.gn)([S.computed],tl.prototype,"public",null),(0,r.gn)([(0,S.computed)({keepAlive:!0})],tl.prototype,"changeManager",null),(0,r.gn)([S.computed],tl.prototype,"graphId",null),(0,r.gn)([S.computed],tl.prototype,"linkHrefs",null),(0,r.gn)([(0,S.computed)({keepAlive:!0})],tl.prototype,"title",null),(0,r.gn)([(0,S.computed)({keepAlive:!0})],tl.prototype,"slug",null),(0,r.gn)([(0,S.computed)({keepAlive:!0})],tl.prototype,"subjectSlug",null),(0,r.gn)([(0,S.computed)({keepAlive:!0})],tl.prototype,"normalizedSubject",null),(0,r.gn)([S.computed],tl.prototype,"line",null),(0,r.gn)([(0,S.computed)({keepAlive:!0})],tl.prototype,"emails",null),(0,r.gn)([S.computed],tl.prototype,"phoneNumbers",null),(0,r.gn)([S.computed],tl.prototype,"domains",null),(0,r.gn)([(0,S.computed)({keepAlive:!0})],tl.prototype,"tags",null),(0,r.gn)([(0,S.computed)({keepAlive:!0})],tl.prototype,"hasPersonTag",null),(0,r.gn)([S.computed],tl.prototype,"hasCompanyTag",null),(0,r.gn)([(0,S.computed)({keepAlive:!0})],tl.prototype,"contentMetadata",null),(0,r.gn)([S.computed],tl.prototype,"asin",null),(0,r.gn)([S.computed],tl.prototype,"mentions",null),(0,r.gn)([S.computed],tl.prototype,"snippet",null),(0,r.gn)([(0,S.computed)({keepAlive:!0})],tl.prototype,"isBlank",null),(0,r.gn)([S.computed],tl.prototype,"editedOrUpdatedAtTime",null),(0,r.gn)([(0,S.computed)({keepAlive:!0})],tl.prototype,"editedAtFormatted",null),(0,r.gn)([S.computed],tl.prototype,"dailyTense",null),(0,r.gn)([S.computed],tl.prototype,"dailyDate",null),(0,r.gn)([S.computed],tl.prototype,"dailyDateFormatted",null),(0,r.gn)([S.computed],tl.prototype,"dailyAt",null),(0,r.gn)([S.computed],tl.prototype,"isTodaysDailyNote",null),(0,r.gn)([S.computed],tl.prototype,"enrichment",null),(0,r.gn)([S.computed],tl.prototype,"previewSrc",null),(0,r.gn)([S.computed],tl.prototype,"firstEmail",null),(0,r.gn)([S.computed],tl.prototype,"enrichmentMatchText",null),(0,r.gn)([S.computed],tl.prototype,"uid",null),(0,r.gn)([S.computed],tl.prototype,"canRead",null),(0,r.gn)([S.computed],tl.prototype,"canWrite",null),(0,r.gn)([S.computed],tl.prototype,"pendingYDoc",null),(0,r.gn)([S.computed],tl.prototype,"pendingDocument",null),(0,r.gn)([S.computed],tl.prototype,"pendingCommit",null),(0,r.gn)([(0,S.computed)({keepAlive:!0})],tl.prototype,"editedDocument",null),(0,r.gn)([S.computed],tl.prototype,"editedYDoc",null),(0,r.gn)([S.computed],tl.prototype,"hasEditedYDoc",null),(0,r.gn)([(0,S.computed)({keepAlive:!0})],tl.prototype,"editedDocumentNode",null),(0,r.gn)([S.computed],tl.prototype,"editedDocumentMarkdown",null),(0,r.gn)([S.computed],tl.prototype,"editedDocumentHtml",null),(0,r.gn)([(0,S.computed)({keepAlive:!0})],tl.prototype,"debouncedDocument",null),(0,r.gn)([(0,S.computed)({keepAlive:!0})],tl.prototype,"debouncedDocumentNode",null),(0,r.gn)([(0,S.computed)({keepAlive:!0})],tl.prototype,"debouncedSubject",null),(0,r.gn)([S.computed],tl.prototype,"yDocAsUpdateArray",null),(0,r.gn)([S.action],tl.prototype,"setPlaceholderCommit",null),(0,r.gn)([S.action],tl.prototype,"removePlaceholderCommit",null),(0,r.gn)([S.action],tl.prototype,"setIsDailyGenerated",null),(0,r.gn)([S.computed],tl.prototype,"yDoc",null),(0,r.gn)([S.action],tl.prototype,"addIncomingUpdates",null),(0,r.gn)([S.action],tl.prototype,"clearIncomingUpdates",null),(0,r.gn)([(0,S.computed)({keepAlive:!0})],tl.prototype,"documentNode",null),(0,r.gn)([S.computed],tl.prototype,"documentJson",null),(0,r.gn)([S.computed],tl.prototype,"documentHash",null),(0,r.gn)([S.computed],tl.prototype,"documentHtml",null),(0,r.gn)([S.computed],tl.prototype,"documentMarkdown",null),(0,r.gn)([S.computed],tl.prototype,"publishUrl",null),(0,r.gn)([S.computed],tl.prototype,"incomingBacklinksQuery",null),(0,r.gn)([S.computed],tl.prototype,"incomingBacklinks",null),(0,r.gn)([S.computed],tl.prototype,"groupedIncomingBacklinks",null),(0,r.gn)([S.action],tl.prototype,"requestRerender",null),(0,r.gn)([S.action],tl.prototype,"requestRemount",null),(0,r.gn)([S.action],tl.prototype,"setTasks",null),(0,r.gn)([k.ZBq],tl.prototype,"setCreatedAtDate",null),(0,r.gn)([k.ZBq],tl.prototype,"setUpdatedAtDate",null),(0,r.gn)([k.ZBq],tl.prototype,"setDeletedAtDate",null),(0,r.gn)([S.action],tl.prototype,"touchViewedAt",null),(0,r.gn)([S.computed],tl.prototype,"tasksWithContext",null),(0,r.gn)([S.computed],tl.prototype,"assetIds",null),(0,r.gn)([k.ZBq],tl.prototype,"enablePublic",null),(0,r.gn)([k.ZBq],tl.prototype,"disablePublic",null),(0,r.gn)([k.ZBq],tl.prototype,"updatePinned",null),(0,r.gn)([k.ZBq],tl.prototype,"addIgnoredContactName",null),(0,r.gn)([k.ZBq],tl.prototype,"addIgnoredBacklinkLabel",null),(0,r.gn)([k.ZBq],tl.prototype,"addIgnoredBacklinkFromNoteId",null),(0,r.gn)([k.ZBq],tl.prototype,"setEnrichment",null),(0,r.gn)([k.ZBq],tl.prototype,"touchEditedAt",null),tl=(0,r.gn)([(0,k.o4J)("Note")],tl)},9793:function(t,e,n){"use strict";n.d(e,{l7:function(){return o},qg:function(){return a}});var r=n(86534),i=n(87808);let a=(0,r.ZMl)("NoteRef",{getId(t){if(!(t instanceof i.j))throw TypeError("must be note");return function(t){let{graphId:e,noteId:n}=t;return JSON.stringify({graphId:e,noteId:n})}({graphId:t.assertGraph.id,noteId:t.id})},resolve(t){let{graphId:e,noteId:n}=o(t.id),i=(0,r.k0l)(t);if(!i)return;let a=i.graphStore.findById(e);return null==a?void 0:a.noteStore.pool.get(n)},onResolvedValueChange(t,e,n){n&&!e&&(0,r.ogt)(t)}});function o(t){let e=JSON.parse(t);if(!e.graphId||!e.noteId)throw Error("Invalid NoteRef ID: it must contain both a graphId and a noteId");return e}},22341:function(t,e,n){"use strict";n.d(e,{M:function(){return k}});var r=n(15767),i=n(44838),a=n(86534),o=n(8680),s=n(86708),l=n(20991),c=n(88448);class d extends(0,a.Hnr)({showPinnedTasks:(0,a.vgT)(!0).withSetter(),showUpcomingTasks:(0,a.vgT)(!0).withSetter(),showOverdueTasks:(0,a.vgT)(!0).withSetter(),showCurrentTasks:(0,a.vgT)(!0).withSetter(),showOtherTasks:(0,a.vgT)(!0).withSetter()}){setShowArchivedTasks(t){this.showArchivedTasks=t}get filterCount(){return[this.showPinnedTasks,this.showCurrentTasks,this.showOverdueTasks,this.showUpcomingTasks,this.showOtherTasks].filter(t=>!t).length}get showAll(){return[this.showPinnedTasks,this.showCurrentTasks,this.showOverdueTasks,this.showUpcomingTasks,this.showOtherTasks].every(Boolean)}setShowAll(){this.setShowPinnedTasks(!0),this.setShowCurrentTasks(!0),this.setShowOverdueTasks(!0),this.setShowUpcomingTasks(!0),this.setShowOtherTasks(!0)}constructor(...t){super(...t),this.showArchivedTasks=!1}}(0,r.gn)([i.observable],d.prototype,"showArchivedTasks",void 0),(0,r.gn)([i.action],d.prototype,"setShowArchivedTasks",null),(0,r.gn)([i.computed],d.prototype,"filterCount",null),(0,r.gn)([i.computed],d.prototype,"showAll",null),d=(0,r.gn)([(0,a.o4J)("TaskFilterStore")],d);class u extends(0,a.Hnr)({leftSidebarSize:(0,a.vgT)(300).withSetter(),rightSidebarSize:(0,a.vgT)(300).withSetter(),secondaryEditorRatio:(0,a.vgT)(.5).withSetter(),preferencesSidebarSize:(0,a.vgT)(300).withSetter()}){}u=(0,r.gn)([(0,a.o4J)("UiStateStore")],u);let h={showPublicNotes:(0,a.vgT)(!0).withSetter(),showPrivateNotes:(0,a.vgT)(!0).withSetter(),showDailyNotes:(0,a.vgT)(!0).withSetter(),showRegularNotes:(0,a.vgT)(!0).withSetter(),showUnlinkedNotes:(0,a.vgT)(!0).withSetter(),showBlankNotes:(0,a.vgT)(!0).withSetter()},p=Object.keys(h);class g extends(0,a.Hnr)(h){toggleFilter(t){this[t]=!this[t]}get filterCount(){return p.filter(t=>!this[t]).length}}(0,r.gn)([a.ZBq],g.prototype,"toggleFilter",null),(0,r.gn)([i.computed],g.prototype,"filterCount",null),g=(0,r.gn)([(0,a.o4J)("NotesMapFilterStore")],g);var m=n(88351),y=n(82020),f=n(11161),v=n(9544),w=n(81246),b=n(60288),S=n(44719);class k extends(0,a.Hnr)({changeStore:(0,a.vgT)(()=>new s.Me({})),contactStore:(0,a.vgT)(()=>new o.fc({syncEnabled:!(0,f.W)()})),credentialStore:(0,a.vgT)(()=>new o.lT({})),graphStore:(0,a.vgT)(()=>new o.gH({})),mainView:(0,a.vgT)(()=>new c.v({})),meetingStore:(0,a.vgT)(()=>new o.BE({})),preferenceStore:(0,a.vgT)(()=>new o.Vi({})),promptTemplateStore:(0,a.vgT)(()=>new o.Ob({})),uiStateStore:(0,a.vgT)(()=>new u({})),taskFilterStore:(0,a.vgT)(()=>new d({})),notesMapFilterStore:(0,a.vgT)(()=>new g({})),userStore:(0,a.vgT)(()=>new o.U6({})),historyStore:(0,a.vgT)(()=>new l.B({}))}){onAttachedToRootStore(){return this.logger.info("RootStore attached"),this.listeners.push((0,w.g)(t=>this.setOnline(t))),this.markLoadingState(),()=>this.beforeDetach()}async beforeDetach(){return S.k.info("Detaching root-store"),(0,y.$)(this.listeners)}get noteStore(){var t;return null===(t=this.graphStore.currentGraph)||void 0===t?void 0:t.noteStore}get assertNoteStore(){return(0,v.wi)(this,"noteStore")}get bookStore(){var t;return null===(t=this.graphStore.currentGraph)||void 0===t?void 0:t.bookStore}get currentGraph(){return this.graphStore.currentGraph}get assertCurrentGraph(){return(0,v.wi)(this,"currentGraph")}get currentUser(){return this.userStore.currentUser}get assertCurrentUser(){let t=this.currentUser;if(!t)throw Error("user blank");return t}get credentials(){return this.credentialStore.credentials}get uid(){var t;return null===(t=this.userStore.currentUser)||void 0===t?void 0:t.id}get logger(){return S.k.child({userId:this.uid})}get currentUserIsGraphOwner(){var t;return null===(t=this.currentGraph)||void 0===t?void 0:t.isOwner}get needsGraphSetup(){return!!this.currentUser&&this.currentUser.needsSetup}get userNeedsAuth(){return this.userStore.needsAuth}get currentUserAssociatedEmails(){var t,e;let n=this.currentUser,r=null!==(t=this.credentials)&&void 0!==t?t:[],i=null!==(e=null==r?void 0:r.map(t=>{let{email:e}=t;return e}))&&void 0!==e?e:[];return(null==n?void 0:n.email)&&i.push(n.email),i}setScreen(t){this.screen=t}openDefaultScreen(){this.screen=m.z2.Main}openPreferencesScreen(){this.screen=m.z2.Preferences}togglePreferencesScreen(){this.screen===m.z2.Preferences?this.openDefaultScreen():this.openPreferencesScreen()}get loadingState(){var t,e,n;let r=this.currentGraph,i=this.currentUser;for(let[a,o]of[[this.userNeedsAuth,m.Gu.Auth],[!!(null===b.v||void 0===b.v?void 0:b.v.migrating),m.Gu.Migrating],[!!(null===b.v||void 0===b.v?void 0:b.v.migrationFailed),m.Gu.MigrationFailed],[this.needsGraphSetup,m.Gu.GraphSetup],[!(null==r?void 0:r.ready),m.Gu.Loading],[!(null==i?void 0:i.ready),m.Gu.Loading],[!!(null==r?void 0:r.needsEncryptionSetup),m.Gu.GraphEncryptionSetup],[!!(null==r?void 0:null===(t=r.migrationManager)||void 0===t?void 0:t.migrating),m.Gu.Migrating],[!!(null==r?void 0:null===(e=r.migrationManager)||void 0===e?void 0:e.migrationFailed),m.Gu.MigrationFailed],[!!(null==r?void 0:null===(n=r.migrationManager)||void 0===n?void 0:n.migrationOffline),m.Gu.MigrationOffline],[!!(null==r?void 0:r.migratingElsewhere),m.Gu.Migrating],[!!(null==r?void 0:r.versionUnsupported),m.Gu.VersionUnsupported],[!!(null==r?void 0:r.noteStore),m.Gu.MainScreen]])if(a)return o;return m.Gu.Loading}setOnline(t){this.online=t}async markLoadingState(){console.time("Loading all"),await (0,i.when)(()=>this.loadingState!==m.Gu.Loading),console.timeEnd("Loading all")}constructor(...t){super(...t),this.screen=m.z2.Main,this.online=!0,this.listeners=[]}}(0,r.gn)([i.observable],k.prototype,"screen",void 0),(0,r.gn)([i.observable],k.prototype,"online",void 0),(0,r.gn)([i.computed],k.prototype,"needsGraphSetup",null),(0,r.gn)([(0,i.computed)({keepAlive:!0})],k.prototype,"currentUserAssociatedEmails",null),(0,r.gn)([i.action],k.prototype,"setScreen",null),(0,r.gn)([i.action],k.prototype,"openDefaultScreen",null),(0,r.gn)([i.action],k.prototype,"openPreferencesScreen",null),(0,r.gn)([i.computed],k.prototype,"loadingState",null),(0,r.gn)([i.action],k.prototype,"setOnline",null),k=(0,r.gn)([(0,a.o4J)("root")],k)},28407:function(t,e,n){"use strict";n.d(e,{A3:function(){return a},O9:function(){return o},R0:function(){return d},UC:function(){return u},_H:function(){return r},c4:function(){return c},lw:function(){return i},mt:function(){return l},ps:function(){return s}});let r="person",i="company",a="author",o="meeting",s="book",l="link",c="article",d="tweet",u="podcast"},32167:function(t,e,n){"use strict";n.d(e,{i:function(){return m}});var r=n(15767),i=n(75422),a=n(69776),o=n(65741),s=n(80073),l=n(66292),c=n.n(l),d=n(44838),u=n(18688),h=n(24601),p=n(53342),g=n(1130);class m{static build(t){let{text:e,note:n}=t,r=e?[i.K3.paragraphText(e)]:[];return new m({note:n,node:i.K3.taskListItem(r,{checked:!1,archived:!1})})}syncFromTaskNode(t){let{node:e,parentBreadcrumbs:n}=t;this.node.eq(e)||(this.setNode(e),this.resetPendingValues()),this.setParentBreadcrumbs(n)}get noteId(){return this.note.id}get checked(){var t;return null!==(t=this.checkedPending)&&void 0!==t?t:this.node.attrs.checked}setChecked(t){this.checkedPending=t}setNode(t){this.node=t}setParentBreadcrumbs(t){this.parentBreadcrumbs=t&&t.length>0?t:null}resetPendingValues(){this.contentDocumentPending=null,this.checkedPending=null,this.archivedPending=null}updateChecked(t){this.setChecked(t),this.unarchive(),this.syncToNote()}get archived(){var t;return!!this.checked&&(null!==(t=this.archivedPending)&&void 0!==t?t:this.node.attrs.archived)}unarchive(){this.setArchived(!1)}setArchived(t){this.archivedPending=t}updateArchived(t){this.setArchived(t),this.syncToNote()}get overdue(){let t=this.dueDate;return!!t&&!(0,a.Z)(t)&&(0,o.Z)(t)}get upcoming(){let t=this.dueOrDailyDate;return!!t&&!(0,a.Z)(t)&&(0,s.Z)(t)}get current(){return this.scheduled&&!this.upcoming&&!this.overdue}get scheduled(){return!!this.dueOrDailyDate}get isEmpty(){return(0,i._F)(this.contentDocument)}get contentDocumentSource(){var t;return(0,i.cO)(this.node,null===(t=this.note.document)||void 0===t?void 0:t.attrs)}get contentDocument(){var t;return null!==(t=this.contentDocumentPending)&&void 0!==t?t:this.contentDocumentSource}setContentDocument(t){this.contentDocumentPending=t}get contentDocumentNode(){return(0,i.hH)(this.contentDocument)}get inlineDocument(){return(0,i.MQ)(this.contentDocument)}get inlineDocumentNode(){return(0,i.hH)(this.inlineDocument)}get inlineDocumentHtml(){return(0,i.eJ)(this.inlineDocumentNode)}updateInlineDocument(t){let{debounce:e=!1}=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},n=(0,i.wk)({doc:this.contentDocument,inlineDoc:t});this.unarchive(),this.setContentDocument(n),this.syncToNote({debounce:e})}syncToNote(){let{debounce:t=!1}=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};if(t){this.syncToNoteDebounce();return}this.note.syncFromTask(this)}delete(){this.syncToNoteFlush(),this.note.deleteTask({taskGuid:this.id})}convertChecklist(){this.note.convertTaskIntoChecklist({taskGuid:this.id})}async schedule(t){var e,n;let r=t.dailyDate;if(!r)return;await t.incrementBacklinkedCount();let a=this.contentDocumentNode,o=(0,i.S3)(a,{id:t.id,label:(0,u.l6)(r,null===(n=this.rootStore)||void 0===n?void 0:null===(e=n.preferenceStore)||void 0===e?void 0:e.dateFormat),graphId:t.graphId},t=>(0,h.$4)(t.id));this.setContentDocument((0,i.FT)(o)),this.syncToNote()}syncToNoteFlush(){this.syncToNoteDebounce.flush()}matches(t){return!!this.matchText&&this.matchText.includes(t)}get dueDate(){let t=(0,i.QA)(this.node,t=>(0,h.$4)(t.id));return(0,h.cB)(null==t?void 0:t.id)||null}get dueOrDailyDate(){var t,e;return null!==(e=null!==(t=this.dueDate)&&void 0!==t?t:this.note.dailyDate)&&void 0!==e?e:null}get group(){return this.overdue?"overdue":this.current?"current":this.upcoming?"upcoming":this.note}get rootStore(){return this.note.rootStore}get contentNodeText(){var t,e;return null!==(e=null===(t=this.node)||void 0===t?void 0:t.textContent)&&void 0!==e?e:""}get matchText(){var t,e;let n=[this.contentNodeText,null===(t=this.note)||void 0===t?void 0:t.subject,...null!==(e=this.parentBreadcrumbs)&&void 0!==e?e:[]].filter(p.Dw);return(0,g.Up)(n.join(" "))}constructor({node:t,note:e,parentBreadcrumbs:n}){this.parentBreadcrumbs=null,this.contentDocumentPending=null,this.checkedPending=null,this.archivedPending=null,this.syncToNoteDebounce=c()(this.syncToNote.bind(this),6e4),this.id=t.attrs.guid,this.node=null!=t?t:null,this.note=e,this.parentBreadcrumbs=n&&n.length>0?n:null,(0,d.makeObservable)(this)}}(0,r.gn)([d.observable.ref],m.prototype,"node",void 0),(0,r.gn)([d.observable.shallow],m.prototype,"parentBreadcrumbs",void 0),(0,r.gn)([d.observable.ref],m.prototype,"contentDocumentPending",void 0),(0,r.gn)([d.observable],m.prototype,"checkedPending",void 0),(0,r.gn)([d.observable],m.prototype,"archivedPending",void 0),(0,r.gn)([d.computed],m.prototype,"checked",null),(0,r.gn)([d.action],m.prototype,"setChecked",null),(0,r.gn)([d.action],m.prototype,"setNode",null),(0,r.gn)([d.action],m.prototype,"setParentBreadcrumbs",null),(0,r.gn)([d.action],m.prototype,"resetPendingValues",null),(0,r.gn)([d.computed],m.prototype,"archived",null),(0,r.gn)([d.action],m.prototype,"setArchived",null),(0,r.gn)([d.computed],m.prototype,"overdue",null),(0,r.gn)([d.computed],m.prototype,"upcoming",null),(0,r.gn)([d.computed],m.prototype,"current",null),(0,r.gn)([d.computed],m.prototype,"scheduled",null),(0,r.gn)([d.computed],m.prototype,"isEmpty",null),(0,r.gn)([d.computed],m.prototype,"contentDocumentSource",null),(0,r.gn)([d.computed],m.prototype,"contentDocument",null),(0,r.gn)([d.action],m.prototype,"setContentDocument",null),(0,r.gn)([d.computed],m.prototype,"contentDocumentNode",null),(0,r.gn)([d.computed],m.prototype,"inlineDocument",null),(0,r.gn)([d.computed],m.prototype,"inlineDocumentNode",null),(0,r.gn)([d.computed],m.prototype,"inlineDocumentHtml",null),(0,r.gn)([d.computed],m.prototype,"dueDate",null),(0,r.gn)([d.computed],m.prototype,"group",null),(0,r.gn)([d.computed],m.prototype,"contentNodeText",null),(0,r.gn)([(0,d.computed)({keepAlive:!0})],m.prototype,"matchText",null)},32137:function(t,e,n){"use strict";var r,i,a,o,s,l,c,d;n.d(e,{L8:function(){return r},t6:function(){return i},ux:function(){return o},zt:function(){return a}}),(s=r||(r={})).Monday="Monday",s.Sunday="Sunday",(l=i||(i={})).DayMonthYear="dayMonthYear",l.MonthDayYear="monthDayYear",(c=a||(a={})).Hours12="12",c.Hours24="24",(d=o||(o={})).Active="active",d.Canceled="canceled",d.Incomplete="incomplete",d.IncompleteExpired="incomplete_expired",d.PastDue="past_due",d.Trialing="trialing",d.Unpaid="unpaid"},88351:function(t,e,n){"use strict";var r,i,a,o,s,l,c,d,u,h;n.d(e,{Gu:function(){return r},JY:function(){return s},iO:function(){return g},oK:function(){return a},q4:function(){return p},xr:function(){return o},z2:function(){return i}});let p="0.2.5";function g(t){return"object"==typeof t&&null!==t&&("rootScreen"in t||"mainScreen"in t||"preferenceScreen"in t||"graphId"in t||"noteListQuery"in t||"noteId"in t)}(l=r||(r={})).Auth="Auth",l.GraphSetup="GraphSetup",l.GraphEncryptionSetup="GraphEncryptionSetup",l.Migrating="Migrating",l.MigrationFailed="MigrationFailed",l.MigrationOffline="MigrationOffline",l.MigrationRequired="MigrationRequired",l.VersionUnsupported="VersionUnsupported",l.MainScreen="MainScreen",l.Loading="Loading",(c=i||(i={})).Main="main",c.Preferences="preferences",(d=a||(a={})).NoteDaily="note-daily",d.NoteList="note-list",d.NoteEdit="note-edit",d.Map="map",d.TaskList="task-list",(u=o||(o={})).Shortcuts="shortcuts",u.Search="search",(h=s||(s={})).Profile="profile",h.Credentials="credentials",h.Templates="templates",h.Billing="billing",h.Graph="graph",h.NewGraph="new-graph"},28109:function(t,e,n){"use strict";n.d(e,{b:function(){return l},W:function(){return c}});var r=n(11527),i=n(88526),a=n(29442),o=n(50959);let s=t=>{let{hex:e,onClick:n}=t;return(0,r.jsx)(i.v.Item,{children:(0,r.jsx)("button",{className:"h-5 w-5 rounded-md",style:{backgroundColor:e},onClick:n})})},l=["#737373","#f97316","#f59e0b","#eab308","#84cc16","#22c55e","#10b981","#14b8a6","#06b6d4","#0ea5e9","#3b82f6","#6366f1","#8b5cf6","#a855f7","#d946ef","#ec4899","#f43f5e","#ef4444"],c=t=>{let{value:e,onChange:n}=t,c=t=>{null==n||n(t)};return(0,r.jsxs)(i.v,{as:"div",className:"relative",children:[(0,r.jsx)(i.v.Button,{className:"block",children:(0,r.jsx)("div",{className:"h-5 w-5 rounded-md bg-gray-100",style:e?{backgroundColor:e}:{}})}),(0,r.jsx)(a.u,{as:o.Fragment,enter:"transition ease-out duration-100",enterFrom:"transform opacity-0 scale-95",enterTo:"transform opacity-100 scale-100",leave:"transition ease-in duration-75",leaveFrom:"transform opacity-100 scale-100",leaveTo:"transform opacity-0 scale-95",children:(0,r.jsx)(i.v.Items,{className:"absolute left-0 top-7 origin-top-left rounded-md bg-white shadow-lg ring-1 ring-black ring-opacity-5 focus:outline-none dark:bg-bluegray-600",children:(0,r.jsx)("div",{className:"grid grid-cols-6 gap-2 p-2",children:l.map(t=>(0,r.jsx)(s,{hex:t,onClick:()=>c(t)},t))})})})]})}},46935:function(t,e,n){"use strict";n.d(e,{Q2:function(){return u},Fg:function(){return d}});var r=n(11527),i=n(4814),a=n(72811);n(50959);var o=n(11161),s=n(15858),l=n(8680),c=n(98070);function d(){let t=(0,c.tv)(),e=function(){let t=(0,l.bG)();return(null==t?void 0:t.theme)||"system"}();return"system"===e?t:e}let u=(0,a.Pi)((t,e)=>{let{children:n}=t,a=d();return(0,r.jsx)("div",{ref:e,className:(0,i.Z)(["app-theme","dark"===a?"dark":"light",(0,s.d)()&&"electron",(0,o.W)()&&"capacitor",(0,s.qx)()&&"iphone",(0,s.HM)()&&"ipad","select-none antialiased"]),style:{colorScheme:a},children:(0,r.jsx)("div",{className:"bg-background-stark font-sans text-coolgray-900 dark:text-near-white",children:n})})},{forwardRef:!0});u.displayName="Theme"},18688:function(t,e,n){"use strict";n.d(e,{$X:function(){return u},l6:function(){return d},mr:function(){return h},p6:function(){return c},sG:function(){return m},sY:function(){return y},zg:function(){return p}});var r=n(34281),i=n(73625),a=n(82410),o=n(69776),s=n(96757),l=n(44535);function c(t,e){switch(e){case"dayMonthYear":return(0,r.Z)(t,"do MMMM, yyyy");case"monthDayYear":return(0,r.Z)(t,"MMMM do, yyyy");case"weekDayMonthYear":return(0,r.Z)(t,"EEE, do MMMM, yyyy");case"weekMonthDayYear":return(0,r.Z)(t,"EEE, MMMM do, yyyy")}}function d(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"weekDayMonthYear";switch(e){case"dayMonthYear":return(0,r.Z)(t,"d/M/yyyy");case"monthDayYear":return(0,r.Z)(t,"M/d/yyyy");case"weekDayMonthYear":return(0,r.Z)(t,"EEE, d/M/yyyy");case"weekMonthDayYear":return(0,r.Z)(t,"EEE, M/d/yyyy")}}function u(t){return"dayMonthYear"===t?"weekDayMonthYear":"weekMonthDayYear"}function h(t,e){return(0,r.Z)(t,"24"===e?"HH:mm":"h:mmaaa")}function p(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"monthDayYear",n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"12";return(0,o.Z)(t)?h(t,n):(0,a.Z)(t)?(0,r.Z)(t,"eee"):d(t,e)}function g(t,e,n){let r=(0,l.Z)(t,e,n);return(0,s.Z)(r)?r:void 0}function m(t,e){var n,r,i,a;let o=arguments.length>2&&void 0!==arguments[2]?arguments[2]:new Date;switch(e){case"dayMonthYear":return null!==(r=null!==(n=g(t,"dd/MM/yyyy",o))&&void 0!==n?n:g(t,"d/M/yyyy",o))&&void 0!==r?r:g(t,"d/M",o);case"monthDayYear":return null!==(a=null!==(i=g(t,"MM/dd/yyyy",o))&&void 0!==i?i:g(t,"M/d/yyyy",o))&&void 0!==a?a:g(t,"M/d",o)}}function y(t,e){return function(t){var e,n,r,i,a,o,s;let l=null!==(e=t.years)&&void 0!==e?e:0,c=(null!==(n=t.months)&&void 0!==n?n:0)+12*l,d=(null!==(r=t.weeks)&&void 0!==r?r:0)+4*c,u=(null!==(i=t.days)&&void 0!==i?i:0)+7*d,h=(null!==(a=t.hours)&&void 0!==a?a:0)+24*u,p=null!==(o=t.minutes)&&void 0!==o?o:0,g=null!==(s=t.seconds)&&void 0!==s?s:0;return h>0?"".concat(h,":").concat(f(p),":").concat(f(g)):"".concat(p,":").concat(f(g))}((0,i.Z)({start:t,end:e}))}function f(t){return t.toString().padStart(2,"0")}},94242:function(t,e,n){"use strict";function r(t,e){return e&&Object.values(t).includes(e)?e:void 0}n.d(e,{g:function(){return r}})},54879:function(t,e,n){"use strict";n.d(e,{Mn:function(){return i},c0:function(){return o},v3:function(){return a}});var r=n(65728);function i(t){return t?JSON.stringify(t):null}function a(t){return JSON.stringify(t)}function o(t){return t?r.ZP.array(r.ZP.string()).parse(JSON.parse(t)):null}},24601:function(t,e,n){"use strict";function r(t){return t.toLowerCase().trim().replace(/^.+-/g,"").replace(/[\W_]/g,"")}function i(t){if(t instanceof Date||(t=new Date(t)),Number.isNaN(t.getTime()))throw TypeError("Invalid date");let e=t.getDate(),n=t.getMonth()+1,r=t.getFullYear(),i=e<10?"0"+e.toString():e,a=n<10?"0"+n.toString():n;return"".concat(i).concat(a).concat(r)}function a(t){return/^\d{8}$/.test(t)}function o(t){if(!t)return;let e=t.match(/^(\d{2})(\d{2})(\d{4})$/);if(!e)return;let n=Number.parseInt(e[1]),r=Number.parseInt(e[2]),i=Number.parseInt(e[3]);if(n<1||n>31||r<1||r>12)return;let a=new Date(i,r-1,n);return Number.isNaN(a.getTime())?void 0:a}n.d(e,{$4:function(){return a},SG:function(){return r},cB:function(){return o},l5:function(){return i}})},82020:function(t,e,n){"use strict";function r(t){return Promise.all(t.map(i))}async function i(t){if("function"==typeof t)t();else if("function"==typeof t.cancel)t.cancel();else{var e;null===(e=await t)||void 0===e||e()}}n.d(e,{$:function(){return r}})},63317:function(t,e,n){"use strict";n.d(e,{Bu:function(){return c},CI:function(){return u},Gn:function(){return s},KT:function(){return d},NR:function(){return p},Q:function(){return o},gc:function(){return h},kg:function(){return l}});var r=n(75422),i=n(59592);n(23949),n(4363);var a=n(73165);function o(t,e){let n=r.pU.encodeStateVector(e);return function(t,e){let n=r.pU.snapshot(e).ds;for(let[e,i]of r.pU.decodeUpdate(t).ds.clients)for(let t of i){let i=new r.pU.ID(e,t.clock);if(!r.pU.isDeleted(n,i))return!0}return!1}(t=r.pU.diffUpdate(t,n),e)||function(t){let e=r.pU.parseUpdateMeta(t);return e.from.size>0||e.to.size>0}(t)}function s(t){let{originalYDoc:e,updatedNode:n}=t,i=new r.pU.Doc;r.pU.applyUpdate(i,r.pU.encodeStateAsUpdate(e));let a=[];return i.on("update",t=>a.push(t)),function(t,e){let n=e.get("prosemirror",r.pU.XmlFragment);(0,r.e$)(t,n)}(n,i),a}function l(t,e){let n=(0,r.hH)(t);if(null==e||!e.template)return{ydoc:(0,r.VN)(n),node:n};{let e=(0,a.j6)(t);return{ydoc:(0,r.VN)(n,{clientID:e}),node:n,clientId:e}}}function c(t,e){for(let n of e)r.pU.applyUpdate(t,n)}function d(t){let e=r.pU.encodeStateAsUpdate(t);return(0,i.kZ)(e)}function u(t){let e=h(t);return(0,r.eJ)(e)}function h(t){return(0,r._w)(r.fK,t)}function p(t){let e=new r.pU.Doc;return r.pU.applyUpdate(e,t),e}},53342:function(t,e,n){"use strict";function r(t){return null!=t}function i(t,e,n){let r=t[e],i=t.length,a=e-n;if(a>0)return[...t.slice(0,n),r,...t.slice(n,e),...t.slice(e+1,i)];if(a<0){let a=n+1;return[...t.slice(0,e),...t.slice(e+1,a),r,...t.slice(a,i)]}return t}async function a(t,e){return Promise.all(t.map(e))}n.d(e,{Dw:function(){return r},LF:function(){return i},sz:function(){return a}})},39833:function(t,e,n){"use strict";n.d(e,{Ee:function(){return a},Rn:function(){return o},hu:function(){return i},vE:function(){return s}}),n(55872).Buffer;class r extends Error{constructor(t){super(t),this.name="AssertError"}}function i(t,e){if(!t)throw new r(e)}function a(t,e){if("string"!=typeof t||0===t.length)throw new r(e)}function o(t,e){if(function(t,e){if("number"!=typeof t||Number.isNaN(t))throw new r(e)}(t,e),t<=0)throw new r(e)}function s(t,e){var n;throw new r(null!==(n="".concat(e,": ").concat(t))&&void 0!==n?n:"Unexpected value: ".concat(t))}},25333:function(t,e,n){"use strict";n.d(e,{N:function(){return a},S:function(){return o}});let r="reflect-last-auth-provider",i=window.localStorage;function a(t){try{t&&"string"==typeof t&&(null==i||i.setItem(r,t))}catch(t){console.error(t)}}function o(){try{let t=null==i?void 0:i.getItem(r);if(t&&"string"==typeof t){if(t.includes("google"))return"google";if(t.includes("apple"))return"apple";return"email"}}catch(t){console.error(t)}return null}},11161:function(t,e,n){"use strict";n.d(e,{W:function(){return i}});var r=n(90708);function i(){return r.dV.isNativePlatform()}},25637:function(t,e,n){"use strict";n.d(e,{R4:function(){return a},yr:function(){return o}});var r=n(89990),i=n(18143);function a(t){return new Blob([(0,r.unparse)(t)],{type:"text/csv"})}function o(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"export.csv";!function(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"export.csv",n=new Blob([t],{type:"text/csv"});(0,i.l)(n,e)}((0,r.unparse)(t),e)}},7947:function(t,e,n){"use strict";n.d(e,{KF:function(){return i},Y8:function(){return o},yG:function(){return a},yv:function(){return s}});var r=n(14224);function i(){let t=null==r?void 0:"production";return"development"===t?"development":"production"===t?"production":"test"===t?"test":void 0}function a(){return"development"===i()}function o(){return"test"===i()}function s(){return"production"===i()}},44387:function(t,e,n){"use strict";n.d(e,{CR:function(){return c},zO:function(){return s},zk:function(){return l}});var r=n(81149),i=n(92978),a=n(29514),o=n(82317);function s(){return(0,o.zO)(18e5)}let l=(0,o.Om)(t=>(0,r.Z)(t,s())),c=(0,o.Om)(t=>(0,a.Z)(t).getTime()<s());(0,o.Om)(t=>(0,i.Z)(t,s()))},18143:function(t,e,n){"use strict";function r(t,e){let n=URL.createObjectURL(t),r=window.document.createElement("a");r.download=e,r.href=n,r.click()}n.d(e,{l:function(){return r}})},71324:function(t,e,n){"use strict";n.d(e,{K:function(){return o},t:function(){return a}});var r=n(65632),i=n.n(r);function a(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:2,n=["Bytes","KB","MB","GB","TB","PB","EB","ZB","YB"],r=t,i=0;for(;Math.abs(r)>=1024&&i<n.length-1;)r/=1024,i++;return"".concat(r.toFixed(e)," ").concat(n[i])}function o(t){return JSON.stringify(function t(e){return e?"object"==typeof e?i()(e,t):Array.isArray(e)?e.map(t):"number"==typeof e?a(e):e:e}(t))}},44225:function(t,e,n){"use strict";n.d(e,{C:function(){return u}});var r=n(14489),i=n(77783);function a(){let t=(0,r._)(["[^p{L}p{Emoji}d']+"],["[^\\p{L}\\p{Emoji}\\d']+"]);return a=function(){return t},t}function o(){let t=(0,r._)(["p{Ll}p{Lu}"],["\\p{Ll}\\p{Lu}"]);return o=function(){return t},t}function s(){let t=(0,r._)(["p{L}d|dp{L}|p{Ll}p{Lu}"],["\\p{L}\\d|\\d\\p{L}|\\p{Ll}\\p{Lu}"]);return s=function(){return t},t}function l(){let t=(0,r._)(["[p{L}d']"],["[\\p{L}\\d']"]);return l=function(){return t},t}function c(){let t=(0,r._)(["'p{L}{1,2}\b"],["'\\p{L}{1,2}\\b"]);return c=function(){return t},t}let d=new i.Z({unicode:!0,interSplit:String.raw(a()),intraSplit:String.raw(o()),intraBound:String.raw(s()),intraChars:String.raw(l()),intraContr:String.raw(c())});function u(t){let{items:e,query:n,sort:r}=t;n=n.replace(RegExp("\\p{Punctuation}+","gu")," "),n=i.Z.latinize(n),e=i.Z.latinize(e);let a=d.filter(e,n);if(!a||0===a.length)return[];let o=d.info(a,e,n);return r?d.sort(o,e,n).map(t=>[a[t],o.ranges[t]]):a.map((t,e)=>[t,o.ranges[e]])}},41200:function(t,e,n){"use strict";n.d(e,{O:function(){return i}});var r=n(5185);let i=()=>(0,r.Z)().replace(/-/g,"")},91950:function(t,e,n){"use strict";n.d(e,{J:function(){return i}});var r=n(35735);function i(){return(0,r.n)()?null:window}},35735:function(t,e,n){"use strict";function r(){return"undefined"!=typeof WorkerGlobalScope&&"undefined"!=typeof self&&self instanceof WorkerGlobalScope}n.d(e,{n:function(){return r}})},67645:function(t,e,n){"use strict";n.d(e,{AC:function(){return a},C8:function(){return o},Cy:function(){return s},ZE:function(){return i}});var r=n(97708);class i extends Error{constructor(t,e){super(t),this.name="JsonFetchError",this.status=e}}async function a(t){let{url:e,method:n,mode:r,body:a,headers:o,searchParams:s,bearerAuth:l,tokenAuth:c,throwOnHttpError:d=!0}=t,u={method:n||(a?"POST":"GET"),headers:{...a?{"Content-Type":"application/json"}:{},...l?{Authorization:"Bearer ".concat(l)}:{},...c?{Authorization:"Token ".concat(c)}:{},...null!=o?o:{}},body:a?JSON.stringify(a):void 0,mode:r};if(s){let t=new URL(e.startsWith("http")?e:"".concat(window.location.origin).concat(e));for(let[e,n]of Object.entries(s))t.searchParams.append(e,String(n));e=t.toString()}let h=await fetch(e,u);if(500===h.status||d&&!h.ok){let t=e.replace(/\?.*$/,"?hidden_for_logging");console.error("[jsonFetch] Request failed!");let n=await h.text();throw console.error("[jsonFetch] Response text:",n),new i("Request failed for ".concat(u.method," ").concat(t,": ").concat(h.status," ").concat(h.statusText,": ").concat(n),h.status)}return await h.json()}async function o(t,e){return await a({...(0,r.V)(t),body:e,method:"POST"})}function s(t,e){if(t instanceof i)console.warn(e);else throw t}},73748:function(t,e,n){"use strict";function r(t){return JSON.stringify(t)}n.d(e,{l:function(){return r}})},52951:function(t,e,n){"use strict";n.d(e,{Kf:function(){return a},wE:function(){return o}});var r=n(84715),i=n.n(r);function a(t,e){return t.reduce((t,n)=>{let r=e(n),i=t.get(r)||[];return i.push(n),t.set(r,i),t},new Map)}function o(t,e){let n=Array.from(t.entries());return new Map(i()(n,t=>{let[n,r]=t;return e(n,r)}))}},97708:function(t,e,n){"use strict";n.d(e,{V:function(){return s}});var r=n(15858),i=n(39833),a=n(11161),o=n(14224);function s(t){return(0,a.W)()&&(0,r.ob)()===r.t4.Mobile?{url:new URL(t,function(){let t=o.env.NEXT_PUBLIC_REFLECT_ENDPOINT;return(0,i.Ee)(t),t}()).href,mode:"cors"}:{url:t,mode:void 0}}},9544:function(t,e,n){"use strict";n.d(e,{w0:function(){return s},wi:function(){return c},pE:function(){return l}});var r=n(86534);class i extends Error{constructor(t){super("Missing root store for ".concat(t.$modelType," [").concat(t.getRefId(),"]")),this.name="MissingRootStoreError"}}class a extends Error{constructor(t,e){super("Missing prop ".concat(t," in ").concat(e.$modelType)),this.name="MissingPropError"}}class o extends Error{constructor(t){super("Missing parent in ".concat(t)),this.name="MissingParentError"}}function s(t){let e=(0,r.G_R)(t);if(!e){if((0,r.uNj)(t))throw new a("parent",t);throw new o(t)}return e}function l(t){let e=(0,r.k0l)(t);if(!e)throw new i(t);return e}function c(t,e){let n=t[e];if(!n)throw new a(e,t);return n}},66376:function(t,e,n){"use strict";n.d(e,{N:function(){return i}});var r=n(86534);function i(){return{transform(t){let{originalValue:e}=t;return e.data},untransform(t){let{transformedValue:e}=t;return(0,r.jps)(e)}}}},81246:function(t,e,n){"use strict";n.d(e,{g:function(){return a}});let r=!!(0,n(91950).J)(),i=()=>void 0;function a(t){if(!r)return i;t(navigator.onLine);let e=()=>t(!0),n=()=>t(!1);return window.addEventListener("offline",n),window.addEventListener("online",e),()=>{window.removeEventListener("offline",n),window.removeEventListener("online",e)}}},1130:function(t,e,n){"use strict";function r(t){return(t?t.normalize("NFD").replace(RegExp("\\p{Diacritic}","gu"),"").normalize("NFC"):"").trim().toLowerCase().replace(/^"(.*)"$/,"$1")}function i(t){return t.normalize("NFC")}n.d(e,{Up:function(){return r},Ue:function(){return i}})},86655:function(t,e,n){"use strict";n.d(e,{j:function(){return r}});class r{static setup(t){r.adapter=t}static get current(){if(!this.adapter)throw Error("Storage not initialized, call PlatformStorage.setup() first");return this.adapter}static keys(){return r.current.keys()}static setItem(t,e){return r.current.setItem(t,e)}static getItem(t){return r.current.getItem(t)}static removeItem(t){return r.current.removeItem(t)}static clear(){return r.current.clear()}}r.adapter=null},94523:function(t,e,n){"use strict";n.d(e,{GK:function(){return i},Kk:function(){return r}});let r="function"==typeof window.requestIdleCallback?window.requestIdleCallback:setTimeout,i="function"==typeof window.cancelIdleCallback?window.cancelIdleCallback:clearTimeout;e.ZP=r},85204:function(t,e,n){"use strict";n.d(e,{F:function(){return i}});var r=n(18612);class i{async restart(){var t;null===(t=this.listener)||void 0===t||t.call(this),this.listener=void 0;let e=this.handleSnapshotError.bind(this);this.listener=await this.onCreate(e)}async handleSnapshotError(t){this.isDetached||(await (0,r.Z)(5e3),await this.restart())}dispose(){var t;this.isDetached=!0,this.restartInterval&&(clearInterval(this.restartInterval),this.restartInterval=null),null===(t=this.listener)||void 0===t||t.call(this),this.listener=void 0}constructor({onCreate:t,restartPeriod:e=36e5}){this.restartInterval=null,this.isDetached=!1,this.onCreate=t,this.restartPeriod=e,this.restart(),this.restartInterval=setInterval(()=>{this.restart()},this.restartPeriod)}}},18612:function(t,e){"use strict";e.Z=function(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0;return new Promise(e=>{setTimeout(e,t)})}},55673:function(t,e,n){"use strict";async function r(){try{var t,e;if("undefined"==typeof navigator)return null;let n=await (null===(e=navigator.storage)||void 0===e?void 0:null===(t=e.estimate)||void 0===t?void 0:t.call(e));if(!n)return null;let{usage:r,quota:i}=n;if("number"!=typeof r||"number"!=typeof i)return null;return{usage:r,quota:i}}catch(t){return console.error("Failed to get storage estimate:",t),null}}async function i(){try{if("undefined"==typeof navigator)return null;return await navigator.storage.persist()}catch(t){return console.error("Failed to request persistent storage:",t),null}}n.d(e,{i9:function(){return r},lr:function(){return i}})},73165:function(t,e,n){"use strict";n.d(e,{Cv:function(){return r},j6:function(){return i}});let r=n(14979).Z;function i(t){return Math.abs(r(JSON.stringify(t)))}},3146:function(t,e,n){"use strict";n.d(e,{G:function(){return o}});var r=n(57387),i=n(18612);async function a(t){throw await (0,i.Z)(t),new r.m}function o(t,e){return Promise.race([t,a(e)])}},6270:function(t,e,n){"use strict";function r(t){return t.toLowerCase().trim().replace(/\s{2,}/g," ").replace(/\s/g,"-").replace(/[^\w-]/g,"")}n.d(e,{U:function(){return r}})},98070:function(t,e,n){"use strict";n.d(e,{XU:function(){return o},nd:function(){return s},tv:function(){return a}});var r=n(50959);let i="function"==typeof window.matchMedia;function a(){var t;let e=i?window.matchMedia("(prefers-color-scheme: dark)"):{matches:!1},[n,a]=(0,r.useState)(e.matches?"dark":"light");return t=()=>{a(e.matches?"dark":"light")},(0,r.useEffect)(()=>{if(i){let e=window.matchMedia("(prefers-color-scheme: dark)");return o(e,t),()=>{s(e,t)}}},[i]),n}function o(t,e){t.addEventListener?t.addEventListener("change",t=>{e(t)}):t.addListener(t=>{e(t)})}function s(t,e){t.removeEventListener?t.removeEventListener("change",e):t.removeListener(e)}},18734:function(t,e,n){"use strict";n.d(e,{yV:function(){return m},Md:function(){return f},j:function(){return y}});var r=n(5185),i=n(14489),a=n(91950);function o(){let t=(0,i._)(["(^|;)s*"],["(^|;)\\s*"]);return o=function(){return t},t}function s(){let t=(0,i._)(["s*=s*([^;]+)"],["\\s*=\\s*([^;]+)"]);return s=function(){return t},t}let l="anonymous-id";var c=n(36556);async function d(t){let e,{properties:n={},context:i={},event:d}=t,u=await (0,c.nX)(),h=null==u?void 0:u.uid,p=null==u?void 0:u.email,g=((e=function(){let t=(0,a.J)();return function(t){var e;let n=(0,a.J)();if(!n)return null;let r=n.document.cookie.match(String.raw(o())+t+String.raw(s()));return r&&null!==(e=r.pop())&&void 0!==e?e:null}(l)||(null==t?void 0:t.localStorage.getItem(l))||null}())||(e=(0,r.Z)()),function(t){try{!function(t){var e;let n=(0,a.J)();(function(t){let{name:e,value:n,domain:r,daysToLive:i}=t,o=(0,a.J)();if(!o)return;let s=e+"="+encodeURIComponent(n);if("number"==typeof i){let t=new Date;t.setTime(t.getTime()+864e5*i),s+="; expires="+t.toUTCString()}"string"==typeof r&&(s+="; domain=.".concat(r)),s+="; path=/",o.document.cookie=s})({name:l,value:t,domain:null!==(e=function(){var t,e,n;let r=(0,a.J)();return null!==(n=null==r?void 0:null===(e=r.location)||void 0===e?void 0:null===(t=e.hostname)||void 0===t?void 0:t.replace(/^(?:[^.]+\.)*(\w+\.\w+)$/,"$1"))&&void 0!==n?n:null}())&&void 0!==e?e:void 0,daysToLive:365}),null==n||n.localStorage.setItem(l,t)}(t)}catch(t){console.error("Error setting anonymous ID",t)}}(e),e);return{userId:h,anonymousId:g,properties:{...n,email:p},context:{...i,...function(){let t={path:window.location.pathname,title:window.document.title,search:window.location.search,url:window.location.href,referrer:window.document.referrer},e={width:window.screen.width,height:window.screen.height,density:window.devicePixelRatio},n={name:window.navigator.platform,version:window.navigator.appVersion};return{page:t,screen:e,os:n,locale:window.navigator.language,campaign:function(){var t,e,n,r,i;let a=new URL(window.location.href).searchParams;return{source:null!==(t=null==a?void 0:a.get("utm_source"))&&void 0!==t?t:void 0,medium:null!==(e=null==a?void 0:a.get("utm_medium"))&&void 0!==e?e:void 0,name:null!==(n=null==a?void 0:a.get("utm_campaign"))&&void 0!==n?n:void 0,term:null!==(r=null==a?void 0:a.get("utm_term"))&&void 0!==r?r:void 0,content:null!==(i=null==a?void 0:a.get("utm_content"))&&void 0!==i?i:void 0}}(),userAgent:window.navigator.userAgent}}()},event:d}}var u=n(97708);let h="undefined"!=typeof Blob&&"undefined"!=typeof navigator&&"function"==typeof navigator.sendBeacon;var p=n(66530),g=n(33964);function m(t){(0,g.V5)(t)}async function y(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};!function(t,e){if(!h)return;let n=new Blob([JSON.stringify({beacon:e})],{type:"application/json; charset=UTF-8"}),{url:r}=(0,u.V)(t);try{navigator.sendBeacon(r,n)}catch(t){return!1}}("/api/beacon/event",await d({event:t,properties:e}))}function f(){let t=window.location.href,e=window.location.pathname,n=window.document.title;return y("page",{url:t,path:e,title:n,search:window.location.search,referrer:window.document.referrer,...function(){let t,e;let{_fbc:n,_fbp:r}=(0,p.parseCookies)(),i=new URL(window.location.href).searchParams.get("fbclid"),a=new Date().getTime();return i?t="fb.1.".concat(a,".").concat(i):n&&(t=n),r&&(e=r),{fbp:e,fbc:t}}()})}},52619:function(t,e,n){"use strict";n.d(e,{mq:function(){return l},ZU:function(){return c}});var r=n(6046),i=n(81055),a=n(60065),o=n(77956),s=n(76816);async function l(t,e){let n=await (0,s.b)(),i=(0,r.N6)({db:a.db,userId:n,credentialId:t});return o.RZ.onSnapshot(i,t=>{e(t.docs.map(d))})}async function c(t,e){let n=await (0,s.b)(),i=(0,r.N6)({db:a.db,userId:n,credentialId:t}),l=o.RZ.writeBatch(a.db);e.forEach(t=>{let e=o.RZ.doc(i,t.id);l.set(e,{enabled:t.enabled},{merge:!0})}),await l.commit()}function d(t){var e,n,r;let a=t.data();return new i.f({id:t.id,name:null!==(n=null!==(e=a.name)&&void 0!==e?e:a.summary)&&void 0!==n?n:"",primary:a.primary,enabled:a.enabled,priority:null!==(r=a.priority)&&void 0!==r?r:0})}},75087:function(t,e,n){"use strict";n.d(e,{L7:function(){return s},jQ:function(){return o},wk:function(){return i}});var r=n(75422);function i(t){try{return t?(0,r.HU)(t):null}catch(t){return{error:"Couldn't obfuscate document"}}}function a(t){var e;return"<".concat(t.id,"/").concat(null===(e=t.yjsUpdates)||void 0===e?void 0:e.length,">")}function o(t){return t.map(a).join(", ")}function s(t){var e,n;return(null!==(n=null===(e=t.yjsUpdates)||void 0===e?void 0:e.length)&&void 0!==n?n:0)>1e3}},27999:function(t,e,n){"use strict";n.d(e,{PJ:function(){return m},c2:function(){return p},mP:function(){return f}});var r=n(6046),i=n(84715),a=n.n(i),o=n(75240),s=n(53342),l=n(60065),c=n(77956),d=n(71157),u=n(53967),h=n(18786);async function p(t){let{graph:e,noteId:n,afterCommitId:i,encryptionKey:o=e.assertEncryptionKey,skipErrors:d=!1}=t,u=(0,r.Ul)({db:l.db,graphId:e.id,noteId:n}),h=null!==i?c.RZ.query(u,c.RZ.where("id",">",i)):u,p=(await c.RZ.getDocs(h)).docs.map(t=>{let e={noteId:n,encryptionKey:o,snapshot:t};return d?g(e):m(e)}),y=await Promise.all(p);return a()(y.filter(s.Dw),t=>t.id)}async function g(t){try{return await m(t)}catch(e){return console.warn("skipping commit",t.noteId,t.snapshot.id),(0,d.Tb)(e),null}}async function m(t){var e,n,r;let{encryptionKey:i,noteId:a,snapshot:s}=t,l=s.data();if(!l)throw Error("missing data");let c={itemId:a,key:i},d=await f(null!==(n=l.yjs_updates)&&void 0!==n?n:null,c),u=await (0,h.V$)(l.yjs_doc,c),p=l.document_json?await y(l.document_json,c):null;return new o.o({id:l.id,yjsUpdates:d,yjsDocAsUpdate:u,document:p,createdAt:null!==(r=null===(e=l.created_at)||void 0===e?void 0:e.toMillis())&&void 0!==r?r:void 0,platform:l.platform})}async function y(t,e){let n=await (0,u.MJ)({type:"Commit",value:t,...e});return n?JSON.parse(n):null}async function f(t,e){return t?await Promise.all(t.map(t=>(0,u.gq)({type:"Commit",value:t,...e}))):[]}},7665:function(t,e,n){"use strict";n.d(e,{Ms:function(){return l},YO:function(){return s}});var r=n(6046),i=n(53414),a=n(60065),o=n(76816);async function s(){let t=await (0,o.b)();return(0,r.pN)({db:a.db,userId:t})}async function l(t){let{email:e,contactId:n,customName:s}=t,l=await (0,o.b)();if(n){let t=(0,r.ll)({db:a.db,userId:l,contactId:n});if((0,r.Gg)(await (0,r.QT)(t))){await (0,r.r7)(t,{custom_name:s});return}}let d=(0,r.pN)({db:a.db,userId:l}),u=await c(e);if(u.length>0){for(let t of u){let e=(0,r.JU)(d,t.id);await (0,r.r7)(e,{custom_name:s,updated_at:i.Timestamp.now()})}return}{let t=(0,r.JU)(d);return await (0,r.pl)(t,{credential_id:null,given_name:null,family_name:null,custom_name:s,email_values:[e],emails:[{value:e,primary:!0}],primary_email:null,phone_numbers:null,photo_url:null,source_updated_at:null,updated_at:i.Timestamp.now()})}}async function c(t){let e=await (0,o.b)(),n=(0,r.pN)({db:a.db,userId:e}),i=(0,r.IO)(n,(0,r.ZB)("email_values","array-contains-any",[t]));return(await (0,r.PL)(i)).docs}},87823:function(t,e,n){"use strict";n.d(e,{CL:function(){return c},bL:function(){return d},p2:function(){return h}});var r=n(6046),i=n(8680),a=n(60065),o=n(77956),s=n(36556),l=n(76816);async function c(t){let e=await (0,s.i1)();return location.origin+"/api/credentials/auth/".concat(t,"?uid=").concat(e.uid)}async function d(t){return await (0,s.lN)("/api/credentials/".concat(t))}function u(t){let e=t.data();return new i.hJ({id:t.id,provider:e.provider,email:e.email,contactsCount:e.contacts_count,status:e.status,errors:e.errors})}async function h(t){let e=await (0,l.b)(),n=(0,r.Ay)({db:a.db,userId:e});return o.RZ.onSnapshot(n,e=>{t(e.docs.map(u))})}},53967:function(t,e,n){"use strict";n.d(e,{gq:function(){return g},MJ:function(){return h},pM:function(){return p},O6:function(){return y},$N:function(){return m},RY:function(){return s},UF:function(){return c},lb:function(){return l}});var r=n(53414),i=n(81617);class a extends Error{constructor({type:t,itemId:e,cause:n}){super("Failed decrypting ".concat(t,"/").concat(e,": ").concat(n),{cause:n}),this.name="DecryptionFailedError"}}var o=n(39833);async function s(t){let{plain:e,encrypt:n,key:i,itemId:a}=t;if(!n)return{eb:null,pb:r.Bytes.fromUint8Array(e)};{if(!i)throw Error("No key provided");let t=await u({plainblob:e,key:i,itemId:a});return{eb:r.Bytes.fromUint8Array(t),pb:null}}}async function l(t){let{plain:e,encrypt:n,key:r,itemId:i}=t;return s({plain:new TextEncoder().encode(e),encrypt:n,key:r,itemId:i})}async function c(t){let{plain:e,encrypt:n,key:r,itemId:i}=t;if(null==e)return null;if(!n)return{encrypted:null,plain:e};if(!r)throw Error("No key provided");return{encrypted:await d({plain:e,key:r,itemId:i}),plain:null}}async function d(t){let{plain:e,key:n,itemId:r}=t,a=await v({key:n,itemId:r});return(0,i.HI)({key:a,plaintext:e})}async function u(t){let{plainblob:e,key:n,itemId:r}=t,a=await v({key:n,itemId:r});return(0,i.jK)({key:a,plainblob:e})}async function h(t){let{type:e,value:n,key:r,itemId:i}=t;if(!n)return null;if(n.encrypted){if(!r)throw Error("No key provided");return await y({type:e,encrypted:n.encrypted,key:r,itemId:i})}return void 0!==n.plain&&null!==n.plain?n.plain:(console.warn("Decrypting field with no value",n),null)}async function p(t){let{type:e,encrypted:n,plain:r,key:i,itemId:a}=t;if(n){if(!i)throw Error("No key provided");return await y({type:e,encrypted:n,key:i,itemId:a})}if(r)return r}async function g(t){let{type:e,value:n,key:r,itemId:i}=t;if(!n)return null;if(n.eb){(0,o.Ee)(r,"No key provided");let t=n.eb.toUint8Array();return await f({type:e,encrypted:t,key:r,itemId:i})}if(n.pb)return n.pb.toUint8Array();throw Error("Invalid blob field")}async function m(t){let{type:e,value:n,key:r,itemId:i}=t,a=await g({type:e,value:n,key:r,itemId:i});return a?new TextDecoder().decode(a):null}async function y(t){let{type:e,encrypted:n,key:r,itemId:o}=t,s=await v({key:r,itemId:o});try{return(0,i.pe)({key:s,ciphertext:n})}catch(t){throw new a({type:e,itemId:o,cause:t})}}async function f(t){let{type:e,encrypted:n,key:r,itemId:o}=t,s=await v({key:r,itemId:o});try{return(0,i.KL)({key:s,cipherblob:n})}catch(t){throw new a({type:e,itemId:o,cause:t})}}async function v(t){let{itemId:e,key:n}=t;return(0,o.Ee)(e,"No item id provided"),(0,o.Ee)(n,"No key provided"),(0,i.vp)({key:n,salt:e})}},6829:function(t,e,n){"use strict";n.d(e,{Ds:function(){return h},ES:function(){return g},NJ:function(){return m},fL:function(){return p},rz:function(){return u}});var r=n(6046),i=n(53414),a=n(81617),o=n(39833),s=n(41200),l=n(60065),c=n(77956),d=n(53967);async function u(t){let{newHashedPassword:e,graphId:n,masterKey:a,type:o}=t,c=(0,r.OO)({db:l.db,graphId:n}),d=(0,s.O)(),u=await f({itemId:d,masterKey:a,hashedPassword:e}),h=await m({graphId:n,type:o});await (0,r.i3)(l.db,async t=>{for(let e of h)t.delete(e.ref);t.set((0,r.JU)(c,d),{type:o,master_key:u,created_at:i.Timestamp.now()})})}async function h(t){let{hashedPassword:e,graphId:n,type:r}=t;for(let t of(await m({graphId:n,type:r}))){let n=t.data().master_key,r=await y({itemField:n,itemId:t.id,hashedPassword:e});if(r)return r}return null}async function p(t){let{graphId:e,masterKey:n}=t,o=(0,a.Ty)(),c=(0,s.O)(),d=(0,r.Tt)({db:l.db,graphId:e,encryptionKeyId:c}),u=await f({itemId:c,masterKey:n,hashedPassword:o});return await (0,r.pl)(d,{type:"recovery",master_key:u,created_at:i.Timestamp.now()}),{graphId:e,recoveryKey:o,recoveryId:c}}async function g(t){let e=t.graphId,n=t.recoveryId,i=t.recoveryKey;(0,o.Ee)(e),(0,o.Ee)(n),(0,o.Ee)(i);let a=(0,r.Tt)({db:l.db,graphId:e,encryptionKeyId:n}),s=await c.RZ.getDoc(a);if(!s.exists())return null;let d=s.data().master_key;return await y({itemField:d,itemId:n,hashedPassword:i})}async function m(t){let{graphId:e,type:n}=t,i=(0,r.OO)({db:l.db,graphId:e}),a=(0,r.IO)(i,(0,r.ZB)("type","==",n)),{docs:o}=await (0,r.PL)(a);return o}async function y(t){let{itemId:e,itemField:n,hashedPassword:r}=t;try{return await (0,d.$N)({type:"EncryptionKey",itemId:e,value:n,key:r})}catch(t){return null}}async function f(t){let{itemId:e,masterKey:n,hashedPassword:r}=t;return await (0,d.lb)({key:r,itemId:e,encrypt:!0,plain:n})}},68405:function(t,e,n){"use strict";n.d(e,{I:function(){return l}});var r=n(34736),i=n.n(r),a=n(67645),o=n(36556);async function s(t){let{email:e,domain:n}=t,r=new URL("/api/enrich",location.href);e&&r.searchParams.append("email",e),n&&r.searchParams.append("domain",n);try{return await (0,o.AZ)({url:r.href})}catch(t){(0,a.Cy)(t,"[enrich] network error")}}let l=i()(s,t=>"".concat(t.email,"#").concat(t.domain))},99490:function(t,e,n){"use strict";n.d(e,{eP:function(){return v},_3:function(){return w},Vz:function(){return b}});var r=n(6046),i=n(81617),a=n(8680),o=n(18688),s=n(24601),l=n(75422),c=n(41200);let d="journal";var u=n(39833),h=n(97708),p=n(77956),g=n(60065),m=n(6829),y=n(36556),f=n(23354);async function v(t){let{graphId:e,graphName:n,graphPassword:r}=t,a=(0,h.V)("/api/graphs"),o=await (0,y.AZ)({url:a.url,method:"POST",mode:a.mode,body:{graph_name:n,graph_id:e},throwOnHttpError:!1}),s=null==o?void 0:o.error;if(s)return{error:s,graphId:null,recoveryKey:null};e=o.graph_id;let l=(0,i.Ty)();await (0,f.e)({graphId:e,masterKey:l,newPassword:r});let c=await (0,m.fL)({graphId:e,masterKey:l});return{error:null,graphId:e,recoveryKit:c}}async function w(t){return(0,y.lN)("/api/graphs/".concat(t))}async function b(t){(0,u.hu)(t.noteStore,"Missing note store"),(0,u.Ee)(t.encryptionKey,"Missing encryption key");try{await function(t){let e=(0,r.jC)({db:g.db,graphId:t.id});return p.RZ.runTransaction(g.db,async t=>{let n=await t.get(e);if(n.exists())return n.data().has_setup?Promise.reject("already has setup"):t.set(e,{has_setup:!0},{merge:!0});throw Error("unknown graph")})}(t)}catch(t){console.error(t);return}console.log("[reflect-setup] setting up tags..."),t.findOrCreateTag(a._H),t.findOrCreateTag(a.ps),await k(t),await S(t)}async function S(t){console.log("[reflect-setup] setting up notes...");let e=function(t){let e=t.assertRootStore.preferenceStore,n=new Date;return(function(t,e){let n=new Date().getTime(),r=t=>e.onTagAdd(t),i=n=>{let r=t.find(t=>t.subject===n.label);if(!r)throw Error("Seed document not found for backlink ".concat(n.label));return{...n,id:r.id,graphId:e.id}};return t.map(t=>{let{id:e,subject:a,markdown:o,daily:s,pinnedIndex:c}=t;return{id:e,subject:a,daily:s,pinnedIndex:c,createdAt:n,updatedAt:n,documentNode:(0,l.kF)(o,{allowDangerousHtml:!0,onBacklinkAdd:i,onTagAdd:r})}})})([{id:"alexmaccaw",subject:"Alex MacCaw",markdown:"# Alex MacCaw\n\n- Title: CEO\n- Company: [[Reflect]]\n- Type: #person\n- Emails\n  - [alex@reflect.app](mailto:alex@reflect.app)\n"},{id:"how-to-use-reflect",subject:"How to use Reflect",markdown:'# How to use Reflect\n\nThis page will walk you through the basics of how to use reflect effectively. If you\'d prefer, you can also watch our [onboarding video](https://www.youtube.com/watch?v=fYhInYej-lg).\n\nFirst, let\'s make sure you\'ve set up Reflect properly.\n\nWe recommend:\n\n1. syncing [your calendar](https://reflect.app/preferences/credentials),\n1. installing our [Chrome](https://reflect.app/chrome-extension), and [Safari](https://reflect.app/safari-extension) browser extensions to save links and highlights\n1. Download our [iOS and desktop apps](https://reflect.app/download).\n\n### \uD83D\uDCDD The Daily Notes\n\nThe first thing you\'ll notice when you open up Reflect are the **daily notes** stretching forwards and backwards through infinity. Your memory works through time and space so we\'ve mirrored that inside the product.\n\nBy default, everything should go inside today\'s daily note. Your journal, your meeting notes, your bookmarks... all of it.\n\nStart with a fresh day and type `/journal` and then hit `return`. You\'ll see the following:\n\n<img width="655px" alt="journal" src="https://firebasestorage.googleapis.com/v0/b/reflect-prod.appspot.com/o/users%2FRzMNsM9Yy6MSukW9heBcayO8qGH3%2Fb8a81a353c20402d88517d0c5417b507?alt=media&token=967f7807-bf0b-43c3-ba9c-7ed3e119c59a">\n\nThis is a default template we\'ve created for you (you can edit it under the apps preferences).\n\nNotice you can use both bullets or plain text for your notes, but we recommend the former (especially for your daily notes). You can collapse a bullet list by clicking on the parent bullet. This helps keep your daily note nice and clean.\n\nYou can watch our walkthrough of how to use the daily notes format [here](https://www.youtube.com/watch?v=Jlg5__dRUZg).\n\nNow let\'s create a backlink.\n\n### \uD83D\uDD17 Organizing your notes\n\nIn Reflect there is no hierarchy, only association. We\'ve designed it like this because it more accurately represents the way memory works.\n\nA backlink is link between two of your notes. Think of it like a link on the web, but between concepts in your notes.\n\nIn Reflect you create a backlink by typing [(two left brackets). You should backlink any entity you write in your notes (like a person)](https://reflect.site/g/welcomenote/6a7cfff5979c4ece8c13d2eda56335a3).\n\nFor example:\n\n<img width="655px" alt="backlinks" src="https://firebasestorage.googleapis.com/v0/b/reflect-prod.appspot.com/o/users%2FRzMNsM9Yy6MSukW9heBcayO8qGH3%2F53c7507ca78c4f9eb4f06314725ca557?alt=media&token=cfd8dd4c-33fd-44fa-a0dc-75e046a004dc">\n\nThese backlinks automatically start organizing your notes. We delve further into this in [[The power of Backlinks]].\n\n### \uD83C\uDFA4 Transcribing audio notes\n\nReflect has a voice transcriber built in to both it\'s desktop and mobile apps. It uses AI to transcribe your voice with near perfect accuracy. It\'s likely to completely change how you take notes!\n\nYou can record a voice note using the microphone in the top left of the desktop app, and on mobile by tapping the `+` icon and then the microphone.\n\nAudio notes will be placed in your Daily Note. It\'s quite useful to use the AI palette editor to organize your transcribed voice notes.\n\n### ✨ AI Palette Editor\n\nYou can pull up Reflect\'s AI assistant using `cmd j`.\n\nThere is a collection of pre-built prompts you can use. The prompt will be applied to any text that is highlighted when you pull it up.\n\nThe AI palette editor can help you format your notes, fix your writing, help you take meeting notes and a lot more. You can also write and save your own custom prompts!\n\n<img width="655px" alt="ai palette" src="https://firebasestorage.googleapis.com/v0/b/reflect-prod.appspot.com/o/users%2FRzMNsM9Yy6MSukW9heBcayO8qGH3%2F570a96b18e074abf90330dbb94a9878a?alt=media&token=a88d3797-3e2c-4a90-af6c-7968cd90291c">\n\n### \uD83D\uDD0E Advanced search\n\nPress `cmd k` or (`control k` if you\'re on windows) and you\'ll see our advanced search. Whenever you\'ve forgotten something, this is the place to come to find it. You can add filters to narrow down your search, search semantically for words or phrases you don\'t remember, and even chat with your notes using AI!\n\nWe also support some basic commands in here like: `go to daily note`, `5 days from now`, and `Go to a random note`.\n\n<img width="655px" alt="advanced search" src="https://firebasestorage.googleapis.com/v0/b/reflect-prod.appspot.com/o/users%2FRzMNsM9Yy6MSukW9heBcayO8qGH3%2F4a2a6952f8a44262b0117f98512648d2?alt=media&token=02964032-5910-43fe-892d-049f7b75ba0f">\n\n### ✅ Tasks\n\nYou can add tasks to any note, and they will be collected in the Tasks tab on the left.\n\nTasks are shown as a circle you can check off. Regular square checkboxes are not added to the Tasks tab. Add a task by typing `+` and a space on a new line. You can also convert bullets and checkboxes to tasks using `cmd + shift + return`\n\n<img width="655px" alt="tasks" src="https://firebasestorage.googleapis.com/v0/b/reflect-prod.appspot.com/o/users%2FRzMNsM9Yy6MSukW9heBcayO8qGH3%2Fd6f5b910c4264643bf1e612e52a1168b?alt=media&token=2ea4c1e7-7bdc-4f0a-ac78-e087415778b6">\n\n### \uD83D\uDD63 Note history\n\nWe save every key-stroke so you can always go forwards and backwards in time. You can find a note\'s history by clicking the "Show History" button under _note actions_ on the right-hand _sidebar_.\n\n### ⌨️ Keyboard-shortcuts\n\nYou can always see all the keyboard shortcuts by pressing `cmd /` (or control if you\'re on windows). So if there\'s only one shortcut you remember, it\'s that one.\n\nHere are the shortcuts you\'re most likely to use on a day-by-day basis:\n\n- Backlink: `[[`\n- Bullet list: `- space`\n- Todo list: `cmd return` (from inside of a bullet-list)\n- New note: `cmd n`\n- Search notes: `cmd k`\n- Go to daily note: `cmd d`\n- Pull up AI editor `cmd j`\n\n### \uD83D\uDCA1 Learn more\n\nWe\'ve only scratched the surface of Reflect here. Don\'t let our minimalistic interface fool you \uD83D\uDE42\n\nThere\'s a whole [academy of note-taking](https://reflect.academy/) you can check-out with some examples of how best to use Reflect (like as a personal CRM). We also have 100+ workflow videos and tutorials on our [YouTube page](https://www.youtube.com/@reflect-notes).\n',pinnedIndex:0},{id:"reflect",subject:"Reflect",markdown:"# Reflect\n\n- type: #company\n- domain: [reflect.app](http://reflect.app)\n"},{id:"saving-websites",subject:"Saving websites",markdown:'# Saving websites\n\n[[Reflect]] lets you quickly bookmark websites and capture snippets from across the web using [our Chrome and Safari extensions](https://reflect.app/downloads).\n\nFor capturing on the go we have also integrated with iOS’s share menu.\n\n## Capturing with Chrome\n\n1. Browse to a website\n2. Select some text that you want to capture\n3. Press `cmd shift p` to open Reflect’s link capture menu. And then `return`\n   to save the link.\n4. The link will automatically be added to your daily note.\n\n<img width="420px" alt="chrome capture" src="https://firebasestorage.googleapis.com/v0/b/reflect-development-253f5.appspot.com/o/users%2FwUJk2IGa7vNfQvaRDiZ19WxcQ1x1%2F34b571f254fa43bcb3b63e94ae10bf55?alt=media&token=ca9cee7f-9748-45f2-be7a-3522d76aad59">\n\nYou can also activate the Reflect menu by clicking the purple icon, or right clicking on the page.\n\n## Capturing on mobile\n\nIf you have our [iOS app installed](https://reflect.app/testflight) then we’ll add a Reflect icon to iOS’s share menu. Just tap that to save the website to Reflect. Any text highlighted will also be saved.\n\n<img width="420px" alt="mobile capture" src="https://firebasestorage.googleapis.com/v0/b/reflect-development-253f5.appspot.com/o/users%2FwUJk2IGa7vNfQvaRDiZ19WxcQ1x1%2F6f950d9679d84333bb6d0d1a4ce7100f?alt=media&token=97493b91-8ce8-4d3d-b330-5d316579dba1">\n\n## Where do links go?\n\nIncoming links will go under a `Links` bullet inside your daily notes. We backlink this to a dedicated note for that webpage which will contain any text you\'ve captured.\n\n<img width="420px" alt="links bullet" src="https://firebasestorage.googleapis.com/v0/b/reflect-development-253f5.appspot.com/o/users%2FwUJk2IGa7vNfQvaRDiZ19WxcQ1x1%2F66585d0dfdff487ba8bd562c81dcf76d?alt=media&token=e14997a2-90d6-4611-946a-038311ac1547">\n',pinnedIndex:2},{id:"power-of-backlinks",subject:"The power of Backlinks",markdown:'# The power of backlinks\n\nIn Reflect there are two ways of organizing your notes: backlinks and tags.\n\n- Backlinks are a way of _linking notes_ to each other, associating the two.\n- Tags are a way of _categorizing notes_.\n\nLet\'s dive into each.\n\n## **Using Backlinks**\n\nA backlink is just a link between two notes. You should be back-linking any entities you reference in your notes. (For example, an entity might be a particular person, company, or location.)\n\nGenerally you\'ll be working in today\'s daily note, and creating back-links from there. In this example we\'re going to backlink _Ankit Pansari_, a person we just met with.\n\n<img width="420px" alt="backlinking" src="https://firebasestorage.googleapis.com/v0/b/reflect-prod.appspot.com/o/users%2FgjzQZB390LOY9DmlguxzrU6xaHw2%2F16f80aa26aaa4af39813e354a8ae65cf?alt=media&token=3718e2c8-bae0-4f9a-8d86-c1043a469f68">\n\nLet\'s try it. To create a backlink, type `[[` and then the entity name.\n\nYou\'ll then either select an existing note (use the arrow keys) or create a new blank note. Hit `enter` or `tab` to create the backlink.\n\nBacklinks are case-sensitive and should be the full entity name (use New York City rather than NYC).\n\n### Incoming backlinks\n\nClicking on the purple backlink will show you the linked note. In this example, notice that the _incoming backlinks_ panel at the bottom of the note titled _Ankit Pansari_ has a reference back to the daily note linking to it.\n\n<img width="420px" alt="backlinks" src="https://firebasestorage.googleapis.com/v0/b/reflect-prod.appspot.com/o/users%2FgjzQZB390LOY9DmlguxzrU6xaHw2%2Fd0139d51dc1642be84cdcbd77a200273?alt=media&token=80a1672d-2432-4b4c-ab96-f907c613193e">\n\nYou can start to see how this would start to build up an activity feed of your meetings with _Ankit_.\n\n### Forming a graph\n\nOver time these back-linked associations form a graph, in a similar fashion to the way neurons work in your brain.\n\nYou can see this graph forming under the _Map_ tab. Here\'s mine:\n\n<img width="420px" alt="graph view" src="https://firebasestorage.googleapis.com/v0/b/reflect-prod.appspot.com/o/users%2FgjzQZB390LOY9DmlguxzrU6xaHw2%2F9cdf86dc78944abc8e71e5840acbd8b7?alt=media&token=c90d1160-f69f-4db1-9eeb-280365aed889">\n\nSo what’s the point of all this backlinking (other than creating pretty visualizations)? The answer is to do with recall.\n\nLet’s just say you backlink Ankit to the company he works for, OSlash.\n\n<img width="420px" alt="linking oslash" src="https://firebasestorage.googleapis.com/v0/b/reflect-prod.appspot.com/o/users%2FgjzQZB390LOY9DmlguxzrU6xaHw2%2F18373ea4a927498e871b44df4889094f?alt=media&token=22c60e5d-d32a-4b91-9e9c-99be5b74e9fa">\n\nNow you can pull up the company note quickly (`cmd k`). And then see anyone working at that company.\n\n<img width="420px" alt="command k" src="https://firebasestorage.googleapis.com/v0/b/reflect-prod.appspot.com/o/users%2FgjzQZB390LOY9DmlguxzrU6xaHw2%2F094f2c33d64d4e0ea46e3ad42cdadc40?alt=media&token=d18389f0-22a8-497b-953b-74def1ef62eb">\n\nYou can also go in the opposite direction, pulling up employees and seeing where they work.\n\nYou can extend this to all sorts of things, like backlinking specific locations, or projects that you’re working on.\n\nWhen you forget something, say a name, type what you do remember into Reflect. And you’ll be able to follow the associations to whatever you’ve forgotten.\n\n## **Categorizing with tags**\n\nSo now we\'ve seen how backlinks work, let\'s move onto tags. In this example _OSlash_ is Ankit\'s company. Let\'s navigate to that company\'s dedicated note and decorate it with the company website and `#company` hashtag.\n\nTags can be created by typing the hash symbol (`#`) and then the tag-name. Our convention for tag names is lowercase singular without spaces. Hit enter or tab to insert the tag.\n\n<img width="420px" alt="create tag" src="https://firebasestorage.googleapis.com/v0/b/reflect-prod.appspot.com/o/users%2FgjzQZB390LOY9DmlguxzrU6xaHw2%2F29225073939e4a2486a6efb9c89d45c5?alt=media&token=6d0fa6c3-a364-463a-8836-0697af28e6e8">\n\nWe pre-create some system level tags (like `#person`), but in the example above we\'re creating a custom `#company` tag.\n\n### Listing notes by tag\n\nNow that the note has a custom `#company` hashtag we can navigate to it easily under _All notes_.\n\nWhile some system tags are elevated (people/books/etc), custom tags are available under the far right context menu.\n\n<img width="420px" alt="custom tag" src="https://firebasestorage.googleapis.com/v0/b/reflect-prod.appspot.com/o/users%2FgjzQZB390LOY9DmlguxzrU6xaHw2%2Ff447bdd11a154a0abb1afa2c7269ed43?alt=media&token=07ea48d1-70cb-4a9c-a439-8f5807755093">\n\n## **Backlinks vs Tags**\n\nWe often get asked, when do I use a backlink and when do I use a tag? The answer is simple:\n\n- For entities use backlinks\n- For categories use tags\n\nIf something doesn\'t fit neatly into one of these buckets, default to using a backlink.\n\n### Examples of backlinks and tags:\n\nFor example, these entities would be backlinks: Alex MacCaw, Google, New York.\n\nAnd these categories would be tags: #book, #company, #person\n\nNotice we use the convention of singular lower-case for tags.\n\n### Why this distinction?\n\nThe reason lies behind the different behavior when clicking on a backlink vs a tag.\n\nClicking on a _backlink_ takes you to a dedicated note, which is what you\'d want to see for an entity (like a particular person).\n\nEvery time that dedicated note is back-linked (say from your daily notes), a reference will appear in _incoming backlinks_. This is super handy when pulling up call notes on a person, for example.\n\n<img width="420px" alt="incoming backlink" src="https://firebasestorage.googleapis.com/v0/b/reflect-prod.appspot.com/o/users%2FgjzQZB390LOY9DmlguxzrU6xaHw2%2Ff8256614312547b1a57de5d9483398b1?alt=media&token=ae63093f-14e2-4316-a014-fc525517f233">\n\nOn other other hand, clicking on a _tag_ takes you to a list of notes containing that tag. For example, clicking on the `#person` tag shows you a list of all notes with that tag (i.e. all the people you\'ve tagged in Reflect).\n\n<img width="420px" alt="clicking tag" src="https://firebasestorage.googleapis.com/v0/b/reflect-prod.appspot.com/o/users%2FgjzQZB390LOY9DmlguxzrU6xaHw2%2F119880e2bd754b3294d16f8ecdd85854?alt=media&token=9a6eaf54-ae26-4538-811c-506040ce99ee">\n',pinnedIndex:1},{id:"tips-and-tricks",subject:"Tips and tricks",markdown:'# Tips and tricks\n\nHere are a few of our favorite ways of using [[Reflect]].\n\n## Toggle between lists and tasks\n\nWhen in a list:\n\n- hit `cmd return` to toggle between a list-item, checkbox and marked checkbox\n- Hit `cmd shift return` to toggle between a list-item, Task and marked Task\n\n<img width="420px" alt="toggle list" src="https://firebasestorage.googleapis.com/v0/b/reflect-prod.appspot.com/o/users%2FRzMNsM9Yy6MSukW9heBcayO8qGH3%2F61b4aa9462f9456a9098290a59c6a57f?alt=media&token=b6af5a1d-d058-4201-adaa-cba35d4600f9">\n\n## Moving and collapsing bullet points\n\nMove bullet points up or down by using `option up` and `option down`.\n\nYou can also drag and drop list items both vertically, and horizontally to indent them. `tab` and `shift tab` will also indent a list-item.\n\nYou can also collapse parent bullets to clean up complex lists.\n\n<img width="420px" alt="bullets" src="https://firebasestorage.googleapis.com/v0/b/reflect-prod.appspot.com/o/users%2FRzMNsM9Yy6MSukW9heBcayO8qGH3%2Ff9c855fecc5f4714bcab77359f9e1241?alt=media&token=be2b79ff-2802-4395-8504-306ca7490898">\n\n## Focus Mode\n\nIf you either resize Reflect to a smaller window, or hit `cmd shift f`, you go into \'no-distract\' mode which removes the side bars.\n\nBonus points, hit `cmd control f` to go full-screen, and then `cmd shift f` to enable no-distract mode for the ultimate writing experience.\n\nJust hit `cmd` to exit focus mode.\n\n## Back to the future\n\nIt can be useful to write yourself notes in the future. For example, some people like prepping for the week ahead by writing in each daily note.\n\nBoth the command palette and backlink support relative dates. This means you can type dates like: `3 days from now`, `one year ago`, `next thursday`, and you\'ll be sent to the right place.\n\n## Navigate back/forward\n\nUse the keyboard commands `cmd [` and `cmd ]` to navigate back and forward. We\'ve stolen this behavior from your browser, so you should feel right at home.\n\n## Select and backlink\n\nYou can backlink text by highlighting it and typing `[[`\n\n<img width="420px" alt="select and backlink" src="https://firebasestorage.googleapis.com/v0/b/reflect-prod.appspot.com/o/users%2FRzMNsM9Yy6MSukW9heBcayO8qGH3%2Ffb2fc2844d6d4e99a7819d509ccb62a4?alt=media&token=e08eed18-f034-400a-bab1-944b50bb68a8">\n\n## Note aliases\n\nSometimes you\'ll want to alias notes. For example, it\'s easier to type `Mum` than `Charlotte MacCaw`. We\'ve made this simple in Reflect, just use a double forward-slash (`//`) in the subject line of notes to automatically alias each part.\n\nFor example, here our note is called `Charlotte MacCaw // Mum` :\n\n<img width="420px" alt="alias" src="https://firebasestorage.googleapis.com/v0/b/reflect-prod.appspot.com/o/users%2FRzMNsM9Yy6MSukW9heBcayO8qGH3%2Fddecc9ebdf5847e79d19a6011acc0b69?alt=media&token=e36154d1-1121-49f5-9291-b1e9608a64dc">\n\n## De-duplicate notes\n\nNotes with the same subject at the top will automatically prompt you to de-duplicate and merge them when you click into the title.\n\n<img width="420px" alt="de-duplicate notes" src="https://firebasestorage.googleapis.com/v0/b/reflect-prod.appspot.com/o/users%2FRzMNsM9Yy6MSukW9heBcayO8qGH3%2Ffc675eaced9e41e3a5cc14eb4c447d6d?alt=media&token=7ad18d12-9732-42c5-840c-95413159139d">\n\n## Quick text-edit commands\n\n- <mark>highlight</mark> text by surrounding it with `==` on each side of the text\n- ~~strikethrough~~ text by highlighting it and using `cmd shift x`\n- <u>underline</u> text by highlighting it and using `cmd u`\n- create a code block by typing ` ```  ` (don\'t miss the space at the end) on a new line\n  ```\n  like this!\n  ```\n- You can access additional buttons on the mobile editor by swiping the bar to the left\n  <img width="380px" alt="mobile swipe" src="https://firebasestorage.googleapis.com/v0/b/reflect-prod.appspot.com/o/users%2FRzMNsM9Yy6MSukW9heBcayO8qGH3%2F44781b322b49446487add11743defd2d?alt=media&token=06a9985d-9174-41fb-9bb9-76501f736dda">\n\n## And there\'s more!\n\nFor more tips and tricks, please see our [note-taking Academy](https://reflect.academy/).\n',pinnedIndex:3},{id:(0,s.l5)(n),markdown:"- Today I started using [[Reflect]]\n- How should I use [[Reflect]]?\n  - Record everything that happens in your day from your daily note (in a list just like this!)\n    - Write to do lists and items, a running log of what happens in your day, people you meet, ideas, daily reflections, etc.\n    - You can watch workflow videos showing how to use Reflect on our [YouTube page](https://www.youtube.com/@reflect-notes).\n    - We've created a note for you on [[How to use Reflect]] in case you need to reference it at any time.\n  - Use AI to organize your notes\n    - Pull up the AI palette editor using **cmd J**\n    - Chat with your notes with AI through our advanced search (**cmd K**)\n  - If you're not yet familiar, learn about [how to use backlinks](https://reflect.academy/linking-your-notes)\n- Today’s Task List\n  - [ ] Sync your <u>[calendar and contacts](https://reflect.app/preferences/credentials)</u> (for easy meeting imports)\n  - [ ] Install the <u>[Desktop and iOS apps](https://reflect.app/download)</u> (better experience)\n  - [ ] Download our <u>[Chrome and Safari extensions](https://reflect.app/download)</u> (to save things from the web)\n  - [ ] <u>[Import any existing notes](https://reflect.academy/import-export-backups)</u> you have (from tools like Roam, Evernote, Apple Notes, etc.)\n  - [ ] Join our <u>[Discord community](https://reflect.app/discord)</u> (ask questions, share your workflows, product updates, etc.)\n  - [ ] Write down the rest of your to-do items for the day in this list\n  - [ ] Transcribe your first audio note\n",subject:(0,o.p6)(n,e.noteDateFormat),daily:!0},{id:d,subject:"Journal",markdown:"# Journal\n\n-\n"}],t).map(t=>a.jC.build(t,{placeholder:t.daily}))}(t);await Promise.all(e.map(async e=>{await t.noteStore.adapter.addModel(e),e.requestRemount()})),e.forEach(t=>{t.changeManager.requestForceSave()})}async function k(t){for(let e of(console.log("[reflect-setup] setting up templates..."),[new a.YS({name:"journal",document:function(t){let{graphId:e}=t;return{type:"doc",attrs:{version:5},content:[{type:"bulletList",content:[{type:"listItem",attrs:{closed:!1,nested:!1},content:[{type:"paragraph",content:[{type:"backlink",attrs:{id:d,label:"Journal",graphId:e}}]},{type:"bulletList",content:[{type:"listItem",attrs:{closed:!1,nested:!1},content:[{type:"paragraph",content:[{type:"text",text:"Grateful for"}]}]},{type:"listItem",attrs:{closed:!1,nested:!1},content:[{type:"paragraph",content:[{type:"text",text:"On my mind"}]}]},{type:"listItem",attrs:{closed:!1,nested:!1},content:[{type:"paragraph",content:[{type:"text",text:"Working on"}]}]},{type:"listItem",attrs:{closed:!1,nested:!1},content:[{type:"paragraph",content:[{type:"text",text:"Daily habits"}]},{type:"taskList",content:[{type:"taskListItem",attrs:{guid:(0,c.O)(),checked:!1},content:[{type:"paragraph",content:[{type:"text",text:"Exercise"}]}]}]}]}]}]}]}]}}({graphId:t.id})}),new a.YS({name:"person",document:function(t){let{graphId:e}=t;return{type:"doc",attrs:{version:5},content:[{type:"bulletList",content:[{type:"listItem",attrs:{closed:!1,nested:!1},content:[{type:"paragraph",content:[{type:"text",text:"Title: "}]}]},{type:"listItem",attrs:{closed:!1,nested:!1},content:[{type:"paragraph",content:[{type:"text",text:"Company: "}]}]},{type:"listItem",attrs:{closed:!1,nested:!1},content:[{type:"paragraph",content:[{type:"text",text:"Type: "},{type:"tag",attrs:{id:"person",label:"person",graphId:e}},{type:"text",text:" "}]}]},{type:"listItem",attrs:{closed:!1,nested:!1},content:[{type:"paragraph",content:[{type:"text",text:"Email: "}]}]},{type:"listItem",attrs:{closed:!1,nested:!1},content:[{type:"paragraph",content:[{type:"text",text:"Phone: "}]}]},{type:"listItem",attrs:{closed:!1,nested:!1},content:[{type:"paragraph",content:[{type:"text",text:"Location: "}]}]}]}]}}({graphId:t.id})}),new a.YS({name:"company",document:function(t){let{graphId:e}=t;return{type:"doc",attrs:{version:5},content:[{type:"bulletList",content:[{type:"listItem",attrs:{closed:!1,nested:!1},content:[{type:"paragraph",content:[{type:"text",text:"type: "},{type:"tag",attrs:{id:"company",label:"company",graphId:e}},{type:"text",text:" "}]}]},{type:"listItem",attrs:{closed:!1,nested:!1},content:[{type:"paragraph",content:[{type:"text",text:"domain: "}]}]}]}]}}({graphId:t.id})})]))t.templateStore.addTemplate(e),await e.setRemote()}},62298:function(t,e,n){"use strict";n.d(e,{A9:function(){return p},B6:function(){return h},E:function(){return g},Il:function(){return v},h4:function(){return m},w$:function(){return y},yh:function(){return f}});var r=n(6046),i=n(53414),a=n(44838),o=n(69549),s=n(18612),l=n(77956),c=n(71157),d=n(60065),u=n(36556);async function h(t,e){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:5,a=(0,r.jC)({db:d.db,graphId:t});return await (0,u.i1)(),(0,i.onSnapshot)(a,t=>{let n=function(t){var e,n,r,i,a,o;let s=t.data();return s?{id:t.id,ready:!0,name:null!==(e=s.name)&&void 0!==e?e:"",acl:s.acl||[],hasSetup:null!==(n=s.has_setup)&&void 0!==n&&n,version:null!==(r=s.version)&&void 0!==r?r:0,migratingVersion:null!==(i=s.migrating_version)&&void 0!==i?i:null,flags:null!==(a=s.flags)&&void 0!==a?a:[],colorHex:null!==(o=s.color_hex)&&void 0!==o?o:null}:null}(t);n&&e(n)},async r=>{console.error("[onGraphSnapshot] Error:",r),(0,c.Tb)(r),n>0&&(await (0,s.Z)(1e3),console.log("[onGraphSnapshot] Trying again..."),h(t,e,n-1))})}function p(t){let e=(0,r.jC)({db:d.db,graphId:t.id});return l.RZ.setDoc(e,{name:t.name,color_hex:t.colorHex},{merge:!0})}async function g(t){let e;let n=(0,r.jC)({db:d.db,graphId:t});try{e=await l.RZ.getDocFromServer(n)}catch(t){throw new o.fD}if(!e.exists())throw new o.Kg(t);let{version:i}=e.data();return"number"==typeof i?i:0}async function m(t,e){let n=(0,r.jC)({db:d.db,graphId:t.id});await l.RZ.runTransaction(d.db,async r=>{var i;let a=await r.get(n);if(!a.exists())throw new o.Kg(t.id);let s=null!==(i=a.data().migrating_version)&&void 0!==i?i:null;if(null!==s&&s!==e)throw new o.AA({graph:t,migratingVersion:s});r.set(n,{migrating_version:e},{merge:!0})})}async function y(t){let{graph:e,version:n}=t,i=(0,r.jC)({db:d.db,graphId:e.id});await l.RZ.runTransaction(d.db,async t=>{if(!(await t.get(i)).exists())throw new o.Kg(e.id);t.set(i,{migrating_version:null,version:n},{merge:!0})}),await (0,a.when)(()=>e.version===n)}async function f(t,e){let n=(0,r.jC)({db:d.db,graphId:t.id});await (0,i.runTransaction)(d.db,async r=>{if(!function(t,e){var n,r;let i=t.data(),a=null!==(n=null==i?void 0:i.migrating_version)&&void 0!==n?n:null,o=null!==(r=null==i?void 0:i.version)&&void 0!==r?r:null;return null===a&&(null===o||null===e||!(o>e))}(await r.get(n),t.version))throw new o.bZ;return await e(r)})}function v(t,e){let n=(0,r.jC)({db:d.db,graphId:t});return l.RZ.updateDoc(n,{flags:(0,i.arrayUnion)(e)})}},36556:function(t,e,n){"use strict";n.d(e,{$Q:function(){return h},AZ:function(){return g},Aj:function(){return a},g0:function(){return d},i1:function(){return s},lI:function(){return c},lN:function(){return p},nX:function(){return o},rc:function(){return l},tC:function(){return u}});var r=n(67645),i=n(60065);function a(t){return i.I8.onAuthStateChanged(t)}function o(){return new Promise(t=>{i.I8.currentUser?t(i.I8.currentUser):new Promise(t=>{let e=i.I8.onAuthStateChanged(n=>{e(),t(n)})}).then(t)})}function s(){return new Promise(t=>{i.I8.currentUser?t(i.I8.currentUser):new Promise(t=>{let e=i.I8.onAuthStateChanged(n=>{n&&(e(),t(n))})}).then(t)})}function l(){var t,e;return null!==(e=null===(t=i.I8.currentUser)||void 0===t?void 0:t.uid)&&void 0!==e?e:null}async function c(){return(await s()).getIdToken()}async function d(){let t=await c();return{Authorization:"Firebase ".concat(t)}}async function u(t,e){return g({url:t,body:e,method:"POST"})}async function h(t,e){return g({url:t,method:"GET",searchParams:e})}async function p(t){return g({url:t,method:"DELETE"})}async function g(t){let e=await d();return await (0,r.AC)({...t,headers:{...e,...t.headers}})}},67834:function(t,e,n){"use strict";n.d(e,{C:function(){return r}});let r=4},55697:function(t,e,n){"use strict";n.d(e,{H:function(){return c},R:function(){return l}});var r=n(75422),i=n(53414),a=n(63317),o=n(15858),s=n(30059);async function l(t){let{context:e,docCommitId:n}=t,i=(0,s.Ii)(e),o=await (0,s.UF)(t.yDoc,i),l=(0,a.gc)(t.yDoc),c=(0,r.kB)(l);return{subject:await (0,s.Wu)(c,i),yjs_doc:o,doc_commit_id:n,document_json:null}}async function c(t){let{context:e,commitId:n}=t,{graph:r}=e,a=i.Timestamp.now(),l=r.version,c=(0,s.Ii)(e),d=await (0,s.cu)(t.yjsUpdates,c);return{id:n,platform:(0,o.ob)(),created_at:a,graph_version:l,yjs_updates:d}}},17401:function(t,e,n){"use strict";n.d(e,{E:function(){return l},w:function(){return s}});var r=n(54879),i=n(18786),a=n(67834),o=n(30059);function s(t){return e=>l(e,t)}async function l(t,e){var n,s,l,c,d,u,h;let p=(0,o.Ii)({graph:e,row:t}),g=null!==(n=(0,r.c0)(t.ignoredBacklinkLabels))&&void 0!==n?n:[],m=await (0,o.FS)(g,p),y=null!==(s=(0,r.c0)(t.ignoredContactNames))&&void 0!==s?s:[],f=await (0,o.FS)(y,p),v=t.systemMetadata?JSON.parse(t.systemMetadata):null;return{id:t.id,version:a.C,acl:null!==(l=(0,r.c0)(t.acl))&&void 0!==l?l:[],created_at:(0,i.Mp)(t.createdAt),updated_at:(0,i.Mp)(t.updatedAt),edited_at:(0,i.Mp)(null!==(c=t.editedAt)&&void 0!==c?c:null),deleted_at:(0,i.Mp)(null!==(d=t.deletedAt)&&void 0!==d?d:null),backlinked_count:t.backlinkedCount,daily:!!t.isDaily,ignored_backlink_from_note_ids:(0,r.c0)(t.ignoredBacklinkFromNoteIds),ignored_backlink_labels:m,ignored_contact_names:f,pinned_index:null!==(u=t.pinnedIndex)&&void 0!==u?u:null,system_metadata:null!==(h=null==v?void 0:v.data)&&void 0!==h?h:null}}},70968:function(t,e,n){"use strict";n.d(e,{_:function(){return s}});var r=n(75422),i=n(18453),a=n(55697),o=n(17401);async function s(t){let{note:e}=t,n=e.assertYDoc,s=[r.pU.encodeStateAsUpdate(n)],l=(0,i.s4)("123",e),c=await (0,o.E)(l,t.graph),d=await (0,a.R)({yDoc:e.assertYDoc,docCommitId:0,context:t});return{note:{...c,...d,last_commit_id:0},commit:await (0,a.H)({commitId:0,yjsUpdates:s,context:t})}}},30059:function(t,e,n){"use strict";n.d(e,{FS:function(){return u},Ii:function(){return h},UF:function(){return s},Wu:function(){return d},cu:function(){return c},ec:function(){return l}});var r=n(75422),i=n(54879),a=n(73748),o=n(53967);function s(t,e){let n=r.pU.encodeStateAsUpdate(t);return(0,o.RY)({plain:n,...e})}function l(t,e){var n;return t?(0,o.UF)({plain:null!==(n=(0,a.l)(t))&&void 0!==n?n:null,...e}):null}async function c(t,e){return await Promise.all(t.map(t=>(0,o.RY)({plain:t,...e})))}function d(t,e){return(0,o.UF)({plain:t,...e})}function u(t,e){return(0,o.UF)({plain:(0,a.l)(t),...e})}function h(t){if("note"in t){let{note:e,graph:n}=t;return{encrypt:!e.public,key:n.assertEncryptionKey,itemId:e.id}}{var e;let{row:n,graph:r}=t;return{encrypt:!(null!==(e=(0,i.c0)(n.acl))&&void 0!==e?e:[]).includes("public"),key:r.assertEncryptionKey,itemId:n.id}}}},6885:function(t,e,n){"use strict";n.d(e,{c:function(){return s},U3:function(){return w},gw:function(){return T.g}}),n(70968);var r=n(6046),i=n(60065),a=n(77956),o=n(38677);async function s(t){let e=(0,r.J4)({db:i.db,graphId:t.id}),n=new o.r({encryptionKey:t.encryptionKey}),{docs:s}=await a.RZ.getDocsFromServer(e);return Promise.all(s.map(t=>n.valuesFromDoc(t)))}var l=n(75422),c=n(53414),d=n(94232),u=n(18453),h=n(71157),p=n(62298),g=n(55697),m=n(51842),y=n.n(m),f=n(63317),v=n(17401);async function w(t){let e=function(t){let{note:e}=t,n=function(t){let{graph:e,note:n}=t;return e.logger.child({noteId:n.id})}(t),r=e.lastCommitId;return{...t,logger:n,lastCommitId:r}}(t),{logger:n}=e,r=null,i=[];try{await (0,p.yh)(e.graph,async t=>{let a=await b({tx:t,context:e,logger:n});r=a.commitId,i=a.yjsUpdates}),n.info("\uD83D\uDCBE saved commit ".concat(r," reason: ").concat(t.reason))}catch(t){return function(t){let{error:e,context:n,commitId:r}=t,{logger:i,note:a}=n,o=e instanceof Error?e:Error("Unknown error: ".concat(e));if(o instanceof d.Cn)return i.warn("[NoteRemoteStorage] commit ".concat(r," exists, save failed")),{success:!1,error:"commitExists"};if(o.message.startsWith("Document already exists:"))return i.warn("[NoteRemoteStorage] concurrent edit commit ".concat(r," ").concat(o.message)),{success:!1,error:"commitExists"};if(!o.message.includes("exceeds the maximum allowed size"))return i.error("[NoteRemoteStorage] failed saving commit ".concat(r," ").concat(o.message)),(0,h.Tb)(o,{tags:{noteId:a.id}}),{success:!1,error:"other"};{i.error("[".concat(a.id,"] failed saving commit ").concat(r,", commit is too large"));let t=new d.Xn;return(0,h.Tb)(t,{tags:{noteId:a.id},extra:{commitId:r}}),{success:!1,error:"tooLarge"}}}({error:t,context:e,commitId:r})}return{success:!0,error:null,commitId:r,yjsUpdates:i}}async function b(t){let e=await S(t);return function(t){let{tx:e,context:n}=t,{note:r,commit:i}=n,a=N(n).publishedNoteRef;if(r.public){let t=function(t){let{yDoc:e}=t,n=(0,f.gc)(e);return{subject:(0,l.kB)(n),document_html:(0,l.eJ)(n),snippet:y()((0,l.Oj)(n),{length:200}),updated_at:c.Timestamp.now()}}({yDoc:i.getPendingYDoc(r)});e.set(a,t,{merge:!0})}else e.delete(a)}(t),e}async function S(t){let{tx:e,context:n,logger:r}=t,{noteRef:i}=N(n),a=await e.get(i);return a.exists()?await k({tx:e,context:n,noteSnapshot:a,logger:r}):await I({tx:e,context:n,logger:r})}async function k(t){var e;let{tx:n,context:r,noteSnapshot:i,logger:a}=t,{note:o,commit:s}=r,l=i.data(),d=null!==(e=null==l?void 0:l.last_commit_id)&&void 0!==e?e:null,u=null===d?0:d+1,h=x(r,u),{noteRef:p}=N(r),m=c.Timestamp.now(),y=s.getPendingYDoc(o),f=s.yjsUpdatesArrays,v=r.lastCommitId===d;l.yjs_doc||a.warn("yjs_doc is missing for note ".concat(o.id,", last_commit_id: ").concat(d,", lastCommitId: ").concat(r.lastCommitId,".")),v||a.warn("Saving commit ".concat(u,", found existing commit in db ").concat(d," while locally we have ").concat(r.note.lastCommitId,". Skipping content update."));let w=await (0,g.R)({yDoc:y,context:r,docCommitId:u}),b={...v?w:{},last_commit_id:u,updated_at:m,edited_at:m,acl:o.acl},S=await (0,g.H)({context:r,commitId:u,yjsUpdates:f});return function(t){var e;let{shouldSetNoteContent:n,dbNote:r,commitDoc:i,notePartial:a,commitId:o}=t;n&&"number"!=typeof(null!==(e=r.commit_with_ydoc_id)&&void 0!==e?e:null)&&(i.yjs_doc=a.yjs_doc,a.commit_with_ydoc_id=o)}({shouldSetNoteContent:v,dbNote:l,commitDoc:S,notePartial:b,commitId:u}),n.set(p,b,{merge:!0}),n.set(h,S),{commitId:u,yjsUpdates:f}}async function I(t){let{tx:e,context:n,logger:r}=t,{note:i,commit:a}=n,{noteRef:o}=N(n),s=c.Timestamp.now(),d=a.getPendingYDoc(i),h=[l.pU.encodeStateAsUpdate(d)],p=x(n,0),m=(0,u.s4)("123",i),y=await (0,v.E)(m,n.graph),f=await (0,g.R)({yDoc:d,context:n,docCommitId:0}),w={...y,...f,last_commit_id:0,updated_at:s,edited_at:s,acl:i.acl};w.yjs_doc||r.warn("yjs_doc is missing for note ".concat(i.id,", during creation."));let b=await (0,g.H)({context:n,commitId:0,yjsUpdates:h});return e.set(o,w,{merge:!1}),e.set(p,b),{commitId:0,yjsUpdates:h}}function N(t){let{graph:e,note:n}=t;return{noteRef:(0,r.lB)({db:i.db,graphId:e.id,noteId:n.id}),publishedNoteRef:(0,r.dX)({db:i.db,graphId:e.id,publishedNoteId:n.id})}}function x(t,e){let{graph:n,note:a}=t;return(0,r.t2)({db:i.db,graphId:n.id,noteId:a.id,commitId:String(e)})}var T=n(70551)},70551:function(t,e,n){"use strict";n.d(e,{g:function(){return u},h:function(){return d}});var r=n(6046),i=n(41255),a=n.n(i),o=n(60065),s=n(77956),l=n(62298),c=n(70968);async function d(t,e){await g(t,e);let n=p({graph:t,note:e,commitId:"0"}),r=await (0,c._)({graph:t,note:e});await (0,l.yh)(t,async t=>{t.set(n.note,r.note),t.set(n.commit,r.commit)})}async function u(t){let{graph:e,notes:n,batchSize:r=250,progress:i,createInitialCommit:o}=t;for(let t of(null==i||i.setTotal(n.length),a()(n,r)))await h({graph:e,notesChunk:t,createInitialCommit:o}),null==i||i.increment(t.length)}async function h(t){let{graph:e,notesChunk:n,createInitialCommit:r}=t,i=e.logger,a=s.RZ.writeBatch(o.db);for(let t of n){let n=await (0,c._)({graph:e,note:t}),o=p({graph:e,note:t,commitId:"0"});n.note.yjs_doc||i.warn("yjs_doc is missing for note ".concat(t.id,", during unsafe batch saving.")),a.set(o.note,n.note),r&&a.set(o.commit,n.commit)}await a.commit()}function p(t){let{graph:e,note:n,commitId:i}=t,a={db:o.db,graphId:e.id,noteId:n.id,commitId:i};return{note:(0,r.lB)(a),commit:(0,r.t2)({...a,commitId:i})}}async function g(t,e){let n=(0,r.lB)({db:o.db,graphId:t.id,noteId:e.id}),i=(0,r.Ul)({db:o.db,graphId:t.id,noteId:e.id}),a=await s.RZ.getDocs(i),l=s.RZ.writeBatch(o.db);for(let t of a.docs)l.delete(t.ref);l.delete(n),await l.commit()}},74436:function(t,e,n){"use strict";n.d(e,{Lz:function(){return d},Yu:function(){return c},ln:function(){return l}});var r=n(6046),i=n(53414),a=n(41200),o=n(60065),s=n(36556);async function l(t){let e=await (0,s.i1)(),n=(0,r.lG)({db:o.db,userId:e.uid});return(0,i.onSnapshot)(n,e=>{t(e.docs.map(t=>({id:t.id,label:t.data().label,template:t.data().template})))})}async function c(t){let{id:e,label:n,template:l}=t,c=await (0,s.i1)(),d=null!=e?e:(0,a.O)(),u=(0,r.$p)({db:o.db,userId:c.uid,promptTemplateId:d});return await (0,i.setDoc)(u,{label:n,template:l},{merge:!0}),{id:d}}async function d(t){let e=await (0,s.i1)(),n=(0,r.$p)({db:o.db,userId:e.uid,promptTemplateId:t});await (0,i.deleteDoc)(n)}},76816:function(t,e,n){"use strict";n.d(e,{b:function(){return i}});var r=n(36556);async function i(){return(await (0,r.i1)()).uid}},18786:function(t,e,n){"use strict";n.d(e,{Mp:function(){return a},V$:function(){return s},av:function(){return o}});var r=n(53414),i=n(53967);function a(t){var e;return(e=null!=t?new Date(t):null)?r.Timestamp.fromDate(e):null}function o(t){return t?t.toMillis():null}async function s(t,e){if(t)return await (0,i.gq)({type:"Note",value:t,...e})}},38677:function(t,e,n){"use strict";n.d(e,{r:function(){return u}});var r=n(75422),i=n(59592),a=n(44838),o=n(8711),s=n(8680),l=n(63317),c=n(53967),d=n(18786);class u{static async noteFromDoc(t,e){let n=new u({encryptionKey:e});return await n.noteFromDoc(t)}async noteFromDoc(t){try{let e=await this.valuesFromDoc(t);return new s.jC(e)}catch(e){throw new o.UG({id:t.id,cause:e})}}async valuesFromDoc(t){let e=t.id,n=t.data(),r=this.dataWithAllEncrypted(t),i=this.dataWithFieldsEncrypted(t);if(i)return await this.readDocWithFieldsEncrypted(e,i);let a=this.formatFromVersion(null==n?void 0:n.version);if("allEncrypted"===a&&r)return await this.readDocWithAllEncrypted(e,r);if("fieldsEncrypted"===a&&i)return await this.readDocWithFieldsEncrypted(e,i);throw console.error("[NoteReader] Unable to read the note id: ".concat(e),n),Error("[NoteReader] Unable to read the note id: ".concat(e))}dataWithAllEncrypted(t){let e=t.data();if(e&&("encrypted_note_json"in e||"note_json"in e))return e}dataWithFieldsEncrypted(t){let e=t.data();if(e&&("yjs_doc"in e||"document_json"in e))return e}async readDocWithAllEncrypted(t,e){let n=await (0,c.pM)({type:"Note",encrypted:e.encrypted_note_json,plain:e.note_json,key:this.encryptionKey,itemId:t});if(!n)throw console.error("Malformed note",e),Error("Malformed note");return JSON.parse(n)}async readDocWithFieldsEncrypted(t,e){var n,o,s,u,h,p;let g;let m={key:this.encryptionKey,itemId:t},y=await (0,d.V$)(e.yjs_doc,m);if(y){let t=(0,l.NR)(y);g=(0,r.x4)(t)}else{let t=await (0,c.MJ)({type:"Note",value:e.document_json,...m});g=t?JSON.parse(t):void 0}let f=await (0,c.MJ)({type:"Note",value:e.ignored_contact_names,key:this.encryptionKey,itemId:t}),v=f?JSON.parse(f):[],w=await (0,c.MJ)({type:"Note",value:e.ignored_backlink_labels,key:this.encryptionKey,itemId:t}),b=w?JSON.parse(w):[];return{id:e.id,acl:(0,a.toJS)(e.acl),createdAt:e.created_at.toDate().getTime(),updatedAt:e.updated_at.toDate().getTime(),editedAt:null===(n=e.edited_at)||void 0===n?void 0:n.toDate().getTime(),deletedAt:null!==(s=null===(o=e.deleted_at)||void 0===o?void 0:o.toDate().getTime())&&void 0!==s?s:null,backlinkedCount:e.backlinked_count,daily:e.daily,ignoredBacklinkFromNoteIds:null!==(u=(0,a.toJS)(e.ignored_backlink_from_note_ids))&&void 0!==u?u:[],ignoredBacklinkLabels:b,ignoredContactNames:v,pinnedIndex:e.pinned_index,systemMetadata:null!==(h=e.system_metadata)&&void 0!==h?h:void 0,subject:null!==(p=await (0,c.MJ)({type:"Note",value:e.subject,key:this.encryptionKey,itemId:t}))&&void 0!==p?p:"",document:g,yDocAsUpdate:y?(0,i.kZ)(y):void 0,lastCommitId:e.last_commit_id,docCommitId:e.doc_commit_id}}formatFromVersion(t){return void 0===t||t<=3?"allEncrypted":t>=4?"fieldsEncrypted":void 0}constructor({encryptionKey:t}){this.encryptionKey=t}}},23354:function(t,e,n){"use strict";n.d(e,{e:function(){return d},u:function(){return u}});var r=n(6046),i=n(53414),a=n(81617),o=n(60065),s=n(6829),l=n(76343);function c(t){return(0,l.c)({password:t,salt:"7ac05285256da683c4aa863deae95fd3"})}async function d(t){let{newPassword:e,graphId:n,masterKey:r}=t,i=await c(e);await (0,s.rz)({newHashedPassword:i,graphId:n,masterKey:r,type:"sign-in"})}async function u(t){let{password:e,graphId:n}=t,r=await c(e);return await (0,s.Ds)({hashedPassword:r,graphId:n,type:"sign-in"})||h({hashedPassword:r,graphId:n})}async function h(t){var e;let{hashedPassword:n,graphId:l}=t;if((await (0,s.NJ)({graphId:l,type:"sign-in"})).length>0)return null;let c=(0,r.jC)({db:o.db,graphId:l}),d=null===(e=(await (0,i.getDoc)(c)).data())||void 0===e?void 0:e.encryption_check;if(!d)return null;try{return(0,a.pe)({key:n,ciphertext:d}),n}catch(t){return null}}},84769:function(t,e,n){"use strict";n.d(e,{OG:function(){return m},Xc:function(){return y},ij:function(){return p},zX:function(){return g}});var r=n(6046),i=n(53414),a=n(41255),o=n.n(a),s=n(8680),l=n(53342),c=n(60065),d=n(77956),u=n(71157),h=n(53967);function p(t,e){let n=(0,r.Eb)({db:c.db,graphId:t.id});return d.RZ.onSnapshot(n,async n=>{let r=n.docs.map(async e=>{try{return await f(t,e)}catch(t){console.error("Error converting template snapshot",t),(0,u.Tb)(t)}});e((await Promise.all(r)).filter(l.Dw))})}async function g(t,e){let n=(0,r.RE)({db:c.db,graphId:t.id,templateId:e.id}),i=await v(t,e);return d.RZ.setDoc(n,i,{merge:!0})}async function m(t,e){for(let n of o()(e,500)){let e=d.RZ.writeBatch(c.db);for(let i of n){let n=(0,r.RE)({db:c.db,graphId:t.id,templateId:i.id}),a=await v(t,i);e.set(n,a,{merge:!0})}await e.commit()}}async function y(t,e){let n=(0,r.RE)({db:c.db,graphId:t.id,templateId:e});return await d.RZ.deleteDoc(n)}async function f(t,e){var n,r,i;let a=e.data(),o=await (0,h.MJ)({type:"Template",key:t.assertEncryptionKey,itemId:e.id,value:null!==(r=null==a?void 0:a.name)&&void 0!==r?r:null}),l=await (0,h.MJ)({type:"Template",key:t.assertEncryptionKey,itemId:e.id,value:null!==(i=null==a?void 0:a.document_json)&&void 0!==i?i:null});return new s.YS({id:e.id,name:o,document:l?JSON.parse(l):void 0,createdAt:null==a?void 0:null===(n=a.created_at)||void 0===n?void 0:n.toMillis()})}async function v(t,e){return{name:await (0,h.UF)({key:t.assertEncryptionKey,itemId:e.id,plain:e.name,encrypt:!0}),document_json:await (0,h.UF)({key:t.assertEncryptionKey,itemId:e.id,plain:e.document?JSON.stringify(e.document):null,encrypt:!0}),created_at:i.Timestamp.fromMillis(e.createdAt)}}},33964:function(t,e,n){"use strict";n.d(e,{CG:function(){return w},Mo:function(){return f},Oh:function(){return b},PR:function(){return y},V5:function(){return v},gh:function(){return I},mD:function(){return S},sL:function(){return N},tU:function(){return k},xH:function(){return x}});var r=n(6046),i=n(53414),a=n(89300),o=n.n(a),s=n(24465),l=n.n(s),c=n(32137),d=n(94242),u=n(18612),h=n(77956),p=n(71157),g=n(60065),m=n(36556);function y(t){let e=(0,r.DU)({db:g.db,userId:t});return h.RZ.getDoc(e)}async function f(t){let e=await (0,m.i1)(),n=(0,r.DU)({db:g.db,userId:e.uid});return(0,i.onSnapshot)(n,n=>{let r=n.data();r&&t(e,r)},async e=>{console.error("[onUserSnapshot] Error:",e),(0,p.Tb)(e),await (0,u.Z)(1e3),console.log("[onUserSnapshot] Trying again..."),f(t)})}async function v(t){return w((await (0,m.i1)()).uid,t)}async function w(t,e){let n={backlink_created:e.backlinkCreated,book_synced:e.bookSynced,chrome_extension_installed:e.chromeExtensionInstalled,credential_auth:e.credentialAuth,graph_created:e.graphCreated,link_created:e.linkCreated,meeting_added:e.meetingAdded,onboarded:e.onboarded,onboarding_add_meeting_ignored:e.onboardingAddMeetingIgnored,onboarding_backlink_ignored:e.onboardingBacklinkIgnored,onboarding_links_ignored:e.onboardingLinksIgnored,shortcuts_opened:e.shortcutsOpened,tag_created:e.tagCreated},i=(0,r.DU)({db:g.db,userId:t}),a=l()(n,o());await h.RZ.setDoc(i,{traits:a},{merge:!0})}async function b(t){let e=(await (0,m.i1)()).uid,n=(0,r.DU)({db:g.db,userId:e}),i={date_format:t.dateFormat,time_format:t.timeFormat,week_start:t.weekStart,spell_check:t.spellCheck,labs:t.labs,transcription_prompt:t.transcriptionPrompt,transcription_language:t.transcriptionLanguage,transcription_format:t.transcriptionFormat,ai_provider:t.aiProvider,openai_api_key_excerpt:t.openaiApiKeyExcerpt,anthropic_api_key_excerpt:t.anthropicApiKeyExcerpt},a=l()(i,o());await h.RZ.setDoc(n,{preferences:a},{merge:!0})}async function S(t){let{openaiApiKey:e,anthropicApiKey:n}=t;return await (0,m.AZ)({url:"/api/users/me/internal-preferences",method:"PUT",body:{openai_api_key:e,anthropic_api_key:n}})}async function k(t,e){let n=h.IG.ref(g.tO,"users/".concat(t,"/photo"));await h.IG.uploadBytes(n,e,{contentType:e.type});let r=await h.IG.getDownloadURL(n);return g.I8.currentUser&&await h.lX.updateProfile(g.I8.currentUser,{photoURL:r}),r}async function I(t){g.I8.currentUser&&await h.lX.updateProfile(g.I8.currentUser,{displayName:t})}function N(t){var e;return{dateFormat:(0,d.g)(c.t6,null==t?void 0:t.date_format),timeFormat:(0,d.g)(c.zt,null==t?void 0:t.time_format),weekStart:(0,d.g)(c.L8,null==t?void 0:t.week_start),spellCheck:null==t?void 0:t.spell_check,labs:null==t?void 0:t.labs,transcriptionPrompt:null==t?void 0:t.transcription_prompt,transcriptionLanguage:null==t?void 0:t.transcription_language,transcriptionFormat:null==t?void 0:t.transcription_format,aiProvider:null==t?void 0:t.ai_provider,openaiApiKeyExcerpt:null==t?void 0:t.openai_api_key_excerpt,anthropicApiKeyExcerpt:null!==(e=null==t?void 0:t.anthropic_api_key_excerpt)&&void 0!==e?e:void 0}}function x(t){return{backlinkCreated:t.backlink_created,bookSynced:t.book_synced,chromeExtensionInstalled:t.chrome_extension_installed,credentialAuth:t.credential_auth,graphCreated:t.graph_created,linkCreated:t.link_created,meetingAdded:t.meeting_added,onboarded:t.onboarded,onboardingAddMeetingIgnored:t.onboarding_add_meeting_ignored,onboardingBacklinkIgnored:t.onboarding_backlink_ignored,onboardingLinksIgnored:t.onboarding_links_ignored,shortcutsOpened:t.shortcuts_opened,tagCreated:t.tag_created}}},38542:function(t,e,n){"use strict";n.d(e,{I:function(){return o}});var r=n(80345);let i="undefined"!=typeof Worker?new Worker(n.tu(new URL(n.p+n.u(8340),n.b))):null;function a(){throw Error("Your environment does not support file uploading")}let o=i?r.Ud(i):{get:a,put:a,uploadPending:a}},66657:function(t,e,n){"use strict";n.d(e,{w4:function(){return b},_H:function(){return w},hp:function(){return f}});var r=n(34281),i=n(34210),a=n.n(i),o=n(53090),s=n.n(o),l=n(84715),c=n.n(l),d=n(18143);let u=null;async function h(){if(u)return u;if(!("storage"in window.navigator))return null;let t=navigator.storage;return"function"!=typeof t.getDirectory?null:u=await t.getDirectory()}var p=n(79548),g=n(11805),m=n(71157);async function y(t){let e=t.logger,n=await k(t);if(!n)return e.warn("[backup] Backup failed - no storage available"),!1;let i=await (0,g.e)(t),o=function(t){let e=(0,r.Z)(new Date,"yyyyMMdd-HHmm");return"reflect-".concat(t.id,"-").concat(e,"-v").concat(p.Rh)}(t),s="".concat(o,".zip"),l=await n.getFileHandle(s,{create:!0});if("function"!=typeof l.createWritable)return e.warn("[backup] Backup failed - createWritable not supported"),!1;let c=new(a());c.file("".concat(o,".json"),i);let d=await c.generateAsync({type:"blob",compression:"DEFLATE"}),u=await l.createWritable();return await u.write(d),await u.close(),e.warn("[backup] Saved compressed backup: ".concat(s)),await v(n),!0}async function f(t){let e=t.logger;try{return await y(t)}catch(t){return e.warn("[backup] Backup failed: ".concat(t)),(0,m.Tb)(t),!1}}async function v(t){let e=await S(t),n=c()(e),r=s()(n,10);for(let e of r){console.log("[backup]","deleting backup",e);try{await t.removeEntry(e)}catch(t){console.warn("failed to delete backup",{backup:e,backups:JSON.stringify(n),toDelete:JSON.stringify(r)}),(0,m.Tb)(t)}}}async function w(t){let e=await k(t);return e?await S(e):[]}async function b(t,e){let n=await k(t);if(!n)return;let r=await n.getFileHandle(e),i=await r.getFile();(0,d.l)(i,e)}async function S(t){let e=[];for await(let[n]of t.entries())e.push(n);return e}async function k(t){let e=await h();if(!e)return null;let n=await e.getDirectoryHandle("backups",{create:!0});return await n.getDirectoryHandle(t.id,{create:!0})}},22892:function(t,e,n){"use strict";n.d(e,{f:function(){return i}});var r=n(41200);class i{async getLastSync(){let t=await this.selectLastSync();return(null==t?void 0:t.lastSyncAt)?new Date(t.lastSyncAt):null}async setLastSync(t){await this.adapter.executeTransaction("setLastSync",async e=>{let n=await this.selectLastSync(e);if(n)await e.updateTable("lastSyncs").set({lastSyncAt:null==t?void 0:t.getTime(),updatedAt:Date.now()}).where("id","=",n.id).execute();else{let n=(0,r.O)();await e.insertInto("lastSyncs").values({id:n,tableName:this.tableName,contextId:this.contextId,lastSyncAt:null==t?void 0:t.getTime(),updatedAt:Date.now()}).execute()}})}selectLastSync(t){let e=(t||this.adapter.db).selectFrom("lastSyncs").selectAll().where("tableName","=",this.tableName).where(t=>null===this.contextId?t("contextId","is",null):t("contextId","=",this.contextId));return t?e.executeTakeFirst():this.adapter.executeTakeFirst(e)}constructor(t){if(!t.tableName)throw Error("tableName is required");this.tableName=t.tableName,this.adapter=t.adapter,this.contextId=t.contextId}}},33429:function(t,e,n){"use strict";n.d(e,{U:function(){return c}});var r=n(60288),i=n(91523);class a{async getCount(t){var e;let n=(null!=t?t:this.query()).clearSelect().select(this.adapter.db.fn.countAll().as("count")),r=await this.adapter.executeTakeFirst(n);return null!==(e=null==r?void 0:r.count)&&void 0!==e?e:0}async hasIds(t){if(0===t.length)return[];let e=this.query().select("id").where("id","in",(0,i.pP)(t));return(await this.adapter.executeSelect(e)).map(t=>t.id)}async get(t){let e=this.query().selectAll().where("id","==",t);return await this.adapter.executeTakeFirst(e)||null}async getMany(t){if(0===t.length)return[];let e=this.query().selectAll().where("id","in",(0,i.pP)(t));return await this.adapter.executeSelect(e)}async getManyAsMap(t){return new Map((await this.getMany(t)).map(t=>[t.id,t]))}async getAllIds(){let t=this.query().select("id");return(await this.adapter.executeSelect(t)).map(t=>t.id)}query(){let t=this.adapter.db.selectFrom(this.name);return this.scope.length>0&&(t=t.where(t=>(0,i.T6)(t,this.scope))),t}get db(){return this.adapter.db}constructor(t){var e;this.name=t.name,this.scope=null!==(e=t.scope)&&void 0!==e?e:[],this.adapter=t.adapter}}var o=n(81394);class s{detach(){this.listeners.clear(),this.channel.removeEventListener("message",this.handleBroadcastMessage),this.channel.close()}trigger(t){this.triggerLocal(t),this.multiTab&&this.triggerRemote(t)}change(t,e){0!==t.length&&this.trigger({type:"change",ids:t,options:null!=e?e:{}})}triggerLocal(t){for(let e of[...this.listeners.get(t.type)||[]].sort((t,e)=>e.priority-t.priority))e.handler(t)}triggerRemote(t){let e={...t,options:{}};console.log("Broadcasting message to other tabs:",e),this.channel.postMessage(e)}on(t,e){let{priority:n}=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},r={handler:e,priority:null!=n?n:o.gJ.Normal};return this.addListener(t,r),()=>{this.removeListener(t,r)}}off(t,e){let n=(this.listeners.get(t)||[]).find(t=>t.handler===e);n&&this.removeListener(t,n)}addListener(t,e){let n=this.listeners.get(t)||[];n.push(e),this.listeners.set(t,n)}removeListener(t,e){let n=(this.listeners.get(t)||[]).filter(t=>t!==e);this.setListeners(t,n)}setListeners(t,e){e.length>0?this.listeners.set(t,e):this.listeners.delete(t)}constructor(t,e){var n;this.listeners=new Map,this.handleBroadcastMessage=t=>{let e=this.channel.name.replace("table-","");console.log("Table ".concat(e," received message:"),t.data);let n=o.tG.safeParse(t.data);if(!n.success){console.error("Invalid event received for table ".concat(e,":"),n.error);return}this.triggerLocal(n.data)},this.multiTab=null!==(n=null==e?void 0:e.multiTab)&&void 0!==n&&n,this.channel=new BroadcastChannel("table-".concat(String(t))),this.channel.addEventListener("message",this.handleBroadcastMessage)}}class l{register(t){return this.hooks.push(t),()=>{let e=this.hooks.indexOf(t);-1!==e&&this.hooks.splice(e,1)}}on(t,e,n){return this.register({timing:t,action:e,callback:n})}async executeCreateHooks(t,e){for(let n of this.hooks.filter(e=>e.timing===t).filter(t=>"create"===t.action))await n.callback(e)}async executeUpdateHooks(t,e){for(let n of this.hooks.filter(e=>e.timing===t).filter(t=>"update"===t.action))await n.callback(e)}async executeDeleteHooks(t,e){for(let n of this.hooks.filter(e=>e.timing===t).filter(t=>"delete"===t.action))await n.callback(e)}detach(){this.hooks=[]}constructor(){this.hooks=[]}}class c{detach(){this.events.detach(),this.hooks.detach()}query(){return this.reader.query()}async getCount(t){return this.reader.getCount(t)}async hasIds(t){return await this.reader.hasIds(t)}async get(t){return await this.reader.get(t)}async getMany(t){return await this.reader.getMany(t)}async getManyAsMap(t){return await this.reader.getManyAsMap(t)}async getAllIds(){return await this.reader.getAllIds()}async fetch(t){let e=t.clearSelect().selectAll();return await this.adapter.executeSelect(e)}async find(t){let e=t.clearSelect().selectAll(),n=await this.adapter.executeTakeFirst(e);return null!=n?n:null}async executeTransaction(t,e,n){let{result:r,changedIds:i}=await this.adapter.executeTransaction(t,e);return this.events.change(i,n),r}on(t,e){let{priority:n}=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};return this.events.on(t,e,{priority:n})}off(t,e){this.events.off(t,e)}get adapter(){return r.v}get listeners(){return this.events.listeners}constructor(t){this.name=t.name;let e=t.scope;this.reader=new a({name:this.name,adapter:r.v,scope:e}),this.events=new s(this.name,{multiTab:t.multiTab}),this.hooks=new l}}},91523:function(t,e,n){"use strict";n.d(e,{$F:function(){return u},$M:function(){return h},En:function(){return g},T6:function(){return c},Y7:function(){return p},pP:function(){return d}});var r=n(14489),i=n(79633);function a(){let t=(0,r._)(["json_each(",")"]);return a=function(){return t},t}function o(){let t=(0,r._)(["exists (select 1 from json_each(",") where value = ",")"]);return o=function(){return t},t}function s(){let t=(0,r._)(["not exists (select 1 from json_each(",") where value = ",")"]);return s=function(){return t},t}function l(){let t=(0,r._)([""," is not null and json_array_length(",") > 0"]);return l=function(){return t},t}function c(t,e){return t.and(e.map(e=>t(e.key,e.operator,e.value)))}function d(t){return e=>e.selectFrom((0,i.i)(a(),JSON.stringify(t))).select("value")}function u(t,e){return n=>h(n,t,e)}function h(t,e,n){return(0,i.i)(o(),t.ref(e),n)}function p(t,e,n){return(0,i.i)(s(),t.ref(e),n)}function g(t){return e=>(0,i.i)(l(),e.ref(t),e.ref(t))}},60288:function(t,e,n){"use strict";n.d(e,{v:function(){return Z}});var r=n(15767),i=n(93793),a=n(44838),o=n(7480),s=n(11161),l=n(71324),c=n(55673),d=n(71157),u=n(60438),h=n(50743),p=n(34270),g=n(69553),m=n(51842),y=n.n(m);function f(t){if("query"===t.level){let e=t.queryDurationMillis.toFixed(1),n=t.query.parameters,r=n?n.length:0,i=y()(t.query.sql,{length:255}),a=y()(JSON.stringify(t.query.parameters),{length:255}),o="SQL (".concat(e,"ms, ").concat(r," params): ").concat(i," ").concat(a);t.queryDurationMillis>100?console.log("%c"+o,"color: red; font-weight: bold;"):console.log(o)}}let v={up:(0,d.fv)(async t=>{console.log("[sqlite/migrations] Creating contacts table..."),await t.schema.createTable("contacts").ifNotExists().addColumn("id","text",t=>t.primaryKey()).addColumn("credentialId","text").addColumn("givenName","text").addColumn("familyName","text").addColumn("customName","text").addColumn("emailValues","text").addColumn("emails","text").addColumn("primaryEmail","text").addColumn("phoneNumbers","text").addColumn("photoUrl","text").addColumn("sourceUpdatedAt","integer").addColumn("updatedAt","integer",t=>t.notNull()).addColumn("hasChanges","integer",t=>t.notNull().defaultTo(0)).addColumn("isDeleted","integer",t=>t.notNull().defaultTo(0)).execute(),console.log("[sqlite/migrations] Creating books table..."),await t.schema.createTable("books").ifNotExists().addColumn("id","text",t=>t.notNull()).addColumn("graphId","text",t=>t.notNull()).addColumn("asin","text",t=>t.notNull()).addColumn("title","text",t=>t.notNull()).addColumn("authors","text",t=>t.notNull()).addColumn("coverSrc","text").addColumn("notes","text",t=>t.notNull()).addColumn("createdAt","integer").addColumn("updatedAt","integer",t=>t.notNull()).addColumn("hasChanges","integer",t=>t.notNull().defaultTo(0)).addColumn("isDeleted","integer",t=>t.notNull().defaultTo(0)).addPrimaryKeyConstraint("books_pk",["id","graphId"]).execute(),console.log("[sqlite/migrations] Creating noteBacklinks table..."),await t.schema.createTable("noteBacklinks").ifNotExists().addColumn("id","text",t=>t.notNull()).addColumn("contextHtml","text").addColumn("graphId","text",t=>t.notNull()).addColumn("fromNoteId","text",t=>t.notNull()).addColumn("toNoteId","text",t=>t.notNull()).addColumn("fromNoteCreatedAt","integer").addColumn("label","text",t=>t.notNull()).addColumn("updatedAt","integer",t=>t.notNull()).addPrimaryKeyConstraint("noteBacklinks_pk",["id","graphId"]).execute(),await t.schema.createIndex("idx_noteBacklinks_toNoteId").ifNotExists().on("noteBacklinks").column("toNoteId").execute(),await t.schema.createIndex("idx_noteBacklinks_fromNoteId").ifNotExists().on("noteBacklinks").column("fromNoteId").execute(),console.log("[sqlite/migrations] Creating commitBackups table..."),await t.schema.createTable("commitBackups").ifNotExists().addColumn("id","text",t=>t.notNull()).addColumn("graphId","text",t=>t.notNull()).addColumn("noteId","text",t=>t.notNull()).addColumn("documentJson","text").addColumn("platform","text").addColumn("createdAt","integer",t=>t.notNull()).addColumn("updatedAt","integer",t=>t.notNull()).addColumn("hasChanges","integer",t=>t.notNull().defaultTo(0)).addColumn("isDeleted","integer",t=>t.notNull().defaultTo(0)).addPrimaryKeyConstraint("commitBackups_pk",["id","graphId"]).execute(),console.log("[sqlite/migrations] Creating lastSyncs table..."),await t.schema.createTable("lastSyncs").ifNotExists().addColumn("id","text",t=>t.primaryKey()).addColumn("tableName","text",t=>t.notNull()).addColumn("contextId","text").addColumn("lastSyncAt","integer").addColumn("updatedAt","integer",t=>t.notNull()).execute(),await t.schema.createIndex("idx_lastSyncs_tableName").ifNotExists().on("lastSyncs").column("tableName").execute(),await t.schema.createIndex("idx_lastSyncs_contextId").ifNotExists().on("lastSyncs").column("contextId").execute(),console.log("[sqlite/migrations] Creating assets table..."),await t.schema.createTable("assets").ifNotExists().addColumn("id","text",t=>t.notNull()).addColumn("graphId","text",t=>t.notNull()).addColumn("text","text",t=>t.notNull()).addColumn("noteIds","text",t=>t.notNull()).addColumn("isExtracted","integer",t=>t.notNull()).addColumn("createdAt","integer",t=>t.notNull()).addColumn("updatedAt","integer",t=>t.notNull()).addColumn("hasChanges","integer",t=>t.notNull().defaultTo(0)).addColumn("isDeleted","integer",t=>t.notNull().defaultTo(0)).addPrimaryKeyConstraint("assets_pk",["id","graphId"]).execute(),console.log("[sqlite/migrations] Creating notes table..."),await t.schema.createTable("notes").ifNotExists().addColumn("id","text",t=>t.notNull()).addColumn("graphId","text",t=>t.notNull()).addColumn("subject","text",t=>t.notNull()).addColumn("yDocAsUpdate","text").addColumn("document","text").addColumn("systemMetadata","text").addColumn("acl","text").addColumn("pinnedIndex","integer").addColumn("backlinkedCount","integer",t=>t.notNull().defaultTo(0)).addColumn("ignoredContactNames","text").addColumn("ignoredBacklinkLabels","text").addColumn("ignoredBacklinkFromNoteIds","text").addColumn("editedAt","integer").addColumn("deletedAt","integer").addColumn("createdAt","integer",t=>t.notNull()).addColumn("lastCommitId","integer").addColumn("persisted","integer",t=>t.notNull()).addColumn("tags","text").addColumn("hasTask","integer").addColumn("emails","text").addColumn("linkHrefs","text").addColumn("isBlank","integer",t=>t.notNull()).addColumn("dailyDate","integer").addColumn("contentMetadata","text").addColumn("contentMetadataAsin","text").addColumn("normalizedSubject","text",t=>t.notNull()).addColumn("subjectAliases","text").addColumn("backlinkIds","text").addColumn("updatedAt","integer",t=>t.notNull()).addColumn("hasChanges","integer",t=>t.notNull().defaultTo(0)).addColumn("isDeleted","integer",t=>t.notNull().defaultTo(0)).addColumn("isDaily","integer",t=>t.notNull().defaultTo(0)).addPrimaryKeyConstraint("notes_pk",["id","graphId"]).execute(),console.log("[sqlite/migrations] Creating jobs table..."),await t.schema.createTable("jobs").ifNotExists().addColumn("id","text",t=>t.primaryKey()).addColumn("task","text",t=>t.notNull()).addColumn("args","text",t=>t.notNull()).addColumn("contextId","text",t=>t.notNull()).addColumn("updatedAt","integer",t=>t.notNull()).addColumn("scheduledAt","integer",t=>t.notNull()).addColumn("status","text",t=>t.notNull().defaultTo("pending")).execute(),await t.schema.createIndex("idx_jobs_contextId").ifNotExists().on("jobs").column("contextId").execute(),await t.schema.createIndex("idx_jobs_status").ifNotExists().on("jobs").column("status").execute(),await t.schema.createIndex("idx_jobs_task").ifNotExists().on("jobs").column("task").execute(),console.log("[sqlite/migrations] All migrations completed successfully")}),down:(0,d.fv)(async t=>{await t.schema.dropTable("jobs").ifExists().execute(),await t.schema.dropTable("lastSyncs").ifExists().execute(),await t.schema.dropTable("notes").ifExists().execute(),await t.schema.dropTable("assets").ifExists().execute(),await t.schema.dropTable("commitBackups").ifExists().execute(),await t.schema.dropTable("noteBacklinks").ifExists().execute(),await t.schema.dropTable("books").ifExists().execute(),await t.schema.dropTable("contacts").ifExists().execute()})};var w=n(14489),b=n(75422),S=n(79633),k=n(53342);function I(){let t=(0,w._)(["pragma_table_info(",")"]);return I=function(){return t},t}let N=["disk I/O error","unable to open database file","sqlite3_open_v2"];async function x(t,e){try{return await S.i.raw(e).execute(t)}catch(t){throw Error("Error running SQL: ".concat(e,": ").concat(t),{cause:t})}}async function T(t,e,n){var r;let i=await t.selectFrom((0,S.i)(I(),e).as("table_info_result")).where("name","=",n).select(t=>t.fn.countAll().as("count")).executeTakeFirst();return(null!==(r=null==i?void 0:i.count)&&void 0!==r?r:0)>0}function D(){let t=(0,w._)(["rowid"]);return D=function(){return t},t}async function A(t){try{if(await T(t,"notes","documentText"))return}catch(e){let t=Error("[sqlite/migrations] Failed to check if column exists: ".concat(e),{cause:e});console.error(t),(0,d.Tb)(t)}try{await t.schema.alterTable("notes").addColumn("documentText","text").execute()}catch(e){let t=Error("[sqlite/migrations] Failed to add column documentText: ".concat(e),{cause:e});console.error(t),(0,d.Tb)(t)}}async function*C(t){for(let e=0;;e+=500){let n=await t.selectFrom("notes").select(["id","graphId","document"]).limit(500).offset(e).orderBy((0,S.i)(D())).execute();if(yield n,n.length<500)break}}function _(t){try{if(!t.document)return null;let e=JSON.parse(t.document),n="$frozen"in e?e.data:e,r=(0,b.nM)(n).trim();if(!r)return null;return{id:t.id,graphId:t.graphId,documentText:r}}catch(e){return console.error("[sqlite/migrations] Failed to parse note ".concat(null==t?void 0:t.id,":"),e),null}}async function M(t,e){if(0!==e.length)try{await t.transaction().execute(async t=>{for(let n of e)await t.updateTable("notes").set({documentText:n.documentText}).where("id","=",n.id).where("graphId","=",n.graphId).executeTakeFirst()})}catch(t){console.error("[sqlite/migrations] Failed to update note documentText:",t)}}async function E(t){let e=0,n=0;for await(let r of C(t)){e+=r.length;let i=r.map(_).filter(k.Dw);n+=i.length,await M(t,i)}console.log("[sqlite/migrations] Rebuilt documentText for ".concat(n," of ").concat(e," notes"))}let F={up:async function(t){await A(t),await E(t)}};function U(t){let{contentTableName:e,ftsTableName:n,columns:r}=t,i=[],a=[...r.map(t=>t.name+(t.indexed?"":" UNINDEXED")),'tokenize="trigram case_sensitive 0 remove_diacritics 1"',"prefix='3 4 5 6 7 8 9 10'","content='".concat(e,"'")].join(", ");for(let t of(i.push("CREATE VIRTUAL TABLE IF NOT EXISTS ".concat(n," USING fts5(").concat(a,");")),["INSERT","DELETE","UPDATE"]))i.push(function(t){let{contentTableName:e,ftsTableName:n,triggerType:r,columns:i}=t,a="trigger_fts_".concat(e,"_after_").concat(r.toLowerCase()),o="CREATE TRIGGER IF NOT EXISTS ".concat(a," AFTER ").concat(r," ON ").concat(e," BEGIN");return o+="\n",("DELETE"===r||"UPDATE"===r)&&(o+="  "+"INSERT INTO ".concat(n,"(").concat(n,", rowid, ").concat(i.map(t=>t.name).join(", "),") ")+"VALUES ('delete', old.rowid, ".concat(i.map(t=>"old.".concat(t.name)).join(", "),");")+"\n"),("INSERT"===r||"UPDATE"===r)&&(o+="  "+"INSERT INTO ".concat(n,"(rowid, ").concat(i.map(t=>t.name).join(", "),") ")+"VALUES (new.rowid, ".concat(i.map(t=>"new.".concat(t.name)).join(", "),");")+"\n"),o+="END;"}({contentTableName:e,triggerType:t,ftsTableName:n,columns:r}));return i.push("INSERT INTO ".concat(n,"(").concat(n,") VALUES ('rebuild');")),i}function B(t){let{contentTableName:e,ftsTableName:n}=t,r=[];for(let t of["INSERT","DELETE","UPDATE"])r.push(function(t){let{contentTableName:e,triggerType:n}=t,r="trigger_fts_".concat(e,"_after_").concat(n.toLowerCase());return"DROP TRIGGER IF EXISTS ".concat(r,";")}({contentTableName:e,triggerType:t}));return r.push("DROP TABLE IF EXISTS ".concat(n,";")),r}let R={up:async function(t){for(let e of U({contentTableName:"notes",ftsTableName:"notesFts",columns:[{indexed:!0,name:"subject"},{indexed:!0,name:"documentText"},{indexed:!1,name:"id"},{indexed:!1,name:"graphId"},{indexed:!1,name:"updatedAt"},{indexed:!1,name:"deletedAt"}]}))await x(t,e);for(let e of U({contentTableName:"assets",ftsTableName:"assetsFts",columns:[{indexed:!0,name:"text"},{indexed:!1,name:"id"},{indexed:!1,name:"graphId"},{indexed:!1,name:"noteIds"}]}))await x(t,e)},down:async function(t){for(let e of B({contentTableName:"notes",ftsTableName:"notesFts"}))await x(t,e);for(let e of B({contentTableName:"assets",ftsTableName:"assetsFts"}))await x(t,e)}},j={up:async function(t){await t.schema.dropIndex("idx_contacts_id").ifExists().execute(),await t.schema.dropIndex("idx_books_graphId_id").ifExists().execute(),await t.schema.dropIndex("idx_noteBacklinks_graphId_id").ifExists().execute(),await t.schema.dropIndex("idx_commitBackups_graphId_id").ifExists().execute(),await t.schema.dropIndex("idx_lastSyncs_id").ifExists().execute(),await t.schema.dropIndex("idx_assets_graphId_id").ifExists().execute(),await t.schema.dropIndex("idx_notes_graphId_id").ifExists().execute(),await t.schema.dropIndex("idx_jobs_id").ifExists().execute()}},P={up:async function(t){await t.schema.createIndex("idx_notes_graphId_isDaily_dailyDate").ifNotExists().on("notes").columns(["graphId","isDaily","dailyDate"]).execute(),await t.schema.createIndex("idx_notes_graphId_pinnedIndex").ifNotExists().on("notes").columns(["graphId","pinnedIndex"]).execute()}};var O=n(65632),L=n.n(O);function K(t,e){return e?async function(){for(var n=arguments.length,r=Array(n),i=0;i<n;i++)r[i]=arguments[i];try{let n=performance.now();console.debug("[sqlite/migrations] Starting migration ".concat(t,"...")),await e(...r);let i=performance.now();console.debug("[sqlite/migrations] Finished migration ".concat(t," in ").concat(Math.round(i-n),"ms"))}catch(n){console.error("[sqlite/migrations] Failed to run migration ".concat(t,":"),n);let e=Error("Error running migration ".concat(t,": ").concat(n),{cause:n});throw(0,d.Tb)(e),e}}:async()=>{}}async function G(){var t;return Promise.resolve((t={"001-initial":v,"002-notes-document-text":F,"003-fts":R,"004-remove-pk-index":j,"005-note-indexes":P},L()(t,(t,e)=>{var n;return{up:K(e,t.up.bind(t)),down:K(e,null===(n=t.down)||void 0===n?void 0:n.bind(t))}})))}class q{async setup(){await this.migrate(),this.setIsReady(!0)}setIsReady(t){this.isReady=t}setIoFailed(t){this.ioFailed=t}setMigrationStatus(t){this.migrationStatus=t}async migrate(){let t=new i.U6({db:this.db,provider:{getMigrations:G}});if(!(await t.getMigrations()).some(t=>null==t.executedAt)){this.setMigrationStatus({type:"up-to-date"});return}this.setMigrationStatus({type:"running"});let{error:e,results:n}=await t.migrateToLatest();e?(this.setMigrationStatus({type:"failed"}),(0,d.Tb)(e),(0,d.uT)("Failed to migrate SQLite",{extra:{error:String(e),results:n}})):this.setMigrationStatus({type:"up-to-date"})}get migrating(){return"running"===this.migrationStatus.type}get migrationFailed(){return"failed"===this.migrationStatus.type}async executeTransaction(t,e){return await this.runWithLock(async()=>await this.db.transaction().execute(e))}async executeSelect(t){return await this.runWithLock(async()=>await t.execute())}async executeInsert(t){return await this.runWithLock(async()=>await t.execute())}async executeUpdate(t){return await this.runWithLock(async()=>await t.execute())}async executeDelete(t){return await this.runWithLock(async()=>await t.execute())}async executeTakeFirst(t){return await this.runWithLock(async()=>await t.limit(1).executeTakeFirst())}async runWithLock(t){return(this.isReady||await (0,a.when)(()=>this.isReady),(0,s.W)())?this.capacitorDbLock(()=>this.runWithErrorCapture(t)):await this.runWithErrorCapture(t)}async runWithErrorCapture(t){try{return await t()}catch(t){if(t instanceof Error&&N.some(e=>t.message.includes(e)))throw await this.handleIoFailedError(t),t.skipSentry=!0,t;throw Error("".concat(t),{cause:t})}}async handleIoFailedError(t){this.setIoFailed(!0);let e=await this.getStorageEstimate();(0,d.uT)("SQLite out of space: ".concat(t.message),{level:"info",extra:{storage:e}})}async getStorageEstimate(){let t=await (0,c.i9)();return t&&(0,d.sU)("storage_estimate",(0,l.K)(t)),t}constructor(){this.isReady=!1,this.ioFailed=!1,this.migrationStatus={type:"checking"},this.capacitorDbLock=(0,o.Z)(1),(0,a.makeObservable)(this);let{db:t}=(0,s.W)()?function(){let t=new u.Ec(u.f4),e=new p.Z(t,{name:"database"});return{db:new g.$2({dialect:e,log:f})}}():{db:new g.$2({dialect:new h.b().setDriverOptions({dbPath:"/database.sqlite3",vfsOptions:{}}),log:f})};this.db=t,this.setup()}}(0,r.gn)([a.observable],q.prototype,"isReady",void 0),(0,r.gn)([a.observable],q.prototype,"ioFailed",void 0),(0,r.gn)([a.observable],q.prototype,"migrationStatus",void 0),(0,r.gn)([a.action],q.prototype,"setIsReady",null),(0,r.gn)([a.action],q.prototype,"setIoFailed",null),(0,r.gn)([a.action],q.prototype,"setMigrationStatus",null);let Z=new q;window.sqlite=Z},43214:function(t,e,n){"use strict";n.d(e,{w:function(){return v}});var r=n(15767),i=n(12284),a=n(53414),o=n(44838),s=n(53342),l=n(85204),c=n(77956),d=n(71157),u=n(91523);function h(t){return"create"===t.type}function p(t){return"update"===t.type}function g(t){return"delete"===t.type}function m(t){return"custom"===t.type}function y(t){return{type:t.type,id:t.doc.id,data:t.doc.data()}}function f(t){return{type:"added",id:t.id,data:t.data()}}class v{async attach(){await this.startSyncing()}detach(){var t;this.isDetached=!0,null===(t=this.listener)||void 0===t||t.dispose(),this.listener=void 0}async startSyncing(){await this.getLastSync()||await this.runInitialSync(),this.snapshotSubscribe()}async runInitialSync(){let t=null,e=0,n=null,r=0;for(this.log("Initial sync starting");;){let i=await this.buildPageQuery(t),o=await (0,a.getDocs)(i);if(o.empty)break;let s=o.docs.map(f),l=await this.applyChanges(s);if(l&&(n=n?new Date(Math.max(n.getTime(),l.getTime())):l),e+=s.length,++r>1&&this.setInitialSyncProgress({processed:e}),this.log("Processed ".concat(s.length," records in this page (").concat(e," total)")),o.docs.length<500)break;t=o.docs[o.docs.length-1]}this.log("finished initial sync, last change at:",null==n?void 0:n.toLocaleString()),n&&await this.onSync({lastChangeAt:n}),this.setInitialSyncProgress(null),this.setHasSynced(!0)}async buildPageQuery(t){let e=await this.collectionRef();return t?(0,a.query)(e,(0,a.orderBy)("__name__"),(0,a.limit)(500),(0,a.startAfter)(t)):(0,a.query)(e,(0,a.orderBy)("__name__"),(0,a.limit)(500))}snapshotSubscribe(){this.listener=new l.F({onCreate:async t=>{let e=await this.buildSnapshotQuery();return c.RZ.onSnapshot(e,this.onSnapshot,t)}})}async buildSnapshotQuery(){let t;let e=await this.collectionRef(),n=await this.getLastSync();if(n&&await this.table.getCount()===0&&(0,d.uT)("lastSyncAt is set but the table is empty"),n){let r=(0,i.Z)(n,1);t=c.RZ.query(e,c.RZ.where("updated_at",">=",r)),this.log("subscribing to snapshot newer than",r.toLocaleString())}else t=e,this.log("subscribing to snapshot");return t}async applySnapshot(t){let e=t.docChanges().map(y),n=await this.applyChanges(e);n&&await this.onSync({lastChangeAt:n})}async applyChanges(t){let{modifications:e,lastChangeAt:n}=await this.mapChangesToModifications(t);return await this.applyModifications(e),this.log("applied ".concat(e.length,"/").concat(t.length," changes, last change at: ").concat(null==n?void 0:n.toLocaleString())),n}async mapChangesToModifications(t){let e;let n=t.map(t=>t.id),r=await this.fetchLocalRowsForDecidingSync(n),i=[];for(let n of t){var a,o,s,l;let t=n.id,c=n.data.updated_at,d=null!==(a=r.get(t))&&void 0!==a?a:null;if((!e||c&&c.toMillis()>e.getTime())&&(e=null==c?void 0:c.toDate()),"removed"===n.type)i.push({type:"delete",id:t});else if("added"===n.type||"modified"===n.type){let e=n.data,a=null!==(l=null===(o=this.getFlags)||void 0===o?void 0:o.call(this,e))&&void 0!==l?l:null;!r.has(t)&&this.shouldSync(null,e)?i.push({type:"create",id:t,data:e,flags:a}):this.shouldSync(d,e)&&i.push({type:"update",id:t,data:e}),(null===(s=this.wantsCustomSync)||void 0===s?void 0:s.call(this,n,d))&&i.push({type:"custom",id:t})}}return{modifications:i,lastChangeAt:e}}async fetchLocalRowsForDecidingSync(t){var e;let n=["id","updatedAt",...null!==(e=this.fieldsForDecidingSync)&&void 0!==e?e:[]],r=this.table.query().clearSelect().select(n).where("id","in",(0,u.pP)(t));return new Map((await this.table.adapter.executeSelect(r)).map(t=>[t.id,t]))}shouldSync(t,e){var n;let r=null===(n=e.updated_at)||void 0===n?void 0:n.toMillis();if(!r)return!1;if(!t)return!0;let i=t.updatedAt;return!i||!(i>=r)}async applyModifications(t){let e=t.filter(h),n=t.filter(p),r=t.filter(g),i=t.filter(m);await this.applyCreates(e),await this.applyDeletes(r),await this.applyUpdates(n),await this.applyCustomSync(i)}async applyCreates(t){var e;if(this.isDetached)return;let n=await this.convertDownMany(t);await this.table.insertMany(n),await (null===(e=this.onAfterCreate)||void 0===e?void 0:e.call(this,t))}async applyUpdates(t){let{onBeforeUpdate:e,isDetached:n}=this;if(n)return;let r=await this.convertDownMany(t),i=r;for(let t of(e&&(i=r.map(t=>e(t))),i))await this.table.update(t.id,t)}async applyDeletes(t){if(this.isDetached)return;let e=t.map(t=>t.id);await this.table.deleteMany(e)}async applyCustomSync(t){var e;if(this.isDetached)return;let n=t.map(t=>t.id);await (null===(e=this.onCustomSync)||void 0===e?void 0:e.call(this,n))}async convertDownMany(t){let e=t.map(t=>this.convertDownWithId(t));return(await Promise.all(e)).filter(s.Dw)}async convertDownWithId(t){try{return{...await this.convertDown(t.id,t.data),id:t.id}}catch(e){return this.log("failed converting item",t.id),(0,d.Tb)(e),null}}log(t){for(var e=arguments.length,n=Array(e>1?e-1:0),r=1;r<e;r++)n[r-1]=arguments[r];let i="notes"===this.table.name?"background: purple; color: white":"color: purple";console.log("%c[sync-down / ".concat(this.table.name,"]: ").concat(t),i,...n)}async docRef(t){return(0,a.doc)(await this.collectionRef(),t)}setIsApplying(t){this.isApplying=t}setHasSynced(t){this.hasSynced=t}setInitialSyncProgress(t){this.initialSyncProgress=t}constructor(t){this.isDetached=!1,this.isApplying=!1,this.hasSynced=!1,this.initialSyncProgress=null,this.onSnapshot=async t=>{if(this.log("got snapshot with ".concat(t.docChanges().length," changes")),!this.isDetached&&0!==t.docChanges().length){this.isApplying&&await (0,o.when)(()=>!this.isApplying),this.setIsApplying(!0);try{await this.applySnapshot(t)}finally{this.setIsApplying(!1)}this.setHasSynced(!0)}},this.table=t.table,this.collectionRef=t.collectionRef,this.convertDown=t.convertDown,this.getLastSync=t.getLastSync,this.onSync=t.onSync,this.onBeforeUpdate=t.onBeforeUpdate,this.onAfterCreate=t.onAfterCreate,this.fieldsForDecidingSync=t.fieldsForDecidingSync,this.wantsCustomSync=t.wantsCustomSync,this.onCustomSync=t.onCustomSync,this.getFlags=t.getFlags,(0,o.makeObservable)(this)}}(0,r.gn)([o.observable],v.prototype,"isApplying",void 0),(0,r.gn)([o.observable],v.prototype,"hasSynced",void 0),(0,r.gn)([o.observable],v.prototype,"initialSyncProgress",void 0),(0,r.gn)([o.action],v.prototype,"setIsApplying",null),(0,r.gn)([o.action],v.prototype,"setHasSynced",null),(0,r.gn)([o.action],v.prototype,"setInitialSyncProgress",null)},52110:function(t,e,n){"use strict";n.d(e,{h:function(){return u}});var r=n(15767),i=n(53414),a=n(66292),o=n.n(a),s=n(44838),l=n(81246),c=n(60065),d=n(71157);class u{attach(){this.flushAll(),this.listeners.push((0,l.g)(this.handleNavigatorOnlineChange)),this.hasAttached=!0}detach(){}async save(t){await this.saveMany([t])}async saveMany(t){await this.addFlag(t,"changed"),this.flushAllDebounced()}async delete(t){await this.deleteMany([t])}async deleteMany(t){await this.addFlag(t,"deleted"),this.flushAllDebounced()}async flushAll(){await (0,s.when)(()=>!this.isSaving),this.setIsSaving(!0);try{await this.flushChangedRows(),await this.flushDeletedRows()}finally{this.setIsSaving(!1)}}async flushChangedRows(){let t=this.table.reader.query().selectAll().where("hasChanges","==",1).where("isDeleted","==",0),e=await this.table.adapter.executeSelect(t);if(0===e.length)return;let n=e.map(t=>this.saveRow(t)),r=(await Promise.all(n)).filter(Boolean).length;this.log("saved ".concat(r,"/").concat(e.length))}async flushDeletedRows(){let t=this.table.reader.query().selectAll().where("isDeleted","==",1),e=await this.table.adapter.executeSelect(t);if(0===e.length)return;this.log("flushing deleted rows:",e.length);let n=e.map(t=>this.deleteRow(t)),r=(await Promise.all(n)).filter(Boolean).length;this.log("deleted ".concat(r,"/").concat(e.length))}async saveRow(t){let e=await this.docRef(t),n=await this.convertUp(t),r=await this.runTransaction(async t=>{var r,i;let a=await t.get(e),o=null!==(i=null===(r=n.updated_at)||void 0===r?void 0:r.toMillis())&&void 0!==i?i:null;if(!this.allowCreate&&!a.exists())throw Error("[table-sync-up] creating rows not allowed");if(a.exists()&&this.isRemoteNewer(a.data(),o))throw console.error("remote data is newer than saved data",{remoteTimestamp:a.data().updated_at,localTimestamp:o}),Error("[table-sync-up] remote data is newer than saved data");t.set(e,n,{merge:!0})});return r&&await this.clearFlags(t.id),r}async deleteRow(t){let e=await this.docRef(t),n=t.updatedAt,r=await this.runTransaction(async t=>{let r=await t.get(e);if(r.exists()&&this.isRemoteNewer(r.data(),n))throw Error("deleteRow: remote data is newer than saved data");t.delete(e)});return r&&await this.table.delete(t.id),r}async runTransaction(t){try{return await (0,i.runTransaction)(c.db,async e=>{await t(e)}),!0}catch(t){return console.error("transaction failed",t),(0,d.Tb)(t),!1}}isRemoteNewer(t,e){var n;let r=null===(n=t.updated_at)||void 0===n?void 0:n.toMillis();return!!r&&!!e&&r>e}async addFlag(t,e){let n={};n.updatedAt=Date.now(),"changed"===e?n.hasChanges=1:"deleted"===e&&(n.isDeleted=1),await this.table.batchUpdate(t,n),this.log("flagged with ".concat(e),t)}async clearFlags(t){let e={};e.hasChanges=0,e.isDeleted=0,await this.table.update(t,e)}setIsSaving(t){this.isSaving=t}log(t){for(var e=arguments.length,n=Array(e>1?e-1:0),r=1;r<e;r++)n[r-1]=arguments[r];console.log("%c[sync-up / ".concat(this.table.name,"]: ").concat(t),"color: violet",...n)}constructor(t){var e,n;this.isSaving=!1,this.hasAttached=!1,this.listeners=[],this.handleNavigatorOnlineChange=t=>{this.hasAttached&&t&&this.flushAll()},this.table=t.table,this.docRef=t.docRef,this.convertUp=t.convertUp,this.allowCreate=null===(e=t.allowCreate)||void 0===e||e,(0,s.makeObservable)(this),this.flushAllDebounced=o()(this.flushAll.bind(this),null!==(n=t.debounce)&&void 0!==n?n:2e3)}}(0,r.gn)([s.observable],u.prototype,"isSaving",void 0),(0,r.gn)([s.action],u.prototype,"setIsSaving",null)},17234:function(t,e,n){"use strict";n.d(e,{p:function(){return s}});var r=n(22892),i=n(43214),a=n(52110),o=n(36076);class s{attach(){var t,e;null===(t=this.syncDown)||void 0===t||t.attach(),null===(e=this.syncUp)||void 0===e||e.attach()}detach(){var t,e;null===(t=this.syncUp)||void 0===t||t.detach(),null===(e=this.syncDown)||void 0===e||e.detach(),this.table.detach()}constructor(t){var e;this.syncDown=null,this.syncUp=null,this.table=new o._({name:t.name,scope:t.scope}),this.lastSyncManager=new r.f({adapter:this.table.adapter,tableName:t.name,contextId:null!==(e=t.lastSyncContext)&&void 0!==e?e:null}),t.syncDown&&(this.syncDown=new i.w({table:this.table,getLastSync:()=>this.lastSyncManager.getLastSync(),onSync:t=>{let{lastChangeAt:e}=t;return this.lastSyncManager.setLastSync(e)},...t.syncDown})),t.syncUp&&(this.syncUp=new a.h({table:this.table,...t.syncUp}))}}},20282:function(t,e,n){"use strict";n.d(e,{y:function(){return s}});var r=n(15767),i=n(48148),a=n.n(i),o=n(44838);class s{subscribe(){this.table.on("change",this.refresh)}unsubscribe(){this.table.off("change",this.refresh)}setResults(t){this.results=this.afterFetch(t),this.hasFetched=!0}get count(){return this.results.length}constructor(t){this.results=[],this.hasFetched=!1,this.refresh=async()=>{let t=await this.table.adapter.executeSelect(this.query);return this.setResults(t),this.results},this.table=t.table,this.query=t.query,this.afterFetch=t.afterFetch||a(),(0,o.makeObservable)(this),(0,o.onBecomeObserved)(this,"results",()=>{this.subscribe()}),(0,o.onBecomeUnobserved)(this,"results",()=>{this.unsubscribe()}),this.refresh()}}(0,r.gn)([o.observable.shallow],s.prototype,"results",void 0),(0,r.gn)([o.observable],s.prototype,"hasFetched",void 0),(0,r.gn)([o.action],s.prototype,"setResults",null)},36076:function(t,e,n){"use strict";n.d(e,{_:function(){return u}});var r=n(33429),i=n(60288),a=n(41255),o=n.n(a),s=n(4363),l=n.n(s),c=n(91523);class d{async insertMany(t){if(0===t.length)return[];let e=o()(t,100),n=[];for(let t of e){let e=this.adapter.db.insertInto(this.name).values(t).returning("id"),r=await this.adapter.executeInsert(e);n.push(...r)}return n.map(t=>t.id)}async updateMany(t){return 0===t.length?[]:(await this.adapter.executeTransaction("updateMany",async e=>{let n=t.map(t=>t.id),r=new Set((await e.selectFrom(this.name).select("id").where(t=>(0,c.T6)(t,this.scope)).where("id","in",(0,c.pP)(n)).execute()).map(t=>t.id)),i=n.find(t=>!r.has(t));if(i)throw Error("Row with id ".concat(i," does not exist"));for(let{id:n,changes:r}of t)await e.updateTable(this.name).set(r).where(t=>(0,c.T6)(t,this.scope)).where("id","=",n).execute()}),t.map(t=>t.id))}async deleteMany(t){if(0===t.length)return[];let e=this.db.deleteFrom(this.name).where(t=>(0,c.T6)(t,this.scope)).where("id","in",(0,c.pP)(t)).returning("id");return(await this.adapter.executeDelete(e)).map(t=>t.id)}async deleteAll(){let t=this.db.deleteFrom(this.name).where(t=>(0,c.T6)(t,this.scope)).returning("id");return(await this.adapter.executeDelete(t)).map(t=>t.id)}async replaceAll(t){return this.replace("all",t)}async replaceMany(t,e){return this.replace(t,e)}async replace(t,e){return await this.adapter.executeTransaction("replace",async n=>{let r=[];r="all"===t?(await n.deleteFrom(this.name).where(t=>(0,c.T6)(t,this.scope)).returning("id").execute()).map(t=>t.id):(await n.deleteFrom(this.name).where(t=>(0,c.T6)(t,this.scope)).where("id","in",(0,c.pP)(t)).returning("id").execute()).map(t=>t.id);let i=[];return e.length>0&&(i=(await n.insertInto(this.name).values(e).returning("id").execute()).map(t=>t.id)),l()([...r,...i])})}get db(){return this.adapter.db}constructor(t){var e;this.name=t.name,this.adapter=t.adapter,this.scope=null!==(e=t.scope)&&void 0!==e?e:[]}}class u extends r.U{async insert(t,e){await this.hooks.executeCreateHooks("before",[t]);let n=await this.writer.insertMany([t]);await this.hooks.executeCreateHooks("after",[t]),this.events.change(n,e)}async insertMany(t,e){await this.hooks.executeCreateHooks("before",t);let n=await this.writer.insertMany(t);await this.hooks.executeCreateHooks("after",t),this.events.change(n,e)}async update(t,e,n){await this.hooks.executeUpdateHooks("before",[{id:t,changes:e}]);let r=await this.writer.updateMany([{id:t,changes:e}]);await this.hooks.executeUpdateHooks("after",[{id:t,changes:e}]),this.events.change(r,n)}async updateMany(t,e){let n=Array.from(t).map(t=>{let[e,n]=t;return{id:e,changes:n}});await this.hooks.executeUpdateHooks("before",n);let r=await this.writer.updateMany(n);await this.hooks.executeUpdateHooks("after",n),this.events.change(r,e)}async batchUpdate(t,e,n){let r=t.map(t=>({id:t,changes:e}));await this.hooks.executeUpdateHooks("before",r);let i=await this.writer.updateMany(r),a=r.filter(t=>i.includes(t.id));return await this.hooks.executeUpdateHooks("after",a),this.events.change(i,n),i}async delete(t,e){await this.hooks.executeDeleteHooks("before",[t]);let n=await this.writer.deleteMany([t]);return await this.hooks.executeDeleteHooks("after",n),this.events.change(n,e),n[0]}async deleteMany(t,e){await this.hooks.executeDeleteHooks("before",t);let n=await this.writer.deleteMany(t);return await this.hooks.executeDeleteHooks("after",n),this.events.change(n,e),n}async deleteAll(t){let e=await this.getAllIds();await this.hooks.executeDeleteHooks("before",e);let n=await this.writer.deleteAll();return await this.hooks.executeDeleteHooks("after",n),this.events.change(n,t),n}async replace(t,e,n){let r={id:t,changes:e};await this.hooks.executeUpdateHooks("before",[r]);let i=await this.writer.replaceMany([t],[e]);await this.hooks.executeUpdateHooks("after",[r]),this.events.change(i,n)}constructor(t){super(t);let e=t.scope;this.writer=new d({name:this.name,adapter:i.v,scope:e})}}},81394:function(t,e,n){"use strict";n.d(e,{gJ:function(){return i},tG:function(){return c}});var r,i,a=n(65728);let o=a.z.object({}),s=o.extend({skipPoolSync:a.z.boolean().optional()}),l=a.z.object({type:a.z.string(),options:o}).extend({type:a.z.literal("change"),ids:a.z.array(a.z.string()),options:s}),c=a.z.discriminatedUnion("type",[l]);(r=i||(i={}))[r.High=3]="High",r[r.Normal=2]="Normal",r[r.Low=1]="Low"},11805:function(t,e,n){"use strict";n.d(e,{e:function(){return s}});var r=n(34281),i=n(18453),a=n(46711),o=n(44722);async function s(t){let{noteStore:e}=t,n=e.adapter,s=Math.ceil(await e.table.getCount(e.undeletedNotesQuery)/500),l=e.undeletedNotesQuery.orderBy("id"),c="[";for(let t=0;t<s;t++){t>0&&(c+=",");let a=500*t;c+=(await e.table.fetch(l.limit(500).offset(a))).map(t=>JSON.stringify(function(t,e){var n,a,s;let{document:l}=(0,i.tE)(t,e),{updatedAt:c,createdAt:d,editedAt:u,dailyDate:h}=t;return{id:t.id,subject:t.subject,document_json:null!==(a=JSON.stringify(l))&&void 0!==a?a:null,created_at:(0,o.F)(d).toJSON(),updated_at:(0,o.F)(c).toJSON(),edited_at:null!==(s=null===(n=(0,o.F)(u))||void 0===n?void 0:n.toJSON())&&void 0!==s?s:null,daily_at:h?(0,r.Z)(h,"yyyy-MM-dd"):null,backlinked_count:t.backlinkedCount}}(t,n))).join(",")}c+="]";let d=t.tags;return new Blob(['{\n    "export_version": "'.concat(a.Rh,'",\n    "graph_version": ').concat(t.version,',\n    "notes": ').concat(c,',\n    "tags": ').concat(JSON.stringify(d),"\n  }")],{type:a.rt.json})}},79548:function(t,e,n){"use strict";n.d(e,{xH:function(){return m.xH},Rh:function(){return m.Rh},aT:function(){return y}});var r=n(34281),i=n(18143),a=n(75422),o=n(18453),s=n(25637),l=n(44722);async function c(t){let{noteStore:e}=t,n=e.adapter,r=await e.table.fetch(e.undeletedNotesQuery),i=[];for(let t of r){let{node:e}=(0,o.tE)(t,n);if(!e)continue;let r=(0,a.eJ)(e);i.push({id:t.id,subject:t.subject,document_html:r,daily_at:(0,l.F)(t.dailyDate),created_at:(0,l.F)(t.createdAt),updated_at:(0,l.F)(t.updatedAt),edited_at:(0,l.F)(t.editedAt)})}return(0,s.R4)(i)}var d=n(34210),u=n.n(d);async function h(t){let{noteStore:e}=t,n=e.adapter,r=await e.table.fetch(e.undeletedNotesQuery),i=new(u());for(let t of r){let e=(0,l.B)(t.subject),r="".concat(e,"-").concat(t.id,".html"),{node:s}=(0,o.tE)(t,n);if(!s)continue;let c=(0,a.eJ)(s);i.file(r,c)}return i.generateAsync({type:"blob"})}var p=n(11805);async function g(t){let{noteStore:e}=t,n=e.adapter,i=await e.table.fetch(e.undeletedNotesQuery),s=new(u());for(let t of i){let e=t.dailyDate,i=(0,l.B)(t.subject),c=e?"daily-notes/".concat((0,r.Z)(e,"yyyy-MM-dd"),".md"):"".concat(i,"-").concat(t.id,".md"),{node:d}=(0,o.tE)(t,n);if(!d)continue;let u=(0,a.b8)(d);s.file(c,u)}return s.generateAsync({type:"blob"})}var m=n(46711);async function y(t,e){let n=await f(t,e),a=function(t,e){let n=m.yf[e],i=(0,r.Z)(new Date,"yyyyMMdd-HHmm");return"reflect-".concat(t.id,"-").concat(i,"-v").concat(m.Rh,".").concat(n)}(t,e);(0,i.l)(n,a)}async function f(t,e){switch(e){case"json":return(0,p.e)(t);case"csv":return c(t);case"markdown_zip":return g(t);case"html_zip":return h(t)}}},46711:function(t,e,n){"use strict";n.d(e,{Rh:function(){return o},rt:function(){return r},xH:function(){return a},yf:function(){return i}});let r={json:"application/json",csv:"text/csv",markdown_zip:"application/zip",html_zip:"application/zip"},i={json:"json",csv:"csv",markdown_zip:"zip",html_zip:"zip"},a={json:"Reflect JSON",csv:"CSV",markdown_zip:"Markdown ZIP",html_zip:"HTML ZIP"},o="1.0"},44722:function(t,e,n){"use strict";function r(t){return t.replace(/[/\\]/g,"").replace(/\s+/g," ")}function i(t){return"number"==typeof t?new Date(t):void 0}n.d(e,{B:function(){return r},F:function(){return i}})},77956:function(t,e,n){"use strict";n.d(e,{IG:function(){return a},RZ:function(){return r},lX:function(){return i}}),n(1839);var r=n(53414),i=n(86416),a=n(91229)},30234:function(t,e,n){"use strict";n.d(e,{a:function(){return a}});var r=n(1839),i=n(78989);function a(){var t;return null!==(t=(0,r.C6)()[0])&&void 0!==t?t:(0,r.ZF)(i.vc,void 0)}},83085:function(t,e,n){"use strict";n.d(e,{g:function(){return a}});var r=n(86416),i=n(78989);function a(t){let e=(0,r.getAuth)(t);return i.i9&&!e.emulatorConfig&&(0,r.connectAuthEmulator)(e,"http://".concat(i.i9),{disableWarnings:!0}),e}},78989:function(t,e,n){"use strict";n.d(e,{Cj:function(){return l},i9:function(){return s},vc:function(){return d}});var r,i=n(91950),a=n(14224);let o='{"apiKey":"AIzaSyD5tmpwG6ZbTQcMznYMf4_YQgVBqPtfc2w","databaseURL":"https://reflect-prod.firebaseio.com","projectId":"reflect-prod","storageBucket":"reflect-prod.appspot.com","messagingSenderId":"188725225641","appId":"1:188725225641:web:93e4f14c15713f2372a1b8","measurementId":"G-TDJCZM4HVX"}',s=a.env.NEXT_PUBLIC_FIREBASE_AUTH_EMULATOR_HOST,l=a.env.NEXT_PUBLIC_FIRESTORE_EMULATOR_HOST;if(!o)throw Error("missing NEXT_PUBLIC_FIREBASE_AUTH_JSON env var");let c=JSON.parse(o),d={authDomain:null===(r=(0,i.J)())||void 0===r?void 0:r.location.host,...c,clientID:"188725225641-n0tkosc6bsjc5lponcr9sjec1ifn38b2.apps.googleusercontent.com",appleScopes:["email","name"],googleScopes:["email","profile"]}},48851:function(t,e,n){"use strict";n.d(e,{t:function(){return a}});var r=n(53414),i=n(78989);function a(t){let e=(0,r.initializeFirestore)(t,{});if(i.Cj){let[t,n]=i.Cj.split(":");(0,r.connectFirestoreEmulator)(e,t,Number(n))}return e}},72116:function(t,e,n){"use strict";n.d(e,{h:function(){return i}});var r=n(91229);function i(t){let e=(0,r.getStorage)(t);return e.maxUploadRetryTime=0,e}},60065:function(t,e,n){"use strict";n.d(e,{I8:function(){return d},db:function(){return c},tO:function(){return u},vc:function(){return s.vc}});var r=n(30234),i=n(83085),a=n(48851),o=n(72116),s=n(78989);let l=(0,r.a)(),c=(0,a.t)(l),d=(0,i.g)(l),u=(0,o.h)(l)},44719:function(t,e,n){"use strict";n.d(e,{k:function(){return c}});var r=n(80345),i=n(5185),a=n(7947),o=n(15858);class s{addMeta(t){this.meta={...this.meta,...t}}setTransmit(t){this.transmit=t}child(t){return new s(this.ipc,{...this.meta,...t,transmit:this.transmit})}info(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};this.ipc.log(t,{level:"info",meta:this.meta,object:e})}warn(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};this.ipc.log(t,{level:"warn",meta:this.meta,object:e})}error(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};this.ipc.log(t,{level:"error",meta:this.meta,object:e})}fatal(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};this.ipc.log(t,{level:"fatal",meta:this.meta,object:e})}constructor(t,e={}){this.ipc=t,this.meta=e,this.transmit=!1}}let l="undefined"!=typeof Worker?new Worker(n.tu(new URL(n.p+n.u(7780),n.b))):null,c=new s(l?r.Ud(l):{log:function(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},{level:n="info",meta:r={},object:i={}}=e;switch(n){case"info":console.info(t,{...i,...r});break;case"warn":console.warn(t,{...i,...r});break;case"error":case"fatal":console.error(t,{...i,...r})}}},{platform:(0,o.ob)(),env:(0,a.KF)(),sessionId:(0,i.Z)(),sessionStart:new Date().toISOString()})},48901:function(t,e,n){"use strict";n.d(e,{Z:function(){return y}});var r=n(6046),i=n(75422),a=n(59592),o=n(63317),s=n(39833),l=n(18734),c=n(53967),d=n(67834),u=n(30059),h=n(18786),p=n(60065),g=n(77956),m=n(71157);async function y(t){let{graph:e}=t,n=e.logger.child({migration:15}),i=(0,r.J4)({db:p.db,graphId:e.id}),a=(await g.RZ.getDocsFromServer(i)).docs,o=0;for(let t of a){let r=t.id,i=t.data();!i.yjs_doc&&(o+=1,i.document_json?await f({noteId:r,data:i,graph:e,logger:n}):(i.encrypted_note_json||i.note_json)&&await v({noteId:r,data:i,graph:e,logger:n}))}o>0&&(await e.noteStore.deleteAll(),await e.noteStore.lastSyncManager.setLastSync(null),(0,l.j)("migration_15_applied",{graphId:e.id,notesCount:o}))}async function f(t){let{noteId:e,data:n,graph:r,logger:i}=t;if(!n.document_json)return;i.info("Note ".concat(e," has document_json, fixing..."));let a=await b({noteId:e,dbDocumentJson:n.document_json,graph:r});if(!a){i.error("Failed to read document from note ".concat(e));return}let o=await k(e,a,r);if(!o){i.error("Failed to create YJS document from note ".concat(e));return}await w({noteId:e,changes:{yjs_doc:o},graph:r})}async function v(t){let{noteId:e,data:n,graph:r,logger:i}=t;i.info("Note ".concat(e," has encrypted_note_json or note_json, fixing..."));let a=await S({graph:r,noteId:e,data:n});if(!a){i.error("Failed to decrypt encrypted_note_json in note ".concat(e));return}let o=a.document;if(!o){i.error("Document not found in encrypted_note_json");return}let s=await I(o);if(!s){i.error("Failed to create YJS document from note ".concat(e));return}let l=a.id||a.$modelId||null,c={...a,yDocAsUpdate:s,id:l},d=await x(c,{encrypt:!0,key:r.encryptionKey,itemId:l});try{await w({noteId:e,changes:d,graph:r})}catch(t){(0,m.Tb)(t),i.error("Failed to update note: ".concat(e))}}async function w(t){let{noteId:e,changes:n,graph:i}=t,a=(0,r.J4)({db:p.db,graphId:i.id}),o=g.RZ.doc(a,e);await g.RZ.updateDoc(o,n)}async function b(t){let{noteId:e,dbDocumentJson:n,graph:r}=t,i={key:r.encryptionKey,itemId:e};try{let t=await (0,c.MJ)({type:"Note",value:n,...i});return t?JSON.parse(t):void 0}catch(t){return(0,m.Tb)(t),null}}async function S(t){let e,{graph:n,noteId:r,data:i}=t;try{e=await N({type:"Note",encrypted:i.encrypted_note_json,plain:i.note_json,key:n.encryptionKey,itemId:r})}catch(t){return(0,m.Tb)(t),null}if(!e)return null;try{return JSON.parse(e)}catch(t){return(0,m.Tb)(t),null}}async function k(t,e,n){try{let r=await I(e);return await T(r,{key:n.encryptionKey,encrypt:!0,itemId:t})}catch(t){return(0,m.Tb)(t),null}}async function I(t){let{ydoc:e}=(0,o.kg)(t,{template:!0}),n=i.pU.encodeStateAsUpdate(e);return(0,a.kZ)(n)}async function N(t){let{type:e,encrypted:n,plain:r,key:i,itemId:a}=t;if(n){if(!i)throw Error("No key provided");return await (0,c.O6)({type:e,encrypted:n,key:i,itemId:a})}if(r)return r}async function x(t,e){var n,r,i,a,o,s;let l={id:t.id,version:d.C,acl:t.acl,created_at:(0,h.Mp)(t.createdAt),updated_at:(0,h.Mp)(t.updatedAt),edited_at:(0,h.Mp)(null!==(n=t.editedAt)&&void 0!==n?n:null),deleted_at:(0,h.Mp)(t.deletedAt),backlinked_count:t.backlinkedCount,daily:t.daily,ignored_backlink_from_note_ids:t.ignoredBacklinkFromNoteIds,ignored_backlink_labels:await (0,u.FS)(null!==(r=t.ignoredBacklinkLabels)&&void 0!==r?r:[],e),ignored_contact_names:await (0,u.FS)(null!==(i=t.ignoredContactNames)&&void 0!==i?i:[],e),pinned_index:null!==(a=t.pinnedIndex)&&void 0!==a?a:null,system_metadata:null!==(o=t.systemMetadata)&&void 0!==o?o:null,subject:await (0,u.Wu)(null!==(s=t.subject)&&void 0!==s?s:"",e),document_json:t.yDocAsUpdate?null:await (0,u.ec)(t.document,e)};return t.yDocAsUpdate&&(l.yjs_doc=await T(t.yDocAsUpdate,e)),l}function T(t,e){(0,s.hu)(t,"yDocAsUpdate is required");let n=(0,a._f)(t);return(0,c.RY)({plain:n,...e})}},15858:function(t,e,n){"use strict";var r,i;n.d(e,{HM:function(){return s},Ky:function(){return c},d:function(){return a},ob:function(){return l},qx:function(){return o},t4:function(){return r}}),(i=r||(r={})).App="app",i.Web="web",i.Mobile="mobile";let a=()=>void 0!==window.electron,o=()=>navigator.userAgent.match(/iphone/i),s=()=>navigator.userAgent.match(/ipad/i);function l(){return a()?"app":"web"}function c(){return o()?"iphone":s()?"ipad":"browser"}},71157:function(t,e,n){"use strict";n.d(e,{Tb:function(){return d},fv:function(){return m},sU:function(){return c},uT:function(){return u}});var r=n(98454),i=n(65632),a=n.n(i),o=n(11161),s=n(7947),l=n(15858);function c(t,e){r.sU(t,g(e))}function d(t,e){let n=p(e);(0,s.Y8)()||console.error(t,n.extra),r.Tb(t,n),h(e)}function u(t,e){let n=p(e);(0,s.Y8)()||console.warn(t,n.extra),r.uT(t,n),h(e)}async function h(t){(null==t?void 0:t.flush)&&await r.yl(2e3)}function p(t){var e;let n=null==t?void 0:t.tags,r=null==t?void 0:t.level;return{extra:a()(null!==(e=null==t?void 0:t.extra)&&void 0!==e?e:{},g),level:r,tags:n}}function g(t){if("string"==typeof t)return t;try{return JSON.stringify(t)}catch(e){return"Unable to serialize ".concat(t,": ").concat(e)}}function m(t){return async function(){for(var e=arguments.length,n=Array(e),r=0;r<e;r++)n[r]=arguments[r];try{return await t(...n)}catch(t){throw d(t),t}}}r.YA("platform",(0,l.ob)()),r.YA("agent",(0,l.Ky)()),r.YA("capacitor",(0,o.W)())},65660:function(){}}]);